{% extends "shared/generic/generic_list.html" %}
{% load i18n jalali_tags %}

{% block breadcrumb_extra %}
<span class="separator">/</span>
<span>{% trans "Issues" %}</span>
<span class="separator">/</span>
<span>{% trans "Consumption Issues" %}</span>
{% endblock %}

{% block page_actions %}
<div class="page-actions">
  {% if create_url %}
    <a href="{{ create_url }}" class="btn btn-primary">
      + {% trans "Create" %} {{ create_label|default:_("Issue") }}
    </a>
  {% endif %}
  {% if print_enabled %}
    <button class="btn btn-secondary btn-print" data-action="print">
      {% trans "Print" %}
    </button>
  {% endif %}
</div>
{% endblock %}

{% block before_table %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/shared.css' %}">
{% if stats %}
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-label">{% trans "Total" %}</div>
    <div class="stat-value">{{ stats.total }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Posted</div>
    <div class="stat-value stat-value-success">{{ stats.posted }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">{% trans "Draft" %}</div>
    <div class="stat-value stat-value-muted">{{ stats.draft }}</div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block filter_fields %}
<div class="form-group">
  <label for="posted">Posted {% trans "Status" %}</label>
  <select name="posted" id="posted" class="form-control">
    <option value="">-- {% trans "All" %} --</option>
    <option value="1" {% if request.GET.posted == '1' %}selected{% endif %}>Posted</option>
    <option value="0" {% if request.GET.posted == '0' %}selected{% endif %}>Not Posted</option>
  </select>
</div>

<div class="form-group">
  <label for="search">{% trans "Search" %}</label>
  <input type="text" name="search" id="search" 
         placeholder="{% trans 'Document code or item' %}" 
         value="{{ search_query }}"
         class="form-control">
</div>
{% endblock %}

{% block table_headers %}
<th>{% trans "Document Code" %}</th>
<th>{% trans "Document Date" %}</th>
<th>{% trans "Created By" %}</th>
<th>{% trans "Items" %}</th>
<th>{% trans "Quantity" %}</th>
<th>{% trans "Warehouses" %}</th>
<th>{% trans "Organizational Unit" %}</th>
<th>Posted</th>
<th>{% trans "Actions" %}</th>
{% endblock %}

{% block table_rows %}
{% for issue in object_list %}
<tr>
  <td><code>{{ issue.document_code }}</code></td>
  <td>{{ issue.document_date|jalali_date }}</td>
  <td>
    {% if issue.created_by %}
      {{ issue.created_by.get_full_name|default:issue.created_by.username }}
    {% else %}
      <span class="text-muted">â€”</span>
    {% endif %}
  </td>
  <td>
    {% if issue.lines.all %}
      {% for line in issue.lines.all|slice:":3" %}
        <div class="line-item">
          <strong>{{ line.item.name }}</strong><br>
          <small class="text-muted"><code>{{ line.item.item_code }}</code></small>
        </div>
      {% endfor %}
      {% if issue.lines.count > 3 %}
        <small class="muted">+ {{ issue.lines.count|add:"-3" }} {% trans "more" %}</small>
      {% endif %}
    {% else %}
      <span class="text-muted">â€”</span>
    {% endif %}
  </td>
  <td class="table-cell-right">
    {% if issue.lines.all %}
      {% for line in issue.lines.all|slice:":3" %}
        <div class="line-item">
          {{ line.entered_quantity|default:line.quantity|floatformat:2 }} {{ line.entered_unit|default:line.unit }}
        </div>
      {% endfor %}
    {% else %}
      <span class="text-muted">â€”</span>
    {% endif %}
  </td>
  <td>
    {% if issue.lines.all %}
      {% for line in issue.lines.all|slice:":3" %}
        <div class="line-item">{{ line.warehouse.name }}</div>
      {% endfor %}
    {% else %}
      <span class="text-muted">â€”</span>
    {% endif %}
  </td>
  <td>{% if issue.department_unit %}{{ issue.department_unit.name }}{% else %}â€”{% endif %}</td>
  <td>
    {% if issue.is_locked %}
      <span class="badge badge-active">âœ“ Posted</span>
    {% else %}
      <span class="badge badge-draft">{% trans "Draft" %}</span>
    {% endif %}
  </td>
  <td>
    <div class="action-buttons">
      {% load access_tags %}
      {# View button - always show if user has view permission #}
      {% if detail_url_name %}
        {% can_view_object issue feature_code|default:"" as can_view %}
        {% if can_view or user.is_superuser %}
          <a href="{% url detail_url_name issue.pk %}" class="btn btn-info btn-xs">
            {% trans "View" %}
          </a>
        {% endif %}
      {% elif view_url_name %}
        {% can_view_object issue feature_code|default:"" as can_view %}
        {% if can_view or user.is_superuser %}
          <a href="{% url view_url_name issue.pk %}" class="btn btn-info btn-xs">
            {% trans "View" %}
          </a>
        {% endif %}
      {% endif %}
      {# Edit button - only show if object is not locked and user has edit permission #}
      {% if edit_url_name %}
        {% can_edit_object issue feature_code|default:"" as can_edit %}
        {% if can_edit or user.is_superuser %}
          {% if not issue.is_locked %}
            <a href="{% url edit_url_name issue.pk %}" class="btn btn-secondary btn-xs">
              {% trans "Edit" %}
            </a>
          {% endif %}
        {% endif %}
      {% endif %}
      {# Lock status #}
      {% if issue.is_locked %}
        <span class="badge badge-locked badge-mt">{% trans "Locked" %}</span>
      {% endif %}
      {# Additional actions for unlocked issues #}
      {% if not issue.is_locked %}
        {% if delete_url_name %}
          {% if issue.created_by == user %}
            {% if can_delete_own %}
              <a href="{% url delete_url_name issue.pk %}" class="btn btn-danger btn-xs" data-confirm="{% trans 'Are you sure you want to delete this issue?' %}">
                {% trans "Delete" %}
              </a>
            {% endif %}
          {% else %}
            {% if can_delete_other %}
              <a href="{% url delete_url_name issue.pk %}" class="btn btn-danger btn-xs" data-confirm="{% trans 'Are you sure you want to delete this issue?' %}">
                {% trans "Delete" %}
              </a>
            {% endif %}
          {% endif %}
        {% endif %}
        {% if lock_url_name %}
        <form method="post" action="{% url lock_url_name issue.pk %}" class="inline-lock-form form-inline-flex-ml">
          {% csrf_token %}
          <button type="submit" class="btn btn-warning btn-xs">
            {% trans "Lock" %}
          </button>
        </form>
        {% endif %}
        {% if serial_url_name and issue.enabled_lines %}
          {% with first_line=issue.enabled_lines|first %}
            {% if first_line.item.has_lot_tracking == 1 %}
              <a href="{% url serial_url_name issue.pk %}" class="btn btn-info btn-xs">
                {% trans "Manage Serials" %}
              </a>
            {% endif %}
          {% endwith %}
        {% endif %}
      {% else %}
        {% if serial_url_name and issue.enabled_lines %}
          {% with first_line=issue.enabled_lines|first %}
            {% if first_line.item.has_lot_tracking == 1 %}
              <a href="{% url serial_url_name issue.pk %}" class="btn btn-info btn-xs">
                {% trans "View Serials" %}
              </a>
            {% endif %}
          {% endwith %}
        {% endif %}
      {% endif %}
    </div>
  </td>
</tr>
{% endfor %}
{% endblock %}

{% block empty_state_title %}{{ empty_heading|default:_("No Issues Found") }}{% endblock %}
{% block empty_state_message %}{{ empty_text|default:_("Start by creating your first issue document.") }}{% endblock %}
{% block empty_state_icon %}ðŸ“¤{% endblock %}
