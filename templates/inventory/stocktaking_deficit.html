{% extends "shared/generic/generic_list.html" %}
{% load i18n jalali_tags %}

{% block breadcrumb_extra %}
<span class="separator">/</span>
<span>{% trans "Stocktaking" %}</span>
<span class="separator">/</span>
<span>{% trans "Deficit Records" %}</span>
{% endblock %}

{% block page_actions %}
<div class="page-actions">
  {% if create_url %}
    <a href="{{ create_url }}" class="btn btn-primary">
      + {% trans "Create" %} {% trans "Deficit Record" %}
    </a>
  {% endif %}
</div>
{% endblock %}

{% block before_table %}
<style>
  .action-buttons {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  .badge-locked {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 999px;
    background-color: #dc2626;
    color: #ffffff;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .muted {
    color: #6b7280;
    font-size: 0.75rem;
    display: block;
  }
</style>
{% endblock %}

{% block table_headers %}
<th>{% trans "Document Code" %}</th>
<th>{% trans "Document Date" %}</th>
<th>{% trans "Items" %}</th>
<th>{% trans "Warehouses" %}</th>
<th>{% trans "Quantity Expected" %}</th>
<th>{% trans "Quantity Counted" %}</th>
<th>{% trans "Quantity Adjusted" %}</th>
<th>{% trans "Posted" %}</th>
<th>{% trans "Actions" %}</th>
{% endblock %}

{% block table_rows %}
{% for record in object_list %}
  {% with lines=record.lines.all %}
    {% if lines %}
      {% for line in lines %}
      <tr>
        {% if forloop.first %}
        <td rowspan="{{ lines|length }}"><code>{{ record.document_code }}</code></td>
        <td rowspan="{{ lines|length }}">{{ record.document_date|jalali_date }}</td>
        {% endif %}
        <td>
          <strong>{{ line.item.name }}</strong><br>
          <small class="muted"><code>{{ line.item_code }}</code></small>
        </td>
        <td>{{ line.warehouse.name }}</td>
        <td style="text-align: right;">{{ line.quantity_expected|floatformat:2 }}</td>
        <td style="text-align: right;">{{ line.quantity_counted|floatformat:2 }}</td>
        <td style="text-align: right; color: #ef4444;">-{{ line.quantity_adjusted|floatformat:2 }}</td>
        {% if forloop.first %}
        <td rowspan="{{ lines|length }}">
          {% if record.is_locked %}
            <span class="badge badge-active">âœ“ {% trans "Posted" %}</span>
          {% else %}
            <span class="badge badge-draft">{% trans "Draft" %}</span>
          {% endif %}
        </td>
        <td rowspan="{{ lines|length }}">
          <div class="action-buttons">
            {% if edit_url_name %}
            <a href="{% url edit_url_name record.pk %}" class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.85rem;">
              {% if record.is_locked %}{% trans "View" %}{% else %}{% trans "Edit" %}{% endif %}
            </a>
            {% endif %}
            {% if record.is_locked %}
              <span class="badge-locked">{% trans "Locked" %}</span>
            {% else %}
              {% if delete_url_name %}
                {% if record.created_by == user %}
                  {% if can_delete_own %}
                    <a href="{% url delete_url_name record.pk %}" class="btn btn-danger" style="padding: 4px 12px; font-size: 0.85rem;" onclick="return confirm('{% trans "Are you sure you want to delete this record?" %}');">
                      {% trans "Delete" %}
                    </a>
                  {% endif %}
                {% else %}
                  {% if can_delete_other %}
                    <a href="{% url delete_url_name record.pk %}" class="btn btn-danger" style="padding: 4px 12px; font-size: 0.85rem;" onclick="return confirm('{% trans "Are you sure you want to delete this record?" %}');">
                      {% trans "Delete" %}
                    </a>
                  {% endif %}
                {% endif %}
              {% endif %}
              {% if lock_url_name %}
              <form method="post" action="{% url lock_url_name record.pk %}" class="inline-lock-form" style="display:inline-flex; margin:0;">
                {% csrf_token %}
                <button type="submit" class="btn btn-warning" style="padding: 4px 12px; font-size: 0.85rem;">
                  {% trans "Lock" %}
                </button>
              </form>
              {% endif %}
            {% endif %}
          </div>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td><code>{{ record.document_code }}</code></td>
        <td>{{ record.document_date|jalali_date }}</td>
        <td colspan="5" style="text-align: center; color: #6b7280;">{% trans "No items" %}</td>
        <td>
          {% if record.is_locked %}
            <span class="badge badge-active">âœ“ {% trans "Posted" %}</span>
          {% else %}
            <span class="badge badge-draft">{% trans "Draft" %}</span>
          {% endif %}
        </td>
        <td>
          <div class="action-buttons">
            {% if edit_url_name %}
            <a href="{% url edit_url_name record.pk %}" class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.85rem;">
              {% if record.is_locked %}{% trans "View" %}{% else %}{% trans "Edit" %}{% endif %}
            </a>
            {% endif %}
            {% if record.is_locked %}
              <span class="badge-locked">{% trans "Locked" %}</span>
            {% else %}
              {% if delete_url_name %}
                {% if record.created_by == user %}
                  {% if can_delete_own %}
                    <a href="{% url delete_url_name record.pk %}" class="btn btn-danger" style="padding: 4px 12px; font-size: 0.85rem;" onclick="return confirm('{% trans "Are you sure you want to delete this record?" %}');">
                      {% trans "Delete" %}
                    </a>
                  {% endif %}
                {% else %}
                  {% if can_delete_other %}
                    <a href="{% url delete_url_name record.pk %}" class="btn btn-danger" style="padding: 4px 12px; font-size: 0.85rem;" onclick="return confirm('{% trans "Are you sure you want to delete this record?" %}');">
                      {% trans "Delete" %}
                    </a>
                  {% endif %}
                {% endif %}
              {% endif %}
              {% if lock_url_name %}
              <form method="post" action="{% url lock_url_name record.pk %}" class="inline-lock-form" style="display:inline-flex; margin:0;">
                {% csrf_token %}
                <button type="submit" class="btn btn-warning" style="padding: 4px 12px; font-size: 0.85rem;">
                  {% trans "Lock" %}
                </button>
              </form>
              {% endif %}
            {% endif %}
          </div>
        </td>
      </tr>
    {% endif %}
  {% endwith %}
{% endfor %}
{% endblock %}

{% block empty_state_title %}{{ empty_heading|default:_("No Deficit Records Found") }}{% endblock %}
{% block empty_state_message %}{{ empty_text|default:_("Deficit records are created during stocktaking when counted quantity is less than expected.") }}{% endblock %}
{% block empty_state_icon %}ðŸ“‰{% endblock %}
