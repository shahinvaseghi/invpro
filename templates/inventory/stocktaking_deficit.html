{% extends "shared/generic/generic_list.html" %}
{% load i18n jalali_tags %}

{% block breadcrumb_extra %}
<span class="separator">/</span>
<span>{% trans "Stocktaking" %}</span>
<span class="separator">/</span>
<span>{% trans "Deficit Records" %}</span>
{% endblock %}

{% block page_actions %}
<div class="page-actions">
  {% if create_url %}
    <a href="{{ create_url }}" class="btn btn-primary">
      + {% trans "Create" %} {% trans "Deficit Record" %}
    </a>
  {% endif %}
</div>
{% endblock %}

{% block before_table %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/shared.css' %}">
{% endblock %}

{% block table_headers %}
<th>{% trans "Document Code" %}</th>
<th>{% trans "Document Date" %}</th>
<th>{% trans "Items" %}</th>
<th>{% trans "Warehouses" %}</th>
<th>{% trans "Quantity Expected" %}</th>
<th>{% trans "Quantity Counted" %}</th>
<th>{% trans "Quantity Adjusted" %}</th>
<th>{% trans "Posted" %}</th>
<th>{% trans "Actions" %}</th>
{% endblock %}

{% block table_rows %}
{% for record in object_list %}
  {% with lines=record.lines.all %}
    {% if lines %}
      {% for line in lines %}
      <tr>
        {% if forloop.first %}
        <td rowspan="{{ lines|length }}"><code>{{ record.document_code }}</code></td>
        <td rowspan="{{ lines|length }}">{{ record.document_date|jalali_date }}</td>
        {% endif %}
        <td>
          <strong>{{ line.item.name }}</strong><br>
          <small class="muted"><code>{{ line.item_code }}</code></small>
        </td>
        <td>{{ line.warehouse.name }}</td>
        <td class="table-cell-right">{{ line.quantity_expected|floatformat:2 }}</td>
        <td class="table-cell-right">{{ line.quantity_counted|floatformat:2 }}</td>
        <td class="table-cell-negative">-{{ line.quantity_adjusted|floatformat:2 }}</td>
        {% if forloop.first %}
        <td rowspan="{{ lines|length }}">
          {% if record.is_locked %}
            <span class="badge badge-active">âœ“ {% trans "Posted" %}</span>
          {% else %}
            <span class="badge badge-draft">{% trans "Draft" %}</span>
          {% endif %}
        </td>
        <td rowspan="{{ lines|length }}">
          <div class="action-buttons">
            {% load access_tags %}
            {# View button - always show if user has view permission #}
            {% if detail_url_name %}
              {% can_view_object record feature_code|default:"" as can_view %}
              {% if can_view or user.is_superuser %}
                <a href="{% url detail_url_name record.pk %}" class="btn btn-info btn-xs">
                  {% trans "View" %}
                </a>
              {% endif %}
            {% elif view_url_name %}
              {% can_view_object record feature_code|default:"" as can_view %}
              {% if can_view or user.is_superuser %}
                <a href="{% url view_url_name record.pk %}" class="btn btn-info btn-xs">
                  {% trans "View" %}
                </a>
              {% endif %}
            {% endif %}
            {# Edit button - only show if object is not locked and user has edit permission #}
            {% if edit_url_name %}
              {% can_edit_object record feature_code|default:"" as can_edit %}
              {% if can_edit or user.is_superuser %}
                {% if not record.is_locked %}
                  <a href="{% url edit_url_name record.pk %}" class="btn btn-secondary btn-xs">
                    {% trans "Edit" %}
                  </a>
                {% endif %}
              {% endif %}
            {% endif %}
            {% if record.is_locked %}
              <span class="badge badge-locked">{% trans "Locked" %}</span>
            {% else %}
              {% if delete_url_name %}
                {% if record.created_by == user %}
                  {% if can_delete_own %}
                    <a href="{% url delete_url_name record.pk %}" class="btn btn-danger btn-xs" data-confirm="{% trans 'Are you sure you want to delete this record?' %}">
                      {% trans "Delete" %}
                    </a>
                  {% endif %}
                {% else %}
                  {% if can_delete_other %}
                    <a href="{% url delete_url_name record.pk %}" class="btn btn-danger btn-xs" data-confirm="{% trans 'Are you sure you want to delete this record?' %}">
                      {% trans "Delete" %}
                    </a>
                  {% endif %}
                {% endif %}
              {% endif %}
              {% if lock_url_name %}
              <form method="post" action="{% url lock_url_name record.pk %}" class="inline-lock-form form-inline-flex">
                {% csrf_token %}
                <button type="submit" class="btn btn-warning btn-xs">
                  {% trans "Lock" %}
                </button>
              </form>
              {% endif %}
            {% endif %}
          </div>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td><code>{{ record.document_code }}</code></td>
        <td>{{ record.document_date|jalali_date }}</td>
        <td colspan="5" class="table-cell-empty">{% trans "No items" %}</td>
        <td>
          {% if record.is_locked %}
            <span class="badge badge-active">âœ“ {% trans "Posted" %}</span>
          {% else %}
            <span class="badge badge-draft">{% trans "Draft" %}</span>
          {% endif %}
        </td>
        <td>
          <div class="action-buttons">
            {% load access_tags %}
            {# View button - always show if user has view permission #}
            {% if detail_url_name %}
              {% can_view_object record feature_code|default:"" as can_view %}
              {% if can_view or user.is_superuser %}
                <a href="{% url detail_url_name record.pk %}" class="btn btn-info btn-xs">
                  {% trans "View" %}
                </a>
              {% endif %}
            {% elif view_url_name %}
              {% can_view_object record feature_code|default:"" as can_view %}
              {% if can_view or user.is_superuser %}
                <a href="{% url view_url_name record.pk %}" class="btn btn-info btn-xs">
                  {% trans "View" %}
                </a>
              {% endif %}
            {% endif %}
            {# Edit button - only show if object is not locked and user has edit permission #}
            {% if edit_url_name %}
              {% can_edit_object record feature_code|default:"" as can_edit %}
              {% if can_edit or user.is_superuser %}
                {% if not record.is_locked %}
                  <a href="{% url edit_url_name record.pk %}" class="btn btn-secondary btn-xs">
                    {% trans "Edit" %}
                  </a>
                {% endif %}
              {% endif %}
            {% endif %}
            {% if record.is_locked %}
              <span class="badge badge-locked">{% trans "Locked" %}</span>
            {% else %}
              {% if delete_url_name %}
                {% if record.created_by == user %}
                  {% if can_delete_own %}
                    <a href="{% url delete_url_name record.pk %}" class="btn btn-danger btn-xs" data-confirm="{% trans 'Are you sure you want to delete this record?' %}">
                      {% trans "Delete" %}
                    </a>
                  {% endif %}
                {% else %}
                  {% if can_delete_other %}
                    <a href="{% url delete_url_name record.pk %}" class="btn btn-danger btn-xs" data-confirm="{% trans 'Are you sure you want to delete this record?' %}">
                      {% trans "Delete" %}
                    </a>
                  {% endif %}
                {% endif %}
              {% endif %}
              {% if lock_url_name %}
              <form method="post" action="{% url lock_url_name record.pk %}" class="inline-lock-form form-inline-flex">
                {% csrf_token %}
                <button type="submit" class="btn btn-warning btn-xs">
                  {% trans "Lock" %}
                </button>
              </form>
              {% endif %}
            {% endif %}
          </div>
        </td>
      </tr>
    {% endif %}
  {% endwith %}
{% endfor %}
{% endblock %}

{% block empty_state_title %}{{ empty_heading|default:_("No Deficit Records Found") }}{% endblock %}
{% block empty_state_message %}{{ empty_text|default:_("Deficit records are created during stocktaking when counted quantity is less than expected.") }}{% endblock %}
{% block empty_state_icon %}ðŸ“‰{% endblock %}
