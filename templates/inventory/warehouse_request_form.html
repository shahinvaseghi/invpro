{% extends "inventory/base.html" %}
{% load i18n %}
{% load static %}

{% block page_title %}{{ form_title }}{% endblock %}

{% block inventory_content %}
<div class="form-container">
  <form method="post" class="entity-form">
    {% csrf_token %}
    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
    
    {% if form.non_field_errors %}
      <div class="alert alert-error" style="margin-bottom: 20px; padding: 15px; background-color: #fee; border: 1px solid #fcc; border-radius: 6px; color: #c33;">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    {% for section_title, section_fields in fieldsets %}
      <div class="form-section">
        <h3>{{ section_title }}</h3>
        <div class="form-row">
          {% for field in section_fields %}
            <div class="form-field">
              <label for="{{ field.id_for_label }}">
                {{ field.label }}
                {% if field.field.required and not field.field.widget.attrs.readonly %}*{% endif %}
              </label>
              {% if field.name == 'item' %}
              <div class="item-select-wrapper">
                <div class="item-filters">
                  <select class="form-control filter-type-select" id="filter-type-select">
                    <option value="">{% trans "Type" %}</option>
                    {% for item_type in item_types %}
                    <option value="{{ item_type.id }}" {% if current_item_type == item_type.id|stringformat:"s" %}selected{% endif %}>{{ item_type.name }}</option>
                    {% endfor %}
                  </select>
                  <select class="form-control filter-category-select" id="filter-category-select">
                    <option value="">{% trans "Category" %}</option>
                    {% for category in item_categories %}
                    <option value="{{ category.id }}" {% if current_category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                  </select>
                  <select class="form-control filter-subcategory-select" id="filter-subcategory-select">
                    <option value="">{% trans "Subcategory" %}</option>
                    {% for subcategory in item_subcategories %}
                    <option value="{{ subcategory.id }}" {% if current_subcategory == subcategory.id|stringformat:"s" %}selected{% endif %}>{{ subcategory.name }}</option>
                    {% endfor %}
                  </select>
                  <input type="text" class="form-control filter-search-input" id="filter-search-input"
                         placeholder="{% trans 'Search by name or code...' %}" 
                         value="{{ current_item_search }}"
                         style="flex: 2; min-width: 150px;">
                </div>
                {{ field }}
              </div>
              {% else %}
              {{ field }}
              {% endif %}
              {% if field.errors %}
                <span class="error">{{ field.errors.0 }}</span>
              {% endif %}
              {% if field.help_text %}
                <small class="form-text">{{ field.help_text }}</small>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}

    {% for field in form.visible_fields %}
      {% if field.name not in used_fields %}
      <div class="form-section">
        <div class="form-row">
          <div class="form-field">
            <label for="{{ field.id_for_label }}">
              {{ field.label }}
              {% if field.field.required and not field.field.widget.attrs.readonly %}*{% endif %}
            </label>
            {% if field.name == 'item' %}
            <div class="item-select-wrapper">
              <div class="item-filters">
                <select class="form-control filter-type-select" id="filter-type-select">
                  <option value="">{% trans "Type" %}</option>
                  {% for item_type in item_types %}
                  <option value="{{ item_type.id }}" {% if current_item_type == item_type.id|stringformat:"s" %}selected{% endif %}>{{ item_type.name }}</option>
                  {% endfor %}
                </select>
                <select class="form-control filter-category-select" id="filter-category-select">
                  <option value="">{% trans "Category" %}</option>
                  {% for category in item_categories %}
                  <option value="{{ category.id }}" {% if current_category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                  {% endfor %}
                </select>
                <select class="form-control filter-subcategory-select" id="filter-subcategory-select">
                  <option value="">{% trans "Subcategory" %}</option>
                  {% for subcategory in item_subcategories %}
                  <option value="{{ subcategory.id }}" {% if current_subcategory == subcategory.id|stringformat:"s" %}selected{% endif %}>{{ subcategory.name }}</option>
                  {% endfor %}
                </select>
                <input type="text" class="form-control filter-search-input" id="filter-search-input"
                       placeholder="{% trans 'Search by name or code...' %}" 
                       value="{{ current_item_search }}"
                       style="flex: 2; min-width: 150px;">
              </div>
              {{ field }}
            </div>
            {% else %}
            {{ field }}
            {% endif %}
            {% if field.errors %}
              <span class="error">{{ field.errors.0 }}</span>
            {% endif %}
            {% if field.help_text %}
              <small class="form-text">{{ field.help_text }}</small>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %}

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">{% trans "Save" %}</button>
      <a href="{{ list_url }}" class="btn btn-secondary">{% trans "Cancel" %}</a>
    </div>
  </form>
</div>

<style>
.form-container {
  max-width: 760px;
  margin: 2rem auto;
  background: #ffffff;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.1);
}

.entity-form .form-section {
  margin-bottom: 2rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
}

.entity-form .form-section:last-of-type {
  border-bottom: none;
  padding-bottom: 0;
}

.entity-form .form-section h3 {
  font-size: 1.15rem;
  font-weight: 600;
  margin-bottom: 1.25rem;
  color: #111827;
}

.entity-form .form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 1.5rem;
}

.entity-form .form-field {
  display: flex;
  flex-direction: column;
}

.entity-form label {
  font-weight: 500;
  margin-bottom: 0.5rem;
  color: #1f2937;
}

.entity-form .form-control,
.entity-form select,
.entity-form textarea,
.entity-form input[type="text"],
.entity-form input[type="number"],
.entity-form input[type="date"] {
  width: 100%;
  padding: 0.55rem 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 1rem;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.entity-form .form-control:focus,
.entity-form select:focus,
.entity-form textarea:focus,
.entity-form input[type="text"]:focus,
.entity-form input[type="number"]:focus,
.entity-form input[type="date"]:focus {
  outline: none;
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.entity-form textarea {
  min-height: 100px;
  resize: vertical;
}

.entity-form .error {
  margin-top: 0.35rem;
  color: #dc2626;
  font-size: 0.875rem;
}

.entity-form .form-text {
  margin-top: 0.4rem;
  color: #6b7280;
  font-size: 0.875rem;
}

.form-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  padding-top: 1rem;
}

.alert {
  padding: 0.9rem 1.1rem;
  border-radius: 6px;
  margin-bottom: 1.5rem;
}

.alert-success {
  background-color: #dcfce7;
  color: #166534;
  border: 1px solid #bbf7d0;
}

.alert-error {
  background-color: #fee2e2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

.alert-info {
  background-color: #e0f2fe;
  color: #0c4a6e;
  border: 1px solid #bae6fd;
}

.item-select-wrapper {
  width: 100%;
}

.item-filters {
  display: flex;
  gap: 0.4rem;
  margin-bottom: 0.4rem;
  flex-wrap: wrap;
}

.item-filters select,
.item-filters input[type="text"] {
  flex: 1;
  min-width: 80px;
  font-size: 0.7rem;
  padding: 0.3rem 0.4rem;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  background-color: #f9fafb;
  color: #6b7280;
}

.item-filters select:focus,
.item-filters input[type="text"]:focus {
  outline: none;
  border-color: #2563eb;
  background-color: #ffffff;
}

.item-filters input[type="text"] {
  flex: 2;
  min-width: 150px;
}
</style>

<script>
const unitMap = {{ unit_options_json|default:"{}" }};
const warehouseMap = {{ warehouse_options_json|default:"{}" }};
const unitPlaceholder = "{{ unit_placeholder|escapejs }}";
const warehousePlaceholder = "{{ warehouse_placeholder|escapejs }}";
const itemSelect = document.getElementById("id_item");
const unitSelect = document.getElementById("id_unit");
const warehouseSelect = document.getElementById("id_warehouse");

function refreshUnitOptions() {
  if (!itemSelect || !unitSelect) return;
  const selectedItem = itemSelect.value || "";
  const options = unitMap[selectedItem] || [];
  const currentValue = unitSelect.value;

  unitSelect.innerHTML = "";

  const placeholderOption = document.createElement("option");
  placeholderOption.value = "";
  placeholderOption.textContent = unitPlaceholder;
  unitSelect.appendChild(placeholderOption);

  options.forEach(function(option) {
    const optionEl = document.createElement("option");
    optionEl.value = option.value;
    optionEl.textContent = option.label;
    unitSelect.appendChild(optionEl);
  });

  if (currentValue && options.some(option => option.value === currentValue)) {
    unitSelect.value = currentValue;
  }
}

function refreshWarehouseOptions() {
  if (!itemSelect || !warehouseSelect) return;
  const selectedItem = itemSelect.value || "";
  const options = warehouseMap[selectedItem] || [];
  const currentValue = warehouseSelect.value;

  warehouseSelect.innerHTML = "";

  const placeholderOption = document.createElement("option");
  placeholderOption.value = "";
  placeholderOption.textContent = warehousePlaceholder;
  warehouseSelect.appendChild(placeholderOption);

  options.forEach(function(option) {
    const optionEl = document.createElement("option");
    optionEl.value = option.value;
    optionEl.textContent = option.label;
    warehouseSelect.appendChild(optionEl);
  });

  if (currentValue && options.some(option => option.value === currentValue)) {
    warehouseSelect.value = currentValue;
  }
}

function refreshOptions() {
  refreshUnitOptions();
  refreshWarehouseOptions();
}

if (itemSelect) {
  itemSelect.addEventListener("change", refreshOptions);
  refreshOptions();
}

// Filter items based on type, category, subcategory, and search
function filterItems() {
  const typeSelect = document.getElementById('filter-type-select');
  const categorySelect = document.getElementById('filter-category-select');
  const subcategorySelect = document.getElementById('filter-subcategory-select');
  const searchInput = document.getElementById('filter-search-input');
  
  if (!itemSelect) return;
  
  const typeId = typeSelect?.value || '';
  const categoryId = categorySelect?.value || '';
  const subcategoryId = subcategorySelect?.value || '';
  const searchTerm = searchInput?.value?.trim() || '';
  
  // Build API URL
  let apiUrl = '/inventory/api/filtered-items/';
  const params = new URLSearchParams();
  if (typeId) params.append('type_id', typeId);
  if (categoryId) params.append('category_id', categoryId);
  if (subcategoryId) params.append('subcategory_id', subcategoryId);
  if (searchTerm) params.append('search', searchTerm);
  
  // If no filters and no search, load all items
  // Otherwise, apply filters
  if (params.toString()) {
    apiUrl += '?' + params.toString();
  }
  
  // Fetch filtered items (or all items if no filters)
  fetch(apiUrl)
    .then(response => response.json())
    .then(data => {
      if (data.items) {
        const itemMap = {};
        data.items.forEach(function(item) {
          itemMap[item.value] = item;
        });
        
        const currentValue = itemSelect.value;
        const placeholder = itemSelect.options[0];
        
        // Clear all options except placeholder
        itemSelect.innerHTML = '';
        if (placeholder && placeholder.value === '') {
          itemSelect.appendChild(placeholder.cloneNode(true));
        } else {
          const emptyOption = document.createElement('option');
          emptyOption.value = '';
          emptyOption.textContent = '--- انتخاب کنید ---';
          itemSelect.appendChild(emptyOption);
        }
        
        // Add filtered items
        data.items.forEach(function(item) {
          const option = document.createElement('option');
          option.value = item.value;
          option.textContent = item.label;
          itemSelect.appendChild(option);
        });
        
        // Restore current value if it's in filtered list
        if (currentValue && itemMap[currentValue]) {
          itemSelect.value = currentValue;
          refreshOptions();
        } else if (currentValue) {
          // Current value is not in filtered list, clear it
          itemSelect.value = '';
          refreshOptions();
        }
      }
    })
    .catch(error => {
      console.error('Error filtering items:', error);
    });
}

// Load categories based on type
function loadCategories(typeId) {
  const categorySelect = document.getElementById('filter-category-select');
  const subcategorySelect = document.getElementById('filter-subcategory-select');
  
  if (!categorySelect) return;
  
  categorySelect.innerHTML = '<option value="">{% trans "All Categories" %}</option>';
  if (subcategorySelect) {
    subcategorySelect.innerHTML = '<option value="">{% trans "All Subcategories" %}</option>';
  }
  
  if (!typeId) {
    // Load all categories
    fetch('/inventory/api/filtered-categories/')
      .then(response => response.json())
      .then(data => {
        if (data.categories) {
          data.categories.forEach(function(cat) {
            const option = document.createElement("option");
            option.value = cat.value;
            option.textContent = cat.label;
            categorySelect.appendChild(option);
          });
        }
        // Filter items after loading categories
        filterItems();
      });
    return;
  }
  
  fetch(`/inventory/api/filtered-categories/?type_id=${typeId}`)
    .then(response => response.json())
    .then(data => {
      if (data.categories) {
        data.categories.forEach(function(cat) {
          const option = document.createElement("option");
          option.value = cat.value;
          option.textContent = cat.label;
          categorySelect.appendChild(option);
        });
      }
      // Filter items after loading categories
      filterItems();
    });
}

// Load subcategories based on category
function loadSubcategories(categoryId) {
  const subcategorySelect = document.getElementById('filter-subcategory-select');
  if (!subcategorySelect) return;
  
  subcategorySelect.innerHTML = '<option value="">{% trans "All Subcategories" %}</option>';
  
  if (!categoryId) {
    // Filter items after clearing subcategory
    filterItems();
    return;
  }
  
  fetch(`/inventory/api/filtered-subcategories/?category_id=${categoryId}`)
    .then(response => response.json())
    .then(data => {
      if (data.subcategories) {
        data.subcategories.forEach(function(sub) {
          const option = document.createElement("option");
          option.value = sub.value;
          option.textContent = sub.label;
          subcategorySelect.appendChild(option);
        });
      }
      // Filter items after loading subcategories
      filterItems();
    });
}

// Setup filter listeners
const typeSelect = document.getElementById('filter-type-select');
const categorySelect = document.getElementById('filter-category-select');
const subcategorySelect = document.getElementById('filter-subcategory-select');
const searchInput = document.getElementById('filter-search-input');

if (typeSelect) {
  typeSelect.addEventListener('change', function() {
    loadCategories(this.value);
  });
}

if (categorySelect) {
  categorySelect.addEventListener('change', function() {
    loadSubcategories(this.value);
  });
}

if (subcategorySelect) {
  subcategorySelect.addEventListener('change', function() {
    filterItems();
  });
}

if (searchInput) {
  let searchTimeout;
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() {
      filterItems();
    }, 300); // Debounce 300ms
  });
}

// Initialize filters - load all categories initially and filter items
if (typeSelect) {
  loadCategories(typeSelect.value);
} else {
  // If no type filter, just load all items
  filterItems();
}
</script>

<!-- Jalali DatePicker Library -->
<link rel="stylesheet" href="{% static 'css/jalali-datepicker/jalali-datepicker.min.css' %}">
<script src="{% static 'js/jalali-datepicker/jalali-datepicker.min.js' %}"></script>

<script>
// Initialize Jalali DatePicker for date inputs
document.addEventListener('DOMContentLoaded', function() {
  // Find all Jalali date inputs
  var jalaliInputs = document.querySelectorAll('input.jalali-date-input, input[data-jalali="true"]');
  
  jalaliInputs.forEach(function(input) {
    // Ensure data attributes are set
    if (!input.hasAttribute('data-jdp')) {
      input.setAttribute('data-jdp', '');
    }
    if (!input.hasAttribute('data-jdp-only-date')) {
      input.setAttribute('data-jdp-only-date', '');
    }
  });
  
  // Start watching for Jalali DatePicker initialization
  if (typeof jalaliDatepicker !== 'undefined') {
    jalaliDatepicker.startWatch({
      date: true,
      time: false,
      separatorChars: {
        date: '/',
        between: ' ',
        time: ':'
      },
      persianDigits: false,
      autoShow: true,
      autoHide: true,
      hideAfterChange: true,
      showTodayBtn: true,
      showEmptyBtn: true,
      showCloseBtn: true,
      useDropDownYears: true,
      zIndex: 1000
    });
  } else {
    console.error('Jalali DatePicker library not loaded!');
  }
});
</script>
{% endblock %}

