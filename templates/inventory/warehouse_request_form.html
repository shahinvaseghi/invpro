{% extends "shared/generic/generic_form.html" %}
{% load i18n %}
{% load static %}

{% block form_extra %}
{% if lines_formset %}
<div class="form-section">
  <div>
    <h3>{% trans "Request Lines" %}</h3>
    <p class="form-text">
      {% trans "Add one or more items to this warehouse request. Each line represents a single item with its quantity and warehouse." %}
    </p>
  </div>
  
  {% if lines_formset.non_form_errors %}
    <div class="alert alert-danger" role="alert">
      {% for error in lines_formset.non_form_errors %}
        <div>{{ error }}</div>
      {% endfor %}
    </div>
  {% endif %}
  
  {{ lines_formset.management_form }}
  {% for hidden in lines_formset.hidden_fields %}{{ hidden }}{% endfor %}

  <div class="lines-formset-wrapper">
    <div class="lines-formset" id="lines-formset" data-can-delete="{% if lines_formset.can_delete %}true{% else %}false{% endif %}">
      <div class="lines-table-header" style="display: grid !important; grid-template-columns: {% if lines_formset.can_delete %}50px 3fr 1.5fr 1.5fr 2fr 2fr 80px{% else %}50px 3fr 1.5fr 1.5fr 2fr 2fr{% endif %} !important;">
        <div class="line-cell line-number">#</div>
        <div class="line-cell line-item">{% trans "Item" %} *</div>
        <div class="line-cell line-unit">{% trans "Unit" %} *</div>
        <div class="line-cell line-quantity">{% trans "Quantity" %} *</div>
        <div class="line-cell line-warehouse">{% trans "Warehouse" %} *</div>
        <div class="line-cell line-notes">{% trans "Notes" %}</div>
        {% if lines_formset.can_delete %}
        <div class="line-cell line-delete-header">{% trans "Delete" %}</div>
        {% endif %}
      </div>
      
      {% for line_form in lines_formset %}
        <div class="line-row" data-form-index="{{ forloop.counter0 }}" style="display: grid !important; grid-template-columns: {% if lines_formset.can_delete %}50px 3fr 1.5fr 1.5fr 2fr 2fr 80px{% else %}50px 3fr 1.5fr 1.5fr 2fr 2fr{% endif %} !important;">
          {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}
          
          <div class="line-cell line-number">{{ forloop.counter }}</div>
          
          <div class="line-cell line-item">
            <div class="item-select-wrapper">
              <div class="item-filters">
                <select class="form-control filter-type-select" data-form-index="{{ forloop.counter0 }}">
                  <option value="">{% trans "Type" %}</option>
                  {% for item_type in item_types %}
                  <option value="{{ item_type.id }}">{{ item_type.name }}</option>
                  {% endfor %}
                </select>
                <select class="form-control filter-category-select" data-form-index="{{ forloop.counter0 }}">
                  <option value="">{% trans "Category" %}</option>
                  {% for category in item_categories %}
                  <option value="{{ category.id }}">{{ category.name }}</option>
                  {% endfor %}
                </select>
                <select class="form-control filter-subcategory-select" data-form-index="{{ forloop.counter0 }}">
                  <option value="">{% trans "Subcategory" %}</option>
                  {% for subcategory in item_subcategories %}
                  <option value="{{ subcategory.id }}">{{ subcategory.name }}</option>
                  {% endfor %}
                </select>
                <input type="text" class="form-control filter-search-input" data-form-index="{{ forloop.counter0 }}" 
                       placeholder="{% trans 'Search by name or code...' %}">
              </div>
              {{ line_form.item }}
              {% if line_form.item.errors %}
                <div class="error-message" role="alert">
                  {% for error in line_form.item.errors %}
                    <span class="error">{{ error }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>

          <div class="line-cell line-unit">
            {{ line_form.unit }}
            {% if line_form.unit.errors %}
              <div class="error-message" role="alert">
                {% for error in line_form.unit.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="line-cell line-quantity">
            {{ line_form.quantity_requested }}
            {% if line_form.quantity_requested.errors %}
              <div class="error-message" role="alert">
                {% for error in line_form.quantity_requested.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="line-cell line-warehouse">
            {{ line_form.warehouse }}
            {% if line_form.warehouse.errors %}
              <div class="error-message" role="alert">
                {% for error in line_form.warehouse.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="line-cell line-notes">
            {{ line_form.line_notes }}
            {% if line_form.line_notes.errors %}
              <div class="error-message" role="alert">
                {% for error in line_form.line_notes.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          {% if lines_formset.can_delete %}
          <div class="line-cell line-delete">
            {{ line_form.DELETE }}
          </div>
          {% endif %}
          
          {% if line_form.non_field_errors %}
            <div class="error full-width">{{ line_form.non_field_errors|join:", " }}</div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
  
  <button type="button" id="add-line-btn" class="btn btn-success btn-add-formset-row">
    <span class="btn-add-icon">+</span> {% trans "Add Line" %}
  </button>
{% endif %}
{% endblock %}

{% block extra_styles %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/formset-table.css' %}">
{% endblock %}

{% block form_scripts %}
{{ block.super }}
<script src="{% static 'js/formset.js' %}"></script>
<script src="{% static 'js/cascading-dropdowns.js' %}"></script>
<script src="{% static 'js/item-filters.js' %}"></script>
<script src="{% static 'js/formset-table.js' %}"></script>
<script>
// Main initialization
document.addEventListener('DOMContentLoaded', function() {
  const formsetContainer = document.getElementById('lines-formset');
  if (!formsetContainer) return;
  
  // Force grid layout immediately
  const canDelete = formsetContainer.getAttribute('data-can-delete') === 'true';
  const gridColumns = canDelete ? '50px 3fr 1.5fr 1.5fr 2fr 2fr 80px' : '50px 3fr 1.5fr 1.5fr 2fr 2fr';
  
  // Apply to header
  const header = formsetContainer.querySelector('.lines-table-header');
  if (header) {
    header.style.setProperty('display', 'grid', 'important');
    header.style.setProperty('grid-template-columns', gridColumns, 'important');
  }
  
  // Apply to all rows
  const rows = formsetContainer.querySelectorAll('.line-row');
  rows.forEach(function(row) {
    row.style.setProperty('display', 'grid', 'important');
    row.style.setProperty('grid-template-columns', gridColumns, 'important');
  });
  
  // Also use shared function for consistency
  initFormsetTableLayout(formsetContainer, {
    columnsWithDelete: '50px 3fr 1.5fr 1.5fr 2fr 2fr 80px',
    columnsWithoutDelete: '50px 3fr 1.5fr 1.5fr 2fr 2fr',
  });
  
  // Configuration for item filters
  const filterOptions = {
    placeholder: "--- {% trans 'Select' %} ---",
    allCategoriesText: "{% trans 'All Categories' %}",
    allSubcategoriesText: "{% trans 'All Subcategories' %}",
  };
  
  // Initialize item filters for existing rows
  function initializeLineForms() {
    formsetContainer.querySelectorAll('.line-row').forEach(function(lineRow, index) {
      const lineNumber = lineRow.querySelector('.line-number');
      if (lineNumber) {
        lineNumber.textContent = index + 1;
      }
      
      // Use shared item-filters.js function
      initializeItemFiltersForRow(lineRow, filterOptions);
    });
  }
  
  // Initialize existing rows
  setTimeout(function() {
    initializeLineForms();
  }, 100);
  
  // Handle add line button - use formset.js
  const addLineBtn = document.getElementById('add-line-btn');
  const totalFormsInput = document.querySelector('input[name="lines-TOTAL_FORMS"]');
  
  if (addLineBtn && formsetContainer && totalFormsInput) {
    // Clone first row as template
    const firstRow = formsetContainer.querySelector('.line-row');
    if (firstRow) {
      const templateRow = firstRow.cloneNode(true);
      templateRow.id = 'lines-formset-template';
      templateRow.style.display = 'none';
      templateRow.classList.add('formset-template');
      formsetContainer.appendChild(templateRow);
      
      // Initialize formset
      initFormset('lines', '#lines-formset-template', {
        minRows: 1,
        maxRows: null,
        addButtonSelector: '#add-line-btn',
        removeButtonSelector: '.line-delete input[type="checkbox"]'
      });
      
      // After adding row, initialize filters and update layout
      document.addEventListener('formset:row-added', function(e) {
        if (e.detail.prefix === 'lines') {
          setTimeout(function() {
            const newRow = formsetContainer.querySelector('.line-row:not(.formset-template)');
            if (newRow) {
              // Force grid layout on new row
              newRow.style.setProperty('display', 'grid', 'important');
              newRow.style.setProperty('grid-template-columns', gridColumns, 'important');
              initializeItemFiltersForRow(newRow, filterOptions);
              initializeLineForms(); // Re-index all rows
              updateFormsetTableLayout(formsetContainer, {
                columnsWithDelete: '50px 3fr 1.5fr 1.5fr 2fr 2fr 80px',
                columnsWithoutDelete: '50px 3fr 1.5fr 1.5fr 2fr 2fr',
              });
            }
          }, 50);
        }
      });
    }
  }
  
  // Handle delete checkboxes
  formsetContainer.addEventListener('change', function(e) {
    if (e.target.type === 'checkbox' && e.target.name && e.target.name.includes('-DELETE')) {
      const lineRow = e.target.closest('.line-row');
      if (lineRow) {
        if (e.target.checked) {
          lineRow.classList.add('deleted');
        } else {
          lineRow.classList.remove('deleted');
        }
        initializeLineForms();
      }
    }
  });
});
</script>
{% endblock %}
