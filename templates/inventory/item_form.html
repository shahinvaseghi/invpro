{% extends "inventory/base.html" %}
{% load i18n %}

{% block page_title %}{{ form_title }}{% endblock %}

{% block inventory_content %}
<div class="form-container">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form method="post" class="entity-form" id="item-form" onsubmit="return handleFormSubmit(event)">
    {% csrf_token %}
    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}

    <div class="form-section">
      {% if form.allowed_warehouses %}
      <div class="form-field full-width">
        <label>{{ form.allowed_warehouses.label }}{% if form.allowed_warehouses.field.required %}*{% endif %}</label>
        <div class="checkbox-grid">
          {% for checkbox in form.allowed_warehouses %}
            <label class="checkbox-item">
              {{ checkbox.tag }}
              <span>{{ checkbox.choice_label }}</span>
            </label>
          {% endfor %}
        </div>
        {% if form.allowed_warehouses.errors %}
          <span class="error">{{ form.allowed_warehouses.errors.0 }}</span>
        {% endif %}
        {% if form.allowed_warehouses.help_text %}
          <small class="form-text">{{ form.allowed_warehouses.help_text }}</small>
        {% endif %}
      </div>
      {% endif %}

      {% for field in form.visible_fields %}
        {% if field.name != 'allowed_warehouses' %}
        <div class="form-field">
          <label for="{{ field.id_for_label }}">
            {{ field.label }}
            {% if field.field.required %}*{% endif %}
          </label>
          {{ field }}
          {% if field.errors %}
            <span class="error">{{ field.errors.0 }}</span>
          {% endif %}
          {% if field.help_text %}
            <small class="form-text">{{ field.help_text }}</small>
          {% endif %}
        </div>
        {% endif %}
      {% endfor %}
    </div>

    <div class="form-section">
      <h3 style="margin-top: 2rem;">واحدهای ثانویه (اختیاری)</h3>
      <p class="form-text">
        در صورت نیاز می‌توانید تبدیل واحد تعریف کنید (مثلاً ۲ متر = ۲۰ کیلوگرم).
      </p>
      {{ units_formset.management_form }}
      {% for hidden in units_formset.hidden_fields %}{{ hidden }}{% endfor %}

      <div class="unit-formset" id="unit-formset">
        {% for unit_form in units_formset %}
          <div class="unit-form">
            {% for hidden in unit_form.hidden_fields %}{{ hidden }}{% endfor %}
            <div class="unit-row">
              <div class="unit-field">
                <label>{{ unit_form.from_quantity.label }}</label>
                {{ unit_form.from_quantity }}
                {% if unit_form.from_quantity.errors %}
                  <span class="error">{{ unit_form.from_quantity.errors.0 }}</span>
                {% endif %}
              </div>
              <div class="unit-field">
                <label>{{ unit_form.from_unit.label }}</label>
                {{ unit_form.from_unit }}
                {% if unit_form.from_unit.errors %}
                  <span class="error">{{ unit_form.from_unit.errors.0 }}</span>
                {% endif %}
              </div>
              <div class="unit-field">
                <label>{{ unit_form.to_quantity.label }}</label>
                {{ unit_form.to_quantity }}
                {% if unit_form.to_quantity.errors %}
                  <span class="error">{{ unit_form.to_quantity.errors.0 }}</span>
                {% endif %}
              </div>
              <div class="unit-field">
                <label>{{ unit_form.to_unit.label }}</label>
                {{ unit_form.to_unit }}
                {% if unit_form.to_unit.errors %}
                  <span class="error">{{ unit_form.to_unit.errors.0 }}</span>
                {% endif %}
              </div>
              <div class="unit-field">
                <label>{{ unit_form.description.label }}</label>
                {{ unit_form.description }}
              </div>
              <div class="unit-field">
                <label>{{ unit_form.notes.label }}</label>
                {{ unit_form.notes }}
              </div>
              {% if units_formset.can_delete %}
              <div class="unit-field unit-delete">
                <label>{{ unit_form.DELETE.label }}</label>
                {{ unit_form.DELETE }}
              </div>
              {% endif %}
            </div>
            {% if unit_form.non_field_errors %}
              <div class="error">{{ unit_form.non_field_errors|join:", " }}</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      <button type="button" id="add-unit-row" class="btn btn-secondary" style="margin-top: 1rem;">
        + {% trans "Add Unit Conversion" %}
      </button>
      
      <!-- Empty form template for cloning -->
      <div id="empty-unit-form" style="display: none;">
        {{ units_formset.empty_form }}
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">ذخیره</button>
      <a href="{% url 'inventory:items' %}" class="btn btn-secondary">لغو</a>
    </div>
  </form>
</div>

<style>
.unit-formset {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  margin-top: 1rem;
}

.unit-form {
  padding: 1rem;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  background-color: #f9fafb;
}

.unit-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 1rem;
}

.unit-field label {
  display: block;
  font-weight: 500;
  margin-bottom: 0.25rem;
}

.unit-delete {
  display: flex;
  align-items: center;
}

.form-field.full-width {
  width: 100%;
}

.checkbox-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 0.75rem 1rem;
  margin-top: 0.5rem;
}

.checkbox-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  background-color: #ffffff;
  cursor: pointer;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.checkbox-item:hover {
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
}

.checkbox-item input[type="checkbox"] {
  width: 1.1rem;
  height: 1.1rem;
  cursor: pointer;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Unit formset handling
  const formsetContainer = document.getElementById('unit-formset');
  const addButton = document.getElementById('add-unit-row');
  const managementForm = document.querySelector('[name="units-TOTAL_FORMS"]');
  
  if (formsetContainer && addButton && managementForm) {
    const emptyFormTemplate = document.getElementById('empty-unit-form');
    
    addButton.addEventListener('click', function() {
      const totalForms = parseInt(managementForm.value);
      
      // Clone the empty form template
      const newForm = emptyFormTemplate.cloneNode(true);
      newForm.style.display = 'block';
      newForm.id = '';
      
      // Update all form field names and IDs to use the new index
      const formFields = newForm.querySelectorAll('input, select, textarea, label');
      formFields.forEach(function(field) {
        if (field.name) {
          field.name = field.name.replace(/__prefix__/g, totalForms);
        }
        if (field.id) {
          field.id = field.id.replace(/__prefix__/g, totalForms);
        }
        if (field.getAttribute('for')) {
          field.setAttribute('for', field.getAttribute('for').replace(/__prefix__/g, totalForms));
        }
      });
      
      // Add the new form to the formset container
      formsetContainer.appendChild(newForm);
      
      // Update the total forms count
      managementForm.value = totalForms + 1;
    });
    
    // Handle delete checkboxes
    formsetContainer.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox' && e.target.name && e.target.name.includes('DELETE')) {
        const form = e.target.closest('.unit-form');
        if (form && e.target.checked) {
          form.style.opacity = '0.5';
        } else if (form) {
          form.style.opacity = '1';
        }
      }
    });
  }
  
  // Category/Subcategory cascading
  const categorySelect = document.getElementById('id_category');
  const subcategorySelect = document.getElementById('id_subcategory');
  const typeSelect = document.getElementById('id_type');
  
  function loadSubcategories(categoryId, typeId, selectedSubcategoryId = null) {
    if (!subcategorySelect) return;
    
    subcategorySelect.innerHTML = '<option value="">--- انتخاب کنید ---</option>';
    subcategorySelect.disabled = true;
    
    if (!categoryId) {
      return;
    }
    
    const url = new URL('{% url "inventory:filtered_subcategories" %}', window.location.origin);
    if (typeId) url.searchParams.set('type_id', typeId);
    if (categoryId) url.searchParams.set('category_id', categoryId);
    
    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          return;
        }
        
        subcategorySelect.innerHTML = '<option value="">--- انتخاب کنید ---</option>';
        if (data.subcategories && data.subcategories.length > 0) {
          data.subcategories.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub.value;
            option.textContent = sub.label;
            if (selectedSubcategoryId && sub.value === selectedSubcategoryId.toString()) {
              option.selected = true;
            }
            subcategorySelect.appendChild(option);
          });
        }
        subcategorySelect.disabled = false;
      })
      .catch(error => {
        subcategorySelect.disabled = false;
      });
  }
  
  if (categorySelect) {
    categorySelect.addEventListener('change', function() {
      const categoryId = this.value;
      const typeId = typeSelect ? typeSelect.value : null;
      loadSubcategories(categoryId, typeId);
    });
  }
  
  if (typeSelect) {
    typeSelect.addEventListener('change', function() {
      const typeId = this.value;
      const categoryId = categorySelect ? categorySelect.value : null;
      if (categoryId) {
        loadSubcategories(categoryId, typeId);
      }
    });
  }
  
  // Load subcategories on page load if category is already selected
  if (categorySelect && categorySelect.value) {
    const categoryId = categorySelect.value;
    const typeId = typeSelect ? typeSelect.value : null;
    const subcategoryId = subcategorySelect ? subcategorySelect.value : null;
    loadSubcategories(categoryId, typeId, subcategoryId);
  }
});

function handleFormSubmit(event) {
  const form = event.target;
  
  // Check form validation
  if (!form.checkValidity()) {
    form.reportValidity();
    return false;
  }
  
  return true;
}
</script>
{% endblock %}
