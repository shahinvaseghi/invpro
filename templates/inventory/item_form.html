{% extends "shared/generic/generic_form.html" %}
{% load i18n %}

{% block breadcrumb_extra %}
<span class="separator">/</span>
<span>{% trans "Items" %}</span>
<span class="separator">/</span>
<span>{{ form_title }}</span>
{% endblock %}

{% block form_sections %}
<div class="form-section">
  {% if form.allowed_warehouses %}
  <div class="form-field full-width">
    <label>{{ form.allowed_warehouses.label }}{% if form.allowed_warehouses.field.required %}*{% endif %}</label>
    <div class="checkbox-grid">
      {% for checkbox in form.allowed_warehouses %}
        <label class="checkbox-item">
          {{ checkbox.tag }}
          <span>{{ checkbox.choice_label }}</span>
        </label>
      {% endfor %}
    </div>
    {% if form.allowed_warehouses.errors %}
      <span class="error">{{ form.allowed_warehouses.errors.0 }}</span>
    {% endif %}
    {% if form.allowed_warehouses.help_text %}
      <small class="form-text">{{ form.allowed_warehouses.help_text }}</small>
    {% endif %}
  </div>
  {% endif %}

  {% for field in form.visible_fields %}
    {% if field.name != 'allowed_warehouses' and field.name != 'is_sellable' and field.name != 'has_lot_tracking' and field.name != 'requires_temporary_receipt' and field.name != 'serial_in_qc' %}
    <div class="form-field">
      <label for="{{ field.id_for_label }}">
        {{ field.label }}
        {% if field.field.required %}*{% endif %}
      </label>
      {{ field }}
      {% if field.errors %}
        <span class="error">{{ field.errors.0 }}</span>
      {% endif %}
      {% if field.help_text %}
        <small class="form-text">{{ field.help_text }}</small>
      {% endif %}
    </div>
    {% endif %}
  {% endfor %}
  
  <!-- Checkbox fields section -->
  <div class="form-field full-width checkbox-section">
    <label>{% trans "Options" %}</label>
    <div class="checkbox-group">
      {% if form.is_sellable %}
      <div class="checkbox-item">
        <label for="{{ form.is_sellable.id_for_label }}">
          {{ form.is_sellable }}
          <span>{{ form.is_sellable.label }}</span>
        </label>
        {% if form.is_sellable.errors %}
          <span class="error">{{ form.is_sellable.errors.0 }}</span>
        {% endif %}
      </div>
      {% endif %}
      
      {% if form.has_lot_tracking %}
      <div class="checkbox-item">
        <label for="{{ form.has_lot_tracking.id_for_label }}">
          {{ form.has_lot_tracking }}
          <span>{{ form.has_lot_tracking.label }}</span>
        </label>
        {% if form.has_lot_tracking.errors %}
          <span class="error">{{ form.has_lot_tracking.errors.0 }}</span>
        {% endif %}
      </div>
      {% endif %}
      
      {% if form.requires_temporary_receipt %}
      <div class="checkbox-item">
        <label for="{{ form.requires_temporary_receipt.id_for_label }}">
          {{ form.requires_temporary_receipt }}
          <span>{{ form.requires_temporary_receipt.label }}</span>
        </label>
        {% if form.requires_temporary_receipt.errors %}
          <span class="error">{{ form.requires_temporary_receipt.errors.0 }}</span>
        {% endif %}
      </div>
      {% endif %}
      
      {% if form.serial_in_qc %}
      <div class="checkbox-item">
        <label for="{{ form.serial_in_qc.id_for_label }}">
          {{ form.serial_in_qc }}
          <span>{{ form.serial_in_qc.label }}</span>
        </label>
        {% if form.serial_in_qc.errors %}
          <span class="error">{{ form.serial_in_qc.errors.0 }}</span>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block form_extra %}
<div class="form-section">
  <h3 style="margin-top: 2rem;">{% trans "Unit Conversions (Optional)" %}</h3>
  <p class="form-text">
    {% trans "You can define unit conversions if needed (e.g., 2 meters = 20 kilograms)." %}
  </p>
  {{ units_formset.management_form }}
  {% for hidden in units_formset.hidden_fields %}{{ hidden }}{% endfor %}

  <div class="unit-formset" id="unit-formset">
    {% for unit_form in units_formset %}
      <div class="unit-form">
        {% for hidden in unit_form.hidden_fields %}{{ hidden }}{% endfor %}
        <div class="unit-row">
          <div class="unit-field">
            <label>{{ unit_form.from_quantity.label }}</label>
            {{ unit_form.from_quantity }}
            {% if unit_form.from_quantity.errors %}
              <span class="error">{{ unit_form.from_quantity.errors.0 }}</span>
            {% endif %}
          </div>
          <div class="unit-field">
            <label>{{ unit_form.from_unit.label }}</label>
            {{ unit_form.from_unit }}
            {% if unit_form.from_unit.errors %}
              <span class="error">{{ unit_form.from_unit.errors.0 }}</span>
            {% endif %}
          </div>
          <div class="unit-field">
            <label>{{ unit_form.to_quantity.label }}</label>
            {{ unit_form.to_quantity }}
            {% if unit_form.to_quantity.errors %}
              <span class="error">{{ unit_form.to_quantity.errors.0 }}</span>
            {% endif %}
          </div>
          <div class="unit-field">
            <label>{{ unit_form.to_unit.label }}</label>
            {{ unit_form.to_unit }}
            {% if unit_form.to_unit.errors %}
              <span class="error">{{ unit_form.to_unit.errors.0 }}</span>
            {% endif %}
          </div>
          <div class="unit-field">
            <label>{{ unit_form.description.label }}</label>
            {{ unit_form.description }}
          </div>
          <div class="unit-field">
            <label>{{ unit_form.notes.label }}</label>
            {{ unit_form.notes }}
          </div>
          {% if units_formset.can_delete %}
          <div class="unit-field unit-delete">
            <label>{{ unit_form.DELETE.label }}</label>
            {{ unit_form.DELETE }}
          </div>
          {% endif %}
        </div>
        {% if unit_form.non_field_errors %}
          <div class="error">{{ unit_form.non_field_errors|join:", " }}</div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
  <button type="button" id="add-unit-row" class="btn btn-secondary" style="margin-top: 1rem;">
    + {% trans "Add Unit Conversion" %}
  </button>
  
  <!-- Empty form template for cloning -->
  <div id="empty-unit-form" style="display: none;">
    {{ units_formset.empty_form }}
  </div>
</div>
{% endblock %}

{% block extra_styles %}
<style>
.unit-formset {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  margin-top: 1rem;
}

.unit-form {
  padding: 1rem;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  background-color: #f9fafb;
}

.unit-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 1rem;
}

.unit-field label {
  display: block;
  font-weight: 500;
  margin-bottom: 0.25rem;
}

.unit-delete {
  display: flex;
  align-items: center;
}

.form-field.full-width {
  width: 100%;
}

.checkbox-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 0.75rem 1rem;
  margin-top: 0.5rem;
}

.checkbox-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  background-color: #ffffff;
  cursor: pointer;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.checkbox-item:hover {
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
}

.checkbox-item input[type="checkbox"] {
  width: 1.1rem;
  height: 1.1rem;
  cursor: pointer;
}

.checkbox-section {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid #e5e7eb;
}

.checkbox-group {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-top: 0.5rem;
}

.checkbox-group .checkbox-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  background-color: #ffffff;
  cursor: pointer;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.checkbox-group .checkbox-item:hover {
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
}

.checkbox-group .checkbox-item label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  margin: 0;
  width: 100%;
}

.checkbox-group .checkbox-item input[type="checkbox"] {
  width: 1.1rem;
  height: 1.1rem;
  cursor: pointer;
}
</style>
{% endblock %}

{% block form_scripts %}
{% load static %}
<script src="{% static 'js/formset.js' %}"></script>
<script src="{% static 'js/cascading-dropdowns.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Unit formset handling - use formset.js
  const formsetContainer = document.getElementById('unit-formset');
  const emptyFormTemplate = document.getElementById('empty-unit-form');
  
  if (formsetContainer && emptyFormTemplate) {
    // Make template visible for cloning
    emptyFormTemplate.style.display = 'block';
    emptyFormTemplate.id = 'units-formset-template';
    emptyFormTemplate.classList.add('formset-template');
    
    // Initialize formset using formset.js
    initFormset('units', '#units-formset-template', {
      minRows: 0,
      maxRows: null,
      addButtonSelector: '#add-unit-row',
      removeButtonSelector: 'input[name*="-DELETE"]'
    });
    
    // Handle delete checkboxes visual feedback
    formsetContainer.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox' && e.target.name && e.target.name.includes('DELETE')) {
        const form = e.target.closest('.unit-form');
        if (form) {
          form.style.opacity = e.target.checked ? '0.5' : '1';
        }
      }
    });
  }
  
  // Category/Subcategory cascading - use cascading-dropdowns.js
  const categorySelect = document.getElementById('id_category');
  const subcategorySelect = document.getElementById('id_subcategory');
  const typeSelect = document.getElementById('id_type');
  
  // Initialize Type → Category cascading
  if (typeSelect && categorySelect) {
    // Note: This requires a custom API endpoint that accepts type_id
    // For now, we'll use the existing filtered_categories endpoint
    const categoryApiUrl = '{% url "inventory:filtered_categories" %}';
    
    // Custom handler for Type → Category
    typeSelect.addEventListener('change', function() {
      const typeId = this.value;
      if (!typeId) {
        clearDropdown(categorySelect, '--- {% trans "Please select" %} ---');
        if (subcategorySelect) {
          clearDropdown(subcategorySelect, '--- {% trans "Please select" %} ---');
        }
        return;
      }
      
      categorySelect.disabled = true;
      const url = new URL(categoryApiUrl, window.location.origin);
      url.searchParams.set('type_id', typeId);
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.categories) {
            updateDropdownOptions(categorySelect, data.categories, '--- {% trans "Please select" %} ---', 'value', 'label');
            categorySelect.disabled = false;
            // Trigger category change to update subcategories
            if (categorySelect.value) {
              categorySelect.dispatchEvent(new Event('change'));
            }
          }
        })
        .catch(error => {
          console.error('Error loading categories:', error);
          categorySelect.disabled = false;
        });
    });
  }
  
  // Initialize Category → Subcategory cascading
  if (categorySelect && subcategorySelect) {
    const subcategoryApiUrl = '{% url "inventory:filtered_subcategories" %}';
    
    initCascadingDropdown(categorySelect, subcategorySelect, subcategoryApiUrl, {
      parentField: 'category_id',
      placeholder: '--- {% trans "Please select" %} ---',
      valueField: 'value',
      labelField: 'label',
      onChange: function(value, element) {
        // Additional handling if needed
      }
    });
    
    // Also handle type_id parameter if type is selected
    if (typeSelect) {
      const originalChangeHandler = categorySelect.onchange;
      categorySelect.addEventListener('change', function() {
        const categoryId = this.value;
        const typeId = typeSelect.value;
        
        if (!categoryId) {
          clearDropdown(subcategorySelect, '--- {% trans "Please select" %} ---');
          return;
        }
        
        subcategorySelect.disabled = true;
        const url = new URL(subcategoryApiUrl, window.location.origin);
        url.searchParams.set('category_id', categoryId);
        if (typeId) {
          url.searchParams.set('type_id', typeId);
        }
        
        fetch(url)
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              subcategorySelect.disabled = false;
              return;
            }
            
            const options = data.subcategories || [];
            const selectedSubcategoryId = subcategorySelect.value;
            updateDropdownOptions(subcategorySelect, options, '--- {% trans "Please select" %} ---', 'value', 'label');
            
            // Restore selected value if it exists
            if (selectedSubcategoryId && options.some(opt => opt.value === selectedSubcategoryId)) {
              subcategorySelect.value = selectedSubcategoryId;
            }
            
            subcategorySelect.disabled = false;
          })
          .catch(error => {
            console.error('Error loading subcategories:', error);
            subcategorySelect.disabled = false;
          });
      });
    }
  }
  
  // Load initial values on page load
  if (categorySelect && categorySelect.value && typeSelect) {
    typeSelect.dispatchEvent(new Event('change'));
  }
});
</script>
{% endblock %}
