{% extends "shared/generic/generic_list.html" %}
{% load i18n jalali_tags %}

{% block breadcrumb_extra %}
<span class="separator">/</span>
<span>{% trans "Stocktaking" %}</span>
<span class="separator">/</span>
<span>{% trans "Stocktaking Records" %}</span>
{% endblock %}

{% block page_actions %}
<div class="page-actions">
  {% if create_url %}
    <a href="{{ create_url }}" class="btn btn-primary">
      + {% trans "Create" %} {% trans "Stocktaking Record" %}
    </a>
  {% endif %}
</div>
{% endblock %}

{% block before_table %}
<style>
  .action-buttons {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  .badge-locked {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 999px;
    background-color: #dc2626;
    color: #ffffff;
    font-size: 0.75rem;
    font-weight: 600;
  }
</style>
{% endblock %}

{% block table_headers %}
<th>{% trans "Document Code" %}</th>
<th>{% trans "Document Date" %}</th>
<th>{% trans "Session ID" %}</th>
<th>{% trans "Confirmed By" %}</th>
<th>Approval {% trans "Status" %}</th>
<th>{% trans "Final Value" %}</th>
<th>{% trans "Actions" %}</th>
{% endblock %}

{% block table_rows %}
{% for record in object_list %}
<tr>
  <td><code>{{ record.document_code }}</code></td>
  <td>{{ record.document_date|jalali_date }}</td>
  <td>{{ record.stocktaking_session_id }}</td>
  <td>
    {% if record.confirmed_by %}
      {{ record.confirmed_by.get_full_name|default:record.confirmed_by.username }}
    {% else %}
      <span style="color: #6b7280;">â€”</span>
    {% endif %}
  </td>
  <td>
    {% if record.approval_status == 'approved' %}
      <span class="badge badge-approved">{% trans "Approved" %}</span>
    {% elif record.approval_status == 'rejected' %}
      <span class="badge badge-rejected">{% trans "Rejected" %}</span>
    {% else %}
      <span class="badge badge-pending">{% trans "Pending" %}</span>
    {% endif %}
  </td>
  <td style="text-align: right;">
    {% if record.final_inventory_value %}
      {{ record.final_inventory_value|floatformat:2 }}
    {% else %}
      <span style="color: #6b7280;">â€”</span>
    {% endif %}
  </td>
  <td>
    <div class="action-buttons">
      {% load access_tags %}
      {# View button - always show if user has view permission #}
      {% if detail_url_name %}
        {% can_view_object record feature_code|default:"" as can_view %}
        {% if can_view or user.is_superuser %}
          <a href="{% url detail_url_name record.pk %}" class="btn btn-info" style="padding: 4px 12px; font-size: 0.85rem; background-color: #0dcaf0; border-color: #0dcaf0; color: #000;">
            {% trans "View" %}
          </a>
        {% endif %}
      {% elif view_url_name %}
        {% can_view_object record feature_code|default:"" as can_view %}
        {% if can_view or user.is_superuser %}
          <a href="{% url view_url_name record.pk %}" class="btn btn-info" style="padding: 4px 12px; font-size: 0.85rem; background-color: #0dcaf0; border-color: #0dcaf0; color: #000;">
            {% trans "View" %}
          </a>
        {% endif %}
      {% endif %}
      {# Edit button - only show if object is not locked and user has edit permission #}
      {% if edit_url_name %}
        {% can_edit_object record feature_code|default:"" as can_edit %}
        {% if can_edit or user.is_superuser %}
          {% if not record.is_locked %}
            <a href="{% url edit_url_name record.pk %}" class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.85rem;">
              {% trans "Edit" %}
            </a>
          {% endif %}
        {% endif %}
      {% endif %}
      {% if record.is_locked %}
        <span class="badge-locked">{% trans "Locked" %}</span>
      {% else %}
        {% if delete_url_name %}
          {% if record.created_by == user %}
            {% if can_delete_own %}
              <a href="{% url delete_url_name record.pk %}" class="btn btn-danger" style="padding: 4px 12px; font-size: 0.85rem;" onclick="return confirm('{% trans "Are you sure you want to delete this record?" %}');">
                {% trans "Delete" %}
              </a>
            {% endif %}
          {% else %}
            {% if can_delete_other %}
              <a href="{% url delete_url_name record.pk %}" class="btn btn-danger" style="padding: 4px 12px; font-size: 0.85rem;" onclick="return confirm('{% trans "Are you sure you want to delete this record?" %}');">
                {% trans "Delete" %}
              </a>
            {% endif %}
          {% endif %}
        {% endif %}
        {% if lock_url_name %}
        <form method="post" action="{% url lock_url_name record.pk %}" class="inline-lock-form" style="display:inline-flex; margin:0;">
          {% csrf_token %}
          <button type="submit" class="btn btn-warning" style="padding: 4px 12px; font-size: 0.85rem;">
            {% trans "Lock" %}
          </button>
        </form>
        {% endif %}
      {% endif %}
    </div>
  </td>
</tr>
{% endfor %}
{% endblock %}

{% block empty_state_title %}{{ empty_heading|default:_("No Stocktaking Records Found") }}{% endblock %}
{% block empty_state_message %}{{ empty_text|default:_("Stocktaking records confirm the accuracy of inventory counts.") }}{% endblock %}
{% block empty_state_icon %}ðŸ“‹{% endblock %}
