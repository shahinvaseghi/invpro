{% extends "inventory/base.html" %}
{% load i18n jalali_tags %}
{% load static %}

{% block page_title %}{{ form_title }}{% endblock %}

{% block inventory_styles %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/shared.css' %}">
<link rel="stylesheet" href="{% static 'css/formset-table.css' %}">
{% endblock %}

{% block inventory_content %}
<div class="form-container">
  {% if document_instance and document_instance.pk %}
  <div class="info-banner">
    <div><strong>{% trans "Document Code" %}:</strong> {{ document_instance.document_code }}</div>
    <div><strong>{% trans "Document Date" %}:</strong> {{ document_instance.document_date|jalali_date }}</div>
    {% if document_status_display %}
    <div><strong>{% trans "Status" %}:</strong> {{ document_status_display }}</div>
    {% endif %}
    <div class="lock-status">
      <strong>{% trans "Lock Status" %}:</strong>
      {% if document_is_locked %}
        <span class="badge badge-locked">{% trans "Locked" %}</span>
      {% else %}
        <span class="badge badge-unlocked">{% trans "Editable" %}</span>
        {% if lock_url %}
        <form method="post" action="{{ lock_url }}" class="inline-lock-form">
          {% csrf_token %}
          <button type="submit" class="btn btn-warning btn-lock">{% trans "Lock" %}</button>
        </form>
        {% endif %}
      {% endif %}
    </div>
  </div>
  {% if document_is_locked %}
  <div class="alert alert-info">
    {% trans "This document is locked and can no longer be edited or deleted." %}
  </div>
  {% endif %}
  {% endif %}

  <form method="post" class="entity-form" id="receipt-form" novalidate{% if document_is_locked %} onsubmit="return false;"{% endif %}>
    {% csrf_token %}
    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for error in form.non_field_errors %}
          <div>{{ error }}</div>
        {% endfor %}
      </div>
    {% endif %}

    {% for section_title, section_fields in fieldsets %}
      <div class="form-section">
        <h3>{{ section_title }}</h3>
        <div class="form-row">
          {% for field in section_fields %}
            <div class="form-field">
              <label for="{{ field.id_for_label }}">
                {{ field.label }}
                {% if field.field.required %}*{% endif %}
              </label>
              {{ field }}
              {% if field.errors %}
                <span class="error">{{ field.errors.0 }}</span>
              {% endif %}
              {% if field.help_text %}
                <small class="form-text">{{ field.help_text }}</small>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}

    {% for field in form.visible_fields %}
      {% if field.name not in used_fields %}
      <div class="form-section">
        <div class="form-row">
          <div class="form-field">
            <label for="{{ field.id_for_label }}">
              {{ field.label }}
              {% if field.field.required %}*{% endif %}
            </label>
            {{ field }}
            {% if field.errors %}
              <span class="error">{{ field.errors.0 }}</span>
            {% endif %}
            {% if field.help_text %}
              <small class="form-text">{{ field.help_text }}</small>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %}

    {% if lines_formset %}
    <div class="form-section">
      <div>
        <h3 class="no-margin">{% trans "Document Lines" %}</h3>
        <p class="form-text form-text-mt no-margin">
          {% trans "Add one or more items to this document. Each line represents a single item with its quantity and other details." %}
        </p>
      </div>
      {% if lines_formset.non_form_errors %}
        <div class="alert alert-danger">
          {% for error in lines_formset.non_form_errors %}
            <div>{{ error }}</div>
          {% endfor %}
        </div>
      {% endif %}
      {{ lines_formset.management_form }}
      {% for hidden in lines_formset.hidden_fields %}{{ hidden }}{% endfor %}

      <div class="lines-formset" id="lines-formset">
        {% for line_form in lines_formset %}
          {% comment %}Determine if this form should be displayed:
             - In create mode: show all forms that have initial data or first empty form
             - In edit mode: show existing lines (with pk) and first empty form if any
          {% endcomment %}
          {% if not form.instance.pk %}
            {# Create mode: show all forms that have initial data or first empty form #}
            {% if line_form.initial.item or line_form.initial.warehouse or forloop.counter0 < 1 %}
          <div class="line-form" data-form-index="{{ forloop.counter0 }}">
            {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}
            
            <div class="line-header">
              <h4>{% trans "Line" %} {{ forloop.counter }}</h4>
              {% if lines_formset.can_delete %}
              <div class="line-delete">
                <label>{{ line_form.DELETE.label }}</label>
                {{ line_form.DELETE }}
              </div>
              {% endif %}
            </div>

            <div class="line-fields">
              <div class="form-row">
                {% if 'item' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.item.label }}{% if line_form.item.field.required %}*{% endif %}</label>
                  <div class="item-select-wrapper">
                    {% if not document_is_locked %}
                    <div class="item-filters">
                      <select class="form-control filter-type-select" data-form-index="{{ forloop.counter0 }}">
                        <option value="">{% trans "Type" %}</option>
                        {% for item_type in item_types %}
                        <option value="{{ item_type.id }}" {% if current_item_type == item_type.id|stringformat:"s" %}selected{% endif %}>{{ item_type.name }}</option>
                        {% endfor %}
                      </select>
                      <select class="form-control filter-category-select" data-form-index="{{ forloop.counter0 }}">
                        <option value="">{% trans "Category" %}</option>
                        {% for category in item_categories %}
                        <option value="{{ category.id }}" {% if current_category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                      </select>
                      <select class="form-control filter-subcategory-select" data-form-index="{{ forloop.counter0 }}">
                        <option value="">{% trans "Subcategory" %}</option>
                        {% for subcategory in item_subcategories %}
                        <option value="{{ subcategory.id }}" {% if current_subcategory == subcategory.id|stringformat:"s" %}selected{% endif %}>{{ subcategory.name }}</option>
                        {% endfor %}
                      </select>
                      <input type="text" class="form-control filter-search-input" data-form-index="{{ forloop.counter0 }}"
                            placeholder="{% trans 'Search by name or code...' %}"
                            value="{{ current_item_search }}"
                            class="filter-search-input-flex">
                    </div>
                    {% endif %}
                    {{ line_form.item }}
                  </div>
                  {% if line_form.item.errors %}
                    <span class="error">{{ line_form.item.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'warehouse' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.warehouse.label }}{% if line_form.warehouse.field.required %}*{% endif %}</label>
                  {{ line_form.warehouse }}
                  {% if line_form.warehouse.errors %}
                    <span class="error">{{ line_form.warehouse.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'source_warehouse' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.source_warehouse.label }}{% if line_form.source_warehouse.field.required %}*{% endif %}</label>
                  {{ line_form.source_warehouse }}
                  {% if line_form.source_warehouse.errors %}
                    <span class="error">{{ line_form.source_warehouse.errors.0 }}</span>
                  {% endif %}
                  {% if line_form.source_warehouse.help_text %}
                    <small class="form-text text-muted">{{ line_form.source_warehouse.help_text }}</small>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'destination_warehouse' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.destination_warehouse.label }}{% if line_form.destination_warehouse.field.required %}*{% endif %}</label>
                  {{ line_form.destination_warehouse }}
                  {% if line_form.destination_warehouse.errors %}
                    <span class="error">{{ line_form.destination_warehouse.errors.0 }}</span>
                  {% endif %}
                  {% if line_form.destination_warehouse.help_text %}
                    <small class="form-text text-muted">{{ line_form.destination_warehouse.help_text }}</small>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'unit' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit.label }}{% if line_form.unit.field.required %}*{% endif %}</label>
                  {{ line_form.unit }}
                  {% if line_form.unit.errors %}
                    <span class="error">{{ line_form.unit.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'quantity' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.quantity.label }}{% if line_form.quantity.field.required %}*{% endif %}</label>
                  {{ line_form.quantity }}
                  {% if line_form.quantity.errors %}
                    <span class="error">{{ line_form.quantity.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>

              {% if 'supplier' in line_form.fields %}
              <div class="form-row">
                <div class="form-field">
                  <label>{{ line_form.supplier.label }}</label>
                  {{ line_form.supplier }}
                  {% if line_form.supplier.errors %}
                    <span class="error">{{ line_form.supplier.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {% if 'destination_type' in line_form.fields or 'destination_type_choice' in line_form.fields or 'consumption_type' in line_form.fields or 'consignment_receipt' in line_form.fields %}
              <div class="form-row">
                {% if 'destination_type_choice' in line_form.fields %}
                {# Consumption Issue: Show destination type choice first #}
                <div class="form-field">
                  <label>{{ line_form.destination_type_choice.label }}{% if line_form.destination_type_choice.field.required %}*{% endif %}</label>
                  {{ line_form.destination_type_choice }}
                  {% if line_form.destination_type_choice.errors %}
                    <span class="error">{{ line_form.destination_type_choice.errors.0 }}</span>
                  {% endif %}
                  {% if line_form.destination_type_choice.help_text %}
                    <small class="form-text text-muted">{{ line_form.destination_type_choice.help_text }}</small>
                  {% endif %}
                </div>
                
                {% if 'destination_company_unit' in line_form.fields %}
                <div class="form-field destination-company-unit-field hidden">
                  <label>{{ line_form.destination_company_unit.label }}{% if line_form.destination_company_unit.field.required %}*{% endif %}</label>
                  {{ line_form.destination_company_unit }}
                  {% if line_form.destination_company_unit.errors %}
                    <span class="error">{{ line_form.destination_company_unit.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                
                {% if 'destination_work_line' in line_form.fields %}
                <div class="form-field destination-work-line-field hidden">
                  <label>{{ line_form.destination_work_line.label }}{% if line_form.destination_work_line.field.required %}*{% endif %}</label>
                  {{ line_form.destination_work_line }}
                  {% if line_form.destination_work_line.errors %}
                    <span class="error">{{ line_form.destination_work_line.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% endif %}

                {% if 'destination_type' in line_form.fields %}
                {# Permanent/Consignment Issue: Show Work Line directly #}
                <div class="form-field">
                  <label>{{ line_form.destination_type.label }}{% if line_form.destination_type.field.required %}*{% endif %}</label>
                  {{ line_form.destination_type }}
                  {% if line_form.destination_type.errors %}
                    <span class="error">{{ line_form.destination_type.errors.0 }}</span>
                  {% endif %}
                  {% if line_form.destination_type.help_text %}
                    <small class="form-text text-muted">{{ line_form.destination_type.help_text }}</small>
                  {% endif %}
                </div>
                {% endif %}

                {# consumption_type is hidden, managed by destination_type_choice #}

                {% if 'consignment_receipt' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.consignment_receipt.label }}{% if line_form.consignment_receipt.field.required %}*{% endif %}</label>
                  {{ line_form.consignment_receipt }}
                  {% if line_form.consignment_receipt.errors %}
                    <span class="error">{{ line_form.consignment_receipt.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              {# Price fields removed - moved to accounting module #}

              {% if 'expected_receipt_date' in line_form.fields %}
              <div class="form-row">
                <div class="form-field">
                  <label>{{ line_form.expected_receipt_date.label }}</label>
                  {{ line_form.expected_receipt_date }}
                  {% if line_form.expected_receipt_date.errors %}
                    <span class="error">{{ line_form.expected_receipt_date.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {# Stocktaking fields: quantity_expected, quantity_counted, quantity_adjusted #}
              {% if 'quantity_expected' in line_form.fields %}
              <div class="form-row">
                <div class="form-field">
                  <label>{{ line_form.quantity_expected.label }}{% if line_form.quantity_expected.field.required %}*{% endif %}</label>
                  {{ line_form.quantity_expected }}
                  {% if line_form.quantity_expected.errors %}
                    <span class="error">{{ line_form.quantity_expected.errors.0 }}</span>
                  {% endif %}
                </div>
                {% if 'quantity_counted' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.quantity_counted.label }}{% if line_form.quantity_counted.field.required %}*{% endif %}</label>
                  {{ line_form.quantity_counted }}
                  {% if line_form.quantity_counted.errors %}
                    <span class="error">{{ line_form.quantity_counted.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if 'quantity_adjusted' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.quantity_adjusted.label }}{% if line_form.quantity_adjusted.field.required %}*{% endif %}</label>
                  {{ line_form.quantity_adjusted }}
                  {% if line_form.quantity_adjusted.errors %}
                    <span class="error">{{ line_form.quantity_adjusted.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              {# Stocktaking fields: valuation_method, unit_cost, total_cost #}
              {% if 'valuation_method' in line_form.fields or 'unit_cost' in line_form.fields or 'total_cost' in line_form.fields %}
              <div class="form-row">
                {% if 'valuation_method' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.valuation_method.label }}</label>
                  {{ line_form.valuation_method }}
                  {% if line_form.valuation_method.errors %}
                    <span class="error">{{ line_form.valuation_method.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if 'unit_cost' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit_cost.label }}</label>
                  {{ line_form.unit_cost }}
                  {% if line_form.unit_cost.errors %}
                    <span class="error">{{ line_form.unit_cost.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if 'total_cost' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.total_cost.label }}</label>
                  {{ line_form.total_cost }}
                  {% if line_form.total_cost.errors %}
                    <span class="error">{{ line_form.total_cost.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              {# Stocktaking fields: reason_code, investigation_reference #}
              {% if 'reason_code' in line_form.fields or 'investigation_reference' in line_form.fields %}
              <div class="form-row">
                {% if 'reason_code' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.reason_code.label }}</label>
                  {{ line_form.reason_code }}
                  {% if line_form.reason_code.errors %}
                    <span class="error">{{ line_form.reason_code.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if 'investigation_reference' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.investigation_reference.label }}</label>
                  {{ line_form.investigation_reference }}
                  {% if line_form.investigation_reference.errors %}
                    <span class="error">{{ line_form.investigation_reference.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              {% if 'line_notes' in line_form.fields %}
              <div class="form-row">
                <div class="form-field full-width">
                  <label>{{ line_form.line_notes.label }}</label>
                  {{ line_form.line_notes }}
                  {% if line_form.line_notes.errors %}
                    <span class="error">{{ line_form.line_notes.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {% if not document_is_locked and 'issue' in request.path %}
              {# Serial selection for new issue lines (when line doesn't have pk yet) #}
              <div class="form-row">
                <div class="form-field full-width">
                  <div class="serial-assignment-section hidden" data-line-index="{{ forloop.counter0 }}">
                    <button type="button" class="btn btn-sm btn-primary select-serials-btn">
                      {% trans "Select Serials" %}
                    </button>
                    <span class="serial-count">
                      {% trans "Selected:" %} <span class="selected-serials-count">0</span> / {% if line_form.quantity.value %}{{ line_form.quantity.value|floatformat:0 }}{% else %}0{% endif %}
                    </span>
                    <input type="hidden" class="selected-serials-input" name="{{ line_form.prefix }}-selected_serials" value="">
                  </div>
                </div>
              </div>
              {% endif %}

              {% if document_instance and document_instance.pk and line_form.instance.pk %}
                {% with line=line_form.instance %}
                  {% if line.item and line.item.has_lot_tracking == 1 %}
                  <div class="form-row">
                    <div class="form-field full-width">
                      <div class="serial-assignment-section">
                        {% if 'receipt' in request.path %}
                          {% if 'permanent' in request.path %}
                            <a href="{% url 'inventory:receipt_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-info">
                              {% trans "Manage Serials" %}
                            </a>
                          {% elif 'consignment' in request.path %}
                            <a href="{% url 'inventory:receipt_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-info">
                              {% trans "Manage Serials" %}
                            </a>
                          {% endif %}
                          <span class="serial-count">
                            {% trans "Serials:" %} {{ line.serials.count }}
                          </span>
                        {% elif 'issue' in request.path %}
                          {% if 'permanent' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% elif 'consumption' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_consumption_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_consumption_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% elif 'consignment' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% endif %}
                          <span class="serial-count">
                            {% trans "Assigned:" %} {{ line.serials.count }} / 
                            {% if line.quantity %}{{ line.quantity|floatformat:0 }}{% else %}0{% endif %}
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% endif %}
                {% endwith %}
              {% endif %}
            </div>

            {% if line_form.non_field_errors %}
              <div class="error">{{ line_form.non_field_errors|join:", " }}</div>
            {% endif %}
          </div>
            {% endif %}
          {% else %}
            {# Edit mode: show existing lines (with pk) and first empty form if any #}
            {% if line_form.instance.pk %}
              {# Existing line - always show #}
          <div class="line-form" data-form-index="{{ forloop.counter0 }}">
            {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}
            
            <div class="line-header">
              <h4>{% trans "Line" %} {{ forloop.counter }}</h4>
              {% if lines_formset.can_delete %}
              <div class="line-delete">
                <label>{{ line_form.DELETE.label }}</label>
                {{ line_form.DELETE }}
              </div>
              {% endif %}
            </div>

            <div class="line-fields">
              <div class="form-row">
                {% if 'item' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.item.label }}{% if line_form.item.field.required %}*{% endif %}</label>
                  <div class="item-select-wrapper">
                    {% if not document_is_locked %}
                    <div class="item-filters">
                      <select class="form-control filter-type-select" data-form-index="{{ forloop.counter0 }}">
                        <option value="">{% trans "Type" %}</option>
                        {% for item_type in item_types %}
                        <option value="{{ item_type.id }}" {% if current_item_type == item_type.id|stringformat:"s" %}selected{% endif %}>{{ item_type.name }}</option>
                        {% endfor %}
                      </select>
                      <select class="form-control filter-category-select" data-form-index="{{ forloop.counter0 }}">
                        <option value="">{% trans "Category" %}</option>
                        {% for category in item_categories %}
                        <option value="{{ category.id }}" {% if current_category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                      </select>
                      <select class="form-control filter-subcategory-select" data-form-index="{{ forloop.counter0 }}">
                        <option value="">{% trans "Subcategory" %}</option>
                        {% for subcategory in item_subcategories %}
                        <option value="{{ subcategory.id }}" {% if current_subcategory == subcategory.id|stringformat:"s" %}selected{% endif %}>{{ subcategory.name }}</option>
                        {% endfor %}
                      </select>
                      <input type="text" class="form-control filter-search-input" data-form-index="{{ forloop.counter0 }}"
                            placeholder="{% trans 'Search by name or code...' %}"
                            value="{{ current_item_search }}"
                            class="filter-search-input-flex">
                    </div>
                    {% endif %}
                    {{ line_form.item }}
                  </div>
                  {% if line_form.item.errors %}
                    <span class="error">{{ line_form.item.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'warehouse' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.warehouse.label }}{% if line_form.warehouse.field.required %}*{% endif %}</label>
                  {{ line_form.warehouse }}
                  {% if line_form.warehouse.errors %}
                    <span class="error">{{ line_form.warehouse.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'source_warehouse' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.source_warehouse.label }}{% if line_form.source_warehouse.field.required %}*{% endif %}</label>
                  {{ line_form.source_warehouse }}
                  {% if line_form.source_warehouse.errors %}
                    <span class="error">{{ line_form.source_warehouse.errors.0 }}</span>
                  {% endif %}
                  {% if line_form.source_warehouse.help_text %}
                    <small class="form-text text-muted">{{ line_form.source_warehouse.help_text }}</small>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'destination_warehouse' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.destination_warehouse.label }}{% if line_form.destination_warehouse.field.required %}*{% endif %}</label>
                  {{ line_form.destination_warehouse }}
                  {% if line_form.destination_warehouse.errors %}
                    <span class="error">{{ line_form.destination_warehouse.errors.0 }}</span>
                  {% endif %}
                  {% if line_form.destination_warehouse.help_text %}
                    <small class="form-text text-muted">{{ line_form.destination_warehouse.help_text }}</small>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'unit' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit.label }}{% if line_form.unit.field.required %}*{% endif %}</label>
                  {{ line_form.unit }}
                  {% if line_form.unit.errors %}
                    <span class="error">{{ line_form.unit.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'quantity' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.quantity.label }}{% if line_form.quantity.field.required %}*{% endif %}</label>
                  {{ line_form.quantity }}
                  {% if line_form.quantity.errors %}
                    <span class="error">{{ line_form.quantity.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>

              {% if 'supplier' in line_form.fields %}
              <div class="form-row">
                <div class="form-field">
                  <label>{{ line_form.supplier.label }}</label>
                  {{ line_form.supplier }}
                  {% if line_form.supplier.errors %}
                    <span class="error">{{ line_form.supplier.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {# Price fields removed - moved to accounting module #}

              {% if 'expected_receipt_date' in line_form.fields %}
              <div class="form-row">
                <div class="form-field">
                  <label>{{ line_form.expected_receipt_date.label }}</label>
                  {{ line_form.expected_receipt_date }}
                  {% if line_form.expected_receipt_date.errors %}
                    <span class="error">{{ line_form.expected_receipt_date.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {# Stocktaking fields: quantity_expected, quantity_counted, quantity_adjusted #}
              {% if 'quantity_expected' in line_form.fields %}
              <div class="form-row">
                <div class="form-field">
                  <label>{{ line_form.quantity_expected.label }}{% if line_form.quantity_expected.field.required %}*{% endif %}</label>
                  {{ line_form.quantity_expected }}
                  {% if line_form.quantity_expected.errors %}
                    <span class="error">{{ line_form.quantity_expected.errors.0 }}</span>
                  {% endif %}
                </div>
                {% if 'quantity_counted' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.quantity_counted.label }}{% if line_form.quantity_counted.field.required %}*{% endif %}</label>
                  {{ line_form.quantity_counted }}
                  {% if line_form.quantity_counted.errors %}
                    <span class="error">{{ line_form.quantity_counted.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if 'quantity_adjusted' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.quantity_adjusted.label }}{% if line_form.quantity_adjusted.field.required %}*{% endif %}</label>
                  {{ line_form.quantity_adjusted }}
                  {% if line_form.quantity_adjusted.errors %}
                    <span class="error">{{ line_form.quantity_adjusted.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              {# Stocktaking fields: valuation_method, unit_cost, total_cost #}
              {% if 'valuation_method' in line_form.fields or 'unit_cost' in line_form.fields or 'total_cost' in line_form.fields %}
              <div class="form-row">
                {% if 'valuation_method' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.valuation_method.label }}</label>
                  {{ line_form.valuation_method }}
                  {% if line_form.valuation_method.errors %}
                    <span class="error">{{ line_form.valuation_method.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if 'unit_cost' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit_cost.label }}</label>
                  {{ line_form.unit_cost }}
                  {% if line_form.unit_cost.errors %}
                    <span class="error">{{ line_form.unit_cost.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if 'total_cost' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.total_cost.label }}</label>
                  {{ line_form.total_cost }}
                  {% if line_form.total_cost.errors %}
                    <span class="error">{{ line_form.total_cost.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              {# Stocktaking fields: reason_code, investigation_reference #}
              {% if 'reason_code' in line_form.fields or 'investigation_reference' in line_form.fields %}
              <div class="form-row">
                {% if 'reason_code' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.reason_code.label }}</label>
                  {{ line_form.reason_code }}
                  {% if line_form.reason_code.errors %}
                    <span class="error">{{ line_form.reason_code.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if 'investigation_reference' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.investigation_reference.label }}</label>
                  {{ line_form.investigation_reference }}
                  {% if line_form.investigation_reference.errors %}
                    <span class="error">{{ line_form.investigation_reference.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              {% if 'line_notes' in line_form.fields %}
              <div class="form-row">
                <div class="form-field full-width">
                  <label>{{ line_form.line_notes.label }}</label>
                  {{ line_form.line_notes }}
                  {% if line_form.line_notes.errors %}
                    <span class="error">{{ line_form.line_notes.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {% if not document_is_locked and 'issue' in request.path %}
              {# Serial selection for new issue lines (when line doesn't have pk yet) #}
              <div class="form-row">
                <div class="form-field full-width">
                  <div class="serial-assignment-section hidden" data-line-index="{{ forloop.counter0 }}">
                    <button type="button" class="btn btn-sm btn-primary select-serials-btn">
                      {% trans "Select Serials" %}
                    </button>
                    <span class="serial-count">
                      {% trans "Selected:" %} <span class="selected-serials-count">0</span> / {% if line_form.quantity.value %}{{ line_form.quantity.value|floatformat:0 }}{% else %}0{% endif %}
                    </span>
                    <input type="hidden" class="selected-serials-input" name="{{ line_form.prefix }}-selected_serials" value="">
                  </div>
                </div>
              </div>
              {% endif %}

              {% if document_instance and document_instance.pk and line_form.instance.pk %}
                {% with line=line_form.instance %}
                  {% if line.item and line.item.has_lot_tracking == 1 %}
                  <div class="form-row">
                    <div class="form-field full-width">
                      <div class="serial-assignment-section">
                        {% if 'receipt' in request.path %}
                          {% if 'permanent' in request.path %}
                            <a href="{% url 'inventory:receipt_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-info">
                              {% trans "Manage Serials" %}
                            </a>
                          {% elif 'consignment' in request.path %}
                            <a href="{% url 'inventory:receipt_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-info">
                              {% trans "Manage Serials" %}
                            </a>
                          {% endif %}
                          <span class="serial-count">
                            {% trans "Serials:" %} {{ line.serials.count }}
                          </span>
                        {% elif 'issue' in request.path %}
                          {% if 'permanent' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% elif 'consumption' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_consumption_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_consumption_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% elif 'consignment' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% endif %}
                          <span class="serial-count">
                            {% trans "Assigned:" %} {{ line.serials.count }} / 
                            {% if line.quantity %}{{ line.quantity|floatformat:0 }}{% else %}0{% endif %}
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% endif %}
                {% endwith %}
              {% endif %}
            </div>

            {% if line_form.non_field_errors %}
              <div class="error">{{ line_form.non_field_errors|join:", " }}</div>
            {% endif %}
          </div>
            {% elif forloop.counter0 < 1 %}
              {# First empty form in edit mode #}
          <div class="line-form" data-form-index="{{ forloop.counter0 }}">
            {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}
            
            <div class="line-header">
              <h4>{% trans "Line" %} {{ forloop.counter }}</h4>
              {% if lines_formset.can_delete %}
              <div class="line-delete">
                <label>{{ line_form.DELETE.label }}</label>
                {{ line_form.DELETE }}
              </div>
              {% endif %}
            </div>

            <div class="line-fields">
              <div class="form-row">
                {% if 'item' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.item.label }}{% if line_form.item.field.required %}*{% endif %}</label>
                  <div class="item-select-wrapper">
                    {% if not document_is_locked %}
                    <div class="item-filters">
                      <select class="form-control filter-type-select" data-form-index="{{ forloop.counter0 }}">
                        <option value="">{% trans "Type" %}</option>
                        {% for item_type in item_types %}
                        <option value="{{ item_type.id }}" {% if current_item_type == item_type.id|stringformat:"s" %}selected{% endif %}>{{ item_type.name }}</option>
                        {% endfor %}
                      </select>
                      <select class="form-control filter-category-select" data-form-index="{{ forloop.counter0 }}">
                        <option value="">{% trans "Category" %}</option>
                        {% for category in item_categories %}
                        <option value="{{ category.id }}" {% if current_category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                      </select>
                      <select class="form-control filter-subcategory-select" data-form-index="{{ forloop.counter0 }}">
                        <option value="">{% trans "Subcategory" %}</option>
                        {% for subcategory in item_subcategories %}
                        <option value="{{ subcategory.id }}" {% if current_subcategory == subcategory.id|stringformat:"s" %}selected{% endif %}>{{ subcategory.name }}</option>
                        {% endfor %}
                      </select>
                      <input type="text" class="form-control filter-search-input" data-form-index="{{ forloop.counter0 }}"
                            placeholder="{% trans 'Search by name or code...' %}"
                            value="{{ current_item_search }}"
                            class="filter-search-input-flex">
                    </div>
                    {% endif %}
                    {{ line_form.item }}
                  </div>
                  {% if line_form.item.errors %}
                    <span class="error">{{ line_form.item.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'warehouse' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.warehouse.label }}{% if line_form.warehouse.field.required %}*{% endif %}</label>
                  {{ line_form.warehouse }}
                  {% if line_form.warehouse.errors %}
                    <span class="error">{{ line_form.warehouse.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'source_warehouse' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.source_warehouse.label }}{% if line_form.source_warehouse.field.required %}*{% endif %}</label>
                  {{ line_form.source_warehouse }}
                  {% if line_form.source_warehouse.errors %}
                    <span class="error">{{ line_form.source_warehouse.errors.0 }}</span>
                  {% endif %}
                  {% if line_form.source_warehouse.help_text %}
                    <small class="form-text text-muted">{{ line_form.source_warehouse.help_text }}</small>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'destination_warehouse' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.destination_warehouse.label }}{% if line_form.destination_warehouse.field.required %}*{% endif %}</label>
                  {{ line_form.destination_warehouse }}
                  {% if line_form.destination_warehouse.errors %}
                    <span class="error">{{ line_form.destination_warehouse.errors.0 }}</span>
                  {% endif %}
                  {% if line_form.destination_warehouse.help_text %}
                    <small class="form-text text-muted">{{ line_form.destination_warehouse.help_text }}</small>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'unit' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit.label }}{% if line_form.unit.field.required %}*{% endif %}</label>
                  {{ line_form.unit }}
                  {% if line_form.unit.errors %}
                    <span class="error">{{ line_form.unit.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'quantity' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.quantity.label }}{% if line_form.quantity.field.required %}*{% endif %}</label>
                  {{ line_form.quantity }}
                  {% if line_form.quantity.errors %}
                    <span class="error">{{ line_form.quantity.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>

              {% if 'supplier' in line_form.fields %}
              <div class="form-row">
                <div class="form-field">
                  <label>{{ line_form.supplier.label }}</label>
                  {{ line_form.supplier }}
                  {% if line_form.supplier.errors %}
                    <span class="error">{{ line_form.supplier.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {# Price fields removed - moved to accounting module #}

              {% if 'expected_receipt_date' in line_form.fields %}
              <div class="form-row">
                <div class="form-field">
                  <label>{{ line_form.expected_receipt_date.label }}</label>
                  {{ line_form.expected_receipt_date }}
                  {% if line_form.expected_receipt_date.errors %}
                    <span class="error">{{ line_form.expected_receipt_date.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {# Stocktaking fields: quantity_expected, quantity_counted, quantity_adjusted #}
              {% if 'quantity_expected' in line_form.fields %}
              <div class="form-row">
                <div class="form-field">
                  <label>{{ line_form.quantity_expected.label }}{% if line_form.quantity_expected.field.required %}*{% endif %}</label>
                  {{ line_form.quantity_expected }}
                  {% if line_form.quantity_expected.errors %}
                    <span class="error">{{ line_form.quantity_expected.errors.0 }}</span>
                  {% endif %}
                </div>
                {% if 'quantity_counted' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.quantity_counted.label }}{% if line_form.quantity_counted.field.required %}*{% endif %}</label>
                  {{ line_form.quantity_counted }}
                  {% if line_form.quantity_counted.errors %}
                    <span class="error">{{ line_form.quantity_counted.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if 'quantity_adjusted' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.quantity_adjusted.label }}{% if line_form.quantity_adjusted.field.required %}*{% endif %}</label>
                  {{ line_form.quantity_adjusted }}
                  {% if line_form.quantity_adjusted.errors %}
                    <span class="error">{{ line_form.quantity_adjusted.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              {# Stocktaking fields: valuation_method, unit_cost, total_cost #}
              {% if 'valuation_method' in line_form.fields or 'unit_cost' in line_form.fields or 'total_cost' in line_form.fields %}
              <div class="form-row">
                {% if 'valuation_method' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.valuation_method.label }}</label>
                  {{ line_form.valuation_method }}
                  {% if line_form.valuation_method.errors %}
                    <span class="error">{{ line_form.valuation_method.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if 'unit_cost' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit_cost.label }}</label>
                  {{ line_form.unit_cost }}
                  {% if line_form.unit_cost.errors %}
                    <span class="error">{{ line_form.unit_cost.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if 'total_cost' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.total_cost.label }}</label>
                  {{ line_form.total_cost }}
                  {% if line_form.total_cost.errors %}
                    <span class="error">{{ line_form.total_cost.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              {# Stocktaking fields: reason_code, investigation_reference #}
              {% if 'reason_code' in line_form.fields or 'investigation_reference' in line_form.fields %}
              <div class="form-row">
                {% if 'reason_code' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.reason_code.label }}</label>
                  {{ line_form.reason_code }}
                  {% if line_form.reason_code.errors %}
                    <span class="error">{{ line_form.reason_code.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if 'investigation_reference' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.investigation_reference.label }}</label>
                  {{ line_form.investigation_reference }}
                  {% if line_form.investigation_reference.errors %}
                    <span class="error">{{ line_form.investigation_reference.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              {% if 'line_notes' in line_form.fields %}
              <div class="form-row">
                <div class="form-field full-width">
                  <label>{{ line_form.line_notes.label }}</label>
                  {{ line_form.line_notes }}
                  {% if line_form.line_notes.errors %}
                    <span class="error">{{ line_form.line_notes.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {% if not document_is_locked and 'issue' in request.path %}
              {# Serial selection for new issue lines (when line doesn't have pk yet) #}
              <div class="form-row">
                <div class="form-field full-width">
                  <div class="serial-assignment-section hidden" data-line-index="{{ forloop.counter0 }}">
                    <button type="button" class="btn btn-sm btn-primary select-serials-btn">
                      {% trans "Select Serials" %}
                    </button>
                    <span class="serial-count">
                      {% trans "Selected:" %} <span class="selected-serials-count">0</span> / {% if line_form.quantity.value %}{{ line_form.quantity.value|floatformat:0 }}{% else %}0{% endif %}
                    </span>
                    <input type="hidden" class="selected-serials-input" name="{{ line_form.prefix }}-selected_serials" value="">
                  </div>
                </div>
              </div>
              {% endif %}

              {% if document_instance and document_instance.pk and line_form.instance.pk %}
                {% with line=line_form.instance %}
                  {% if line.item and line.item.has_lot_tracking == 1 %}
                  <div class="form-row">
                    <div class="form-field full-width">
                      <div class="serial-assignment-section">
                        {% if 'receipt' in request.path %}
                          {% if 'permanent' in request.path %}
                            <a href="{% url 'inventory:receipt_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-info">
                              {% trans "Manage Serials" %}
                            </a>
                          {% elif 'consignment' in request.path %}
                            <a href="{% url 'inventory:receipt_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-info">
                              {% trans "Manage Serials" %}
                            </a>
                          {% endif %}
                          <span class="serial-count">
                            {% trans "Serials:" %} {{ line.serials.count }}
                          </span>
                        {% elif 'issue' in request.path %}
                          {% if 'permanent' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% elif 'consumption' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_consumption_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_consumption_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% elif 'consignment' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% endif %}
                          <span class="serial-count">
                            {% trans "Assigned:" %} {{ line.serials.count }} / 
                            {% if line.quantity %}{{ line.quantity|floatformat:0 }}{% else %}0{% endif %}
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% endif %}
                {% endwith %}
              {% endif %}
            </div>

            {% if line_form.non_field_errors %}
              <div class="error">{{ line_form.non_field_errors|join:", " }}</div>
            {% endif %}
          </div>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
      
      {% if not document_is_locked %}
      <button type="button" id="add-line-btn" class="btn btn-success btn-add-line">
        <span class="btn-add-line-icon">+</span> {% trans "Add Line" %}
      </button>
      {% endif %}
    </div>
    {% endif %}

    <div class="form-actions">
      {% if document_is_locked %}
      <a href="{{ list_url }}" class="btn btn-secondary">{% trans "Back" %}</a>
      {% else %}
      <button type="submit" class="btn btn-primary">{% trans "Save" %}</button>
      <a href="{{ list_url }}" class="btn btn-secondary">{% trans "Cancel" %}</a>
      {% endif %}
    </div>
  </form>
</div>

<script>
// Disable all form fields if document is locked
/* eslint-disable */
{% if document_is_locked %}
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('receipt-form');
  if (form) {
    // Disable all input, select, and textarea fields
    const fields = form.querySelectorAll('input, select, textarea, button[type="button"]');
    fields.forEach(function(field) {
      if (field.type !== 'hidden' && field.id !== 'add-line-btn') {
        field.disabled = true;
      }
    });
    // Hide delete checkboxes
    const deleteCheckboxes = form.querySelectorAll('input[type="checkbox"][name*="DELETE"]');
    deleteCheckboxes.forEach(function(checkbox) {
      checkbox.disabled = true;
      checkbox.closest('.line-delete')?.style.setProperty('display', 'none', 'important');
    });
    // Hide add line button
    const addLineBtn = document.getElementById('add-line-btn');
    if (addLineBtn) {
      addLineBtn.style.display = 'none';
    }
  }
});
{% endif %}
/* eslint-enable */

// Direct test - attach to button IMMEDIATELY when script loads
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.querySelector('button[type="submit"]');
  if (btn) {
    
    // Force attach a click listener
    btn.addEventListener('click', function(e) {
    }, true);
  } else {
    console.error('Submit button NOT FOUND!');
  }
});
</script>

<style>
.form-container {
  max-width: 960px;
  margin: 2rem auto;
  background: #ffffff;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.1);
}

.entity-form .form-section {
  margin-bottom: 2rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
}

.entity-form .form-section:last-of-type {
  border-bottom: none;
  padding-bottom: 0;
}

.entity-form .form-section h3 {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 1.25rem;
  color: #111827;
}

.entity-form .form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 1.5rem;
}

.entity-form .form-field {
  display: flex;
  flex-direction: column;
}

.entity-form label {
  font-weight: 500;
  margin-bottom: 0.5rem;
  color: #1f2937;
}

.entity-form .form-control,
.entity-form select,
.entity-form textarea,
.entity-form input[type="text"],
.entity-form input[type="number"],
.entity-form input[type="date"],
.entity-form input[type="datetime-local"] {
  width: 100%;
  padding: 0.55rem 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 1rem;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.entity-form .form-control:focus,
.entity-form select:focus,
.entity-form textarea:focus,
.entity-form input[type="text"]:focus,
.entity-form input[type="number"]:focus,
.entity-form input[type="date"]:focus,
.entity-form input[type="datetime-local"]:focus {
  outline: none;
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.entity-form textarea {
  min-height: 100px;
  resize: vertical;
}

.entity-form .form-check-input {
  width: 1.1rem;
  height: 1.1rem;
  cursor: pointer;
}

.entity-form .error {
  margin-top: 0.35rem;
  color: #dc2626;
  font-size: 0.875rem;
}

.entity-form .form-text {
  margin-top: 0.4rem;
  color: #6b7280;
  font-size: 0.875rem;
}

.form-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  padding-top: 1rem;
}

.alert {
  padding: 0.9rem 1.1rem;
  border-radius: 6px;
  margin-bottom: 1.5rem;
}

.alert-success {
  background-color: #dcfce7;
  color: #166534;
  border: 1px solid #bbf7d0;
}

.alert-error {
  background-color: #fee2e2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

.alert-info {
  background-color: #e0f2fe;
  color: #0c4a6e;
  border: 1px solid #bae6fd;
}

.info-banner {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
  padding: 0.85rem 1.25rem;
  border-radius: 8px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(139, 92, 246, 0.12));
  border: 1px solid rgba(59, 130, 246, 0.2);
  color: #1f2937;
  font-weight: 500;
}

.info-banner strong {
  color: #1d4ed8;
}

.lock-status {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.badge {
  display: inline-flex;
  align-items: center;
  padding: 0.2rem 0.55rem;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
}

.badge-locked {
  background-color: #dc2626;
  color: #ffffff;
}

.badge-unlocked {
  background-color: #10b981;
  color: #ffffff;
}

.inline-lock-form {
  display: inline-flex;
  margin: 0;
}

.btn-lock {
  padding: 0.35rem 0.9rem;
  font-size: 0.85rem;
  font-weight: 600;
}

.lines-formset {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  margin-top: 1rem;
}

.line-form {
  padding: 1.5rem;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  background-color: #f9fafb;
  position: relative;
}

.line-form.deleted {
  opacity: 0.5;
  background-color: #fee2e2;
}

.line-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid #e5e7eb;
}

.line-header h4 {
  margin: 0;
  font-size: 1.1rem;
  font-weight: 600;
  color: #1f2937;
}

.line-delete {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.line-delete label {
  margin: 0;
  font-weight: 500;
  color: #dc2626;
}

.line-fields {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.line-fields .form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.line-fields .form-field.full-width {
  grid-column: 1 / -1;
}

.item-select-wrapper {
  width: 100%;
}

.item-filters {
  display: flex;
  gap: 0.4rem;
  margin-bottom: 0.4rem;
  flex-wrap: wrap;
}

.item-filters select,
.item-filters input[type="text"] {
  flex: 1;
  min-width: 80px;
  font-size: 0.7rem;
  padding: 0.3rem 0.4rem;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  background-color: #f9fafb;
  color: #6b7280;
}

.item-filters select:focus,
.item-filters input[type="text"]:focus {
  outline: none;
  border-color: #2563eb;
  background-color: #ffffff;
}

.item-filters input[type="text"] {
  flex: 2;
  min-width: 150px;
}

/* Hide any search inputs that are directly before or after filter selects */
/* Note: This rule is intentionally empty - JavaScript handles the hiding */

/* Hide search inputs that are siblings of filter selects (using adjacent sibling selector) */
.item-filters .filter-type-select + .select-search-input,
.item-filters .filter-category-select + .select-search-input,
.item-filters .filter-subcategory-select + .select-search-input,
.item-filters .select-search-input + .filter-type-select,
.item-filters .select-search-input + .filter-category-select,
.item-filters .select-search-input + .filter-subcategory-select {
  display: none !important;
}

.serial-assignment-section {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem;
  background-color: #f3f4f6;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
}

.serial-assignment-section .btn {
  padding: 0.4rem 0.9rem;
  font-size: 0.875rem;
  font-weight: 500;
  text-decoration: none;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.serial-assignment-section .btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.serial-count {
  font-size: 0.875rem;
  color: #6b7280;
  font-weight: 500;
}

/* Serial Selection Modal Styles */
.serial-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 10000;
}

.serial-modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.serial-modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 10px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
}

.serial-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
}

.serial-modal-header h3 {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
}

.serial-modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: #6b7280;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
}

.serial-modal-close:hover {
  background-color: #f3f4f6;
  color: #374151;
}

.serial-modal-body {
  padding: 1.5rem;
  overflow-y: auto;
  flex: 1;
}

.serial-modal-info {
  margin-bottom: 1rem;
  color: #6b7280;
  font-size: 0.9rem;
}

.serial-checkboxes-container {
  max-height: 400px;
  overflow-y: auto;
}

.serial-checkboxes-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.serial-checkboxes-list li {
  padding: 0.75rem;
  margin: 0.5rem 0;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  transition: background-color 0.2s;
}

.serial-checkboxes-list li:hover {
  background-color: #f9fafb;
}

.serial-checkboxes-list li input[type="checkbox"]:checked + label,
.serial-checkboxes-list li:has(input[type="checkbox"]:checked) {
  background-color: #eff6ff;
  border-color: #2563eb;
}

.serial-checkboxes-list li label {
  display: flex;
  align-items: center;
  cursor: pointer;
  font-weight: normal;
  margin: 0;
  gap: 0.5rem;
  user-select: none;
}

.serial-checkboxes-list li input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #2563eb;
  flex-shrink: 0;
}

.serial-status-badge {
  font-size: 0.75rem;
  color: #f59e0b;
  font-weight: 500;
}

.serial-modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
  padding: 1.5rem;
  border-top: 1px solid #e5e7eb;
}

.serial-modal-footer .btn {
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
  font-weight: 500;
  border-radius: 6px;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
}

.serial-modal-footer .btn-secondary {
  background-color: #f3f4f6;
  color: #374151;
}

.serial-modal-footer .btn-secondary:hover {
  background-color: #e5e7eb;
}

.serial-modal-footer .btn-primary {
  background-color: #2563eb;
  color: white;
}

.serial-modal-footer .btn-primary:hover {
  background-color: #1d4ed8;
}
</style>

<script src="{% static 'js/cascading-dropdowns.js' %}"></script>
<script src="{% static 'js/formset.js' %}"></script>
<script>
// Global error handler
window.addEventListener('error', function(e) {
  console.error('Global JavaScript Error:', e.error);
  console.error('Error message:', e.message);
  console.error('Stack trace:', e.error ? e.error.stack : 'N/A');
});

// Log all form submissions (even if prevented) - CAPTURE PHASE
document.addEventListener('submit', function(e) {
}, true); // Use capture phase

// Also listen in bubble phase
document.addEventListener('submit', function(e) {
}, false); // Bubble phase

console.log('[SCRIPT] Script file loaded, waiting for DOMContentLoaded...');

// Auto-calculate quantity_adjusted for stocktaking forms (defined at global scope for access from addLineBtn handler)
function calculateQuantityAdjusted(lineForm) {
  const quantityExpectedInput = lineForm.querySelector('input[name*="-quantity_expected"]');
  const quantityCountedInput = lineForm.querySelector('input[name*="-quantity_counted"]');
  const quantityAdjustedInput = lineForm.querySelector('input[name*="-quantity_adjusted"]');
  
  if (!quantityExpectedInput || !quantityCountedInput || !quantityAdjustedInput) {
    return; // Not a stocktaking form
  }
  
  const expected = parseFloat(quantityExpectedInput.value) || 0;
  const counted = parseFloat(quantityCountedInput.value) || 0;
  
  // Check if this is deficit or surplus by checking the form title or URL
  const isDeficit = window.location.pathname.includes('deficit');
  const adjusted = isDeficit ? (expected - counted) : (counted - expected);
  
  // Only set if adjusted is non-negative (validation will catch negative values)
  if (adjusted >= 0) {
    quantityAdjustedInput.value = adjusted.toFixed(6);
  } else {
    quantityAdjustedInput.value = '';
  }
}

document.addEventListener('DOMContentLoaded', function() {
  console.log('[DOMContentLoaded] ===== DOMContentLoaded event fired =====');
  
  const formsetContainer = document.getElementById('lines-formset');
  console.log('[DOMContentLoaded] formsetContainer:', formsetContainer);
  const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
  console.log('[DOMContentLoaded] totalFormsInput:', totalFormsInput);
  const addLineBtn = document.getElementById('add-line-btn');
  console.log('[DOMContentLoaded] addLineBtn:', addLineBtn);
  const unitChoicesUrl = '{% url "inventory:item_allowed_units" %}';
  const warehouseChoicesUrl = '{% url "inventory:item_allowed_warehouses" %}';
  const temporaryReceiptDataUrl = '{% url "inventory:temporary_receipt_data" %}';
  console.log('[DOMContentLoaded] URLs - unitChoicesUrl:', unitChoicesUrl, 'warehouseChoicesUrl:', warehouseChoicesUrl);
  
  // Initialize: Disable all unit and warehouse selects that don't have an item selected
  /* eslint-disable */
  {% if not document_is_locked %}
  console.log('[DOMContentLoaded] Initializing unit and warehouse selects...');
  document.querySelectorAll('.line-form').forEach(function(lineForm) {
    const itemSelect = lineForm.querySelector('select[name*="-item"]');
    const unitSelect = lineForm.querySelector('select[name*="-unit"]');
    const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
    const sourceWarehouseSelect = lineForm.querySelector('select[name*="-source_warehouse"]');
    const destinationWarehouseSelect = lineForm.querySelector('select[name*="-destination_warehouse"]');
    
    if (itemSelect && unitSelect) {
      if (!itemSelect.value || itemSelect.value === '') {
        unitSelect.disabled = true;
        const placeholder = unitSelect.querySelector('option[value=""]');
        if (!placeholder || (placeholder && placeholder.textContent.indexOf('Select Item') === -1)) {
          unitSelect.innerHTML = '<option value="">--- {% trans "Select Item First" %} ---</option>';
        }
      }
    }
    
    if (itemSelect && warehouseSelect) {
      if (!itemSelect.value || itemSelect.value === '') {
        warehouseSelect.disabled = true;
        const placeholder = warehouseSelect.querySelector('option[value=""]');
        if (!placeholder || (placeholder && placeholder.textContent.indexOf('Select Item') === -1)) {
          warehouseSelect.innerHTML = '<option value="">--- {% trans "Select Item First" %} ---</option>';
        }
      } else {
        // Item is already selected (edit mode), update warehouses
        console.log('[DOMContentLoaded] Item already selected, updating warehouse choices for item:', itemSelect.value);
        // Save current warehouse value before updating
        const currentWarehouseValue = warehouseSelect.value || warehouseSelect.querySelector('option[selected]')?.value;
        console.log('[DOMContentLoaded] Current warehouse value before update:', currentWarehouseValue);
        // Store it in a data attribute so updateWarehouseChoices can use it
        if (currentWarehouseValue) {
          warehouseSelect.setAttribute('data-initial-value', currentWarehouseValue);
        }
        updateWarehouseChoices(itemSelect, warehouseSelect);
      }
    }
    
    if (itemSelect && sourceWarehouseSelect) {
      if (!itemSelect.value || itemSelect.value === '') {
        sourceWarehouseSelect.disabled = true;
        const placeholder = sourceWarehouseSelect.querySelector('option[value=""]');
        if (!placeholder || (placeholder && placeholder.textContent.indexOf('Select Item') === -1)) {
          sourceWarehouseSelect.innerHTML = '<option value="">--- {% trans "Select Item First" %} ---</option>';
        }
      } else {
        // Item is already selected (edit mode), update source warehouse
        const currentSourceWarehouseValue = sourceWarehouseSelect.value || sourceWarehouseSelect.querySelector('option[selected]')?.value;
        if (currentSourceWarehouseValue) {
          sourceWarehouseSelect.setAttribute('data-initial-value', currentSourceWarehouseValue);
        }
        updateWarehouseChoices(itemSelect, sourceWarehouseSelect);
      }
    }
    
    if (itemSelect && destinationWarehouseSelect) {
      if (!itemSelect.value || itemSelect.value === '') {
        destinationWarehouseSelect.disabled = true;
        const destPlaceholder = destinationWarehouseSelect.querySelector('option[value=""]');
        if (!destPlaceholder || (destPlaceholder && destPlaceholder.textContent.indexOf('Select Item') === -1)) {
          destinationWarehouseSelect.innerHTML = '<option value="">--- {% trans "Select Item First" %} ---</option>';
        }
      } else {
        // Item is already selected (edit mode), update destination warehouse
        const currentDestinationWarehouseValue = destinationWarehouseSelect.value || destinationWarehouseSelect.querySelector('option[selected]')?.value;
        if (currentDestinationWarehouseValue) {
          destinationWarehouseSelect.setAttribute('data-initial-value', currentDestinationWarehouseValue);
        }
        updateWarehouseChoices(itemSelect, destinationWarehouseSelect);
      }
    }
  });
  console.log('[DOMContentLoaded] Unit and warehouse selects initialized');
  {% endif %}
  /* eslint-enable */
  
  // Save selected serials to localStorage before form submission (for error recovery)
  const form = document.getElementById('receipt-form');
  
  if (form) {
    form.addEventListener('submit', function(e) {
      
      // Debug: Log all form data
      const formData = new FormData(form);
      for (let [key, value] of formData.entries()) {
      }
      
      // Check if all required fields in line 1 are filled
      const line0Item = document.querySelector('select[name="lines-0-item"]');
      const line0Warehouse = document.querySelector('select[name="lines-0-warehouse"]');
      const line0Unit = document.querySelector('select[name="lines-0-unit"]');
      const line0Quantity = document.querySelector('input[name="lines-0-quantity"]');
      const line0DestChoice = document.querySelector('select[name*="lines-0-destination_type_choice"]');
      const line0DestType = document.querySelector('select[name*="lines-0-destination_type"]');
      
      // Check if this is a stocktaking form (has quantity_expected field)
      const line0QuantityExpected = document.querySelector('input[name="lines-0-quantity_expected"]');
      const line0QuantityCounted = document.querySelector('input[name="lines-0-quantity_counted"]');
      const line0QuantityAdjusted = document.querySelector('input[name="lines-0-quantity_adjusted"]');
      const isStocktakingForm = !!line0QuantityExpected;
      
      // Check for any empty required fields
      let missingFields = [];
      if (!line0Item || !line0Item.value) missingFields.push('Item');
      if (!line0Warehouse || !line0Warehouse.value) missingFields.push('Warehouse');
      if (!line0Unit || !line0Unit.value) missingFields.push('Unit');
      
      if (isStocktakingForm) {
        // For stocktaking forms, check quantity_expected, quantity_counted, and quantity_adjusted
        if (!line0QuantityExpected || !line0QuantityExpected.value) missingFields.push('Quantity Expected');
        if (!line0QuantityCounted || !line0QuantityCounted.value) missingFields.push('Quantity Counted');
        // quantity_adjusted is auto-calculated, but we should ensure it has a value
        if (line0QuantityAdjusted && (!line0QuantityAdjusted.value || line0QuantityAdjusted.value === '')) {
          // Try to calculate it if expected and counted are available
          if (line0QuantityExpected && line0QuantityExpected.value && line0QuantityCounted && line0QuantityCounted.value) {
            const expected = parseFloat(line0QuantityExpected.value) || 0;
            const counted = parseFloat(line0QuantityCounted.value) || 0;
            // Check if this is deficit or surplus by checking the form title or URL
            const isDeficit = window.location.pathname.includes('deficit');
            const adjusted = isDeficit ? (expected - counted) : (counted - expected);
            if (adjusted >= 0) {
              line0QuantityAdjusted.value = adjusted;
            } else {
              missingFields.push('Quantity Adjusted (calculated value is negative)');
            }
          } else {
            missingFields.push('Quantity Adjusted');
          }
        }
      } else {
        // For regular forms, check quantity
        if (!line0Quantity || !line0Quantity.value) missingFields.push('Quantity');
      }
      
      // Only check destination_type_choice for Consumption Issues (it has destination_type_choice field)
      // For Permanent/Consignment Issues, destination_type is optional
      if (line0DestChoice && !line0DestChoice.value) {
        missingFields.push('Destination Type');
      }
      
      if (missingFields.length > 0) {
        console.error('Missing required fields:', missingFields.join(', '));
        alert('     :\n' + missingFields.join('\n'));
        e.preventDefault();
        return false;
      }
      
      // Make sure all hidden inputs have their values before submit
      document.querySelectorAll('.selected-serials-input').forEach(function(input) {
        if (input.value) {
          localStorage.setItem('selected_serials_' + input.name, input.value);
        } else {
          // If input is empty but localStorage has value, restore it before submit
          const savedValue = localStorage.getItem('selected_serials_' + input.name);
          if (savedValue) {
            input.value = savedValue;
          }
        }
      });
      
    });
    
    // Also attach listener to submit button directly
    const submitButton = form.querySelector('button[type="submit"]');
    if (submitButton) {
      submitButton.addEventListener('click', function(e) {
      });
    }
    
    // Restore selected serials from localStorage after form re-render (for validation errors)
    document.querySelectorAll('.selected-serials-input').forEach(function(input) {
      const savedValue = localStorage.getItem('selected_serials_' + input.name);
      if (savedValue) {
        // Always restore from localStorage if available (even if input has value)
        // This handles the case when form is re-rendered after error
        if (!input.value || input.value === '') {
          input.value = savedValue;
        }
        
        // Update count display
        const lineForm = input.closest('.line-form');
        if (lineForm) {
          const selectedSerialsCount = lineForm.querySelector('.selected-serials-count');
          if (selectedSerialsCount) {
            const serialIds = savedValue.split(',').filter(id => id.trim());
            selectedSerialsCount.textContent = serialIds.length;
          }
        }
      }
    });
    
    // Clear localStorage if form was successfully submitted (redirect happened)
    // Check if we're on a different page (not the form page)
    const currentUrl = window.location.pathname;
    const isFormPage = currentUrl.includes('/create/') || currentUrl.includes('/edit/');
    if (!isFormPage) {
      // Form was successfully submitted, clear saved serials
      Object.keys(localStorage).forEach(function(key) {
        if (key.startsWith('selected_serials_')) {
          localStorage.removeItem(key);
        }
      });
    }
  }
  
  // Handle line formset delete checkboxes
  const deleteCheckboxes = document.querySelectorAll('.line-form input[type="checkbox"][name*="DELETE"]');
  deleteCheckboxes.forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const lineForm = this.closest('.line-form');
      if (this.checked) {
        lineForm.classList.add('deleted');
      } else {
        lineForm.classList.remove('deleted');
      }
    });
  });
  
  // Add search functionality to select fields
  function addSearchToSelect(select) {
    if (select.tagName !== 'SELECT') return;
    // Skip if already wrapped
    if (select.parentNode && select.parentNode.classList && select.parentNode.classList.contains('select-wrapper')) return;
    
    // Skip unit selects (they are dynamically populated and search causes issues)
    if (select.name && select.name.includes('-unit')) return;
    
    // Skip filter selects (type, category, subcategory) - they don't need search box
    // Check by class name
    if (select.classList && (
        select.classList.contains('filter-type-select') ||
        select.classList.contains('filter-category-select') ||
        select.classList.contains('filter-subcategory-select')
    )) return;
    
    // Also check if select is inside .item-filters (skip all selects in item-filters)
    if (select.closest && select.closest('.item-filters')) {
      return; // Skip all selects inside item-filters (including item select)
    }
    
    // Add search input above select
    const wrapper = document.createElement('div');
    wrapper.className = 'select-wrapper';
    wrapper.style.position = 'relative';
    select.parentNode.insertBefore(wrapper, select);
    wrapper.appendChild(select);
    
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'select-search-input';
    searchInput.placeholder = '{% trans "Search..." %}';
    searchInput.style.cssText = 'width: 100%; padding: 0.4rem; margin-bottom: 0.25rem; border: 1px solid #d1d5db; border-radius: 4px;';
    wrapper.insertBefore(searchInput, select);
    
    // Filter options on search
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      Array.from(select.options).forEach(function(option) {
        const text = option.text.toLowerCase();
        option.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  }
  
  // Remove any existing search boxes from filter selects (cleanup)
  function removeSearchBoxesFromFilterSelects() {
    // Find all filter selects
    document.querySelectorAll('.filter-type-select, .filter-category-select, .filter-subcategory-select').forEach(function(select) {
      // Check if this select has a search box wrapper
      const wrapper = select.parentNode;
      if (wrapper && wrapper.classList && wrapper.classList.contains('select-wrapper')) {
        const searchInput = wrapper.querySelector('.select-search-input');
        if (searchInput) {
          // Remove the search input
          searchInput.remove();
          // Unwrap the select (move it back to its original parent)
          const grandParent = wrapper.parentNode;
          if (grandParent) {
            grandParent.insertBefore(select, wrapper);
            wrapper.remove();
          }
        }
      }
      
      // Check if there's a search input right before this select (sibling)
      const previousSibling = select.previousElementSibling;
      if (previousSibling && 
          previousSibling.tagName === 'INPUT' && 
          previousSibling.classList && 
          previousSibling.classList.contains('select-search-input')) {
        previousSibling.remove();
      }
      
      // Check if there's a search input right after this select (sibling)
      const nextSibling = select.nextElementSibling;
      if (nextSibling && 
          nextSibling.tagName === 'INPUT' && 
          nextSibling.classList && 
          nextSibling.classList.contains('select-search-input')) {
        nextSibling.remove();
      }
    });
    
    // Also check all .item-filters sections and remove any search inputs that are near filter selects
    document.querySelectorAll('.item-filters').forEach(function(itemFilters) {
      // Find all search inputs in this item-filters section
      const allSearchInputs = itemFilters.querySelectorAll('.select-search-input');
      allSearchInputs.forEach(function(searchInput) {
        // Check if this search input is near a filter select
        const nextSibling = searchInput.nextElementSibling;
        const previousSibling = searchInput.previousElementSibling;
        
        // If next sibling is a filter select, remove this search input
        if (nextSibling && (
            nextSibling.classList.contains('filter-type-select') ||
            nextSibling.classList.contains('filter-category-select') ||
            nextSibling.classList.contains('filter-subcategory-select')
        )) {
          searchInput.remove();
          return;
        }
        
        // If previous sibling is a filter select, remove this search input
        if (previousSibling && (
            previousSibling.classList.contains('filter-type-select') ||
            previousSibling.classList.contains('filter-category-select') ||
            previousSibling.classList.contains('filter-subcategory-select')
        )) {
          searchInput.remove();
          return;
        }
        
        // Check if this search input is inside a wrapper that contains a filter select
        const wrapper = searchInput.closest('.select-wrapper');
        if (wrapper) {
          const filterSelect = wrapper.querySelector('.filter-type-select, .filter-category-select, .filter-subcategory-select');
          if (filterSelect) {
            searchInput.remove();
            // Also unwrap the select
            const grandParent = wrapper.parentNode;
            if (grandParent) {
              grandParent.insertBefore(filterSelect, wrapper);
              wrapper.remove();
            }
          }
        }
      });
    });
  }
  
  // Clean up any existing search boxes on filter selects (before adding new ones)
  removeSearchBoxesFromFilterSelects();
  
  // Remove search boxes from item selects
  document.querySelectorAll('.item-select-wrapper select[name*="-item"]').forEach(function(select) {
    const wrapper = select.parentNode;
    if (wrapper && wrapper.classList && wrapper.classList.contains('select-wrapper')) {
      const searchInput = wrapper.querySelector('.select-search-input');
      if (searchInput) {
        searchInput.remove();
        // Unwrap the select
        const grandParent = wrapper.parentNode;
        if (grandParent) {
          grandParent.insertBefore(select, wrapper);
          wrapper.remove();
        }
      }
    }
    // Also check for sibling search inputs
    const prevSibling = select.previousElementSibling;
    if (prevSibling && prevSibling.classList && prevSibling.classList.contains('select-search-input')) {
      prevSibling.remove();
    }
  });
  
  // Add search to all select fields in lines (except unit selects and filter selects)
  // Use :not() selector to explicitly exclude filter selects
  // Also exclude selects inside .item-filters (including item select)
  document.querySelectorAll('.line-form select').forEach(function(select) {
    // Skip filter selects
    if (select.classList && (
        select.classList.contains('filter-type-select') ||
        select.classList.contains('filter-category-select') ||
        select.classList.contains('filter-subcategory-select')
    )) return;
    
    // Skip if inside .item-filters (don't add search to item select)
    if (select.closest('.item-filters')) {
      return; // Skip all selects inside item-filters (including item select)
    }
    
    // Skip unit selects
    if (select.name && select.name.includes('-unit')) return;
    
    // Add search to this select
    addSearchToSelect(select);
  });
  
  // Clean up again after adding search boxes (in case any filter selects were processed)
  removeSearchBoxesFromFilterSelects();
  
  // Remove search boxes from item selects
  function removeSearchBoxesFromItemSelects() {
    document.querySelectorAll('.item-select-wrapper select[name*="-item"]').forEach(function(select) {
      const wrapper = select.parentNode;
      if (wrapper && wrapper.classList && wrapper.classList.contains('select-wrapper')) {
        const searchInput = wrapper.querySelector('.select-search-input');
        if (searchInput) {
          searchInput.remove();
          const grandParent = wrapper.parentNode;
          if (grandParent) {
            grandParent.insertBefore(select, wrapper);
            wrapper.remove();
          }
        }
      }
      const prevSibling = select.previousElementSibling;
      if (prevSibling && prevSibling.classList && prevSibling.classList.contains('select-search-input')) {
        prevSibling.remove();
      }
    });
  }
  
  removeSearchBoxesFromItemSelects();
  
  // Also run cleanup after a short delay to catch any dynamically added elements
  setTimeout(function() {
    removeSearchBoxesFromFilterSelects();
    removeSearchBoxesFromItemSelects();
  }, 100);
  
  setTimeout(function() {
    removeSearchBoxesFromFilterSelects();
    removeSearchBoxesFromItemSelects();
  }, 500);
  
  // Run cleanup on any DOM mutations (for dynamically added forms)
  if (typeof MutationObserver !== 'undefined') {
    const observer = new MutationObserver(function(mutations) {
      let shouldCleanup = false;
      mutations.forEach(function(mutation) {
        if (mutation.addedNodes.length > 0) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1) { // Element node
              if (node.classList && (
                  node.classList.contains('filter-type-select') ||
                  node.classList.contains('filter-category-select') ||
                  node.classList.contains('filter-subcategory-select') ||
                  node.querySelector('.filter-type-select') ||
                  node.querySelector('.filter-category-select') ||
                  node.querySelector('.filter-subcategory-select')
              )) {
                shouldCleanup = true;
              }
            }
          });
        }
      });
      if (shouldCleanup) {
        removeSearchBoxesFromFilterSelects();
        removeSearchBoxesFromItemSelects();
      }
    });
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  }
  
  function resetLineFormFields(lineForm, preserveItem) {
    if (!lineForm) return;
    lineForm.classList.remove('deleted');
    lineForm.querySelectorAll('input, textarea').forEach(function(input) {
      if (input.type === 'checkbox') {
        input.checked = false;
      } else if (input.type !== 'hidden') {
        input.value = '';
      } else if (input.name && input.name.endsWith('-id')) {
        input.value = '';
      }
    });
    lineForm.querySelectorAll('select').forEach(function(select) {
      // Don't reset item select if preserveItem is true
      if (preserveItem && select.name && select.name.includes('-item')) {
        return;
      }
      select.selectedIndex = 0;
    });
  }
  
  function updateLineFormIndex(lineForm, index) {
    if (!lineForm) return;
    lineForm.setAttribute('data-form-index', index);
    lineForm.querySelectorAll('[name]').forEach(function(el) {
      if (el.name) {
        el.name = el.name.replace(/lines-(\d+)-/g, `lines-${index}-`);
      }
    });
    lineForm.querySelectorAll('[id]').forEach(function(el) {
      if (el.id) {
        el.id = el.id.replace(/lines-(\d+)-/g, `lines-${index}-`);
      }
    });
    lineForm.querySelectorAll('label[for]').forEach(function(label) {
      if (label.htmlFor) {
        label.htmlFor = label.htmlFor.replace(/lines-(\d+)-/g, `lines-${index}-`);
      }
    });
    const headerTitle = lineForm.querySelector('.line-header h4');
    if (headerTitle) {
      headerTitle.textContent = '{% trans "Line" %} ' + (index + 1);
    }
  }
  
  function setSelectValue(select, value, label) {
    if (!select) return;
    if (value === undefined || value === null || value === '') {
      select.value = '';
      return;
    }
    let option = Array.from(select.options).find(opt => opt.value == value);
    if (!option) {
      option = document.createElement('option');
      option.value = value;
      option.textContent = label || value;
      select.appendChild(option);
    }
    select.value = value;
  }
  
  function populateLineFormFields(lineForm, lineData) {
    if (!lineForm || !lineData) return;
    const itemSelect = lineForm.querySelector('select[name*="-item"]');
    const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
    const unitSelect = lineForm.querySelector('select[name*="-unit"]');
    const quantityInput = lineForm.querySelector('input[name*="-quantity"]');
    const supplierSelect = lineForm.querySelector('select[name*="-supplier"]');
    
    // First, load item options if needed, then set the item
    if (itemSelect && lineData.item_id) {
      const itemLabel = lineData.item_name && lineData.item_code
        ? `${lineData.item_name} (${lineData.item_code})`
        : (lineData.item_name || lineData.item_code || lineData.item_id);
      
      // Set the item value (setSelectValue will add it to options if not exists)
      setSelectValue(itemSelect, lineData.item_id, itemLabel);
      
      // Load units and warehouses
      loadUnitsAndWarehousesForItem(lineForm, lineData);
    } else {
      // If no item, set warehouse and unit directly
      if (warehouseSelect && lineData.warehouse_id) {
        setSelectValue(warehouseSelect, lineData.warehouse_id, lineData.warehouse_name || lineData.warehouse_code || lineData.warehouse_id);
      }
      
      if (unitSelect && (lineData.entered_unit || lineData.unit)) {
        const unitValue = lineData.entered_unit || lineData.unit;
        setSelectValue(unitSelect, unitValue, unitValue);
      }
    }
    
    if (quantityInput) {
      quantityInput.value = lineData.entered_quantity || lineData.quantity || '';
    }
    
    if (supplierSelect && lineData.supplier_id) {
      setSelectValue(supplierSelect, lineData.supplier_id, lineData.supplier_name || lineData.supplier_code || lineData.supplier_id);
    }
  }
  
  function loadUnitsAndWarehousesForItem(lineForm, lineData) {
    if (!lineForm || !lineData || !lineData.item_id) return;
    
    const itemSelect = lineForm.querySelector('select[name*="-item"]');
    const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
    const unitSelect = lineForm.querySelector('select[name*="-unit"]');
    
    const promises = [];
    
    if (unitSelect) {
      promises.push(
        fetch(unitChoicesUrl + '?item_id=' + lineData.item_id)
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              console.error('Error fetching units:', data.error);
              return;
            }
            unitSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
            if (data.units && data.units.length > 0) {
              data.units.forEach(function(unit) {
                const option = document.createElement('option');
                option.value = unit.value;
                option.textContent = unit.label;
                unitSelect.appendChild(option);
              });
            }
            // Set the unit value after loading
            const unitValue = lineData.entered_unit || lineData.unit;
            if (unitValue) {
              setSelectValue(unitSelect, unitValue, unitValue);
            }
          })
          .catch(error => {
            console.error('Error loading units:', error);
          })
      );
    }
    
    if (warehouseSelect) {
      promises.push(
        fetch(warehouseChoicesUrl + '?item_id=' + lineData.item_id)
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              console.error('Error fetching warehouses:', data.error);
              return;
            }
            warehouseSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
            if (data.warehouses && data.warehouses.length > 0) {
              data.warehouses.forEach(function(warehouse) {
                const option = document.createElement('option');
                option.value = warehouse.value;
                option.textContent = warehouse.label;
                warehouseSelect.appendChild(option);
              });
            }
            // Set the warehouse value after loading
            if (lineData.warehouse_id) {
              setSelectValue(warehouseSelect, lineData.warehouse_id, lineData.warehouse_name || lineData.warehouse_code || lineData.warehouse_id);
            }
          })
          .catch(error => {
            console.error('Error loading warehouses:', error);
          })
      );
    }
    
    // Wait for both to complete
    Promise.all(promises).then(() => {
      // Trigger change event after everything is loaded
      if (itemSelect) {
        const changeEvent = new Event('change', { bubbles: true });
        itemSelect.dispatchEvent(changeEvent);
      }
    });
  }
  
  function rebuildLineFormsFromTemporaryReceipt(linesData) {
    if (!lineFormTemplate || !formsetContainer || !totalFormsInput) return;
    if (!Array.isArray(linesData) || !linesData.length) return;
    
    formsetContainer.innerHTML = '';
    
    linesData.forEach(function(lineData, index) {
      const newForm = lineFormTemplate.cloneNode(true);
      resetLineFormFields(newForm);
      updateLineFormIndex(newForm, index);
      populateLineFormFields(newForm, lineData);
      formsetContainer.appendChild(newForm);
    });
    
    totalFormsInput.value = linesData.length;
    initializeLineFormFilters();
    attachItemChangeHandlersToAllLines();
    removeSearchBoxesFromFilterSelects();
    removeSearchBoxesFromItemSelects();
  }
  
  function setupItemSelectHandlers(lineForm) {
    console.log('[setupItemSelectHandlers] Called for lineForm:', lineForm);
    if (!lineForm) {
      console.log('[setupItemSelectHandlers] No lineForm provided');
      return;
    }
    const itemSelect = lineForm.querySelector('select[name*="-item"]');
    if (!itemSelect) {
      console.log('[setupItemSelectHandlers] No itemSelect found');
      return;
    }
    const unitSelect = lineForm.querySelector('select[name*="-unit"]');
    const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
    
    console.log('[setupItemSelectHandlers] Found selects:', {
      itemSelect: itemSelect ? itemSelect.name : 'none',
      unitSelect: unitSelect ? unitSelect.name : 'none',
      warehouseSelect: warehouseSelect ? warehouseSelect.name : 'none',
      itemValue: itemSelect.value
    });
    
    // Check if handlers are already attached (to avoid duplicates)
    // But allow re-attachment if the select element was replaced (e.g., by filterItemsForRow)
    if (itemSelect.dataset.handlersAttached === 'true') {
      console.log('[setupItemSelectHandlers] Handlers already attached, removing flag for re-attachment');
      // Remove the flag and re-attach to ensure handlers work after DOM manipulation
      delete itemSelect.dataset.handlersAttached;
    }
    
    // Use cascading-dropdowns.js for Item  Unit
    if (unitSelect && typeof initCascadingDropdown === 'function') {
      try {
        initCascadingDropdown(itemSelect, unitSelect, unitChoicesUrl, {
          parentField: 'item_id',
          placeholder: '--- {% trans "Select Item First" %} ---',
          valueField: 'value',
          labelField: 'label'
        });
        console.log('[setupItemSelectHandlers] Cascading dropdown initialized for Item  Unit');
      } catch (error) {
        console.error('[setupItemSelectHandlers] Error initializing cascading dropdown for Unit:', error);
        // Fallback to old method if initCascadingDropdown fails
        if (itemSelect.value) {
          updateUnitChoices(itemSelect, unitSelect);
        } else {
          unitSelect.disabled = true;
          const placeholder = unitSelect.querySelector('option[value=""]');
          if (!placeholder || placeholder.textContent.indexOf('Select Item') === -1) {
            unitSelect.innerHTML = '<option value="">--- {% trans "Select Item First" %} ---</option>';
          }
        }
      }
    }
    
    // Use cascading-dropdowns.js for Item  Warehouse
    if (warehouseSelect && typeof initCascadingDropdown === 'function') {
      try {
        initCascadingDropdown(itemSelect, warehouseSelect, warehouseChoicesUrl, {
          parentField: 'item_id',
          placeholder: '--- {% trans "Select Item First" %} ---',
          valueField: 'value',
          labelField: 'label'
        });
        console.log('[setupItemSelectHandlers] Cascading dropdown initialized for Item  Warehouse');
      } catch (error) {
        console.error('[setupItemSelectHandlers] Error initializing cascading dropdown for Warehouse:', error);
        // Fallback to old method if initCascadingDropdown fails
        if (itemSelect.value) {
          updateWarehouseChoices(itemSelect, warehouseSelect);
        } else {
          warehouseSelect.disabled = true;
          const placeholder = warehouseSelect.querySelector('option[value=""]');
          if (!placeholder || placeholder.textContent.indexOf('Select Item') === -1) {
            warehouseSelect.innerHTML = '<option value="">--- {% trans "Select Item First" %} ---</option>';
          }
        }
      }
    }
    
    // Handle source_warehouse and destination_warehouse if they exist
    const sourceWarehouseSelect = lineForm.querySelector('select[name*="-source_warehouse"]');
    const destinationWarehouseSelect = lineForm.querySelector('select[name*="-destination_warehouse"]');
    
    if (sourceWarehouseSelect && typeof initCascadingDropdown === 'function') {
      try {
        initCascadingDropdown(itemSelect, sourceWarehouseSelect, warehouseChoicesUrl, {
          parentField: 'item_id',
          placeholder: '--- {% trans "Select Item First" %} ---',
          valueField: 'value',
          labelField: 'label'
        });
        console.log('[setupItemSelectHandlers] Cascading dropdown initialized for Item  Source Warehouse');
      } catch (error) {
        console.error('[setupItemSelectHandlers] Error initializing cascading dropdown for Source Warehouse:', error);
        if (itemSelect.value) {
          updateWarehouseChoices(itemSelect, sourceWarehouseSelect);
        }
      }
    }
    
    if (destinationWarehouseSelect && typeof initCascadingDropdown === 'function') {
      try {
        initCascadingDropdown(itemSelect, destinationWarehouseSelect, warehouseChoicesUrl, {
          parentField: 'item_id',
          placeholder: '--- {% trans "Select Item First" %} ---',
          valueField: 'value',
          labelField: 'label'
        });
        console.log('[setupItemSelectHandlers] Cascading dropdown initialized for Item  Destination Warehouse');
      } catch (error) {
        console.error('[setupItemSelectHandlers] Error initializing cascading dropdown for Destination Warehouse:', error);
        if (itemSelect.value) {
          updateWarehouseChoices(itemSelect, destinationWarehouseSelect);
        }
      }
    }
    
    // Mark as attached
    itemSelect.dataset.handlersAttached = 'true';
    console.log('[setupItemSelectHandlers] Handlers attached successfully');
  }
  
  function attachItemChangeHandlersToAllLines() {
    console.log('[attachItemChangeHandlersToAllLines] Called');
    const lineForms = document.querySelectorAll('.line-form');
    console.log('[attachItemChangeHandlersToAllLines] Found', lineForms.length, 'line forms');
    lineForms.forEach(function(lineForm, index) {
      console.log('[attachItemChangeHandlersToAllLines] Setting up handlers for line form', index);
      setupItemSelectHandlers(lineForm);
    });
    console.log('[attachItemChangeHandlersToAllLines] Completed');
  }
  
  function getLineForms() {
    if (!formsetContainer) return [];
    return Array.from(formsetContainer.querySelectorAll('.line-form:not(.formset-template)'));
  }
  
  function ensureLineFormCount(count) {
    if (!formsetContainer || !totalFormsInput || !addLineBtn) return [];
    let forms = getLineForms();
    while (forms.length < count) {
      addLineBtn.click();
      forms = getLineForms();
    }
    return forms;
  }
  
  // Initialize a new line form (called after formset.js adds a row)
  function initializeNewLineForm(newForm) {
    if (!newForm) return;
    
    // Clear values
    newForm.querySelectorAll('input[type="text"], input[type="number"], select, textarea').forEach(function(input) {
      if (input.type !== 'checkbox' && input.type !== 'hidden') {
        input.value = '';
      }
    });
    
    // Update line number
    const lineHeader = newForm.querySelector('.line-header h4');
    if (lineHeader) {
      const formIndex = parseInt(newForm.dataset.formIndex) || getLineForms().length;
      lineHeader.textContent = '{% trans "Line" %} ' + (formIndex + 1);
    }
    
    // Reset delete checkbox
    const deleteCheckbox = newForm.querySelector('input[type="checkbox"][name*="DELETE"]');
    if (deleteCheckbox) {
      deleteCheckbox.checked = false;
      newForm.classList.remove('deleted');
      deleteCheckbox.addEventListener('change', function() {
        const lineForm = this.closest('.line-form');
        if (this.checked) {
          lineForm.classList.add('deleted');
        } else {
          lineForm.classList.remove('deleted');
        }
      });
    }
    
    // Setup item change handlers for new form
    setupItemSelectHandlers(newForm);
    
    // Setup quantity_adjusted auto-calculation for stocktaking forms
    const quantityExpectedInput = newForm.querySelector('input[name*="-quantity_expected"]');
    const quantityCountedInput = newForm.querySelector('input[name*="-quantity_counted"]');
    if (quantityExpectedInput) {
      quantityExpectedInput.addEventListener('input', function() {
        calculateQuantityAdjusted(newForm);
      });
      quantityExpectedInput.addEventListener('change', function() {
        calculateQuantityAdjusted(newForm);
      });
    }
    if (quantityCountedInput) {
      quantityCountedInput.addEventListener('input', function() {
        calculateQuantityAdjusted(newForm);
      });
      quantityCountedInput.addEventListener('change', function() {
        calculateQuantityAdjusted(newForm);
      });
    }
    
    // Disable unit and warehouse selects for new form (no item selected yet)
    const newFormUnitSelect = newForm.querySelector('select[name*="-unit"]');
    const newFormWarehouseSelect = newForm.querySelector('select[name*="-warehouse"]');
    const newFormSourceWarehouseSelect = newForm.querySelector('select[name*="-source_warehouse"]');
    const newFormDestinationWarehouseSelect = newForm.querySelector('select[name*="-destination_warehouse"]');
    if (newFormUnitSelect) {
      newFormUnitSelect.disabled = true;
      newFormUnitSelect.innerHTML = '<option value="">--- {% trans "Select Item First" %} ---</option>';
    }
    if (newFormWarehouseSelect) {
      newFormWarehouseSelect.disabled = true;
      newFormWarehouseSelect.innerHTML = '<option value="">--- {% trans "Select Item First" %} ---</option>';
    }
    if (newFormSourceWarehouseSelect) {
      newFormSourceWarehouseSelect.disabled = true;
      newFormSourceWarehouseSelect.innerHTML = '<option value="">--- {% trans "Select Item First" %} ---</option>';
    }
    if (newFormDestinationWarehouseSelect) {
      newFormDestinationWarehouseSelect.disabled = true;
    }
    
    // Setup filters for new form
    const typeSelect = newForm.querySelector('.filter-type-select');
    const categorySelect = newForm.querySelector('.filter-category-select');
    const subcategorySelect = newForm.querySelector('.filter-subcategory-select');
    const searchInput = newForm.querySelector('.filter-search-input');
    
    // Setup filter listeners for new form
    if (typeSelect) {
      typeSelect.addEventListener('change', function() {
        loadCategoriesForRow(newForm, this.value);
      });
    }
    
    if (categorySelect) {
      categorySelect.addEventListener('change', function() {
        loadSubcategoriesForRow(newForm, this.value);
      });
    }
    
    if (subcategorySelect) {
      subcategorySelect.addEventListener('change', function() {
        filterItemsForRow(newForm);
      });
    }
    
    // Setup search input for new form
    if (searchInput) {
      let searchTimeout;
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
          filterItemsForRow(newForm);
        }, 300); // Debounce 300ms
      });
    }
    
    // Initialize filters for new form
    if (typeSelect) {
      loadCategoriesForRow(newForm, typeSelect.value);
    } else {
      // If no type filter, just load all items
      filterItemsForRow(newForm);
    }
    
    // Remove search box from item select if it was added
    const newItemSelect = newForm.querySelector('select[name*="-item"]');
    if (newItemSelect) {
      const wrapper = newItemSelect.parentNode;
      if (wrapper && wrapper.classList && wrapper.classList.contains('select-wrapper')) {
        const searchInput = wrapper.querySelector('.select-search-input');
        if (searchInput) {
          searchInput.remove();
          const grandParent = wrapper.parentNode;
          if (grandParent) {
            grandParent.insertBefore(newItemSelect, wrapper);
            wrapper.remove();
          }
        }
      }
      const prevSibling = newItemSelect.previousElementSibling;
      if (prevSibling && prevSibling.classList && prevSibling.classList.contains('select-search-input')) {
        prevSibling.remove();
      }
    }
    
    // Handle serial button visibility and work lines
    const newWarehouseSelect = newForm.querySelector('select[name*="-warehouse"]');
    
    if (newWarehouseSelect) {
      newWarehouseSelect.addEventListener('change', function() {
        // Update serial button visibility when warehouse changes
        if (typeof updateSerialButtonVisibility === 'function') {
          updateSerialButtonVisibility(newForm);
        }
        
        // Update work lines if destination type is work_line
        const choiceSelect = newForm.querySelector('select[id*="destination_type_choice"]');
        const workLineField = newForm.querySelector('select[id*="destination_work_line"]');
        if (choiceSelect && choiceSelect.value === 'work_line' && workLineField && typeof updateWorkLineChoices === 'function') {
          updateWorkLineChoices(newWarehouseSelect, workLineField);
        }
      });
    }
    
    // Add handler for serial button visibility when item changes
    if (newItemSelect) {
      newItemSelect.addEventListener('change', function() {
        // Update serial button visibility when item changes
        if (typeof updateSerialButtonVisibility === 'function') {
          updateSerialButtonVisibility(newForm);
        }
      });
    }
    
    // Attach serial selection button handler for new form
    const newSelectSerialsBtn = newForm.querySelector('.select-serials-btn');
    if (newSelectSerialsBtn && typeof openSerialModal === 'function') {
      newSelectSerialsBtn.addEventListener('click', function() {
        openSerialModal(newForm);
      });
    }
    
    // Handle destination type choice for new form
    const newChoiceSelect = newForm.querySelector('select[id*="destination_type_choice"]');
    if (newChoiceSelect) {
      const newCompanyUnitField = newForm.querySelector('select[id*="destination_company_unit"]');
      const newCompanyUnitFieldContainer = newCompanyUnitField ? newCompanyUnitField.closest('.destination-company-unit-field') : null;
      const newWorkLineField = newForm.querySelector('select[id*="destination_work_line"]');
      const newWorkLineFieldContainer = newWorkLineField ? newWorkLineField.closest('.destination-work-line-field') : null;
      const newWarehouseSelect = newForm.querySelector('select[name*="-warehouse"]');
      const newConsumptionTypeHidden = newForm.querySelector('input[name*="-consumption_type"]');
      
      function toggleFieldsForNewForm() {
        const value = newChoiceSelect.value;
        
        // Update hidden consumption_type field
        if (newConsumptionTypeHidden) {
          newConsumptionTypeHidden.value = value;
        }
        
        if (newCompanyUnitFieldContainer) {
          newCompanyUnitFieldContainer.style.display = (value === 'company_unit') ? 'block' : 'none';
          if (value !== 'company_unit' && newCompanyUnitField) {
            newCompanyUnitField.value = '';
          }
        }
        if (newWorkLineFieldContainer) {
          newWorkLineFieldContainer.style.display = (value === 'work_line') ? 'block' : 'none';
          if (value !== 'work_line' && newWorkLineField) {
            newWorkLineField.value = '';
          } else if (value === 'work_line' && newWarehouseSelect && newWorkLineField && typeof updateWorkLineChoices === 'function') {
            // When work_line is selected, update work lines based on warehouse
            updateWorkLineChoices(newWarehouseSelect, newWorkLineField);
          }
        }
      }
      
      // Initial toggle
      toggleFieldsForNewForm();
      
      // Add change handler
      newChoiceSelect.addEventListener('change', toggleFieldsForNewForm);
      
      // Update work lines when warehouse changes (only if work_line is selected)
      if (newWarehouseSelect && newWorkLineField) {
        newWarehouseSelect.addEventListener('change', function() {
          if (newChoiceSelect.value === 'work_line' && typeof updateWorkLineChoices === 'function') {
            updateWorkLineChoices(newWarehouseSelect, newWorkLineField);
          }
        });
      }
    }
    
    // Initial check for serial button visibility
    if (typeof updateSerialButtonVisibility === 'function') {
      updateSerialButtonVisibility(newForm);
    }
    
    // Add search to new selects (exclude filter selects explicitly)
    newForm.querySelectorAll('select').forEach(function(select) {
      // Skip filter selects
      if (select.classList && (
          select.classList.contains('filter-type-select') ||
          select.classList.contains('filter-category-select') ||
          select.classList.contains('filter-subcategory-select')
      )) return;
      
      // Skip if inside .item-filters (unless it's the main item select)
      if (select.closest('.item-filters')) {
        if (!select.name || !select.name.includes('-item')) return;
      }
      
      // Skip unit selects
      if (select.name && select.name.includes('-unit')) return;
      
      // Add search to this select
      addSearchToSelect(select);
    });
    
    // Clean up any search boxes from filter selects in new form
    removeSearchBoxesFromFilterSelects();
    
    // Also run cleanup after a short delay for the new form
    setTimeout(function() {
      removeSearchBoxesFromFilterSelects();
    }, 50);
    
    setTimeout(function() {
      removeSearchBoxesFromFilterSelects();
    }, 200);
    
    // Update line numbers for all forms
    getLineForms().forEach(function(lineForm, index) {
      const lineHeader = lineForm.querySelector('.line-header h4');
      if (lineHeader) {
        lineHeader.textContent = '{% trans "Line" %} ' + (index + 1);
      }
    });
  }
  // Update unit choices when item changes
  function updateUnitChoices(itemSelect, unitSelect) {
    
    const itemId = itemSelect.value;
    if (!itemId) {
      console.log('[updateUnitChoices] No itemId, clearing unit select');
      unitSelect.disabled = true;
      unitSelect.innerHTML = '<option value="">--- {% trans "Select Item First" %} ---</option>';
      console.log('[updateUnitChoices] ===== END (no itemId) =====');
      return;
    }
    
    // Enable unit select when item is selected
    unitSelect.disabled = false;
    
    // Show loading state
    unitSelect.disabled = true;
    const currentValue = unitSelect.value;
    unitSelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
    
    const url = unitChoicesUrl + '?item_id=' + itemId;
    
    const fetchStartTime = Date.now();
    fetch(url)
      .then(response => {
        const fetchDuration = Date.now() - fetchStartTime;
        
        if (!response.ok) {
          console.error('[updateUnitChoices] Response not OK, status:', response.status);
          throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          console.error('[updateUnitChoices] Error fetching units:', data.error);
          unitSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
          unitSelect.disabled = false;
          alert('{% trans "Error loading units" %}: ' + data.error);
          return;
        }
        
        const currentValue = unitSelect.value;
        unitSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
        
        if (data.units && data.units.length > 0) {
          console.log('[updateUnitChoices] Adding', data.units.length, 'units to select');
          let hasSelectedValue = false;
          data.units.forEach(function(unit, index) {
            console.log(`[updateUnitChoices]   Unit ${index + 1}: value="${unit.value}", label="${unit.label}"`);
            const option = document.createElement('option');
            option.value = unit.value;
            option.textContent = unit.label;
            if (unit.value === currentValue) {
              option.selected = true;
              hasSelectedValue = true;
            }
            unitSelect.appendChild(option);
          });
          
          // If no value was selected and we have a default unit, select it
          if (!hasSelectedValue && data.default_unit && data.units.length > 0) {
            // Find the option with default_unit value
            for (let i = 0; i < unitSelect.options.length; i++) {
              if (unitSelect.options[i].value === data.default_unit) {
                unitSelect.options[i].selected = true;
                unitSelect.value = data.default_unit;
                break;
              }
            }
          }
        } else {
          // If no units found, at least show default unit
          if (data.default_unit) {
            const option = document.createElement('option');
            option.value = data.default_unit;
            // Try to get label from UNIT_CHOICES
            const labelMap = {
              'EA': ' (EA)',
              'KG': ' (KG)',
              'BOX': ' (BOX)',
              'CARTON': ''
            };
            option.textContent = labelMap[data.default_unit] || data.default_unit;
            if (data.default_unit === currentValue) {
              option.selected = true;
            }
            unitSelect.appendChild(option);
          }
        }
        
        unitSelect.disabled = false;
        
        // Trigger change event to update any UI components
        const changeEvent = new Event('change', { bubbles: true });
        unitSelect.dispatchEvent(changeEvent);
      })
      .catch(error => {
        console.error('[updateUnitChoices] Error:', error.message);
        unitSelect.disabled = true;
        unitSelect.innerHTML = '<option value="">--- {% trans "Select Item First" %} ---</option>';
        alert('{% trans "Error loading units. Please try again." %}: ' + error.message);
      });
  }
  
  // Update warehouse choices when item changes
  function updateWarehouseChoices(itemSelect, warehouseSelect) {
    
    const itemId = itemSelect.value;
    if (!itemId) {
      console.log('[updateWarehouseChoices] No itemId, clearing warehouse select');
      // If no item selected, disable and clear
      warehouseSelect.disabled = true;
      warehouseSelect.innerHTML = '<option value="">--- {% trans "Select Item First" %} ---</option>';
      console.log('[updateWarehouseChoices] ===== END (no itemId) =====');
      return;
    }
    
    // Enable warehouse select when item is selected
    warehouseSelect.disabled = false;
    
    // Show loading state
    warehouseSelect.disabled = true;
    
    // Get current value from multiple sources
    let currentValue = warehouseSelect.value;
    if (!currentValue) {
      // Try to find selected option
      const selectedOption = warehouseSelect.querySelector('option[selected]');
      if (selectedOption) {
        currentValue = selectedOption.value;
      }
    }
    // Also check if there's a value attribute on the select itself (from Django form)
    if (!currentValue && warehouseSelect.hasAttribute('data-initial-value')) {
      currentValue = warehouseSelect.getAttribute('data-initial-value');
    }
    
    warehouseSelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
    
    const url = warehouseChoicesUrl + '?item_id=' + itemId;
    
    const fetchStartTime = Date.now();
    fetch(url)
      .then(response => {
        const fetchDuration = Date.now() - fetchStartTime;
        
        if (!response.ok) {
          console.error('[updateWarehouseChoices] Response not OK, status:', response.status);
          throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          console.error('[updateWarehouseChoices] Error fetching warehouses:', data.error);
          warehouseSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
          warehouseSelect.disabled = false;
          alert('{% trans "Error loading warehouses" %}: ' + data.error);
          return;
        }
        
        warehouseSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
        
        if (data.warehouses && data.warehouses.length > 0) {
          data.warehouses.forEach(function(warehouse, index) {
            const option = document.createElement('option');
            option.value = warehouse.value;
            option.textContent = warehouse.label;
            if (warehouse.value == currentValue || warehouse.value === currentValue) {
              option.selected = true;
            }
            warehouseSelect.appendChild(option);
          });
          
          // After adding all options, explicitly set the value if currentValue exists
          if (currentValue) {
            const matchingOption = Array.from(warehouseSelect.options).find(opt => opt.value == currentValue || opt.value === currentValue);
            if (matchingOption) {
              warehouseSelect.value = matchingOption.value;
            } else {
            }
          } else {
            // If no currentValue, check if there's a data-initial-value attribute
            const initialValue = warehouseSelect.getAttribute('data-initial-value');
            if (initialValue) {
              const matchingOption = Array.from(warehouseSelect.options).find(opt => opt.value == initialValue || opt.value === initialValue);
              if (matchingOption) {
                warehouseSelect.value = matchingOption.value;
              }
            }
          }
        } else {
        }
        
        warehouseSelect.disabled = false;
      })
      .catch(error => {
        console.error('[updateWarehouseChoices] Error:', error.message);
        console.error('[updateWarehouseChoices] Error stack:', error.stack);
        warehouseSelect.disabled = true;
        warehouseSelect.innerHTML = '<option value="">--- {% trans "Select Item First" %} ---</option>';
        alert('{% trans "Error loading warehouses. Please try again." %}: ' + error.message);
        console.log('[updateWarehouseChoices] ===== END (error) =====');
      });
  }
  
  // Filter items for a specific row based on type, category, subcategory, and search
  // Returns a Promise that resolves when items are loaded
  function filterItemsForRow(rowElement, includeItemId) {
    if (!rowElement) return Promise.resolve();
    
    const typeSelect = rowElement.querySelector('.filter-type-select');
    const categorySelect = rowElement.querySelector('.filter-category-select');
    const subcategorySelect = rowElement.querySelector('.filter-subcategory-select');
    const searchInput = rowElement.querySelector('.filter-search-input');
    const itemSelect = rowElement.querySelector('select[name*="-item"]');
    
    if (!itemSelect) return Promise.resolve();
    
    const typeId = typeSelect?.value || '';
    const categoryId = categorySelect?.value || '';
    const subcategoryId = subcategorySelect?.value || '';
    let searchTerm = searchInput?.value?.trim() || '';
    
    // Fix: If searchTerm is "None" (string), treat it as empty
    if (searchTerm === 'None' || searchTerm === 'none') {
      searchTerm = '';
    }
    
    // Build API URL
    let apiUrl = '/inventory/api/filtered-items/';
    const params = new URLSearchParams();
    if (typeId) params.append('type_id', typeId);
    if (categoryId) params.append('category_id', categoryId);
    if (subcategoryId) params.append('subcategory_id', subcategoryId);
    if (searchTerm) params.append('search', searchTerm);
    
    // If item is already selected or provided as parameter, include it in the API call
    const currentValue = includeItemId || itemSelect.value;
    if (currentValue) {
      params.append('include_item_id', currentValue);
    }
    
    // Always add params to URL (even if empty, API will return all items)
    if (params.toString()) {
      apiUrl += '?' + params.toString();
    }
    // If no params at all, still call API to get all items
    
    // Fetch filtered items (or all items if no filters)
    return fetch(apiUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        if (data.items) {
          const itemMap = {};
          data.items.forEach(function(item) {
            itemMap[item.value] = item;
          });
          
          // Save current value and label BEFORE clearing
          const currentValue = itemSelect.value;
          let currentLabel = '';
          if (currentValue) {
            const currentOption = Array.from(itemSelect.options).find(opt => opt.value == currentValue);
            if (currentOption) {
              currentLabel = currentOption.textContent;
            }
          }
          
          // Clear all options
          itemSelect.innerHTML = '';
          
          // Add placeholder
          const emptyOption = document.createElement('option');
          emptyOption.value = '';
          emptyOption.textContent = '---   ---';
          itemSelect.appendChild(emptyOption);
          
          // If current value exists and is not in filtered list, add it first (preserve existing selection)
          if (currentValue && !itemMap[currentValue]) {
            const preservedOption = document.createElement('option');
            preservedOption.value = currentValue;
            preservedOption.textContent = currentLabel || currentValue;
            preservedOption.selected = true;
            itemSelect.appendChild(preservedOption);
          }
          
          // Add filtered items
          data.items.forEach(function(item) {
            // Skip if this item is already added (preserved current value)
            if (currentValue && item.value == currentValue) {
              return;
            }
            const option = document.createElement('option');
            option.value = item.value;
            option.textContent = item.label;
            itemSelect.appendChild(option);
          });
          
          
          // Restore current value if it's in filtered list
          if (currentValue && itemMap[currentValue]) {
            itemSelect.value = currentValue;
          }
        } else {
          // At least show placeholder
          itemSelect.innerHTML = '<option value="">---   ---</option>';
        }
        
        // Re-attach event handlers after replacing the select options
        // This is necessary because innerHTML = '' removes event listeners
        const lineForm = rowElement.closest('.line-form');
        if (lineForm) {
          // Use setTimeout to ensure DOM is fully updated before re-attaching handlers
          setTimeout(function() {
            setupItemSelectHandlers(lineForm);
            
            // Manually update units and warehouses if item is selected
            const freshItemSelect = lineForm.querySelector('select[name*="-item"]');
            if (freshItemSelect && freshItemSelect.value) {
              const freshUnitSelect = lineForm.querySelector('select[name*="-unit"]');
              const freshWarehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
              if (freshUnitSelect) {
                updateUnitChoices(freshItemSelect, freshUnitSelect);
              }
              if (freshWarehouseSelect) {
                updateWarehouseChoices(freshItemSelect, freshWarehouseSelect);
              }
              // Also dispatch change event for any other listeners
              const changeEvent = new Event('change', { bubbles: true });
              freshItemSelect.dispatchEvent(changeEvent);
            } else {
            }
          }, 10); // Small delay to ensure DOM is updated
        } else {
        }
      })
      .catch(error => {
        console.error('[filterItemsForRow] Error filtering items:', error);
        console.error('[filterItemsForRow] Error details:', error.message, error.stack);
        // Show placeholder on error
        itemSelect.innerHTML = '<option value="">---   ---</option>';
        alert('    : ' + error.message);
        // Re-throw error so caller can handle it
        throw error;
      });
  }

  // Load categories for a specific row based on type
  function loadCategoriesForRow(rowElement, typeId) {
    if (!rowElement) return;
    
    const categorySelect = rowElement.querySelector('.filter-category-select');
    const subcategorySelect = rowElement.querySelector('.filter-subcategory-select');
    
    if (!categorySelect) return;
    
    categorySelect.innerHTML = '<option value="">{% trans "All Categories" %}</option>';
    if (subcategorySelect) {
      subcategorySelect.innerHTML = '<option value="">{% trans "All Subcategories" %}</option>';
    }
    
    if (!typeId) {
      // Load all categories
      fetch('/inventory/api/filtered-categories/')
        .then(response => response.json())
        .then(data => {
          if (data.categories) {
            data.categories.forEach(function(cat) {
              const option = document.createElement("option");
              option.value = cat.value;
              option.textContent = cat.label;
              categorySelect.appendChild(option);
            });
          }
          // Filter items after loading categories
          filterItemsForRow(rowElement);
        });
      return;
    }
    
    fetch(`/inventory/api/filtered-categories/?type_id=${typeId}`)
      .then(response => response.json())
      .then(data => {
        if (data.categories) {
          data.categories.forEach(function(cat) {
            const option = document.createElement("option");
            option.value = cat.value;
            option.textContent = cat.label;
            categorySelect.appendChild(option);
          });
        }
        // Filter items after loading categories
        filterItemsForRow(rowElement);
      });
  }

  // Load subcategories for a specific row based on category
  function loadSubcategoriesForRow(rowElement, categoryId) {
    if (!rowElement) return;
    
    const subcategorySelect = rowElement.querySelector('.filter-subcategory-select');
    if (!subcategorySelect) return;
    
    subcategorySelect.innerHTML = '<option value="">{% trans "All Subcategories" %}</option>';
    
    if (!categoryId) {
      // Filter items after clearing subcategory
      filterItemsForRow(rowElement);
      return;
    }
    
    fetch(`/inventory/api/filtered-subcategories/?category_id=${categoryId}`)
      .then(response => response.json())
      .then(data => {
        if (data.subcategories) {
          data.subcategories.forEach(function(sub) {
            const option = document.createElement("option");
            option.value = sub.value;
            option.textContent = sub.label;
            subcategorySelect.appendChild(option);
          });
        }
        // Filter items after loading subcategories
        filterItemsForRow(rowElement);
      });
  }

  // Initialize filters for all line forms
  function initializeLineFormFilters() {
    // Don't initialize if document is locked (view mode)
    /* eslint-disable */
    {% if document_is_locked %}
    return;
    {% endif %}
    /* eslint-enable */
    
    console.log('[initializeLineFormFilters] Starting initialization...');
    const lineForms = document.querySelectorAll('.line-form');
    console.log('[initializeLineFormFilters] Found', lineForms.length, 'line forms');
    lineForms.forEach(function(lineForm, index) {
      console.log('[initializeLineFormFilters] Processing line form', index);
      const typeSelect = lineForm.querySelector('.filter-type-select');
      const categorySelect = lineForm.querySelector('.filter-category-select');
      const subcategorySelect = lineForm.querySelector('.filter-subcategory-select');
      const searchInput = lineForm.querySelector('.filter-search-input');
      const itemSelect = lineForm.querySelector('select[name*="-item"]');
      
      // Setup type filter
      if (typeSelect) {
        typeSelect.addEventListener('change', function() {
          loadCategoriesForRow(lineForm, this.value);
        });
      }
      
      // Setup category filter
      if (categorySelect) {
        categorySelect.addEventListener('change', function() {
          loadSubcategoriesForRow(lineForm, this.value);
        });
      }
      
      // Setup subcategory filter
      if (subcategorySelect) {
        subcategorySelect.addEventListener('change', function() {
          filterItemsForRow(lineForm);
        });
      }
      
      // Setup search input with debounce
      if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(function() {
            filterItemsForRow(lineForm);
          }, 300); // Debounce 300ms
        });
      }
      
      // Initialize filters - load all categories initially and filter items
      // itemSelect is already defined above (line 2730), so we reuse it
      const hasExistingItem = itemSelect && itemSelect.value && itemSelect.value !== '';
      const hasOptions = itemSelect && itemSelect.options.length > 1; // More than just placeholder
      
      // Fix: Clear "None" value from search input if it exists
      if (searchInput && searchInput.value === 'None') {
        console.log('[initializeLineFormFilters] Line', index, '- Clearing "None" value from search input');
        searchInput.value = '';
      }
      
      // If item is selected but options are not loaded (only placeholder), we need to load items
      // to preserve the selection properly
      if (hasExistingItem && !hasOptions) {
        console.log('[initializeLineFormFilters] Line', index, '- Item selected but options not loaded, loading items');
        // Item is selected but options are not loaded - load all items to preserve selection
        if (typeSelect) {
          loadCategoriesForRow(lineForm, typeSelect.value);
        } else {
          filterItemsForRow(lineForm);
        }
      } else if (!hasExistingItem) {
        console.log('[initializeLineFormFilters] Line', index, '- No item selected, normal initialization');
        // No item selected - normal initialization
        if (typeSelect) {
          loadCategoriesForRow(lineForm, typeSelect.value);
        } else {
          filterItemsForRow(lineForm);
        }
      } else {
        console.log('[initializeLineFormFilters] Line', index, '- Item selected AND options loaded, skipping filter');
        // Even if item is selected and options are loaded, we still need to update units and warehouses
        // This will be done by attachItemChangeHandlersToAllLines which is called after this function
      }
      // If item is selected AND options are loaded, don't filter (preserve existing selection)
    });
    console.log('[initializeLineFormFilters] Initialization completed');
  }

  // Initialize filters for all existing line forms
  // BUT: Don't initialize filters if document is locked (view mode)
  /* eslint-disable */
  {% if not document_is_locked %}
  console.log('[Initialization] Starting initialization...');
  initializeLineFormFilters();
  console.log('[Initialization] Filters initialized, attaching item change handlers...');
  attachItemChangeHandlersToAllLines();
  
  // Use event delegation on formsetContainer to handle item changes
  // This ensures handlers work even if DOM is replaced
  console.log('[Initialization] Checking formsetContainer...', formsetContainer);
  if (formsetContainer) {
    console.log('[Initialization] formsetContainer found, setting up event delegation for item changes...');
    formsetContainer.addEventListener('change', function(e) {
      console.log('[Event Delegation] Change event detected on:', e.target);
      console.log('[Event Delegation] tagName:', e.target ? e.target.tagName : 'N/A', 'name:', e.target ? e.target.name : 'N/A');
      const target = e.target;
      if (target && target.tagName === 'SELECT' && target.name && target.name.includes('-item')) {
        console.log('[Event Delegation] Item change detected on:', target.name, 'value:', target.value);
        const lineForm = target.closest('.line-form');
        if (lineForm) {
          console.log('[Event Delegation] Found lineForm, updating units and warehouses...');
          const unitSelect = lineForm.querySelector('select[name*="-unit"]');
          const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
          const sourceWarehouseSelect = lineForm.querySelector('select[name*="-source_warehouse"]');
          const destinationWarehouseSelect = lineForm.querySelector('select[name*="-destination_warehouse"]');
          if (unitSelect) {
            console.log('[Event Delegation] Calling updateUnitChoices');
            updateUnitChoices(target, unitSelect);
          }
          if (warehouseSelect) {
            console.log('[Event Delegation] Calling updateWarehouseChoices');
            updateWarehouseChoices(target, warehouseSelect);
          }
          if (sourceWarehouseSelect) {
            console.log('[Event Delegation] Calling updateWarehouseChoices for source_warehouse');
            updateWarehouseChoices(target, sourceWarehouseSelect);
          }
          if (destinationWarehouseSelect) {
            console.log('[Event Delegation] Calling updateWarehouseChoices for destination_warehouse');
            updateWarehouseChoices(target, destinationWarehouseSelect);
          }
        } else {
          console.error('[Event Delegation] Could not find lineForm for item select:', target.name);
        }
      } else {
        console.log('[Event Delegation] Change event is not for item select. Target:', target);
        console.log('[Event Delegation] tagName:', target ? target.tagName : 'N/A', 'name:', target ? target.name : 'N/A');
      }
    });
    console.log('[Initialization] Event delegation set up successfully');
  } else {
    console.error('[Initialization] formsetContainer NOT FOUND! Event delegation cannot be set up.');
  }
  
  // After attaching handlers, ensure units and warehouses are updated for any pre-selected items
  // This is important for edit mode where items are already selected
  console.log('[Initialization] Ensuring units and warehouses are updated for pre-selected items...');
  document.querySelectorAll('.line-form').forEach(function(lineForm) {
    const itemSelect = lineForm.querySelector('select[name*="-item"]');
    if (itemSelect && itemSelect.value) {
      console.log('[Initialization] Found pre-selected item:', itemSelect.value, 'in form:', itemSelect.name);
      const unitSelect = lineForm.querySelector('select[name*="-unit"]');
      const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
      if (unitSelect) {
        console.log('[Initialization] Updating unit choices for pre-selected item');
        updateUnitChoices(itemSelect, unitSelect);
      }
      if (warehouseSelect) {
        console.log('[Initialization] Updating warehouse choices for pre-selected item');
        // Save current warehouse value before updating
        const currentWarehouseValue = warehouseSelect.value || warehouseSelect.querySelector('option[selected]')?.value;
        console.log('[Initialization] Current warehouse value before update:', currentWarehouseValue);
        // Store it in a data attribute so updateWarehouseChoices can use it
        if (currentWarehouseValue) {
          warehouseSelect.setAttribute('data-initial-value', currentWarehouseValue);
        }
        updateWarehouseChoices(itemSelect, warehouseSelect);
      }
      const sourceWarehouseSelect = lineForm.querySelector('select[name*="-source_warehouse"]');
      const destinationWarehouseSelect = lineForm.querySelector('select[name*="-destination_warehouse"]');
      if (sourceWarehouseSelect) {
        console.log('[Initialization] Updating source warehouse choices for pre-selected item');
        const currentSourceWarehouseValue = sourceWarehouseSelect.value || sourceWarehouseSelect.querySelector('option[selected]')?.value;
        if (currentSourceWarehouseValue) {
          sourceWarehouseSelect.setAttribute('data-initial-value', currentSourceWarehouseValue);
        }
        updateWarehouseChoices(itemSelect, sourceWarehouseSelect);
      }
      if (destinationWarehouseSelect) {
        const currentDestinationWarehouseValue = destinationWarehouseSelect.value || destinationWarehouseSelect.querySelector('option[selected]')?.value;
        if (currentDestinationWarehouseValue) {
          destinationWarehouseSelect.setAttribute('data-initial-value', currentDestinationWarehouseValue);
        }
        updateWarehouseChoices(itemSelect, destinationWarehouseSelect);
      }
    }
    
    // Also ensure setupItemSelectHandlers is called for all existing forms
    if (itemSelect) {
      const unitSelect = lineForm.querySelector('select[name*="-unit"]');
      const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
      if (unitSelect || warehouseSelect) {
        console.log('[Initialization] Setting up item select handlers for existing form');
        setupItemSelectHandlers(lineForm);
      }
    }
  });
  
  console.log('[Initialization] Initialization completed');
  {% endif %}
  /* eslint-enable */
  
  // Attach item change handlers for single-line forms (like ReceiptTemporary)
  // Handle forms without lines_formset (single-line forms)
  const singleItemSelect = document.querySelector('select[name="item"]:not([name*="-"])');
  if (singleItemSelect) {
    // Make sure we're not inside a line-form (to avoid duplicates)
    if (!singleItemSelect.closest('.line-form')) {
      const singleUnitSelect = document.querySelector('select[name="unit"]:not([name*="-"])');
      const singleWarehouseSelect = document.querySelector('select[name="warehouse"]:not([name*="-"])');
      
      if (singleUnitSelect && !singleUnitSelect.closest('.line-form')) {
        // Load units if item is already selected (for edit mode)
        if (singleItemSelect.value) {
          updateUnitChoices(singleItemSelect, singleUnitSelect);
        }
        
        // Attach change handler
        singleItemSelect.addEventListener('change', function() {
          updateUnitChoices(singleItemSelect, singleUnitSelect);
        });
      }
      
      // Handle warehouse filtering for single-line forms
      if (singleWarehouseSelect && !singleWarehouseSelect.closest('.line-form')) {
        // Load allowed warehouses if item is already selected (for edit mode)
        if (singleItemSelect.value) {
          updateWarehouseChoices(singleItemSelect, singleWarehouseSelect);
        }
        
        // Attach change handler for warehouse filtering
        singleItemSelect.addEventListener('change', function() {
          updateWarehouseChoices(singleItemSelect, singleWarehouseSelect);
        });
      }
    }
  }
  
  // Handle temporary_receipt auto-fill for permanent receipts
  const temporaryReceiptSelect = document.querySelector('select[name="temporary_receipt"]');
  if (temporaryReceiptSelect && formsetContainer && totalFormsInput && addLineBtn) {
    temporaryReceiptSelect.addEventListener('change', function() {
      const tempReceiptId = this.value;
      
      if (!tempReceiptId) {
        // Clear all lines if no temporary receipt selected
        const forms = getLineForms();
        forms.forEach(function(lineForm, index) {
          if (index > 0) {
            // Keep first form, remove others
            const deleteCheckbox = lineForm.querySelector('input[type="checkbox"][name*="DELETE"]');
            if (deleteCheckbox) {
              deleteCheckbox.checked = true;
              lineForm.classList.add('deleted');
            }
          } else {
            // Reset first form
            resetLineFormFields(lineForm);
            const deleteCheckbox = lineForm.querySelector('input[type="checkbox"][name*="DELETE"]');
            if (deleteCheckbox) {
              deleteCheckbox.checked = false;
              lineForm.classList.remove('deleted');
            }
          }
        });
        totalFormsInput.value = 1;
        totalFormsInput.setAttribute('value', 1);
        
        // Clear header supplier
        const headerSupplierField = document.querySelector('select[name="supplier"]');
        if (headerSupplierField) {
          headerSupplierField.value = '';
        }
        return;
      }
      
      
      // Fetch temporary receipt data
      fetch(temporaryReceiptDataUrl + '?temporary_receipt_id=' + tempReceiptId)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error('Error fetching temporary receipt data:', data.error);
            // Use message if available, otherwise use error
            const errorMessage = data.message || data.error;
            alert('     : ' + errorMessage);
            // Clear the selection
            temporaryReceiptSelect.value = '';
            return;
          }
          
          
          const headerSupplierField = document.querySelector('select[name="supplier"]');
          if (headerSupplierField && data.supplier_id) {
            setSelectValue(headerSupplierField, data.supplier_id, data.supplier_name || data.supplier_code || data.supplier_id);
          }
          
          let linesData = Array.isArray(data.lines) && data.lines.length ? data.lines : [{
            item_id: data.item_id,
            item_code: data.item_code,
            item_name: data.item_name,
            warehouse_id: data.warehouse_id,
            warehouse_code: data.warehouse_code,
            warehouse_name: data.warehouse_name,
            quantity: data.quantity,
            entered_quantity: data.entered_quantity,
            unit: data.unit,
            entered_unit: data.entered_unit,
          }];
          
          linesData = linesData.map(function(line) {
            return Object.assign({}, line, {
              supplier_id: line.supplier_id || data.supplier_id || null,
              supplier_code: line.supplier_code || data.supplier_code || null,
              supplier_name: line.supplier_name || data.supplier_name || null,
            });
          });
          
          // Clear existing lines before adding new ones
          const existingForms = getLineForms();
          existingForms.forEach(function(lineForm, index) {
            resetLineFormFields(lineForm, false);
            const deleteCheckbox = lineForm.querySelector('input[type="checkbox"][name*="DELETE"]');
            if (deleteCheckbox) {
              deleteCheckbox.checked = false;
              lineForm.classList.remove('deleted');
            }
          });
          
          const forms = ensureLineFormCount(linesData.length || 1);
          
          // First, update form indices to ensure correct formset indices
          forms.forEach(function(lineForm, index) {
            updateLineFormIndex(lineForm, index);
          });
          
          // Then, load items for all forms that need data
          const loadPromises = forms.map(function(lineForm, index) {
            if (index < linesData.length && linesData[index].item_id) {
              const lineData = linesData[index];
              const itemSelect = lineForm.querySelector('select[name*="-item"]');
              
              if (itemSelect) {
                // Load items for this row first (with include_item_id to preserve the item)
                // filterItemsForRow now returns a Promise
                return filterItemsForRow(lineForm, lineData.item_id).then(function() {
                  // Wait a bit for the setTimeout in filterItemsForRow to complete
                  return new Promise(function(resolve) {
                    setTimeout(function() {
                      // After items are loaded and DOM is updated, set the item value
                      const itemLabel = lineData.item_name && lineData.item_code
                        ? `${lineData.item_name} (${lineData.item_code})`
                        : (lineData.item_name || lineData.item_code || lineData.item_id);
                      setSelectValue(itemSelect, lineData.item_id, itemLabel);
                      resolve();
                    }, 50);
                  });
                }).catch(function(error) {
                  // Return resolved promise even on error to continue with other rows
                  return Promise.resolve();
                });
              }
            }
            return Promise.resolve();
          });
          
          // After all items are loaded, populate forms
          Promise.all(loadPromises).then(function() {
            // Small delay to ensure all DOM updates are complete
            setTimeout(function() {
              forms.forEach(function(lineForm, index) {
                const deleteCheckbox = lineForm.querySelector('input[type="checkbox"][name*="DELETE"]');
                if (index < linesData.length) {
                  const lineData = linesData[index];
                  // Log only the data being passed to each row
                  console.log(`[Row ${index + 1}] Item: ${lineData.item_name || lineData.item_code || lineData.item_id}, Quantity: ${lineData.quantity || lineData.entered_quantity}, Warehouse: ${lineData.warehouse_name || lineData.warehouse_code || lineData.warehouse_id}, Unit: ${lineData.unit || lineData.entered_unit}`);
                  
                  if (deleteCheckbox) {
                    deleteCheckbox.checked = false;
                    lineForm.classList.remove('deleted');
                  }
                  
                  // Ensure item is set correctly before populating other fields
                  const itemSelect = lineForm.querySelector('select[name*="-item"]');
                  if (itemSelect && lineData.item_id) {
                    const itemLabel = lineData.item_name && lineData.item_code
                      ? `${lineData.item_name} (${lineData.item_code})`
                      : (lineData.item_name || lineData.item_code || lineData.item_id);
                    setSelectValue(itemSelect, lineData.item_id, itemLabel);
                  }
                  
                  // Don't reset item select - it's already loaded by filterItemsForRow
                  resetLineFormFields(lineForm, true);
                  populateLineFormFields(lineForm, lineData);
                } else {
                  resetLineFormFields(lineForm, false);
                  if (deleteCheckbox) {
                    deleteCheckbox.checked = true;
                    lineForm.classList.add('deleted');
                  }
                }
              });
            
              const formCount = getLineForms().length;
              totalFormsInput.value = formCount;
              totalFormsInput.setAttribute('value', formCount);
              
              attachItemChangeHandlersToAllLines();
            }, 100);
          });
        })
        .catch(error => {
          console.error('Error fetching temporary receipt data:', error);
          alert('     ');
        });
    });
  }
  
  // Setup formset management using formset.js
  if (addLineBtn && formsetContainer && totalFormsInput && typeof initFormset === 'function') {
    // Clone first row as template (or use last if no first exists)
    const firstRow = formsetContainer.querySelector('.line-form:not(.formset-template)');
    if (firstRow) {
      const templateRow = firstRow.cloneNode(true);
      templateRow.id = 'lines-formset-template';
      templateRow.style.display = 'none';
      templateRow.classList.add('formset-template');
      formsetContainer.appendChild(templateRow);
      
      // Determine formset prefix from totalFormsInput name
      const prefixMatch = totalFormsInput.name.match(/^(\w+)-TOTAL_FORMS$/);
      const formsetPrefix = prefixMatch ? prefixMatch[1] : 'lines';
      
      // Initialize formset
      initFormset(formsetPrefix, '#lines-formset-template', {
        minRows: 1,
        maxRows: null,
        addButtonSelector: '#add-line-btn',
        removeButtonSelector: 'input[name*="-DELETE"]',
        rowSelector: '.line-form'
      });
      
      // After adding row, initialize the new form
      document.addEventListener('formset:row-added', function(e) {
        if (e.detail.prefix === formsetPrefix) {
          setTimeout(function() {
            const newRow = e.detail.row;
            if (newRow) {
              initializeNewLineForm(newRow);
            }
          }, 50);
        }
      });
      
      // Handle row removal - update line numbers
      document.addEventListener('formset:row-removed', function(e) {
        if (e.detail.prefix === formsetPrefix) {
          setTimeout(function() {
            getLineForms().forEach(function(lineForm, index) {
              const lineHeader = lineForm.querySelector('.line-header h4');
              if (lineHeader) {
                lineHeader.textContent = '{% trans "Line" %} ' + (index + 1);
              }
            });
          }, 50);
        }
      });
    }
  } else if (addLineBtn && totalFormsInput) {
    // Fallback: use old method if formset.js is not available
    console.warn('formset.js not available, using fallback method');
    addLineBtn.addEventListener('click', function() {
      const lastForm = formsetContainer.querySelector('.line-form:last-child');
      if (!lastForm) return;
      
      const newForm = lastForm.cloneNode(true);
      const totalForms = parseInt(totalFormsInput.value);
      const newFormIndex = totalForms;
      
      // Update form indices
      newForm.querySelectorAll('input, select, textarea').forEach(function(input) {
        const name = input.name;
        if (name) {
          input.name = name.replace(/-(\d+)-/, '-' + newFormIndex + '-');
          input.id = input.id ? input.id.replace(/-(\d+)-/, '-' + newFormIndex + '-') : '';
        }
      });
      
      formsetContainer.appendChild(newForm);
      totalFormsInput.value = totalForms + 1;
      initializeNewLineForm(newForm);
    });
  }
  
  // Serial selection modal and functionality for issue lines (new lines only)
  const serialChoicesUrl = '{% url "inventory:item_available_serials" %}';
  
  // Create modal HTML
  const modalHTML = `
    <div id="serial-selection-modal" class="serial-modal hidden">
      <div class="serial-modal-overlay"></div>
      <div class="serial-modal-content">
        <div class="serial-modal-header">
          <h3>{% trans "Select Serial Numbers" %}</h3>
          <button type="button" class="serial-modal-close">&times;</button>
        </div>
        <div class="serial-modal-body">
          <p class="serial-modal-info">{% trans "Select serial numbers for this item:" %}</p>
          <div id="serial-checkboxes-container" class="serial-checkboxes-container">
            <p>{% trans "Loading..." %}</p>
          </div>
        </div>
        <div class="serial-modal-footer">
          <button type="button" class="btn btn-secondary serial-modal-cancel">{% trans "Cancel" %}</button>
          <button type="button" class="btn btn-primary serial-modal-save">{% trans "Save" %}</button>
        </div>
      </div>
    </div>
  `;
  
  // Insert modal into page
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  const modal = document.getElementById('serial-selection-modal');
  const modalOverlay = modal.querySelector('.serial-modal-overlay');
  const modalClose = modal.querySelector('.serial-modal-close');
  const modalCancel = modal.querySelector('.serial-modal-cancel');
  const modalSave = modal.querySelector('.serial-modal-save');
  const serialCheckboxesContainer = document.getElementById('serial-checkboxes-container');
  
  let currentLineForm = null;
  let currentSerialData = [];
  let currentSelectedSerials = new Set();
  
  // Function to open modal
  function openSerialModal(lineForm) {
    currentLineForm = lineForm;
    const itemSelect = lineForm.querySelector('select[name*="-item"]');
    const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
    const selectedSerialsInput = lineForm.querySelector('.selected-serials-input');
    
    if (!itemSelect || !itemSelect.value || !warehouseSelect || !warehouseSelect.value) {
      alert('{% trans "Please select both Item and Warehouse first." %}');
      return;
    }
    
    // Get previously selected serials
    currentSelectedSerials = new Set();
    if (selectedSerialsInput && selectedSerialsInput.value) {
      selectedSerialsInput.value.split(',').forEach(id => {
        if (id) currentSelectedSerials.add(id.trim());
      });
    }
    
    // Load serials from API
    serialCheckboxesContainer.innerHTML = '<p>{% trans "Loading..." %}</p>';
    modal.style.display = 'block';
    
    const url = serialChoicesUrl + '?item_id=' + itemSelect.value + '&warehouse_id=' + warehouseSelect.value;
    
    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          serialCheckboxesContainer.innerHTML = '<p class="error">' + data.error + '</p>';
          return;
        }
        
        if (!data.has_lot_tracking) {
          serialCheckboxesContainer.innerHTML = '<p>{% trans "This item does not require serial tracking." %}</p>';
          return;
        }
        
        if (data.serials && data.serials.length > 0) {
          currentSerialData = data.serials;
          let html = '<ul class="serial-checkboxes-list">';
          data.serials.forEach(function(serial) {
            const isChecked = currentSelectedSerials.has(serial.value);
            html += `
              <li>
                <label>
                  <input type="checkbox" value="${serial.value}" ${isChecked ? 'checked' : ''}>
                  ${serial.label}
                  ${serial.status === 'reserved' ? '<span class="serial-status-badge">({% trans "Reserved" %})</span>' : ''}
                </label>
              </li>
            `;
          });
          html += '</ul>';
          serialCheckboxesContainer.innerHTML = html;
        } else {
          serialCheckboxesContainer.innerHTML = '<p>{% trans "No available serials found for this item in the selected warehouse." %}</p>';
        }
      })
      .catch(error => {
        console.error('Error loading serials:', error);
        serialCheckboxesContainer.innerHTML = '<p class="error">{% trans "Error loading serials. Please try again." %}</p>';
      });
  }
  
  // Function to close modal
  function closeSerialModal() {
    modal.style.display = 'none';
    currentLineForm = null;
    currentSerialData = [];
  }
  
  // Function to save selected serials
  function saveSelectedSerials() {
    if (!currentLineForm) return;
    
    const checkboxes = serialCheckboxesContainer.querySelectorAll('input[type="checkbox"]:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    
    const selectedSerialsInput = currentLineForm.querySelector('.selected-serials-input');
    const selectedSerialsCount = currentLineForm.querySelector('.selected-serials-count');
    
    if (selectedSerialsInput) {
      selectedSerialsInput.value = selectedIds.join(',');
    }
    
    if (selectedSerialsCount) {
      selectedSerialsCount.textContent = selectedIds.length;
    }
    
    closeSerialModal();
  }
  
  // Event listeners for modal
  modalClose.addEventListener('click', closeSerialModal);
  modalCancel.addEventListener('click', closeSerialModal);
  modalOverlay.addEventListener('click', closeSerialModal);
  modalSave.addEventListener('click', saveSelectedSerials);
  
  // Show/hide serial selection button based on item and warehouse selection
  function updateSerialButtonVisibility(lineForm) {
    const itemSelect = lineForm.querySelector('select[name*="-item"]');
    const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
    const serialSection = lineForm.querySelector('.serial-assignment-section[data-line-index]');
    
    if (!serialSection || !itemSelect || !warehouseSelect) return;
    
    if (itemSelect.value && warehouseSelect.value) {
      // Check if item has lot tracking by calling API
      const url = serialChoicesUrl + '?item_id=' + itemSelect.value + '&warehouse_id=' + warehouseSelect.value;
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.has_lot_tracking && data.count > 0) {
            serialSection.style.display = 'flex';
          } else {
            serialSection.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error checking lot tracking:', error);
          serialSection.style.display = 'none';
        });
    } else {
      serialSection.style.display = 'none';
    }
  }
  
  // Attach event listeners for serial selection
  document.querySelectorAll('.line-form').forEach(function(lineForm) {
    // Check if this is an issue form and line doesn't have PK yet
    if (!lineForm.querySelector('.serial-assignment-section[data-line-index]')) return;
    
    const selectSerialsBtn = lineForm.querySelector('.select-serials-btn');
    if (selectSerialsBtn) {
      selectSerialsBtn.addEventListener('click', function() {
        openSerialModal(lineForm);
      });
    }
    
    const itemSelect = lineForm.querySelector('select[name*="-item"]');
    const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
    
    if (itemSelect && warehouseSelect) {
      // Update visibility when item or warehouse changes
      itemSelect.addEventListener('change', function() {
        updateSerialButtonVisibility(lineForm);
      });
      
      warehouseSelect.addEventListener('change', function() {
        updateSerialButtonVisibility(lineForm);
      });
      
      // Initial check (this will show the button if item and warehouse are already selected)
      updateSerialButtonVisibility(lineForm);
      
      // Restore selected serials count from hidden input (for form re-renders after errors)
      const selectedSerialsInput = lineForm.querySelector('.selected-serials-input');
      const selectedSerialsCount = lineForm.querySelector('.selected-serials-count');
      if (selectedSerialsInput && selectedSerialsCount && selectedSerialsInput.value) {
        const serialIds = selectedSerialsInput.value.split(',').filter(id => id.trim());
        selectedSerialsCount.textContent = serialIds.length;
      }
    }
  });
  
  // Also initialize after form submission errors (when page re-renders)
  // This handles the case when validation fails and form is re-rendered with errors
  // Wait a bit for DOM to be fully ready after error rendering
  setTimeout(function() {
    document.querySelectorAll('.line-form').forEach(function(lineForm) {
      const itemSelect = lineForm.querySelector('select[name*="-item"]');
      const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
      
      if (itemSelect && warehouseSelect && itemSelect.value && warehouseSelect.value) {
        // Check if serial button is hidden and should be shown
        const serialSection = lineForm.querySelector('.serial-assignment-section[data-line-index]');
        if (serialSection && serialSection.style.display === 'none') {
          updateSerialButtonVisibility(lineForm);
        }
        
        // Restore selected serials count from hidden input (for form re-renders after errors)
        const selectedSerialsInput = lineForm.querySelector('.selected-serials-input');
        const selectedSerialsCount = lineForm.querySelector('.selected-serials-count');
        if (selectedSerialsInput && selectedSerialsCount && selectedSerialsInput.value) {
          const serialIds = selectedSerialsInput.value.split(',').filter(id => id.trim());
          selectedSerialsCount.textContent = serialIds.length;
        }
      }
    });
  }, 300);
  
  // Handle destination type choice for Consumption Issues
  const workLinesUrl = '{% url "inventory:warehouse_work_lines" %}';
  
  // Function to update work lines based on selected warehouse
  function updateWorkLineChoices(warehouseSelect, workLineSelect) {
    const warehouseId = warehouseSelect.value;
    if (!warehouseId || !workLineSelect) {
      if (workLineSelect) {
        workLineSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
      }
      return;
    }
    
    // Show loading state
    workLineSelect.disabled = true;
    const currentValue = workLineSelect.value;
    workLineSelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
    
    const url = workLinesUrl + '?warehouse_id=' + warehouseId;
    
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          console.error('Error fetching work lines:', data.error);
          workLineSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
          workLineSelect.disabled = false;
          return;
        }
        
        workLineSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
        
        if (data.work_lines && data.work_lines.length > 0) {
          data.work_lines.forEach(function(workLine) {
            const option = document.createElement('option');
            option.value = workLine.value;
            option.textContent = workLine.label;
            if (workLine.value === currentValue) {
              option.selected = true;
            }
            workLineSelect.appendChild(option);
          });
        }
        
        workLineSelect.disabled = false;
      })
      .catch(error => {
        console.error('Error loading work lines:', error);
        workLineSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
        workLineSelect.disabled = false;
      });
  }
  
  // Handle destination type choice for Consumption Issues
  document.querySelectorAll('.line-form').forEach(function(lineForm) {
    const choiceSelect = lineForm.querySelector('select[id*="destination_type_choice"]');
    if (!choiceSelect) return;
    
    const companyUnitField = lineForm.querySelector('select[id*="destination_company_unit"]');
    const companyUnitFieldContainer = companyUnitField ? companyUnitField.closest('.destination-company-unit-field') : null;
    const workLineField = lineForm.querySelector('select[id*="destination_work_line"]');
    const workLineFieldContainer = workLineField ? workLineField.closest('.destination-work-line-field') : null;
    const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
    const consumptionTypeHidden = lineForm.querySelector('input[name*="-consumption_type"]');
    
    
    function toggleFields() {
      const value = choiceSelect.value;
      
      // Update hidden consumption_type field
      if (consumptionTypeHidden) {
        consumptionTypeHidden.value = value;
      }
      
      if (companyUnitFieldContainer) {
        companyUnitFieldContainer.style.display = (value === 'company_unit') ? 'block' : 'none';
        if (value !== 'company_unit' && companyUnitField) {
          companyUnitField.value = '';
        }
      }
      if (workLineFieldContainer) {
        workLineFieldContainer.style.display = (value === 'work_line') ? 'block' : 'none';
        if (value !== 'work_line' && workLineField) {
          workLineField.value = '';
        } else if (value === 'work_line' && warehouseSelect && workLineField) {
          // When work_line is selected, update work lines based on warehouse
          updateWorkLineChoices(warehouseSelect, workLineField);
        }
      }
    }
    
    // Initial toggle based on current value
    toggleFields();
    
    // Add change handler
    choiceSelect.addEventListener('change', toggleFields);
    
    // Update work lines when warehouse changes (only if work_line is selected)
    if (warehouseSelect && workLineField) {
      warehouseSelect.addEventListener('change', function() {
        if (choiceSelect.value === 'work_line') {
          updateWorkLineChoices(warehouseSelect, workLineField);
        }
      });
    }
  });
  
  // Attach event listeners for auto-calculation
  document.querySelectorAll('.line-form').forEach(function(lineForm) {
    const quantityExpectedInput = lineForm.querySelector('input[name*="-quantity_expected"]');
    const quantityCountedInput = lineForm.querySelector('input[name*="-quantity_counted"]');
    
    if (quantityExpectedInput) {
      quantityExpectedInput.addEventListener('input', function() {
        calculateQuantityAdjusted(lineForm);
      });
      quantityExpectedInput.addEventListener('change', function() {
        calculateQuantityAdjusted(lineForm);
      });
    }
    
    if (quantityCountedInput) {
      quantityCountedInput.addEventListener('input', function() {
        calculateQuantityAdjusted(lineForm);
      });
      quantityCountedInput.addEventListener('change', function() {
        calculateQuantityAdjusted(lineForm);
      });
    }
    
    // Initial calculation if values are already present
    if (quantityExpectedInput && quantityCountedInput) {
      calculateQuantityAdjusted(lineForm);
    }
  });
  
});

</script>
{% endblock %}

