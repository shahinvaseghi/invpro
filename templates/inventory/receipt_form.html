{% extends "inventory/base.html" %}
{% load i18n jalali_tags %}

{% block page_title %}{{ form_title }}{% endblock %}

{% block inventory_content %}
<div class="form-container">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  {% if document_instance and document_instance.pk %}
  <div class="info-banner">
    <div><strong>{% trans "Document Code" %}:</strong> {{ document_instance.document_code }}</div>
    <div><strong>{% trans "Document Date" %}:</strong> {{ document_instance.document_date|jalali_date }}</div>
    {% if document_status_display %}
    <div><strong>{% trans "Status" %}:</strong> {{ document_status_display }}</div>
    {% endif %}
    <div class="lock-status">
      <strong>{% trans "Lock Status" %}:</strong>
      {% if document_is_locked %}
        <span class="badge badge-locked">{% trans "Locked" %}</span>
      {% else %}
        <span class="badge badge-unlocked">{% trans "Editable" %}</span>
        {% if lock_url %}
        <form method="post" action="{{ lock_url }}" class="inline-lock-form">
          {% csrf_token %}
          <button type="submit" class="btn btn-warning btn-lock">{% trans "Lock" %}</button>
        </form>
        {% endif %}
      {% endif %}
    </div>
  </div>
  {% if document_is_locked %}
  <div class="alert alert-info">
    {% trans "This document is locked and can no longer be edited or deleted." %}
  </div>
  {% endif %}
  {% endif %}

  <form method="post" class="entity-form" id="receipt-form" novalidate>
    {% csrf_token %}
    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for error in form.non_field_errors %}
          <div>{{ error }}</div>
        {% endfor %}
      </div>
    {% endif %}

    {% for section_title, section_fields in fieldsets %}
      <div class="form-section">
        <h3>{{ section_title }}</h3>
        <div class="form-row">
          {% for field in section_fields %}
            <div class="form-field">
              <label for="{{ field.id_for_label }}">
                {{ field.label }}
                {% if field.field.required %}*{% endif %}
              </label>
              {{ field }}
              {% if field.errors %}
                <span class="error">{{ field.errors.0 }}</span>
              {% endif %}
              {% if field.help_text %}
                <small class="form-text">{{ field.help_text }}</small>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}

    {% for field in form.visible_fields %}
      {% if field.name not in used_fields %}
      <div class="form-section">
        <div class="form-row">
          <div class="form-field">
            <label for="{{ field.id_for_label }}">
              {{ field.label }}
              {% if field.field.required %}*{% endif %}
            </label>
            {{ field }}
            {% if field.errors %}
              <span class="error">{{ field.errors.0 }}</span>
            {% endif %}
            {% if field.help_text %}
              <small class="form-text">{{ field.help_text }}</small>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %}

    {% if lines_formset %}
    <div class="form-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div>
          <h3 style="margin: 0;">{% trans "Document Lines" %}</h3>
          <p class="form-text" style="margin: 0.5rem 0 0 0;">
            {% trans "Add one or more items to this document. Each line represents a single item with its quantity and other details." %}
          </p>
        </div>
        <button type="button" id="add-line-btn" class="btn btn-success" style="padding: 0.5rem 1rem;">
          <span style="font-size: 1.2rem; margin-right: 0.25rem;">+</span> {% trans "Add Line" %}
        </button>
      </div>
      {% if lines_formset.non_form_errors %}
        <div class="alert alert-danger">
          {% for error in lines_formset.non_form_errors %}
            <div>{{ error }}</div>
          {% endfor %}
        </div>
      {% endif %}
      {{ lines_formset.management_form }}
      {% for hidden in lines_formset.hidden_fields %}{{ hidden }}{% endfor %}

      <div class="lines-formset" id="lines-formset">
        {% for line_form in lines_formset %}
          {% comment %}Determine if this form should be displayed:
             - In create mode: only show first empty form (extra=1)
             - In edit mode: show existing lines (with pk) and first empty form if any
          {% endcomment %}
          {% if not form.instance.pk %}
            {# Create mode: only show first empty form (extra=1) #}
            {% if forloop.counter0 < 1 %}
          <div class="line-form" data-form-index="{{ forloop.counter0 }}">
            {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}
            
            <div class="line-header">
              <h4>{% trans "Line" %} {{ forloop.counter }}</h4>
              {% if lines_formset.can_delete %}
              <div class="line-delete">
                <label>{{ line_form.DELETE.label }}</label>
                {{ line_form.DELETE }}
              </div>
              {% endif %}
            </div>

            <div class="line-fields">
              <div class="form-row">
                {% if 'item' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.item.label }}{% if line_form.item.field.required %}*{% endif %}</label>
                  {{ line_form.item }}
                  {% if line_form.item.errors %}
                    <span class="error">{{ line_form.item.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'warehouse' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.warehouse.label }}{% if line_form.warehouse.field.required %}*{% endif %}</label>
                  {{ line_form.warehouse }}
                  {% if line_form.warehouse.errors %}
                    <span class="error">{{ line_form.warehouse.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'unit' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit.label }}{% if line_form.unit.field.required %}*{% endif %}</label>
                  {{ line_form.unit }}
                  {% if line_form.unit.errors %}
                    <span class="error">{{ line_form.unit.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'quantity' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.quantity.label }}{% if line_form.quantity.field.required %}*{% endif %}</label>
                  {{ line_form.quantity }}
                  {% if line_form.quantity.errors %}
                    <span class="error">{{ line_form.quantity.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>

              {% if 'supplier' in line_form.fields %}
              <div class="form-row">
                <div class="form-field">
                  <label>{{ line_form.supplier.label }}</label>
                  {{ line_form.supplier }}
                  {% if line_form.supplier.errors %}
                    <span class="error">{{ line_form.supplier.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {% if 'destination_type' in line_form.fields or 'destination_type_choice' in line_form.fields or 'consumption_type' in line_form.fields or 'consignment_receipt' in line_form.fields %}
              <div class="form-row">
                {% if 'destination_type_choice' in line_form.fields %}
                {# Consumption Issue: Show destination type choice first #}
                <div class="form-field">
                  <label>{{ line_form.destination_type_choice.label }}{% if line_form.destination_type_choice.field.required %}*{% endif %}</label>
                  {{ line_form.destination_type_choice }}
                  {% if line_form.destination_type_choice.errors %}
                    <span class="error">{{ line_form.destination_type_choice.errors.0 }}</span>
                  {% endif %}
                  {% if line_form.destination_type_choice.help_text %}
                    <small class="form-text text-muted">{{ line_form.destination_type_choice.help_text }}</small>
                  {% endif %}
                </div>
                
                {% if 'destination_company_unit' in line_form.fields %}
                <div class="form-field destination-company-unit-field" style="display:none;">
                  <label>{{ line_form.destination_company_unit.label }}{% if line_form.destination_company_unit.field.required %}*{% endif %}</label>
                  {{ line_form.destination_company_unit }}
                  {% if line_form.destination_company_unit.errors %}
                    <span class="error">{{ line_form.destination_company_unit.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                
                {% if 'destination_work_line' in line_form.fields %}
                <div class="form-field destination-work-line-field" style="display:none;">
                  <label>{{ line_form.destination_work_line.label }}{% if line_form.destination_work_line.field.required %}*{% endif %}</label>
                  {{ line_form.destination_work_line }}
                  {% if line_form.destination_work_line.errors %}
                    <span class="error">{{ line_form.destination_work_line.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% endif %}

                {% if 'destination_type' in line_form.fields %}
                {# Permanent/Consignment Issue: Show Work Line directly #}
                <div class="form-field">
                  <label>{{ line_form.destination_type.label }}{% if line_form.destination_type.field.required %}*{% endif %}</label>
                  {{ line_form.destination_type }}
                  {% if line_form.destination_type.errors %}
                    <span class="error">{{ line_form.destination_type.errors.0 }}</span>
                  {% endif %}
                  {% if line_form.destination_type.help_text %}
                    <small class="form-text text-muted">{{ line_form.destination_type.help_text }}</small>
                  {% endif %}
                </div>
                {% endif %}

                {# consumption_type is hidden, managed by destination_type_choice #}

                {% if 'consignment_receipt' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.consignment_receipt.label }}{% if line_form.consignment_receipt.field.required %}*{% endif %}</label>
                  {{ line_form.consignment_receipt }}
                  {% if line_form.consignment_receipt.errors %}
                    <span class="error">{{ line_form.consignment_receipt.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              {% if 'unit_price' in line_form.fields or 'unit_cost' in line_form.fields or 'unit_price_estimate' in line_form.fields %}
              <div class="form-row">
                {% if 'unit_price' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit_price.label }}</label>
                  {{ line_form.unit_price }}
                  {% if line_form.unit_price.errors %}
                    <span class="error">{{ line_form.unit_price.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'entered_price_unit' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.entered_price_unit.label }}{% if line_form.entered_price_unit.field.required %}*{% endif %}</label>
                  {{ line_form.entered_price_unit }}
                  {% if line_form.entered_price_unit.errors %}
                    <span class="error">{{ line_form.entered_price_unit.errors.0 }}</span>
                  {% endif %}
                  {% if line_form.entered_price_unit.help_text %}
                    <small class="form-text text-muted">{{ line_form.entered_price_unit.help_text }}</small>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'unit_cost' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit_cost.label }}</label>
                  {{ line_form.unit_cost }}
                  {% if line_form.unit_cost.errors %}
                    <span class="error">{{ line_form.unit_cost.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'unit_price_estimate' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit_price_estimate.label }}</label>
                  {{ line_form.unit_price_estimate }}
                  {% if line_form.unit_price_estimate.errors %}
                    <span class="error">{{ line_form.unit_price_estimate.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'currency' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.currency.label }}</label>
                  {{ line_form.currency }}
                  {% if line_form.currency.errors %}
                    <span class="error">{{ line_form.currency.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              {% if 'line_notes' in line_form.fields %}
              <div class="form-row">
                <div class="form-field full-width">
                  <label>{{ line_form.line_notes.label }}</label>
                  {{ line_form.line_notes }}
                  {% if line_form.line_notes.errors %}
                    <span class="error">{{ line_form.line_notes.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {% if not document_is_locked and 'issue' in request.path %}
              {# Serial selection for new issue lines (when line doesn't have pk yet) #}
              <div class="form-row">
                <div class="form-field full-width">
                  <div class="serial-assignment-section" data-line-index="{{ forloop.counter0 }}" style="display: none;">
                    <button type="button" class="btn btn-sm btn-primary select-serials-btn">
                      {% trans "Select Serials" %}
                    </button>
                    <span class="serial-count">
                      {% trans "Selected:" %} <span class="selected-serials-count">0</span> / {% if line_form.quantity.value %}{{ line_form.quantity.value|floatformat:0 }}{% else %}0{% endif %}
                    </span>
                    <input type="hidden" class="selected-serials-input" name="{{ line_form.prefix }}-selected_serials" value="">
                  </div>
                </div>
              </div>
              {% endif %}

              {% if document_instance and document_instance.pk and line_form.instance.pk %}
                {% with line=line_form.instance %}
                  {% if line.item and line.item.has_lot_tracking == 1 %}
                  <div class="form-row">
                    <div class="form-field full-width">
                      <div class="serial-assignment-section">
                        {% if 'receipt' in request.path %}
                          {% if 'permanent' in request.path %}
                            <a href="{% url 'inventory:receipt_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-info">
                              {% trans "Manage Serials" %}
                            </a>
                          {% elif 'consignment' in request.path %}
                            <a href="{% url 'inventory:receipt_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-info">
                              {% trans "Manage Serials" %}
                            </a>
                          {% endif %}
                          <span class="serial-count">
                            {% trans "Serials:" %} {{ line.serials.count }}
                          </span>
                        {% elif 'issue' in request.path %}
                          {% if 'permanent' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% elif 'consumption' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_consumption_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_consumption_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% elif 'consignment' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% endif %}
                          <span class="serial-count">
                            {% trans "Assigned:" %} {{ line.serials.count }} / 
                            {% if line.quantity %}{{ line.quantity|floatformat:0 }}{% else %}0{% endif %}
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% endif %}
                {% endwith %}
              {% endif %}
            </div>

            {% if line_form.non_field_errors %}
              <div class="error">{{ line_form.non_field_errors|join:", " }}</div>
            {% endif %}
          </div>
            {% endif %}
          {% else %}
            {# Edit mode: show existing lines (with pk) and first empty form if any #}
            {% if line_form.instance.pk %}
              {# Existing line - always show #}
          <div class="line-form" data-form-index="{{ forloop.counter0 }}">
            {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}
            
            <div class="line-header">
              <h4>{% trans "Line" %} {{ forloop.counter }}</h4>
              {% if lines_formset.can_delete %}
              <div class="line-delete">
                <label>{{ line_form.DELETE.label }}</label>
                {{ line_form.DELETE }}
              </div>
              {% endif %}
            </div>

            <div class="line-fields">
              <div class="form-row">
                {% if 'item' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.item.label }}{% if line_form.item.field.required %}*{% endif %}</label>
                  {{ line_form.item }}
                  {% if line_form.item.errors %}
                    <span class="error">{{ line_form.item.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'warehouse' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.warehouse.label }}{% if line_form.warehouse.field.required %}*{% endif %}</label>
                  {{ line_form.warehouse }}
                  {% if line_form.warehouse.errors %}
                    <span class="error">{{ line_form.warehouse.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'unit' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit.label }}{% if line_form.unit.field.required %}*{% endif %}</label>
                  {{ line_form.unit }}
                  {% if line_form.unit.errors %}
                    <span class="error">{{ line_form.unit.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'quantity' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.quantity.label }}{% if line_form.quantity.field.required %}*{% endif %}</label>
                  {{ line_form.quantity }}
                  {% if line_form.quantity.errors %}
                    <span class="error">{{ line_form.quantity.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>

              {% if 'supplier' in line_form.fields %}
              <div class="form-row">
                <div class="form-field">
                  <label>{{ line_form.supplier.label }}</label>
                  {{ line_form.supplier }}
                  {% if line_form.supplier.errors %}
                    <span class="error">{{ line_form.supplier.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {% if 'unit_price' in line_form.fields or 'unit_cost' in line_form.fields or 'unit_price_estimate' in line_form.fields %}
              <div class="form-row">
                {% if 'unit_price' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit_price.label }}</label>
                  {{ line_form.unit_price }}
                  {% if line_form.unit_price.errors %}
                    <span class="error">{{ line_form.unit_price.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'entered_price_unit' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.entered_price_unit.label }}{% if line_form.entered_price_unit.field.required %}*{% endif %}</label>
                  {{ line_form.entered_price_unit }}
                  {% if line_form.entered_price_unit.errors %}
                    <span class="error">{{ line_form.entered_price_unit.errors.0 }}</span>
                  {% endif %}
                  {% if line_form.entered_price_unit.help_text %}
                    <small class="form-text text-muted">{{ line_form.entered_price_unit.help_text }}</small>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'unit_cost' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit_cost.label }}</label>
                  {{ line_form.unit_cost }}
                  {% if line_form.unit_cost.errors %}
                    <span class="error">{{ line_form.unit_cost.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'unit_price_estimate' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit_price_estimate.label }}</label>
                  {{ line_form.unit_price_estimate }}
                  {% if line_form.unit_price_estimate.errors %}
                    <span class="error">{{ line_form.unit_price_estimate.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'currency' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.currency.label }}</label>
                  {{ line_form.currency }}
                  {% if line_form.currency.errors %}
                    <span class="error">{{ line_form.currency.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              {% if 'line_notes' in line_form.fields %}
              <div class="form-row">
                <div class="form-field full-width">
                  <label>{{ line_form.line_notes.label }}</label>
                  {{ line_form.line_notes }}
                  {% if line_form.line_notes.errors %}
                    <span class="error">{{ line_form.line_notes.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {% if not document_is_locked and 'issue' in request.path %}
              {# Serial selection for new issue lines (when line doesn't have pk yet) #}
              <div class="form-row">
                <div class="form-field full-width">
                  <div class="serial-assignment-section" data-line-index="{{ forloop.counter0 }}" style="display: none;">
                    <button type="button" class="btn btn-sm btn-primary select-serials-btn">
                      {% trans "Select Serials" %}
                    </button>
                    <span class="serial-count">
                      {% trans "Selected:" %} <span class="selected-serials-count">0</span> / {% if line_form.quantity.value %}{{ line_form.quantity.value|floatformat:0 }}{% else %}0{% endif %}
                    </span>
                    <input type="hidden" class="selected-serials-input" name="{{ line_form.prefix }}-selected_serials" value="">
                  </div>
                </div>
              </div>
              {% endif %}

              {% if document_instance and document_instance.pk and line_form.instance.pk %}
                {% with line=line_form.instance %}
                  {% if line.item and line.item.has_lot_tracking == 1 %}
                  <div class="form-row">
                    <div class="form-field full-width">
                      <div class="serial-assignment-section">
                        {% if 'receipt' in request.path %}
                          {% if 'permanent' in request.path %}
                            <a href="{% url 'inventory:receipt_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-info">
                              {% trans "Manage Serials" %}
                            </a>
                          {% elif 'consignment' in request.path %}
                            <a href="{% url 'inventory:receipt_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-info">
                              {% trans "Manage Serials" %}
                            </a>
                          {% endif %}
                          <span class="serial-count">
                            {% trans "Serials:" %} {{ line.serials.count }}
                          </span>
                        {% elif 'issue' in request.path %}
                          {% if 'permanent' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% elif 'consumption' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_consumption_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_consumption_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% elif 'consignment' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% endif %}
                          <span class="serial-count">
                            {% trans "Assigned:" %} {{ line.serials.count }} / 
                            {% if line.quantity %}{{ line.quantity|floatformat:0 }}{% else %}0{% endif %}
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% endif %}
                {% endwith %}
              {% endif %}
            </div>

            {% if line_form.non_field_errors %}
              <div class="error">{{ line_form.non_field_errors|join:", " }}</div>
            {% endif %}
          </div>
            {% elif forloop.counter0 < 1 %}
              {# First empty form in edit mode #}
          <div class="line-form" data-form-index="{{ forloop.counter0 }}">
            {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}
            
            <div class="line-header">
              <h4>{% trans "Line" %} {{ forloop.counter }}</h4>
              {% if lines_formset.can_delete %}
              <div class="line-delete">
                <label>{{ line_form.DELETE.label }}</label>
                {{ line_form.DELETE }}
              </div>
              {% endif %}
            </div>

            <div class="line-fields">
              <div class="form-row">
                {% if 'item' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.item.label }}{% if line_form.item.field.required %}*{% endif %}</label>
                  {{ line_form.item }}
                  {% if line_form.item.errors %}
                    <span class="error">{{ line_form.item.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'warehouse' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.warehouse.label }}{% if line_form.warehouse.field.required %}*{% endif %}</label>
                  {{ line_form.warehouse }}
                  {% if line_form.warehouse.errors %}
                    <span class="error">{{ line_form.warehouse.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'unit' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit.label }}{% if line_form.unit.field.required %}*{% endif %}</label>
                  {{ line_form.unit }}
                  {% if line_form.unit.errors %}
                    <span class="error">{{ line_form.unit.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'quantity' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.quantity.label }}{% if line_form.quantity.field.required %}*{% endif %}</label>
                  {{ line_form.quantity }}
                  {% if line_form.quantity.errors %}
                    <span class="error">{{ line_form.quantity.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>

              {% if 'supplier' in line_form.fields %}
              <div class="form-row">
                <div class="form-field">
                  <label>{{ line_form.supplier.label }}</label>
                  {{ line_form.supplier }}
                  {% if line_form.supplier.errors %}
                    <span class="error">{{ line_form.supplier.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {% if 'unit_price' in line_form.fields or 'unit_cost' in line_form.fields or 'unit_price_estimate' in line_form.fields %}
              <div class="form-row">
                {% if 'unit_price' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit_price.label }}</label>
                  {{ line_form.unit_price }}
                  {% if line_form.unit_price.errors %}
                    <span class="error">{{ line_form.unit_price.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'entered_price_unit' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.entered_price_unit.label }}{% if line_form.entered_price_unit.field.required %}*{% endif %}</label>
                  {{ line_form.entered_price_unit }}
                  {% if line_form.entered_price_unit.errors %}
                    <span class="error">{{ line_form.entered_price_unit.errors.0 }}</span>
                  {% endif %}
                  {% if line_form.entered_price_unit.help_text %}
                    <small class="form-text text-muted">{{ line_form.entered_price_unit.help_text }}</small>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'unit_cost' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit_cost.label }}</label>
                  {{ line_form.unit_cost }}
                  {% if line_form.unit_cost.errors %}
                    <span class="error">{{ line_form.unit_cost.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'unit_price_estimate' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.unit_price_estimate.label }}</label>
                  {{ line_form.unit_price_estimate }}
                  {% if line_form.unit_price_estimate.errors %}
                    <span class="error">{{ line_form.unit_price_estimate.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}

                {% if 'currency' in line_form.fields %}
                <div class="form-field">
                  <label>{{ line_form.currency.label }}</label>
                  {{ line_form.currency }}
                  {% if line_form.currency.errors %}
                    <span class="error">{{ line_form.currency.errors.0 }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              {% if 'line_notes' in line_form.fields %}
              <div class="form-row">
                <div class="form-field full-width">
                  <label>{{ line_form.line_notes.label }}</label>
                  {{ line_form.line_notes }}
                  {% if line_form.line_notes.errors %}
                    <span class="error">{{ line_form.line_notes.errors.0 }}</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {% if not document_is_locked and 'issue' in request.path %}
              {# Serial selection for new issue lines (when line doesn't have pk yet) #}
              <div class="form-row">
                <div class="form-field full-width">
                  <div class="serial-assignment-section" data-line-index="{{ forloop.counter0 }}" style="display: none;">
                    <button type="button" class="btn btn-sm btn-primary select-serials-btn">
                      {% trans "Select Serials" %}
                    </button>
                    <span class="serial-count">
                      {% trans "Selected:" %} <span class="selected-serials-count">0</span> / {% if line_form.quantity.value %}{{ line_form.quantity.value|floatformat:0 }}{% else %}0{% endif %}
                    </span>
                    <input type="hidden" class="selected-serials-input" name="{{ line_form.prefix }}-selected_serials" value="">
                  </div>
                </div>
              </div>
              {% endif %}

              {% if document_instance and document_instance.pk and line_form.instance.pk %}
                {% with line=line_form.instance %}
                  {% if line.item and line.item.has_lot_tracking == 1 %}
                  <div class="form-row">
                    <div class="form-field full-width">
                      <div class="serial-assignment-section">
                        {% if 'receipt' in request.path %}
                          {% if 'permanent' in request.path %}
                            <a href="{% url 'inventory:receipt_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-info">
                              {% trans "Manage Serials" %}
                            </a>
                          {% elif 'consignment' in request.path %}
                            <a href="{% url 'inventory:receipt_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-info">
                              {% trans "Manage Serials" %}
                            </a>
                          {% endif %}
                          <span class="serial-count">
                            {% trans "Serials:" %} {{ line.serials.count }}
                          </span>
                        {% elif 'issue' in request.path %}
                          {% if 'permanent' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_permanent_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% elif 'consumption' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_consumption_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_consumption_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% elif 'consignment' in request.path %}
                            {% if not document_is_locked %}
                              <a href="{% url 'inventory:issue_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-primary">
                                {% trans "Assign Serials" %}
                              </a>
                            {% else %}
                              <a href="{% url 'inventory:issue_consignment_line_serials' document_instance.pk line.pk %}" class="btn btn-sm btn-secondary">
                                {% trans "View Serials" %}
                              </a>
                            {% endif %}
                          {% endif %}
                          <span class="serial-count">
                            {% trans "Assigned:" %} {{ line.serials.count }} / 
                            {% if line.quantity %}{{ line.quantity|floatformat:0 }}{% else %}0{% endif %}
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% endif %}
                {% endwith %}
              {% endif %}
            </div>

            {% if line_form.non_field_errors %}
              <div class="error">{{ line_form.non_field_errors|join:", " }}</div>
            {% endif %}
          </div>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <div class="form-actions">
      {% if not document_is_locked %}
      <button type="submit" class="btn btn-primary">{% trans "Save" %}</button>
      {% endif %}
      <a href="{{ list_url }}" class="btn btn-secondary">{% trans "Cancel" %}</a>
    </div>
  </form>
</div>

<script>
// Direct test - attach to button IMMEDIATELY when script loads
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.querySelector('button[type="submit"]');
  if (btn) {
    
    // Force attach a click listener
    btn.addEventListener('click', function(e) {
    }, true);
  } else {
    console.error('Submit button NOT FOUND!');
  }
});
</script>

<style>
.form-container {
  max-width: 960px;
  margin: 2rem auto;
  background: #ffffff;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.1);
}

.entity-form .form-section {
  margin-bottom: 2rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
}

.entity-form .form-section:last-of-type {
  border-bottom: none;
  padding-bottom: 0;
}

.entity-form .form-section h3 {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 1.25rem;
  color: #111827;
}

.entity-form .form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 1.5rem;
}

.entity-form .form-field {
  display: flex;
  flex-direction: column;
}

.entity-form label {
  font-weight: 500;
  margin-bottom: 0.5rem;
  color: #1f2937;
}

.entity-form .form-control,
.entity-form select,
.entity-form textarea,
.entity-form input[type="text"],
.entity-form input[type="number"],
.entity-form input[type="date"],
.entity-form input[type="datetime-local"] {
  width: 100%;
  padding: 0.55rem 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 1rem;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.entity-form .form-control:focus,
.entity-form select:focus,
.entity-form textarea:focus,
.entity-form input[type="text"]:focus,
.entity-form input[type="number"]:focus,
.entity-form input[type="date"]:focus,
.entity-form input[type="datetime-local"]:focus {
  outline: none;
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.entity-form textarea {
  min-height: 100px;
  resize: vertical;
}

.entity-form .form-check-input {
  width: 1.1rem;
  height: 1.1rem;
  cursor: pointer;
}

.entity-form .error {
  margin-top: 0.35rem;
  color: #dc2626;
  font-size: 0.875rem;
}

.entity-form .form-text {
  margin-top: 0.4rem;
  color: #6b7280;
  font-size: 0.875rem;
}

.form-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  padding-top: 1rem;
}

.alert {
  padding: 0.9rem 1.1rem;
  border-radius: 6px;
  margin-bottom: 1.5rem;
}

.alert-success {
  background-color: #dcfce7;
  color: #166534;
  border: 1px solid #bbf7d0;
}

.alert-error {
  background-color: #fee2e2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

.alert-info {
  background-color: #e0f2fe;
  color: #0c4a6e;
  border: 1px solid #bae6fd;
}

.info-banner {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
  padding: 0.85rem 1.25rem;
  border-radius: 8px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(139, 92, 246, 0.12));
  border: 1px solid rgba(59, 130, 246, 0.2);
  color: #1f2937;
  font-weight: 500;
}

.info-banner strong {
  color: #1d4ed8;
}

.lock-status {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.badge {
  display: inline-flex;
  align-items: center;
  padding: 0.2rem 0.55rem;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
}

.badge-locked {
  background-color: #dc2626;
  color: #ffffff;
}

.badge-unlocked {
  background-color: #10b981;
  color: #ffffff;
}

.inline-lock-form {
  display: inline-flex;
  margin: 0;
}

.btn-lock {
  padding: 0.35rem 0.9rem;
  font-size: 0.85rem;
  font-weight: 600;
}

.lines-formset {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  margin-top: 1rem;
}

.line-form {
  padding: 1.5rem;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  background-color: #f9fafb;
  position: relative;
}

.line-form.deleted {
  opacity: 0.5;
  background-color: #fee2e2;
}

.line-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid #e5e7eb;
}

.line-header h4 {
  margin: 0;
  font-size: 1.1rem;
  font-weight: 600;
  color: #1f2937;
}

.line-delete {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.line-delete label {
  margin: 0;
  font-weight: 500;
  color: #dc2626;
}

.line-fields {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.line-fields .form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.line-fields .form-field.full-width {
  grid-column: 1 / -1;
}

.serial-assignment-section {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem;
  background-color: #f3f4f6;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
}

.serial-assignment-section .btn {
  padding: 0.4rem 0.9rem;
  font-size: 0.875rem;
  font-weight: 500;
  text-decoration: none;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.serial-assignment-section .btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.serial-count {
  font-size: 0.875rem;
  color: #6b7280;
  font-weight: 500;
}

/* Serial Selection Modal Styles */
.serial-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 10000;
}

.serial-modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.serial-modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 10px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
}

.serial-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
}

.serial-modal-header h3 {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
}

.serial-modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: #6b7280;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
}

.serial-modal-close:hover {
  background-color: #f3f4f6;
  color: #374151;
}

.serial-modal-body {
  padding: 1.5rem;
  overflow-y: auto;
  flex: 1;
}

.serial-modal-info {
  margin-bottom: 1rem;
  color: #6b7280;
  font-size: 0.9rem;
}

.serial-checkboxes-container {
  max-height: 400px;
  overflow-y: auto;
}

.serial-checkboxes-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.serial-checkboxes-list li {
  padding: 0.75rem;
  margin: 0.5rem 0;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  transition: background-color 0.2s;
}

.serial-checkboxes-list li:hover {
  background-color: #f9fafb;
}

.serial-checkboxes-list li input[type="checkbox"]:checked + label,
.serial-checkboxes-list li:has(input[type="checkbox"]:checked) {
  background-color: #eff6ff;
  border-color: #2563eb;
}

.serial-checkboxes-list li label {
  display: flex;
  align-items: center;
  cursor: pointer;
  font-weight: normal;
  margin: 0;
  gap: 0.5rem;
  user-select: none;
}

.serial-checkboxes-list li input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #2563eb;
  flex-shrink: 0;
}

.serial-status-badge {
  font-size: 0.75rem;
  color: #f59e0b;
  font-weight: 500;
}

.serial-modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
  padding: 1.5rem;
  border-top: 1px solid #e5e7eb;
}

.serial-modal-footer .btn {
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
  font-weight: 500;
  border-radius: 6px;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
}

.serial-modal-footer .btn-secondary {
  background-color: #f3f4f6;
  color: #374151;
}

.serial-modal-footer .btn-secondary:hover {
  background-color: #e5e7eb;
}

.serial-modal-footer .btn-primary {
  background-color: #2563eb;
  color: white;
}

.serial-modal-footer .btn-primary:hover {
  background-color: #1d4ed8;
}
</style>

<script>
// Global error handler
window.addEventListener('error', function(e) {
  console.error('Global JavaScript Error:', e.error);
  console.error('Error message:', e.message);
  console.error('Stack trace:', e.error ? e.error.stack : 'N/A');
});

// Log all form submissions (even if prevented) - CAPTURE PHASE
document.addEventListener('submit', function(e) {
}, true); // Use capture phase

// Also listen in bubble phase
document.addEventListener('submit', function(e) {
}, false); // Bubble phase

document.addEventListener('DOMContentLoaded', function() {
  
  const formsetContainer = document.getElementById('lines-formset');
  const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
  const addLineBtn = document.getElementById('add-line-btn');
  const unitChoicesUrl = '{% url "inventory:item_allowed_units" %}';
  const warehouseChoicesUrl = '{% url "inventory:item_allowed_warehouses" %}';
  const temporaryReceiptDataUrl = '{% url "inventory:temporary_receipt_data" %}';
  
  // Save selected serials to localStorage before form submission (for error recovery)
  const form = document.getElementById('receipt-form');
  
  if (form) {
    form.addEventListener('submit', function(e) {
      
      // Debug: Log all form data
      const formData = new FormData(form);
      for (let [key, value] of formData.entries()) {
      }
      
      // Check if all required fields in line 1 are filled
      const line0Item = document.querySelector('select[name="lines-0-item"]');
      const line0Warehouse = document.querySelector('select[name="lines-0-warehouse"]');
      const line0Unit = document.querySelector('select[name="lines-0-unit"]');
      const line0Quantity = document.querySelector('input[name="lines-0-quantity"]');
      const line0DestChoice = document.querySelector('select[name*="lines-0-destination_type_choice"]');
      const line0DestType = document.querySelector('select[name*="lines-0-destination_type"]');
      
      
      // Check for any empty required fields
      let missingFields = [];
      if (!line0Item || !line0Item.value) missingFields.push('Item');
      if (!line0Warehouse || !line0Warehouse.value) missingFields.push('Warehouse');
      if (!line0Unit || !line0Unit.value) missingFields.push('Unit');
      if (!line0Quantity || !line0Quantity.value) missingFields.push('Quantity');
      
      // Only check destination_type_choice for Consumption Issues (it has destination_type_choice field)
      // For Permanent/Consignment Issues, destination_type is optional
      if (line0DestChoice && !line0DestChoice.value) {
        missingFields.push('Destination Type');
      }
      
      if (missingFields.length > 0) {
        console.error('Missing required fields:', missingFields.join(', '));
        alert('     :\n' + missingFields.join('\n'));
        e.preventDefault();
        return false;
      }
      
      // Make sure all hidden inputs have their values before submit
      document.querySelectorAll('.selected-serials-input').forEach(function(input) {
        if (input.value) {
          localStorage.setItem('selected_serials_' + input.name, input.value);
        } else {
          // If input is empty but localStorage has value, restore it before submit
          const savedValue = localStorage.getItem('selected_serials_' + input.name);
          if (savedValue) {
            input.value = savedValue;
          }
        }
      });
      
    });
    
    // Also attach listener to submit button directly
    const submitButton = form.querySelector('button[type="submit"]');
    if (submitButton) {
      submitButton.addEventListener('click', function(e) {
      });
    }
    
    // Restore selected serials from localStorage after form re-render (for validation errors)
    document.querySelectorAll('.selected-serials-input').forEach(function(input) {
      const savedValue = localStorage.getItem('selected_serials_' + input.name);
      if (savedValue) {
        // Always restore from localStorage if available (even if input has value)
        // This handles the case when form is re-rendered after error
        if (!input.value || input.value === '') {
          input.value = savedValue;
        }
        
        // Update count display
        const lineForm = input.closest('.line-form');
        if (lineForm) {
          const selectedSerialsCount = lineForm.querySelector('.selected-serials-count');
          if (selectedSerialsCount) {
            const serialIds = savedValue.split(',').filter(id => id.trim());
            selectedSerialsCount.textContent = serialIds.length;
          }
        }
      }
    });
    
    // Clear localStorage if form was successfully submitted (redirect happened)
    // Check if we're on a different page (not the form page)
    const currentUrl = window.location.pathname;
    const isFormPage = currentUrl.includes('/create/') || currentUrl.includes('/edit/');
    if (!isFormPage) {
      // Form was successfully submitted, clear saved serials
      Object.keys(localStorage).forEach(function(key) {
        if (key.startsWith('selected_serials_')) {
          localStorage.removeItem(key);
        }
      });
    }
  }
  
  // Handle line formset delete checkboxes
  const deleteCheckboxes = document.querySelectorAll('.line-form input[type="checkbox"][name*="DELETE"]');
  deleteCheckboxes.forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const lineForm = this.closest('.line-form');
      if (this.checked) {
        lineForm.classList.add('deleted');
      } else {
        lineForm.classList.remove('deleted');
      }
    });
  });
  
  // Add search functionality to select fields
  function addSearchToSelect(select) {
    if (select.tagName !== 'SELECT') return;
    // Skip if already wrapped
    if (select.parentNode && select.parentNode.classList && select.parentNode.classList.contains('select-wrapper')) return;
    
    // Skip unit selects (they are dynamically populated and search causes issues)
    if (select.name && select.name.includes('-unit')) return;
    
    // Add search input above select
    const wrapper = document.createElement('div');
    wrapper.className = 'select-wrapper';
    wrapper.style.position = 'relative';
    select.parentNode.insertBefore(wrapper, select);
    wrapper.appendChild(select);
    
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'select-search-input';
    searchInput.placeholder = '{% trans "Search..." %}';
    searchInput.style.cssText = 'width: 100%; padding: 0.4rem; margin-bottom: 0.25rem; border: 1px solid #d1d5db; border-radius: 4px;';
    wrapper.insertBefore(searchInput, select);
    
    // Filter options on search
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      Array.from(select.options).forEach(function(option) {
        const text = option.text.toLowerCase();
        option.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  }
  
  // Add search to all select fields in lines (except unit selects)
  document.querySelectorAll('.line-form select').forEach(addSearchToSelect);
  
  // Update unit choices when item changes
  function updateUnitChoices(itemSelect, unitSelect) {
    const itemId = itemSelect.value;
    if (!itemId) {
      unitSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
      return;
    }
    
    // Show loading state
    unitSelect.disabled = true;
    unitSelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
    
    const url = unitChoicesUrl + '?item_id=' + itemId;
    
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          console.error('Error fetching units:', data.error);
          unitSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
          unitSelect.disabled = false;
          alert('{% trans "Error loading units" %}: ' + data.error);
          return;
        }
        
        const currentValue = unitSelect.value;
        unitSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
        
        if (data.units && data.units.length > 0) {
          let hasSelectedValue = false;
          data.units.forEach(function(unit) {
            const option = document.createElement('option');
            option.value = unit.value;
            option.textContent = unit.label;
            if (unit.value === currentValue) {
              option.selected = true;
              hasSelectedValue = true;
            }
            unitSelect.appendChild(option);
          });
          
          // If no value was selected and we have a default unit, select it
          if (!hasSelectedValue && data.default_unit && data.units.length > 0) {
            // Find the option with default_unit value
            for (let i = 0; i < unitSelect.options.length; i++) {
              if (unitSelect.options[i].value === data.default_unit) {
                unitSelect.options[i].selected = true;
                unitSelect.value = data.default_unit;
                break;
              }
            }
          }
        } else {
          // If no units found, at least show default unit
          if (data.default_unit) {
            const option = document.createElement('option');
            option.value = data.default_unit;
            // Try to get label from UNIT_CHOICES
            const labelMap = {
              'EA': ' (EA)',
              'KG': ' (KG)',
              'BOX': ' (BOX)',
              'CARTON': ''
            };
            option.textContent = labelMap[data.default_unit] || data.default_unit;
            if (data.default_unit === currentValue) {
              option.selected = true;
            }
            unitSelect.appendChild(option);
          }
        }
        
        unitSelect.disabled = false;
        
        // Trigger change event to update any UI components
        const changeEvent = new Event('change', { bubbles: true });
        unitSelect.dispatchEvent(changeEvent);
      })
      .catch(error => {
        console.error('Error:', error);
        unitSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
        unitSelect.disabled = false;
        alert('{% trans "Error loading units. Please try again." %}: ' + error.message);
      });
  }
  
  // Update warehouse choices when item changes
  function updateWarehouseChoices(itemSelect, warehouseSelect) {
    const itemId = itemSelect.value;
    if (!itemId) {
      // If no item selected, show all warehouses (or clear)
      warehouseSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
      return;
    }
    
    // Show loading state
    warehouseSelect.disabled = true;
    const currentValue = warehouseSelect.value;
    warehouseSelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
    
    const url = warehouseChoicesUrl + '?item_id=' + itemId;
    
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          console.error('Error fetching warehouses:', data.error);
          warehouseSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
          warehouseSelect.disabled = false;
          alert('{% trans "Error loading warehouses" %}: ' + data.error);
          return;
        }
        
        warehouseSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
        
        if (data.warehouses && data.warehouses.length > 0) {
          data.warehouses.forEach(function(warehouse) {
            const option = document.createElement('option');
            option.value = warehouse.value;
            option.textContent = warehouse.label;
            if (warehouse.value === currentValue) {
              option.selected = true;
            }
            warehouseSelect.appendChild(option);
          });
        }
        
        warehouseSelect.disabled = false;
      })
      .catch(error => {
        console.error('Error loading warehouses:', error);
        warehouseSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
        warehouseSelect.disabled = false;
        alert('{% trans "Error loading warehouses. Please try again." %}: ' + error.message);
      });
  }
  
  // Attach item change handlers for multi-line forms (inlinesets)
  document.querySelectorAll('.line-form select[name*="-item"]').forEach(function(itemSelect) {
    const lineForm = itemSelect.closest('.line-form');
    const unitSelect = lineForm.querySelector('select[name*="-unit"]');
    const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
    
    if (unitSelect) {
      // Load units if item is already selected (for edit mode)
      if (itemSelect.value) {
        updateUnitChoices(itemSelect, unitSelect);
      }
      
      // Attach change handler for units
      itemSelect.addEventListener('change', function() {
        updateUnitChoices(itemSelect, unitSelect);
      });
    }
    
    if (warehouseSelect) {
      // Load warehouses if item is already selected (for edit mode)
      if (itemSelect.value) {
        updateWarehouseChoices(itemSelect, warehouseSelect);
      }
      
      // Attach change handler for warehouses
      itemSelect.addEventListener('change', function() {
        updateWarehouseChoices(itemSelect, warehouseSelect);
      });
    }
  });
  
  // Attach item change handlers for single-line forms (like ReceiptTemporary)
  // Handle forms without lines_formset (single-line forms)
  const singleItemSelect = document.querySelector('select[name="item"]:not([name*="-"])');
  if (singleItemSelect) {
    // Make sure we're not inside a line-form (to avoid duplicates)
    if (!singleItemSelect.closest('.line-form')) {
      const singleUnitSelect = document.querySelector('select[name="unit"]:not([name*="-"])');
      const singleWarehouseSelect = document.querySelector('select[name="warehouse"]:not([name*="-"])');
      
      if (singleUnitSelect && !singleUnitSelect.closest('.line-form')) {
        // Load units if item is already selected (for edit mode)
        if (singleItemSelect.value) {
          updateUnitChoices(singleItemSelect, singleUnitSelect);
        }
        
        // Attach change handler
        singleItemSelect.addEventListener('change', function() {
          updateUnitChoices(singleItemSelect, singleUnitSelect);
        });
      }
      
      // Handle warehouse filtering for single-line forms
      if (singleWarehouseSelect && !singleWarehouseSelect.closest('.line-form')) {
        // Load allowed warehouses if item is already selected (for edit mode)
        if (singleItemSelect.value) {
          updateWarehouseChoices(singleItemSelect, singleWarehouseSelect);
        }
        
        // Attach change handler for warehouse filtering
        singleItemSelect.addEventListener('change', function() {
          updateWarehouseChoices(singleItemSelect, singleWarehouseSelect);
        });
      }
    }
  }
  
  // Handle temporary_receipt auto-fill for permanent receipts
  const temporaryReceiptSelect = document.querySelector('select[name="temporary_receipt"]');
  if (temporaryReceiptSelect && formsetContainer && totalFormsInput && addLineBtn) {
    temporaryReceiptSelect.addEventListener('change', function() {
      const tempReceiptId = this.value;
      
      if (!tempReceiptId) {
        return; // No temporary receipt selected
      }
      
      
      // Fetch temporary receipt data
      fetch(temporaryReceiptDataUrl + '?temporary_receipt_id=' + tempReceiptId)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error('Error fetching temporary receipt data:', data.error);
            alert('     : ' + data.error);
            return;
          }
          
          
          // Check if a line with this item already exists
          const existingLine = formsetContainer.querySelector(`select[name*="-item"][value="${data.item_id}"]`);
          if (existingLine) {
            // If line exists, update it
            const lineForm = existingLine.closest('.line-form');
            if (lineForm) {
              // Update existing line
              const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
              const quantityInput = lineForm.querySelector('input[name*="-quantity"]');
              const unitSelect = lineForm.querySelector('select[name*="-unit"]');
              const supplierSelect = lineForm.querySelector('select[name*="-supplier"]');
              
              if (warehouseSelect && data.warehouse_id) {
                warehouseSelect.value = data.warehouse_id;
                // Trigger warehouse change to update units if needed
                if (warehouseSelect.dispatchEvent) {
                  warehouseSelect.dispatchEvent(new Event('change'));
                }
              }
              
              if (quantityInput && data.entered_quantity) {
                quantityInput.value = data.entered_quantity;
              }
              
              if (unitSelect && data.entered_unit) {
                // First, update units for the item
                if (existingLine && typeof updateUnitChoices === 'function') {
                  updateUnitChoices(existingLine, unitSelect);
                  // Then set the unit after units are loaded
                  setTimeout(() => {
                    unitSelect.value = data.entered_unit;
                  }, 300);
                }
              }
              
              if (supplierSelect && data.supplier_id) {
                supplierSelect.value = data.supplier_id;
              }
              
              return;
            }
          }
          
          // Add new line with temporary receipt data
          const totalForms = parseInt(totalFormsInput.value);
          const newFormIndex = totalForms;
          
          // Clone the last form (or first if none exists)
          const lastForm = formsetContainer.querySelector('.line-form:last-child');
          if (!lastForm) {
            console.error('No line form found to clone');
            return;
          }
          
          const newForm = lastForm.cloneNode(true);
          
          // Update form indices
          newForm.querySelectorAll('input, select, textarea').forEach(function(input) {
            const name = input.name;
            if (name) {
              input.name = name.replace(/-(\d+)-/, '-' + newFormIndex + '-');
              input.id = input.id ? input.id.replace(/-(\d+)-/, '-' + newFormIndex + '-') : '';
            }
          });
          
          // Update line number
          const lineHeader = newForm.querySelector('.line-header h4');
          if (lineHeader) {
            lineHeader.textContent = '{% trans "Line" %} ' + (newFormIndex + 1);
          }
          
          // Reset delete checkbox
          const deleteCheckbox = newForm.querySelector('input[type="checkbox"][name*="DELETE"]');
          if (deleteCheckbox) {
            deleteCheckbox.checked = false;
            newForm.classList.remove('deleted');
          }
          
          // Set values from temporary receipt
          const itemSelect = newForm.querySelector('select[name*="-item"]');
          const warehouseSelect = newForm.querySelector('select[name*="-warehouse"]');
          const quantityInput = newForm.querySelector('input[name*="-quantity"]');
          const unitSelect = newForm.querySelector('select[name*="-unit"]');
          const supplierSelect = newForm.querySelector('select[name*="-supplier"]');
          
          if (itemSelect && data.item_id) {
            itemSelect.value = data.item_id;
            
            // Load units for the item
            if (unitSelect && typeof updateUnitChoices === 'function') {
              updateUnitChoices(itemSelect, unitSelect);
              
              // Set unit after units are loaded
              setTimeout(() => {
                if (data.entered_unit) {
                  // Try to find the unit in the options
                  const unitOption = Array.from(unitSelect.options).find(opt => opt.value === data.entered_unit);
                  if (unitOption) {
                    unitSelect.value = data.entered_unit;
                  } else {
                    // If unit not found, create a new option
                    const option = document.createElement('option');
                    option.value = data.entered_unit;
                    option.textContent = data.entered_unit;
                    unitSelect.appendChild(option);
                    unitSelect.value = data.entered_unit;
                  }
                }
              }, 300);
            }
            
            // Load warehouses for the item
            if (warehouseSelect && typeof updateWarehouseChoices === 'function') {
              updateWarehouseChoices(itemSelect, warehouseSelect);
              
              // Set warehouse after warehouses are loaded
              setTimeout(() => {
                if (data.warehouse_id) {
                  warehouseSelect.value = data.warehouse_id;
                }
              }, 300);
            }
          }
          
          if (quantityInput && data.entered_quantity) {
            quantityInput.value = data.entered_quantity;
          }
          
          if (supplierSelect && data.supplier_id) {
            supplierSelect.value = data.supplier_id;
          }
          
          // Add to container
          formsetContainer.appendChild(newForm);
          
          // Update total forms
          totalFormsInput.value = totalForms + 1;
          
          // Re-attach event handlers for the new line
          if (deleteCheckbox) {
            deleteCheckbox.addEventListener('change', function() {
              const lineForm = this.closest('.line-form');
              if (this.checked) {
                lineForm.classList.add('deleted');
              } else {
                lineForm.classList.remove('deleted');
              }
            });
          }
          
          if (itemSelect && unitSelect) {
            itemSelect.addEventListener('change', function() {
              updateUnitChoices(itemSelect, unitSelect);
            });
          }
          
          if (itemSelect && warehouseSelect) {
            itemSelect.addEventListener('change', function() {
              updateWarehouseChoices(itemSelect, warehouseSelect);
            });
          }
          
        })
        .catch(error => {
          console.error('Error fetching temporary receipt data:', error);
          alert('     ');
        });
    });
  }
  
  // Add new line functionality
  if (addLineBtn && totalFormsInput) {
    addLineBtn.addEventListener('click', function() {
      const totalForms = parseInt(totalFormsInput.value);
      const newFormIndex = totalForms;
      
      // Clone the last form
      const lastForm = formsetContainer.querySelector('.line-form:last-child');
      if (!lastForm) return;
      
      const newForm = lastForm.cloneNode(true);
      
      // Update form indices
      newForm.querySelectorAll('input, select, textarea').forEach(function(input) {
        const name = input.name;
        if (name) {
          input.name = name.replace(/-(\d+)-/, '-' + newFormIndex + '-');
          input.id = input.id ? input.id.replace(/-(\d+)-/, '-' + newFormIndex + '-') : '';
        }
      });
      
      // Clear values
      newForm.querySelectorAll('input[type="text"], input[type="number"], select, textarea').forEach(function(input) {
        if (input.type !== 'checkbox' && input.type !== 'hidden') {
          input.value = '';
        }
      });
      
      // Update line number
      const lineHeader = newForm.querySelector('.line-header h4');
      if (lineHeader) {
        lineHeader.textContent = '{% trans "Line" %} ' + (newFormIndex + 1);
      }
      
      // Reset delete checkbox
      const deleteCheckbox = newForm.querySelector('input[type="checkbox"][name*="DELETE"]');
      if (deleteCheckbox) {
        deleteCheckbox.checked = false;
        newForm.classList.remove('deleted');
      }
      
      // Add to container
      formsetContainer.appendChild(newForm);
      
      // Update total forms
      totalFormsInput.value = totalForms + 1;
      
      // Re-attach event handlers
      if (deleteCheckbox) {
        deleteCheckbox.addEventListener('change', function() {
          const lineForm = this.closest('.line-form');
          if (this.checked) {
            lineForm.classList.add('deleted');
          } else {
            lineForm.classList.remove('deleted');
          }
        });
      }
      
      const newItemSelect = newForm.querySelector('select[name*="-item"]');
      const newUnitSelect = newForm.querySelector('select[name*="-unit"]');
      if (newItemSelect && newUnitSelect) {
        const newWarehouseSelect = newForm.querySelector('select[name*="-warehouse"]');
        
        if (newItemSelect && newUnitSelect) {
          newItemSelect.addEventListener('change', function() {
            updateUnitChoices(newItemSelect, newUnitSelect);
          });
        }
        
        if (newItemSelect && newWarehouseSelect) {
          newItemSelect.addEventListener('change', function() {
            updateWarehouseChoices(newItemSelect, newWarehouseSelect);
            // Update serial button visibility when item changes
            if (typeof updateSerialButtonVisibility === 'function') {
              updateSerialButtonVisibility(newForm);
            }
          });
          
          newWarehouseSelect.addEventListener('change', function() {
            // Update serial button visibility when warehouse changes
            if (typeof updateSerialButtonVisibility === 'function') {
              updateSerialButtonVisibility(newForm);
            }
            
            // Update work lines if destination type is work_line
            const choiceSelect = newForm.querySelector('select[id*="destination_type_choice"]');
            const workLineField = newForm.querySelector('select[id*="destination_work_line"]');
            if (choiceSelect && choiceSelect.value === 'work_line' && workLineField && typeof updateWorkLineChoices === 'function') {
              updateWorkLineChoices(newWarehouseSelect, workLineField);
            }
          });
        }
        
        // Attach serial selection button handler for new form
        const newSelectSerialsBtn = newForm.querySelector('.select-serials-btn');
        if (newSelectSerialsBtn && typeof openSerialModal === 'function') {
          newSelectSerialsBtn.addEventListener('click', function() {
            openSerialModal(newForm);
          });
        }
        
        // Handle destination type choice for new form
        const newChoiceSelect = newForm.querySelector('select[id*="destination_type_choice"]');
        if (newChoiceSelect) {
          const newCompanyUnitField = newForm.querySelector('select[id*="destination_company_unit"]');
          const newCompanyUnitFieldContainer = newCompanyUnitField ? newCompanyUnitField.closest('.destination-company-unit-field') : null;
          const newWorkLineField = newForm.querySelector('select[id*="destination_work_line"]');
          const newWorkLineFieldContainer = newWorkLineField ? newWorkLineField.closest('.destination-work-line-field') : null;
          const newWarehouseSelect = newForm.querySelector('select[name*="-warehouse"]');
          const newConsumptionTypeHidden = newForm.querySelector('input[name*="-consumption_type"]');
          
          function toggleFieldsForNewForm() {
            const value = newChoiceSelect.value;
            
            // Update hidden consumption_type field
            if (newConsumptionTypeHidden) {
              newConsumptionTypeHidden.value = value;
            }
            
            if (newCompanyUnitFieldContainer) {
              newCompanyUnitFieldContainer.style.display = (value === 'company_unit') ? 'block' : 'none';
              if (value !== 'company_unit' && newCompanyUnitField) {
                newCompanyUnitField.value = '';
              }
            }
            if (newWorkLineFieldContainer) {
              newWorkLineFieldContainer.style.display = (value === 'work_line') ? 'block' : 'none';
              if (value !== 'work_line' && newWorkLineField) {
                newWorkLineField.value = '';
              } else if (value === 'work_line' && newWarehouseSelect && newWorkLineField && typeof updateWorkLineChoices === 'function') {
                // When work_line is selected, update work lines based on warehouse
                updateWorkLineChoices(newWarehouseSelect, newWorkLineField);
              }
            }
          }
          
          // Initial toggle
          toggleFieldsForNewForm();
          
          // Add change handler
          newChoiceSelect.addEventListener('change', toggleFieldsForNewForm);
          
          // Update work lines when warehouse changes (only if work_line is selected)
          if (newWarehouseSelect && newWorkLineField) {
            newWarehouseSelect.addEventListener('change', function() {
              if (newChoiceSelect.value === 'work_line' && typeof updateWorkLineChoices === 'function') {
                updateWorkLineChoices(newWarehouseSelect, newWorkLineField);
              }
            });
          }
        }
        
        // Initial check for serial button visibility
        if (typeof updateSerialButtonVisibility === 'function') {
          updateSerialButtonVisibility(newForm);
        }
      }
      
      // Add search to new selects
      newForm.querySelectorAll('select').forEach(addSearchToSelect);
    });
  }
  
  // Serial selection modal and functionality for issue lines (new lines only)
  const serialChoicesUrl = '{% url "inventory:item_available_serials" %}';
  
  // Create modal HTML
  const modalHTML = `
    <div id="serial-selection-modal" class="serial-modal" style="display: none;">
      <div class="serial-modal-overlay"></div>
      <div class="serial-modal-content">
        <div class="serial-modal-header">
          <h3>{% trans "Select Serial Numbers" %}</h3>
          <button type="button" class="serial-modal-close">&times;</button>
        </div>
        <div class="serial-modal-body">
          <p class="serial-modal-info">{% trans "Select serial numbers for this item:" %}</p>
          <div id="serial-checkboxes-container" class="serial-checkboxes-container">
            <p>{% trans "Loading..." %}</p>
          </div>
        </div>
        <div class="serial-modal-footer">
          <button type="button" class="btn btn-secondary serial-modal-cancel">{% trans "Cancel" %}</button>
          <button type="button" class="btn btn-primary serial-modal-save">{% trans "Save" %}</button>
        </div>
      </div>
    </div>
  `;
  
  // Insert modal into page
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  const modal = document.getElementById('serial-selection-modal');
  const modalOverlay = modal.querySelector('.serial-modal-overlay');
  const modalClose = modal.querySelector('.serial-modal-close');
  const modalCancel = modal.querySelector('.serial-modal-cancel');
  const modalSave = modal.querySelector('.serial-modal-save');
  const serialCheckboxesContainer = document.getElementById('serial-checkboxes-container');
  
  let currentLineForm = null;
  let currentSerialData = [];
  let currentSelectedSerials = new Set();
  
  // Function to open modal
  function openSerialModal(lineForm) {
    currentLineForm = lineForm;
    const itemSelect = lineForm.querySelector('select[name*="-item"]');
    const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
    const selectedSerialsInput = lineForm.querySelector('.selected-serials-input');
    
    if (!itemSelect || !itemSelect.value || !warehouseSelect || !warehouseSelect.value) {
      alert('{% trans "Please select both Item and Warehouse first." %}');
      return;
    }
    
    // Get previously selected serials
    currentSelectedSerials = new Set();
    if (selectedSerialsInput && selectedSerialsInput.value) {
      selectedSerialsInput.value.split(',').forEach(id => {
        if (id) currentSelectedSerials.add(id.trim());
      });
    }
    
    // Load serials from API
    serialCheckboxesContainer.innerHTML = '<p>{% trans "Loading..." %}</p>';
    modal.style.display = 'block';
    
    const url = serialChoicesUrl + '?item_id=' + itemSelect.value + '&warehouse_id=' + warehouseSelect.value;
    
    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          serialCheckboxesContainer.innerHTML = '<p class="error">' + data.error + '</p>';
          return;
        }
        
        if (!data.has_lot_tracking) {
          serialCheckboxesContainer.innerHTML = '<p>{% trans "This item does not require serial tracking." %}</p>';
          return;
        }
        
        if (data.serials && data.serials.length > 0) {
          currentSerialData = data.serials;
          let html = '<ul class="serial-checkboxes-list">';
          data.serials.forEach(function(serial) {
            const isChecked = currentSelectedSerials.has(serial.value);
            html += `
              <li>
                <label>
                  <input type="checkbox" value="${serial.value}" ${isChecked ? 'checked' : ''}>
                  ${serial.label}
                  ${serial.status === 'reserved' ? '<span class="serial-status-badge">({% trans "Reserved" %})</span>' : ''}
                </label>
              </li>
            `;
          });
          html += '</ul>';
          serialCheckboxesContainer.innerHTML = html;
        } else {
          serialCheckboxesContainer.innerHTML = '<p>{% trans "No available serials found for this item in the selected warehouse." %}</p>';
        }
      })
      .catch(error => {
        console.error('Error loading serials:', error);
        serialCheckboxesContainer.innerHTML = '<p class="error">{% trans "Error loading serials. Please try again." %}</p>';
      });
  }
  
  // Function to close modal
  function closeSerialModal() {
    modal.style.display = 'none';
    currentLineForm = null;
    currentSerialData = [];
  }
  
  // Function to save selected serials
  function saveSelectedSerials() {
    if (!currentLineForm) return;
    
    const checkboxes = serialCheckboxesContainer.querySelectorAll('input[type="checkbox"]:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    
    const selectedSerialsInput = currentLineForm.querySelector('.selected-serials-input');
    const selectedSerialsCount = currentLineForm.querySelector('.selected-serials-count');
    
    if (selectedSerialsInput) {
      selectedSerialsInput.value = selectedIds.join(',');
    }
    
    if (selectedSerialsCount) {
      selectedSerialsCount.textContent = selectedIds.length;
    }
    
    closeSerialModal();
  }
  
  // Event listeners for modal
  modalClose.addEventListener('click', closeSerialModal);
  modalCancel.addEventListener('click', closeSerialModal);
  modalOverlay.addEventListener('click', closeSerialModal);
  modalSave.addEventListener('click', saveSelectedSerials);
  
  // Show/hide serial selection button based on item and warehouse selection
  function updateSerialButtonVisibility(lineForm) {
    const itemSelect = lineForm.querySelector('select[name*="-item"]');
    const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
    const serialSection = lineForm.querySelector('.serial-assignment-section[data-line-index]');
    
    if (!serialSection || !itemSelect || !warehouseSelect) return;
    
    if (itemSelect.value && warehouseSelect.value) {
      // Check if item has lot tracking by calling API
      const url = serialChoicesUrl + '?item_id=' + itemSelect.value + '&warehouse_id=' + warehouseSelect.value;
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.has_lot_tracking && data.count > 0) {
            serialSection.style.display = 'flex';
          } else {
            serialSection.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error checking lot tracking:', error);
          serialSection.style.display = 'none';
        });
    } else {
      serialSection.style.display = 'none';
    }
  }
  
  // Attach event listeners for serial selection
  document.querySelectorAll('.line-form').forEach(function(lineForm) {
    // Check if this is an issue form and line doesn't have PK yet
    if (!lineForm.querySelector('.serial-assignment-section[data-line-index]')) return;
    
    const selectSerialsBtn = lineForm.querySelector('.select-serials-btn');
    if (selectSerialsBtn) {
      selectSerialsBtn.addEventListener('click', function() {
        openSerialModal(lineForm);
      });
    }
    
    const itemSelect = lineForm.querySelector('select[name*="-item"]');
    const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
    
    if (itemSelect && warehouseSelect) {
      // Update visibility when item or warehouse changes
      itemSelect.addEventListener('change', function() {
        updateSerialButtonVisibility(lineForm);
      });
      
      warehouseSelect.addEventListener('change', function() {
        updateSerialButtonVisibility(lineForm);
      });
      
      // Initial check (this will show the button if item and warehouse are already selected)
      updateSerialButtonVisibility(lineForm);
      
      // Restore selected serials count from hidden input (for form re-renders after errors)
      const selectedSerialsInput = lineForm.querySelector('.selected-serials-input');
      const selectedSerialsCount = lineForm.querySelector('.selected-serials-count');
      if (selectedSerialsInput && selectedSerialsCount && selectedSerialsInput.value) {
        const serialIds = selectedSerialsInput.value.split(',').filter(id => id.trim());
        selectedSerialsCount.textContent = serialIds.length;
      }
    }
  });
  
  // Also initialize after form submission errors (when page re-renders)
  // This handles the case when validation fails and form is re-rendered with errors
  // Wait a bit for DOM to be fully ready after error rendering
  setTimeout(function() {
    document.querySelectorAll('.line-form').forEach(function(lineForm) {
      const itemSelect = lineForm.querySelector('select[name*="-item"]');
      const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
      
      if (itemSelect && warehouseSelect && itemSelect.value && warehouseSelect.value) {
        // Check if serial button is hidden and should be shown
        const serialSection = lineForm.querySelector('.serial-assignment-section[data-line-index]');
        if (serialSection && serialSection.style.display === 'none') {
          updateSerialButtonVisibility(lineForm);
        }
        
        // Restore selected serials count from hidden input (for form re-renders after errors)
        const selectedSerialsInput = lineForm.querySelector('.selected-serials-input');
        const selectedSerialsCount = lineForm.querySelector('.selected-serials-count');
        if (selectedSerialsInput && selectedSerialsCount && selectedSerialsInput.value) {
          const serialIds = selectedSerialsInput.value.split(',').filter(id => id.trim());
          selectedSerialsCount.textContent = serialIds.length;
        }
      }
    });
  }, 300);
  
  // Handle destination type choice for Consumption Issues
  const workLinesUrl = '{% url "inventory:warehouse_work_lines" %}';
  
  // Function to update work lines based on selected warehouse
  function updateWorkLineChoices(warehouseSelect, workLineSelect) {
    const warehouseId = warehouseSelect.value;
    if (!warehouseId || !workLineSelect) {
      if (workLineSelect) {
        workLineSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
      }
      return;
    }
    
    // Show loading state
    workLineSelect.disabled = true;
    const currentValue = workLineSelect.value;
    workLineSelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
    
    const url = workLinesUrl + '?warehouse_id=' + warehouseId;
    
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          console.error('Error fetching work lines:', data.error);
          workLineSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
          workLineSelect.disabled = false;
          return;
        }
        
        workLineSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
        
        if (data.work_lines && data.work_lines.length > 0) {
          data.work_lines.forEach(function(workLine) {
            const option = document.createElement('option');
            option.value = workLine.value;
            option.textContent = workLine.label;
            if (workLine.value === currentValue) {
              option.selected = true;
            }
            workLineSelect.appendChild(option);
          });
        }
        
        workLineSelect.disabled = false;
      })
      .catch(error => {
        console.error('Error loading work lines:', error);
        workLineSelect.innerHTML = '<option value="">--- {% trans "Select" %} ---</option>';
        workLineSelect.disabled = false;
      });
  }
  
  // Handle destination type choice for Consumption Issues
  document.querySelectorAll('.line-form').forEach(function(lineForm) {
    const choiceSelect = lineForm.querySelector('select[id*="destination_type_choice"]');
    if (!choiceSelect) return;
    
    const companyUnitField = lineForm.querySelector('select[id*="destination_company_unit"]');
    const companyUnitFieldContainer = companyUnitField ? companyUnitField.closest('.destination-company-unit-field') : null;
    const workLineField = lineForm.querySelector('select[id*="destination_work_line"]');
    const workLineFieldContainer = workLineField ? workLineField.closest('.destination-work-line-field') : null;
    const warehouseSelect = lineForm.querySelector('select[name*="-warehouse"]');
    const consumptionTypeHidden = lineForm.querySelector('input[name*="-consumption_type"]');
    
    
    function toggleFields() {
      const value = choiceSelect.value;
      
      // Update hidden consumption_type field
      if (consumptionTypeHidden) {
        consumptionTypeHidden.value = value;
      }
      
      if (companyUnitFieldContainer) {
        companyUnitFieldContainer.style.display = (value === 'company_unit') ? 'block' : 'none';
        if (value !== 'company_unit' && companyUnitField) {
          companyUnitField.value = '';
        }
      }
      if (workLineFieldContainer) {
        workLineFieldContainer.style.display = (value === 'work_line') ? 'block' : 'none';
        if (value !== 'work_line' && workLineField) {
          workLineField.value = '';
        } else if (value === 'work_line' && warehouseSelect && workLineField) {
          // When work_line is selected, update work lines based on warehouse
          updateWorkLineChoices(warehouseSelect, workLineField);
        }
      }
    }
    
    // Initial toggle based on current value
    toggleFields();
    
    // Add change handler
    choiceSelect.addEventListener('change', toggleFields);
    
    // Update work lines when warehouse changes (only if work_line is selected)
    if (warehouseSelect && workLineField) {
      warehouseSelect.addEventListener('change', function() {
        if (choiceSelect.value === 'work_line') {
          updateWorkLineChoices(warehouseSelect, workLineField);
        }
      });
    }
  });
  
});

</script>
{% endblock %}

