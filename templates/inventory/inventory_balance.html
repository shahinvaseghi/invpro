{% extends "inventory/base.html" %}
{% load i18n jalali_tags %}
{% load static %}

{% block page_title %}{% trans "Inventory Balance" %}{% endblock %}

{% block breadcrumb_extra %}
<span class="separator">/</span>
<span>{% trans "Inventory Balance" %}</span>
{% endblock %}

{% block page_actions %}
<div class="page-actions">
  <button class="btn btn-secondary btn-print" data-action="print">
    {% trans "Print" %}
  </button>
  <button type="button" id="export-excel-btn" class="btn btn-success" data-table-id="balanceTable">
    {% trans "Export" %} Excel
  </button>
</div>
{% endblock %}

{% block inventory_content %}
{% if messages %}
  {% for message in messages %}
    {% if message.tags == 'success' %}
      {% if 'Access level' not in message|safe %}
        <div class="alert alert-success">
          {{ message }}
        </div>
      {% endif %}
    {% else %}
      <div class="alert alert-{{ message.tags }}">
        {{ message }}
      </div>
    {% endif %}
  {% endfor %}
{% endif %}
<!-- Filter Panel -->
<div class="filter-panel">
  <h3>{% trans "Filter" %}</h3>
  <form method="get" action="" class="filter-form">
    <div class="form-group">
      <label for="warehouse_id">{% trans "Select Warehouse" %}</label>
      <select name="warehouse_id" id="warehouse_id" class="form-control" required>
        <option value="">-- {% trans "Select Warehouse" %} --</option>
        {% for warehouse in warehouses %}
        <option value="{{ warehouse.id }}" {% if warehouse.id|stringformat:"s" == selected_warehouse_id %}selected{% endif %}>
          {{ warehouse.public_code }} - {{ warehouse.name }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label for="item_type_id">{% trans "Select Item Type" %}</label>
      <select name="item_type_id" id="item_type_id" class="form-control">
        <option value="">-- {% trans "All Types" %} --</option>
        {% for item_type in item_types %}
        <option value="{{ item_type.id }}" {% if item_type.id|stringformat:"s" == selected_item_type_id %}selected{% endif %}>
          {{ item_type.public_code }} - {{ item_type.name }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label for="item_category_id">{% trans "Select Category" %}</label>
      <select name="item_category_id" id="item_category_id" class="form-control">
        <option value="">-- {% trans "All Categories" %} --</option>
        {% for category in item_categories %}
        <option value="{{ category.id }}" {% if category.id|stringformat:"s" == selected_item_category_id %}selected{% endif %}>
          {{ category.public_code }} - {{ category.name }}
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Hidden date field - automatically set to today -->
    <input type="hidden" name="as_of_date" id="as_of_date" value="{{ as_of_date|date:'Y-m-d' }}">

    <div class="form-group align-end">
      <button type="submit" class="btn btn-primary btn-full-width">
        {% trans "Calculate" %}
      </button>
    </div>
  </form>
</div>

<!-- Stats Summary -->
{% if balances %}
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-label">{% trans "Total Items" %}</div>
    <div class="stat-value">{{ total_items }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">{% trans "Total Balance" %}</div>
    <div class="stat-value">{{ total_balance_value|floatformat:2 }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">{% trans "Last Calculated" %}</div>
    <div class="stat-value stat-value-sm">{{ as_of_date|jalali_date }}</div>
  </div>
</div>

<!-- Balance Table -->
<div class="data-table-container">
  <table class="data-table" id="balanceTable">
    <thead>
      <tr>
        <th>{% trans "Item Code" %}</th>
        <th>{% trans "Item Name" %}</th>
        <th>{% trans "Baseline Date" %}</th>
        <th>{% trans "Baseline Quantity" %}</th>
        <th>{% trans "Receipts Total" %}</th>
        <th>{% trans "Issues Total" %}</th>
        <th>{% trans "Current Balance" %}</th>
        <th>{% trans "Actions" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for balance in balances %}
      <tr>
        <td><code>{{ balance.item_code }}</code></td>
        <td>{{ balance.item_name }}</td>
        <td>
          {% if balance.baseline_date %}
            {{ balance.baseline_date|jalali_date }}
          {% else %}
            <span class="badge badge-draft">{% trans "No Stocktaking" %}</span>
          {% endif %}
        </td>
        <td class="table-cell-right">{{ balance.baseline_quantity|floatformat:2 }}</td>
        <td class="table-cell-positive">+{{ balance.receipts_total|floatformat:2 }}</td>
        <td class="table-cell-negative">-{{ balance.issues_total|floatformat:2 }}</td>
        <td class="table-cell-bold">
          {% if balance.current_balance < 0 %}
            <span class="table-cell-negative">{{ balance.current_balance|floatformat:2 }}</span>
          {% elif balance.current_balance == 0 %}
            <span class="table-cell-neutral">{{ balance.current_balance|floatformat:2 }}</span>
          {% else %}
            <span class="table-cell-positive">{{ balance.current_balance|floatformat:2 }}</span>
          {% endif %}
        </td>
        <td>
          <a href="{% url 'inventory:balance_details' balance.item_id balance.warehouse_id %}?as_of_date={{ as_of_date|date:'Y-m-d' }}" 
             class="btn btn-secondary btn-xs">
            {% trans "Details" %}
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% elif selected_warehouse_id %}
<div class="empty-state">
  <div class="empty-state-icon">üì¶</div>
  <h3>{% trans "No Items Found" %}</h3>
  <p>{% trans "No items with inventory activity found for the selected filters." %}</p>
</div>
{% else %}
<div class="empty-state">
  <div class="empty-state-icon">üè¢</div>
  <h3>{% trans "Select a Warehouse" %}</h3>
  <p>{% trans "Please select a warehouse to view inventory balances." %}</p>
</div>
{% endif %}

{% if error %}
<div class="alert alert-error mt-2">
  <strong>{% trans "Error" %}:</strong> {{ error }}
</div>
{% endif %}
{% endblock %}

{% block inventory_scripts %}
<script src="{% static 'js/table-export.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const exportBtn = document.getElementById('export-excel-btn');
  if (exportBtn && typeof exportTableToExcel === 'function') {
    exportBtn.addEventListener('click', function() {
      const tableId = this.getAttribute('data-table-id');
      const filename = 'inventory_balance_' + new Date().toISOString().split('T')[0];
      exportTableToExcel(tableId, filename);
    });
  }
});
</script>
<script src="{% static 'js/common-actions.js' %}"></script>
{% endblock %}

