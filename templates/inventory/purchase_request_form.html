{% extends "inventory/base.html" %}
{% load i18n %}
{% load static %}

{% block page_title %}{{ form_title }}{% endblock %}

{% block inventory_styles %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/shared.css' %}">
<link rel="stylesheet" href="{% static 'css/formset-table.css' %}">
{% endblock %}

{% block inventory_content %}
<div class="form-container form-container-narrow">
  <form method="post" class="entity-form">
    {% csrf_token %}
    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
    
    {% if form.non_field_errors %}
      <div class="alert alert-error">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    {% for section_title, section_fields in fieldsets %}
      <div class="form-section">
        <h3>{{ section_title }}</h3>
        <div class="form-row">
          {% for field in section_fields %}
            <div class="form-field">
              <label for="{{ field.id_for_label }}">
                {{ field.label }}
                {% if field.field.required and not field.field.widget.attrs.readonly %}*{% endif %}
              </label>
              {{ field }}
              {% if field.errors %}
                <span class="error">{{ field.errors.0 }}</span>
              {% endif %}
              {% if field.help_text %}
                <small class="form-text">{{ field.help_text }}</small>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}

    {% for field in form.visible_fields %}
      {% if field.name not in used_fields %}
      <div class="form-section">
        <div class="form-row">
          <div class="form-field">
            <label for="{{ field.id_for_label }}">
              {{ field.label }}
              {% if field.field.required and not field.field.widget.attrs.readonly %}*{% endif %}
            </label>
            {{ field }}
            {% if field.errors %}
              <span class="error">{{ field.errors.0 }}</span>
            {% endif %}
            {% if field.help_text %}
              <small class="form-text">{{ field.help_text }}</small>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %}

    {% if lines_formset %}
    <div class="form-section">
      <div>
        <h3 class="no-margin">{% trans "Request Lines" %}</h3>
        <p class="form-text form-text-mt no-margin">
          {% trans "Add one or more items to this purchase request. Each line represents a single item with its quantity." %}
        </p>
      </div>
      
{% if lines_formset.non_form_errors %}
        <div class="alert alert-danger">
          {% for error in lines_formset.non_form_errors %}
            <div>{{ error }}</div>
          {% endfor %}
        </div>
      {% endif %}
      {{ lines_formset.management_form }}
      {% for hidden in lines_formset.hidden_fields %}{{ hidden }}{% endfor %}

      <div class="lines-formset" id="lines-formset" data-can-delete="{% if lines_formset.can_delete %}true{% else %}false{% endif %}">image.png
        <div class="lines-table-header">
          <div class="line-cell line-number">#</div>
          <div class="line-cell line-item">{% trans "Item" %} *</div>
          <div class="line-cell line-unit">{% trans "Unit" %} *</div>
          <div class="line-cell line-quantity">{% trans "Quantity" %} *</div>
          <div class="line-cell line-notes">{% trans "Notes" %}</div>
          {% if lines_formset.can_delete %}
          <div class="line-cell line-delete-header">{% trans "Delete" %}</div>
          {% endif %}
        </div>
        {% for line_form in lines_formset %}
          {% if not form.instance.pk %}
            {# Create mode: only show first empty form (extra=1) #}
            {% if forloop.counter0 < 1 %}
          <div class="line-row" data-form-index="{{ forloop.counter0 }}">
            {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}
            
            <div class="line-cell line-number">{{ forloop.counter }}</div>
            
            <div class="line-cell line-item">
              <div class="item-select-wrapper">
                <div class="item-filters">
                  <select class="form-control filter-type-select" data-form-index="{{ forloop.counter0 }}">
                    <option value="">{% trans "Type" %}</option>
                    {% for item_type in item_types %}
                    <option value="{{ item_type.id }}" {% if current_item_type == item_type.id|stringformat:"s" %}selected{% endif %}>{{ item_type.name }}</option>
                    {% endfor %}
                  </select>
                  <select class="form-control filter-category-select" data-form-index="{{ forloop.counter0 }}">
                    <option value="">{% trans "Category" %}</option>
                    {% for category in item_categories %}
                    <option value="{{ category.id }}" {% if current_category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                  </select>
                  <select class="form-control filter-subcategory-select" data-form-index="{{ forloop.counter0 }}">
                    <option value="">{% trans "Subcategory" %}</option>
                    {% for subcategory in item_subcategories %}
                    <option value="{{ subcategory.id }}" {% if current_subcategory == subcategory.id|stringformat:"s" %}selected{% endif %}>{{ subcategory.name }}</option>
                    {% endfor %}
                  </select>
                  <input type="text" class="form-control filter-search-input filter-search-input-flex" data-form-index="{{ forloop.counter0 }}" 
                         placeholder="{% trans 'Search by name or code...' %}" 
                         value="{{ current_item_search }}">
                </div>
                {{ line_form.item }}
                {% if line_form.item.errors %}
                  <span class="error">{{ line_form.item.errors.0 }}</span>
                {% endif %}
              </div>
            </div>

            <div class="line-cell line-unit">
              {{ line_form.unit }}
              {% if line_form.unit.errors %}
                <span class="error">{{ line_form.unit.errors.0 }}</span>
              {% endif %}
            </div>

            <div class="line-cell line-quantity">
              {{ line_form.quantity_requested }}
              {% if line_form.quantity_requested.errors %}
                <span class="error">{{ line_form.quantity_requested.errors.0 }}</span>
              {% endif %}
            </div>

            <div class="line-cell line-notes">
              {{ line_form.line_notes }}
              {% if line_form.line_notes.errors %}
                <span class="error">{{ line_form.line_notes.errors.0 }}</span>
              {% endif %}
            </div>

            {% if lines_formset.can_delete %}
            <div class="line-cell line-delete">
              {{ line_form.DELETE }}
            </div>
            {% endif %}
            
            {% if line_form.non_field_errors %}
              <div class="error full-width">{{ line_form.non_field_errors|join:", " }}</div>
            {% endif %}
          </div>
            {% endif %}
          {% else %}
            {# Edit mode: show all existing lines #}
          <div class="line-row" data-form-index="{{ forloop.counter0 }}">
            {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}
            
            <div class="line-cell line-number">{{ forloop.counter }}</div>
            
            <div class="line-cell line-item">
              <div class="item-select-wrapper">
                <div class="item-filters">
                  <select class="form-control filter-type-select" data-form-index="{{ forloop.counter0 }}">
                    <option value="">{% trans "Type" %}</option>
                    {% for item_type in item_types %}
                    <option value="{{ item_type.id }}" {% if current_item_type == item_type.id|stringformat:"s" %}selected{% endif %}>{{ item_type.name }}</option>
                    {% endfor %}
                  </select>
                  <select class="form-control filter-category-select" data-form-index="{{ forloop.counter0 }}">
                    <option value="">{% trans "Category" %}</option>
                    {% for category in item_categories %}
                    <option value="{{ category.id }}" {% if current_category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                  </select>
                  <select class="form-control filter-subcategory-select" data-form-index="{{ forloop.counter0 }}">
                    <option value="">{% trans "Subcategory" %}</option>
                    {% for subcategory in item_subcategories %}
                    <option value="{{ subcategory.id }}" {% if current_subcategory == subcategory.id|stringformat:"s" %}selected{% endif %}>{{ subcategory.name }}</option>
                    {% endfor %}
                  </select>
                  <input type="text" class="form-control filter-search-input filter-search-input-flex" data-form-index="{{ forloop.counter0 }}" 
                         placeholder="{% trans 'Search by name or code...' %}" 
                         value="{{ current_item_search }}">
                </div>
                {{ line_form.item }}
                {% if line_form.item.errors %}
                  <span class="error">{{ line_form.item.errors.0 }}</span>
                {% endif %}
              </div>
            </div>

            <div class="line-cell line-unit">
              {{ line_form.unit }}
              {% if line_form.unit.errors %}
                <span class="error">{{ line_form.unit.errors.0 }}</span>
              {% endif %}
            </div>

            <div class="line-cell line-quantity">
              {{ line_form.quantity_requested }}
              {% if line_form.quantity_requested.errors %}
                <span class="error">{{ line_form.quantity_requested.errors.0 }}</span>
              {% endif %}
            </div>

            <div class="line-cell line-notes">
              {{ line_form.line_notes }}
              {% if line_form.line_notes.errors %}
                <span class="error">{{ line_form.line_notes.errors.0 }}</span>
              {% endif %}
            </div>

            {% if lines_formset.can_delete %}
            <div class="line-cell line-delete">
              {{ line_form.DELETE }}
            </div>
            {% endif %}
            
            {% if line_form.non_field_errors %}
              <div class="error full-width">{{ line_form.non_field_errors|join:", " }}</div>
            {% endif %}
          </div>
          {% endif %}
        {% endfor %}
      </div>
      
      <button type="button" id="add-line-btn" class="btn btn-success btn-add-line">
        <span class="btn-add-line-icon">+</span> {% trans "Add Line" %}
      </button>
    </div>
    {% endif %}

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">{% trans "Save" %}</button>
      <a href="{{ list_url }}" class="btn btn-secondary">{% trans "Cancel" %}</a>
    </div>
  </form>
</div>

{% load static %}
<script src="{% static 'js/formset.js' %}"></script>
<script src="{% static 'js/item-filters.js' %}"></script>
<script src="{% static 'js/formset-table.js' %}"></script>
<script>
// Configuration for item filters
const filterOptions = {
  placeholder: "{{ unit_placeholder|escapejs }}",
  allCategoriesText: "{% trans 'All Categories' %}",
  allSubcategoriesText: "{% trans 'All Subcategories' %}",
};

// Initialize line forms - update row numbers and setup filters
function initializeLineForms() {
  const formsetContainer = document.getElementById('lines-formset');
  if (!formsetContainer) return;
  
  formsetContainer.querySelectorAll('.line-row:not(.formset-template)').forEach(function(lineRow, index) {
    // Update row number
    const lineNumber = lineRow.querySelector('.line-number');
    if (lineNumber) {
      lineNumber.textContent = index + 1;
    }
    
    // Use shared item-filters.js function
    initializeItemFiltersForRow(lineRow, filterOptions);
  });
}

// Main initialization
document.addEventListener('DOMContentLoaded', function() {
  const formsetContainer = document.getElementById('lines-formset');
  if (!formsetContainer) return;
  
  // Initialize formset table layout
  initFormsetTableLayout(formsetContainer, {
    columnsWithDelete: '50px 3fr 1.5fr 1.5fr 2fr 2fr 80px',
    columnsWithoutDelete: '50px 3fr 1.5fr 1.5fr 2fr 2fr',
  });
  
  // Initialize existing rows
  setTimeout(function() {
    initializeLineForms();
  }, 100);
  
  // Setup formset management using formset.js
  const addLineBtn = document.getElementById('add-line-btn');
  const totalFormsInput = document.querySelector('input[name="lines-TOTAL_FORMS"]');
  
  if (addLineBtn && formsetContainer && totalFormsInput) {
    // Clone first row as template
    const firstRow = formsetContainer.querySelector('.line-row:not(.formset-template)');
    if (firstRow) {
      const templateRow = firstRow.cloneNode(true);
      templateRow.id = 'lines-formset-template';
      templateRow.style.display = 'none';
      templateRow.classList.add('formset-template');
      formsetContainer.appendChild(templateRow);
      
      // Initialize formset
      initFormset('lines', '#lines-formset-template', {
        minRows: 1,
        maxRows: null,
        addButtonSelector: '#add-line-btn',
        removeButtonSelector: 'input[name*="-DELETE"]'
      });
      
      // After adding row, initialize filters and update layout
      document.addEventListener('formset:row-added', function(e) {
        if (e.detail.prefix === 'lines') {
          setTimeout(function() {
            const newRow = e.detail.row;
            if (newRow) {
              // Update layout
              updateFormsetTableLayout(formsetContainer, {
                columnsWithDelete: '50px 3fr 1.5fr 1.5fr 2fr 2fr 80px',
                columnsWithoutDelete: '50px 3fr 1.5fr 1.5fr 2fr 2fr',
              });
              // Initialize filters for new row
              initializeItemFiltersForRow(newRow, filterOptions);
              // Re-index all rows
              initializeLineForms();
            }
          }, 50);
        }
      });
    }
  }
  
  // Handle delete checkboxes - update row numbers
  if (formsetContainer) {
    formsetContainer.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox' && e.target.name && e.target.name.includes('-DELETE')) {
        const lineRow = e.target.closest('.line-row');
        if (lineRow) {
          if (e.target.checked) {
            lineRow.classList.add('deleted');
          } else {
            lineRow.classList.remove('deleted');
          }
          // Reinitialize to update row numbers
          initializeLineForms();
        }
      }
    });
  }
});
</script>

<!-- Jalali DatePicker Library -->
<link rel="stylesheet" href="{% static 'css/jalali-datepicker/jalali-datepicker.min.css' %}">
<script src="{% static 'js/jalali-datepicker/jalali-datepicker.min.js' %}"></script>

<script>
// Initialize Jalali DatePicker for date inputs
document.addEventListener('DOMContentLoaded', function() {
  // Find all Jalali date inputs
  var jalaliInputs = document.querySelectorAll('input.jalali-date-input, input[data-jalali="true"]');
  
  jalaliInputs.forEach(function(input) {
    // Ensure data attributes are set
    if (!input.hasAttribute('data-jdp')) {
      input.setAttribute('data-jdp', '');
    }
    if (!input.hasAttribute('data-jdp-only-date')) {
      input.setAttribute('data-jdp-only-date', '');
    }
  });
  
  // Start watching for Jalali DatePicker initialization
  if (typeof jalaliDatepicker !== 'undefined') {
    jalaliDatepicker.startWatch({
      date: true,
      time: false,
      separatorChars: {
        date: '/',
        between: ' ',
        time: ':'
      },
      persianDigits: false,
      autoShow: true,
      autoHide: true,
      hideAfterChange: true,
      showTodayBtn: true,
      showEmptyBtn: true,
      showCloseBtn: true,
      useDropDownYears: true,
      zIndex: 1000
    });
  } else {
    console.error('Jalali DatePicker library not loaded!');
  }
});
</script>
{% endblock %}

