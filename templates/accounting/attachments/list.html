{% extends "base.html" %}
{% load static i18n %}

{% block title %}{% trans "ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø§Ø³Ù†Ø§Ø¯" %} - {% trans "Accounting" %}{% endblock %}

{% block content %}
<div class="page-container">
  <div class="page-header">
    <h1>{% trans "ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø§Ø³Ù†Ø§Ø¯" %}</h1>
    <nav class="breadcrumb">
      <a href="{% url 'ui:dashboard' %}">{% trans "Dashboard" %}</a>
      <span class="separator">/</span>
      <a href="{% url 'accounting:dashboard' %}">{% trans "Accounting" %}</a>
      <span class="separator">/</span>
      <span>{% trans "ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø§Ø³Ù†Ø§Ø¯" %}</span>
    </nav>
  </div>

  <!-- Filters -->
  <div class="content-section">
    <form method="get" class="filter-form">
      <div class="filter-row">
        <div class="filter-field">
          <label>{{ filter_form.document_number.label }}</label>
          {{ filter_form.document_number }}
        </div>
        <div class="filter-field">
          <label>{{ filter_form.file_type.label }}</label>
          {{ filter_form.file_type }}
        </div>
        <div class="filter-field">
          <label>{{ filter_form.date_from.label }}</label>
          {{ filter_form.date_from }}
        </div>
        <div class="filter-field">
          <label>{{ filter_form.date_to.label }}</label>
          {{ filter_form.date_to }}
        </div>
        <div class="filter-actions">
          <button type="submit" class="btn btn-primary">{% trans "ÙÛŒÙ„ØªØ±" %}</button>
          <a href="{% url 'accounting:attachment_list' %}" class="btn btn-secondary">{% trans "Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†" %}</a>
        </div>
      </div>
    </form>
  </div>

  <!-- List -->
  <div class="content-section">
    <div class="table-actions">
      <button type="button" class="btn btn-success" id="download-selected-btn" disabled>
        {% trans "Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡â€ŒÙ‡Ø§" %}
      </button>
      <span id="selected-count">0 {% trans "Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡" %}</span>
    </div>

    {% if object_list %}
      <table class="data-table">
        <thead>
          <tr>
            <th>
              <input type="checkbox" id="select-all" />
            </th>
            <th>{% trans "Ø´Ù…Ø§Ø±Ù‡ Ø³Ù†Ø¯" %}</th>
            <th>{% trans "Ù†Ø§Ù… ÙØ§ÛŒÙ„" %}</th>
            <th>{% trans "Ù†ÙˆØ¹ ÙØ§ÛŒÙ„" %}</th>
            <th>{% trans "Ø­Ø¬Ù…" %}</th>
            <th>{% trans "ØªØ§Ø±ÛŒØ® Ø¢Ù¾Ù„ÙˆØ¯" %}</th>
            <th>{% trans "Ø¢Ù¾Ù„ÙˆØ¯Ú©Ù†Ù†Ø¯Ù‡" %}</th>
            <th>{% trans "Ø¹Ù…Ù„ÛŒØ§Øª" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for attachment in object_list %}
            <tr>
              <td>
                <input type="checkbox" class="attachment-checkbox" value="{{ attachment.id }}" />
              </td>
              <td>
                {% if attachment.document_number %}
                  <code>{{ attachment.document_number }}</code>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>{{ attachment.file_name }}</td>
              <td>{{ attachment.get_file_type_display }}</td>
              <td>{{ attachment.get_file_size_display }}</td>
              <td>{{ attachment.uploaded_at|date:"Y/m/d H:i" }}</td>
              <td>{{ attachment.uploaded_by.username|default:"-" }}</td>
              <td>
                <a href="{% url 'accounting:attachment_download_single' %}?id={{ attachment.id }}" 
                   class="btn btn-sm btn-primary" 
                   download>{% trans "Ø¯Ø§Ù†Ù„ÙˆØ¯" %}</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Pagination -->
      {% if is_paginated %}
        <div class="pagination">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{% trans "Ù‚Ø¨Ù„ÛŒ" %}</a>
          {% endif %}
          <span>{% trans "ØµÙØ­Ù‡" %} {{ page_obj.number }} {% trans "Ø§Ø²" %} {{ page_obj.paginator.num_pages }}</span>
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{% trans "Ø¨Ø¹Ø¯ÛŒ" %}</a>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“„</div>
        <h3>{% trans "Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯" %}</h3>
        <p>{% trans "Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙÛŒÙ„ØªØ±Ù‡Ø§ ÛŒØ§ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯." %}</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectAll = document.getElementById('select-all');
  const checkboxes = document.querySelectorAll('.attachment-checkbox');
  const downloadBtn = document.getElementById('download-selected-btn');
  const selectedCount = document.getElementById('selected-count');

  function updateSelectedCount() {
    const selected = document.querySelectorAll('.attachment-checkbox:checked');
    const count = selected.length;
    selectedCount.textContent = count + ' {% trans "Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡" %}';
    downloadBtn.disabled = count === 0;
  }

  selectAll.addEventListener('change', function() {
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateSelectedCount();
  });

  checkboxes.forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
  });

  downloadBtn.addEventListener('click', function() {
    const selected = Array.from(document.querySelectorAll('.attachment-checkbox:checked'))
      .map(cb => cb.value);
    
    if (selected.length > 0) {
      const url = '{% url "accounting:attachment_download_bulk" %}?' + 
        selected.map(id => 'ids=' + id).join('&');
      window.location.href = url;
    }
  });
});
</script>
{% endblock %}

