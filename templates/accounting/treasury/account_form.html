{% extends "shared/generic/generic_form.html" %}
{% load i18n %}
{% load static %}

{% block breadcrumb_extra %}
{% if breadcrumbs %}
  {% for crumb in breadcrumbs %}
    <span class="separator">/</span>
    {% if crumb.url %}
      <a href="{{ crumb.url }}">{{ crumb.label }}</a>
    {% else %}
      <span>{{ crumb.label }}</span>
    {% endif %}
  {% endfor %}
{% else %}
<span class="separator">/</span>
<a href="{% url 'accounting:dashboard' %}">{% trans "حسابداری" %}</a>
<span class="separator">/</span>
<a href="{% url 'accounting:treasury_accounts' %}">{% trans "حساب‌های نقدی و بانکی" %}</a>
<span class="separator">/</span>
<span>{{ form_title|default:"ایجاد حساب نقدی/بانکی" }}</span>
{% endif %}
{% endblock %}

{% block form_sections %}
<div class="form-section">
  <h3>{% trans "انتخاب حساب" %}</h3>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.tafsili_account.id_for_label }}">
        {{ form.tafsili_account.label }} *
      </label>
      {{ form.tafsili_account }}
      {% if form.tafsili_account.errors %}
        <span class="error">{{ form.tafsili_account.errors.0 }}</span>
      {% endif %}
      {% if form.tafsili_account.help_text %}
        <small class="form-text">{{ form.tafsili_account.help_text }}</small>
      {% endif %}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.sub_account.id_for_label }}">
        {{ form.sub_account.label }}
      </label>
      {{ form.sub_account }}
      {% if form.sub_account.errors %}
        <span class="error">{{ form.sub_account.errors.0 }}</span>
      {% endif %}
      {% if form.sub_account.help_text %}
        <small class="form-text">{{ form.sub_account.help_text }}</small>
      {% endif %}
    </div>
    
    <div class="form-field">
      <label for="{{ form.gl_account.id_for_label }}">
        {{ form.gl_account.label }}
      </label>
      {{ form.gl_account }}
      {% if form.gl_account.errors %}
        <span class="error">{{ form.gl_account.errors.0 }}</span>
      {% endif %}
      {% if form.gl_account.help_text %}
        <small class="form-text">{{ form.gl_account.help_text }}</small>
      {% endif %}
    </div>
  </div>
</div>

<div class="form-section">
  <h3>{% trans "اطلاعات پایه" %}</h3>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.account_type.id_for_label }}">
        {{ form.account_type.label }} *
      </label>
      {{ form.account_type }}
      {% if form.account_type.errors %}
        <span class="error">{{ form.account_type.errors.0 }}</span>
      {% endif %}
    </div>
    
    <div class="form-field">
      <label for="{{ form.account_name.id_for_label }}">
        {{ form.account_name.label }} *
      </label>
      {{ form.account_name }}
      {% if form.account_name.errors %}
        <span class="error">{{ form.account_name.errors.0 }}</span>
      {% endif %}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.account_name_en.id_for_label }}">
        {{ form.account_name_en.label }}
      </label>
      {{ form.account_name_en }}
      {% if form.account_name_en.errors %}
        <span class="error">{{ form.account_name_en.errors.0 }}</span>
      {% endif %}
    </div>
    
    <div class="form-field">
      <label for="{{ form.currency.id_for_label }}">
        {{ form.currency.label }}
      </label>
      {{ form.currency }}
      {% if form.currency.errors %}
        <span class="error">{{ form.currency.errors.0 }}</span>
      {% endif %}
    </div>
  </div>
</div>

<div class="form-section">
  <h3>{% trans "اطلاعات بانکی" %}</h3>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.bank_name.id_for_label }}">
        {{ form.bank_name.label }}
      </label>
      {{ form.bank_name }}
      {% if form.bank_name.errors %}
        <span class="error">{{ form.bank_name.errors.0 }}</span>
      {% endif %}
    </div>
    
    <div class="form-field">
      <label for="{{ form.account_number.id_for_label }}">
        {{ form.account_number.label }}
      </label>
      {{ form.account_number }}
      {% if form.account_number.errors %}
        <span class="error">{{ form.account_number.errors.0 }}</span>
      {% endif %}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.branch_name.id_for_label }}">
        {{ form.branch_name.label }}
      </label>
      {{ form.branch_name }}
      {% if form.branch_name.errors %}
        <span class="error">{{ form.branch_name.errors.0 }}</span>
      {% endif %}
    </div>
    
    <div class="form-field">
      <label for="{{ form.branch_code.id_for_label }}">
        {{ form.branch_code.label }}
      </label>
      {{ form.branch_code }}
      {% if form.branch_code.errors %}
        <span class="error">{{ form.branch_code.errors.0 }}</span>
      {% endif %}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.iban.id_for_label }}">
        {{ form.iban.label }}
      </label>
      {{ form.iban }}
      {% if form.iban.errors %}
        <span class="error">{{ form.iban.errors.0 }}</span>
      {% endif %}
    </div>
    
    <div class="form-field">
      <label for="{{ form.initial_balance.id_for_label }}">
        {{ form.initial_balance.label }}
      </label>
      {{ form.initial_balance }}
      {% if form.initial_balance.errors %}
        <span class="error">{{ form.initial_balance.errors.0 }}</span>
      {% endif %}
    </div>
  </div>
</div>

<div class="form-section">
  <h3>{% trans "سایر اطلاعات" %}</h3>
  
  <div class="form-row">
    <div class="form-field full-width">
      <label for="{{ form.notes.id_for_label }}">
        {{ form.notes.label }}
      </label>
      {{ form.notes }}
      {% if form.notes.errors %}
        <span class="error">{{ form.notes.errors.0 }}</span>
      {% endif %}
    </div>
  </div>

  {% if form.is_enabled %}
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.is_enabled.id_for_label }}">
        {{ form.is_enabled.label }}
      </label>
      {{ form.is_enabled }}
      {% if form.is_enabled.errors %}
        <span class="error">{{ form.is_enabled.errors.0 }}</span>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/cascading-dropdowns.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tafsiliSelect = document.getElementById('id_tafsili_account');
    const subAccountSelect = document.getElementById('id_sub_account');
    const glAccountSelect = document.getElementById('id_gl_account');
    
    if (!tafsiliSelect || !subAccountSelect || !glAccountSelect) return;
    
    // Initialize cascading dropdown: Tafsili → Sub Account
    initCascadingDropdown('#id_tafsili_account', '#id_sub_account', '{% url "accounting:treasury_account_api_sub_accounts" %}', {
        parentField: 'tafsili_account_id',
        placeholder: '--- {% trans "ابتدا تفصیلی را انتخاب کنید" %} ---',
        valueField: 'id',
        labelField: 'label',
        onChange: function(value, element) {
            // Clear GL account when sub account changes
            if (glAccountSelect) {
                glAccountSelect.innerHTML = '<option value="">--- {% trans "ابتدا معین را انتخاب کنید" %} ---</option>';
                glAccountSelect.disabled = true;
            }
        },
        onError: function(error, element) {
            element.innerHTML = '<option value="">--- {% trans "خطا در بارگذاری" %} ---</option>';
        }
    });
    
    // Initialize cascading dropdown: Sub Account → GL Account
    initCascadingDropdown('#id_sub_account', '#id_gl_account', '{% url "accounting:treasury_account_api_gl_accounts" %}', {
        parentField: 'sub_account_id',
        placeholder: '--- {% trans "ابتدا معین را انتخاب کنید" %} ---',
        valueField: 'id',
        labelField: 'label',
        onError: function(error, element) {
            element.innerHTML = '<option value="">--- {% trans "خطا در بارگذاری" %} ---</option>';
        }
    });
    
    // Initially disable sub_account and gl_account
    subAccountSelect.disabled = true;
    glAccountSelect.disabled = true;
    
    // If tafsili is already selected (edit mode), trigger change
    if (tafsiliSelect.value) {
        tafsiliSelect.dispatchEvent(new Event('change'));
        if (subAccountSelect.value) {
            subAccountSelect.dispatchEvent(new Event('change'));
        }
    }
});
</script>
{% endblock %}

