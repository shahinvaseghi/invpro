{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ page_title }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="inventory-module">
  <div class="module-header">
    <nav class="breadcrumb">
      <a href="{% url 'ui:dashboard' %}">{% trans "Dashboard" %}</a>
      <span>/</span>
      <a href="{% url 'shared:access_levels' %}">{% trans "Access Levels" %}</a>
      <span>/</span>
      <span>{{ page_title }}</span>
    </nav>
    <h1 class="page-title">{{ page_title }}</h1>
  </div>

  <form method="post" class="entity-form">
    {% csrf_token %}
    {% if form.non_field_errors %}
      <div class="form-errors">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <div class="form-grid">
      {% for field in form %}
        <div class="form-field">
          <label for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %} <span style="color: red;">*</span>{% endif %}</label>
          {{ field }}
          {% if field.help_text %}
            <small class="form-text text-muted">{{ field.help_text }}</small>
          {% endif %}
          {% for error in field.errors %}
            <div class="field-error">{{ error }}</div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>
    
    {% if form.instance and form.instance.pk and form.instance.code %}
    <div class="form-grid">
      <div class="form-field">
        <label>{% trans "Code" %}</label>
        <input type="text" class="form-control" value="{{ form.instance.code }}" readonly style="background-color: #f3f4f6;">
        <small class="form-text text-muted">{% trans "Auto-generated from name. Cannot be changed." %}</small>
      </div>
    </div>
    {% endif %}

    <section class="form-section">
      <header class="section-header">
        <h2>{% trans "Feature Permissions" %}</h2>
        <p>{% trans "Select the allowed actions for each feature. View permissions can be limited to own records or extended to all records." %}</p>
        <div style="margin-top: 10px;">
          <button type="button" id="select-all-global" class="btn btn-sm btn-secondary">{% trans "Select All" %}</button>
          <button type="button" id="deselect-all-global" class="btn btn-sm btn-secondary">{% trans "Deselect All" %}</button>
        </div>
      </header>

      <table class="data-table permissions-table">
        <thead>
          <tr>
            <th>{% trans "Feature" %}</th>
            <th>{% trans "View Scope" %}</th>
            <th>{% trans "Actions" %}</th>
            <th style="width: 150px;">{% trans "Quick Actions" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for feature in feature_permissions %}
          <tr data-feature-id="{{ feature.html_id }}">
            <td>
              <strong>{{ feature.label }}</strong>
              <div class="muted-text code">{{ feature.code }}</div>
            </td>
            <td>
              {% if feature.view_supported %}
                <div class="radio-group">
                  <label>
                    <input type="radio" name="perm-{{ feature.html_id }}-view" value="none" {% if feature.view_scope == 'none' %}checked{% endif %}>
                    {% trans "None" %}
                  </label>
                  <label>
                    <input type="radio" name="perm-{{ feature.html_id }}-view" value="own" {% if feature.view_scope == 'own' %}checked{% endif %}>
                    {% trans "Own" %}
                  </label>
                  <label>
                    <input type="radio" name="perm-{{ feature.html_id }}-view" value="all" {% if feature.view_scope == 'all' %}checked{% endif %}>
                    {% trans "All" %}
                  </label>
                </div>
              {% else %}
                <span class="muted-text">{% trans "Not applicable" %}</span>
              {% endif %}
            </td>
            <td>
              {% if feature.actions %}
                <div class="checkbox-grid">
                  {% for action in feature.actions %}
                    <label>
                      <input type="checkbox" name="perm-{{ feature.html_id }}-{{ action.code }}" {% if action.checked %}checked{% endif %}>
                      {{ action.label }}
                    </label>
                  {% endfor %}
                </div>
              {% else %}
                <span class="muted-text">{% trans "No extra actions available." %}</span>
              {% endif %}
            </td>
            <td>
              <button type="button" class="btn btn-sm btn-primary select-all-row" data-feature-id="{{ feature.html_id }}">{% trans "Select All" %}</button>
              <button type="button" class="btn btn-sm btn-secondary deselect-all-row" data-feature-id="{{ feature.html_id }}">{% trans "Deselect All" %}</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Function to select all in a row
      function selectAllRow(featureId) {
        const row = document.querySelector(`tr[data-feature-id="${featureId}"]`);
        if (!row) return;
        
        // Select "all" radio button if view is supported
        const viewRadio = row.querySelector(`input[name="perm-${featureId}-view"][value="all"]`);
        if (viewRadio) {
          viewRadio.checked = true;
        }
        
        // Check all checkboxes in this row
        const checkboxes = row.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = true;
        });
      }
      
      // Function to deselect all in a row
      function deselectAllRow(featureId) {
        const row = document.querySelector(`tr[data-feature-id="${featureId}"]`);
        if (!row) return;
        
        // Select "none" radio button if view is supported
        const viewRadio = row.querySelector(`input[name="perm-${featureId}-view"][value="none"]`);
        if (viewRadio) {
          viewRadio.checked = true;
        }
        
        // Uncheck all checkboxes in this row
        const checkboxes = row.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = false;
        });
      }
      
      // Function to select all globally
      function selectAllGlobal() {
        const rows = document.querySelectorAll('tr[data-feature-id]');
        rows.forEach(row => {
          const featureId = row.getAttribute('data-feature-id');
          selectAllRow(featureId);
        });
      }
      
      // Function to deselect all globally
      function deselectAllGlobal() {
        const rows = document.querySelectorAll('tr[data-feature-id]');
        rows.forEach(row => {
          const featureId = row.getAttribute('data-feature-id');
          deselectAllRow(featureId);
        });
      }
      
      // Attach event listeners for row buttons
      document.querySelectorAll('.select-all-row').forEach(button => {
        button.addEventListener('click', function() {
          const featureId = this.getAttribute('data-feature-id');
          selectAllRow(featureId);
        });
      });
      
      document.querySelectorAll('.deselect-all-row').forEach(button => {
        button.addEventListener('click', function() {
          const featureId = this.getAttribute('data-feature-id');
          deselectAllRow(featureId);
        });
      });
      
      // Attach event listeners for global buttons
      document.getElementById('select-all-global')?.addEventListener('click', selectAllGlobal);
      document.getElementById('deselect-all-global')?.addEventListener('click', deselectAllGlobal);
    });
    </script>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">{% trans "Save" %}</button>
      <a href="{% url 'shared:access_levels' %}" class="btn btn-secondary">{% trans "Cancel" %}</a>
    </div>
  </form>
</div>
{% endblock %}

