{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" dir="{% if LANGUAGE_CODE == 'fa' %}rtl{% else %}ltr{% endif %}">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}{% trans "invproj Platform" %}{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/vazirmatn-font-face.css' %}?v=20241206-2000" />
    <link rel="stylesheet" href="{% static 'css/base.css' %}?v=20241206-2000" />
  </head>
  <body>
    <div class="app-shell sidebar-collapsed">
      <header class="app-header">
        <div class="header-left">
          <button type="button" class="sidebar-toggle-btn" id="sidebar-toggle" title="{% trans 'Toggle Sidebar' %}">
            <span class="toggle-icon">â˜°</span>
          </button>
          <div class="logo">invproj</div>
          <nav class="top-menu-nav">
            {% block top_menu %}
            {% load access_tags %}
            <!-- Dashboard Menu (First Item) -->
            <div class="top-menu-item">
              <button type="button" class="top-menu-btn" onclick="window.location.href='{% url 'ui:dashboard' %}';">
                <span class="menu-icon">ğŸ“Š</span>
                <span class="menu-label">{% trans "Dashboard" %}</span>
              </button>
            </div>
            
            <!-- Modules Menu (All modules in one dropdown) -->
            <div class="top-menu-item">
              <button type="button" class="top-menu-btn" data-menu="modules">
                <span class="menu-icon">ğŸ“</span>
                <span class="menu-label">{% trans "Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§" %}</span>
              </button>
              {% include "ui/components/modules_menu.html" %}
            </div>
            
            <!-- Old individual menus - commented out, all modules are now in modules_menu.html -->
            {% comment %}
            <!-- Shared Menu -->
            <div class="top-menu-item" style="display: none;">
              <button type="button" class="top-menu-btn" data-menu="shared">
                <span class="menu-icon">ğŸ”§</span>
                <span class="menu-label">{% trans "Shared" %}</span>
              </button>
              <div class="dropdown-menu" id="menu-shared">
                {% if user_feature_permissions|feature_allowed:'shared.companies' %}
                  <a href="{% url 'shared:companies' %}" class="dropdown-item">{% trans "Companies" %}</a>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'shared.company_units' %}
                  <a href="{% url 'shared:company_units' %}" class="dropdown-item">{% trans "Company Units" %}</a>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'shared.smtp_servers' or user.is_superuser %}
                  <a href="{% url 'shared:smtp_servers' %}" class="dropdown-item">{% trans "SMTP Servers" %}</a>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'shared.users' or user_feature_permissions|feature_allowed:'shared.groups' or user_feature_permissions|feature_allowed:'shared.access_levels' %}
                  <div class="dropdown-submenu">
                    <button type="button" class="dropdown-item dropdown-toggle" data-submenu="shared-users">
                      <span>{% trans "Users" %}</span>
                      <span class="dropdown-arrow">â–¶</span>
                    </button>
                    <div class="dropdown-menu-sub" id="shared-users">
                      {% if user_feature_permissions|feature_allowed:'shared.users' %}
                        <a href="{% url 'shared:users' %}" class="dropdown-item-sub">{% trans "Users" %}</a>
                      {% endif %}
                      {% if user_feature_permissions|feature_allowed:'shared.groups' %}
                        <a href="{% url 'shared:groups' %}" class="dropdown-item-sub">{% trans "Groups" %}</a>
                      {% endif %}
                      {% if user_feature_permissions|feature_allowed:'shared.access_levels' %}
                        <a href="{% url 'shared:access_levels' %}" class="dropdown-item-sub">{% trans "Access Levels" %}</a>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>

            <!-- Inventory Menu -->
            <div class="top-menu-item">
              <button type="button" class="top-menu-btn" data-menu="inventory">
                <span class="menu-icon">ğŸ“¦</span>
                <span class="menu-label">{% trans "Inventory" %}</span>
              </button>
              <div class="dropdown-menu" id="menu-inventory">
                {% if user_feature_permissions|feature_allowed:'inventory.master.items' or user_feature_permissions|feature_allowed:'inventory.master.item_serials' or user_feature_permissions|feature_allowed:'inventory.balance' %}
                  <div class="dropdown-submenu">
                    <button type="button" class="dropdown-item dropdown-toggle" data-submenu="inventory-items">
                      <span>{% trans "Items" %}</span>
                      <span class="dropdown-arrow">â–¶</span>
                    </button>
                    <div class="dropdown-menu-sub" id="inventory-items">
                      {% if user_feature_permissions|feature_allowed:'inventory.master.items' %}
                        <a href="{% url 'inventory:items' %}" class="dropdown-item-sub">{% trans "Edit Items" %}</a>
                      {% endif %}
                      {% if user_feature_permissions|feature_allowed:'inventory.master.item_serials' %}
                        <a href="{% url 'inventory:item_serials' %}" class="dropdown-item-sub">{% trans "Item Serials" %}</a>
                      {% endif %}
                      {% if user_feature_permissions|feature_allowed:'inventory.balance' %}
                        <a href="{% url 'inventory:inventory_balance' %}" class="dropdown-item-sub">{% trans "Inventory Balance" %}</a>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
                
                <!-- Master Data -->
                
                {% if user_feature_permissions|feature_allowed:'inventory.master.warehouses' %}
                  <a href="{% url 'inventory:warehouses' %}" class="dropdown-item">{% trans "Warehouses" %}</a>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'inventory.suppliers.list' %}
                  <a href="{% url 'inventory:suppliers' %}" class="dropdown-item">{% trans "Suppliers" %}</a>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'inventory.receipts.temporary' or user_feature_permissions|feature_allowed:'inventory.receipts.permanent' or user_feature_permissions|feature_allowed:'inventory.receipts.consignment' %}
                  <div class="dropdown-submenu">
                    <button type="button" class="dropdown-item dropdown-toggle" data-submenu="inventory-receipts">
                      <span>{% trans "Receipts" %}</span>
                      <span class="dropdown-arrow">â–¶</span>
                    </button>
                    <div class="dropdown-menu-sub" id="inventory-receipts">
                      {% if user_feature_permissions|feature_allowed:'inventory.receipts.temporary' %}
                        <a href="{% url 'inventory:receipt_temporary' %}" class="dropdown-item-sub">{% trans "Temporary Receipts" %}</a>
                      {% endif %}
                      {% if user_feature_permissions|feature_allowed:'inventory.receipts.permanent' %}
                        <a href="{% url 'inventory:receipt_permanent' %}" class="dropdown-item-sub">{% trans "Permanent Receipts" %}</a>
                      {% endif %}
                      {% if user_feature_permissions|feature_allowed:'inventory.receipts.consignment' %}
                        <a href="{% url 'inventory:receipt_consignment' %}" class="dropdown-item-sub">{% trans "Consignment Receipts" %}</a>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'inventory.issues.permanent' or user_feature_permissions|feature_allowed:'inventory.issues.consumption' or user_feature_permissions|feature_allowed:'inventory.issues.consignment' %}
                  <div class="dropdown-submenu">
                    <button type="button" class="dropdown-item dropdown-toggle" data-submenu="inventory-issues">
                      <span>{% trans "Issues" %}</span>
                      <span class="dropdown-arrow">â–¶</span>
                    </button>
                    <div class="dropdown-menu-sub" id="inventory-issues">
                      {% if user_feature_permissions|feature_allowed:'inventory.issues.permanent' %}
                        <a href="{% url 'inventory:issue_permanent' %}" class="dropdown-item-sub">{% trans "Permanent Issues" %}</a>
                      {% endif %}
                      {% if user_feature_permissions|feature_allowed:'inventory.issues.consumption' %}
                        <a href="{% url 'inventory:issue_consumption' %}" class="dropdown-item-sub">{% trans "Consumption Issues" %}</a>
                      {% endif %}
                      {% if user_feature_permissions|feature_allowed:'inventory.issues.consignment' %}
                        <a href="{% url 'inventory:issue_consignment' %}" class="dropdown-item-sub">{% trans "Consignment Issues" %}</a>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'inventory.requests.purchase' %}
                  <a href="{% url 'inventory:purchase_requests' %}" class="dropdown-item">{% trans "Purchase Requests" %}</a>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'inventory.requests.warehouse' %}
                  <a href="{% url 'inventory:warehouse_requests' %}" class="dropdown-item">{% trans "Warehouse Requests" %}</a>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'inventory.stocktaking.deficit' or user_feature_permissions|feature_allowed:'inventory.stocktaking.surplus' or user_feature_permissions|feature_allowed:'inventory.stocktaking.records' %}
                  <div class="dropdown-submenu">
                    <button type="button" class="dropdown-item dropdown-toggle" data-submenu="inventory-stocktaking">
                      <span>{% trans "Stocktaking" %}</span>
                      <span class="dropdown-arrow">â–¶</span>
                    </button>
                    <div class="dropdown-menu-sub" id="inventory-stocktaking">
                      {% if user_feature_permissions|feature_allowed:'inventory.stocktaking.deficit' %}
                        <a href="{% url 'inventory:stocktaking_deficit' %}" class="dropdown-item-sub">{% trans "Deficit Records" %}</a>
                      {% endif %}
                      {% if user_feature_permissions|feature_allowed:'inventory.stocktaking.surplus' %}
                        <a href="{% url 'inventory:stocktaking_surplus' %}" class="dropdown-item-sub">{% trans "Surplus Records" %}</a>
                      {% endif %}
                      {% if user_feature_permissions|feature_allowed:'inventory.stocktaking.records' %}
                        <a href="{% url 'inventory:stocktaking_records' %}" class="dropdown-item-sub">{% trans "Stocktaking Records" %}</a>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>

            <!-- Production Menu -->
            {% if user_feature_permissions|feature_allowed:'production.personnel' or user_feature_permissions|feature_allowed:'production.machines' or user_feature_permissions|feature_allowed:'production.work_lines' or user_feature_permissions|feature_allowed:'production.bom' or user_feature_permissions|feature_allowed:'production.processes' or user_feature_permissions|feature_allowed:'production.product_orders' or request.user.is_superuser %}
            <div class="top-menu-item">
              <button type="button" class="top-menu-btn" data-menu="production">
                <span class="menu-icon">âš™ï¸</span>
                <span class="menu-label">{% trans "Production" %}</span>
              </button>
              <div class="dropdown-menu" id="menu-production">
                {% if user_feature_permissions|feature_allowed:'production.personnel' %}
                  <a href="{% url 'production:personnel' %}" class="dropdown-item">{% trans "Personnel" %}</a>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'production.machines' %}
                  <a href="{% url 'production:machines' %}" class="dropdown-item">{% trans "Machines" %}</a>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'production.work_lines' %}
                  <a href="{% url 'production:work_lines' %}" class="dropdown-item">{% trans "Work Lines" %}</a>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'production.bom' or request.user.is_superuser %}
                  <a href="{% url 'production:bom_list' %}" class="dropdown-item">{% trans "BOM" %}</a>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'production.processes' or request.user.is_superuser %}
                  <a href="{% url 'production:processes' %}" class="dropdown-item">{% trans "Processes" %}</a>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'production.product_orders' or request.user.is_superuser %}
                  <a href="{% url 'production:product_orders' %}" class="dropdown-item">{% trans "Product Orders" %}</a>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'production.transfer_requests' or request.user.is_superuser %}
                  <a href="{% url 'production:transfer_requests' %}" class="dropdown-item">{% trans "Transfer to Line Requests" %}</a>
                {% endif %}
                {% if request.user.is_superuser %}
                  <a href="{% url 'production:performance_records' %}" class="dropdown-item">{% trans "Performance" %}</a>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- Quality Control Menu -->
            {% if request.user.is_superuser %}
            <div class="top-menu-item">
              <button type="button" class="top-menu-btn" data-menu="qc">
                <span class="menu-icon">ğŸ”¬</span>
                <span class="menu-label">{% trans "Quality Control" %}</span>
              </button>
              <div class="dropdown-menu" id="menu-qc">
                <a href="{% url 'qc:temporary_receipts' %}" class="dropdown-item">{% trans "Inspections" %}</a>
              </div>
            </div>
            {% endif %}

            <!-- Ticketing Menu -->
            {% if request.user.is_superuser %}
            <div class="top-menu-item">
              <button type="button" class="top-menu-btn" data-menu="ticketing">
                <span class="menu-icon">ğŸ«</span>
                <span class="menu-label">{% trans "Ticketing" %}</span>
              </button>
              <div class="dropdown-menu" id="menu-ticketing">
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="ticketing-tickets">
                    <span>{% trans "Tickets" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="ticketing-tickets">
                    <a href="{% url 'ticketing:ticket_create' %}" class="dropdown-item-sub">{% trans "Create Ticket" %}</a>
                    <a href="{% url 'ticketing:ticket_respond' %}" class="dropdown-item-sub">{% trans "Respond to Ticket" %}</a>
                  </div>
                </div>
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="ticketing-templates">
                    <span>{% trans "Templates" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="ticketing-templates">
                    <a href="{% url 'ticketing:templates' %}" class="dropdown-item-sub">{% trans "Templates" %}</a>
                    <a href="{% url 'ticketing:categories' %}" class="dropdown-item-sub">{% trans "Categories" %}</a>
                    <a href="{% url 'ticketing:subcategories' %}" class="dropdown-item-sub">{% trans "Subcategories" %}</a>
                  </div>
                </div>
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="ticketing-automation">
                    <span>{% trans "Automation" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="ticketing-automation">
                    <a href="{% url 'ticketing:auto_response' %}" class="dropdown-item-sub">{% trans "Auto Response" %}</a>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Accounting Menu -->
            {% if user_feature_permissions|feature_allowed:'accounting.dashboard' or request.user.is_superuser %}
            <div class="top-menu-item">
              <button type="button" class="top-menu-btn" data-menu="accounting">
                <span class="menu-icon">ğŸ’°</span>
                <span class="menu-label">{% trans "Accounting" %}</span>
              </button>
              <div class="dropdown-menu" id="menu-accounting">
                <a href="{% url 'accounting:dashboard' %}" class="dropdown-item">{% trans "Dashboard" %}</a>
                {% if user_feature_permissions|feature_allowed:'accounting.general.ledger' or user_feature_permissions|feature_allowed:'accounting.general.subsidiary' or user_feature_permissions|feature_allowed:'accounting.general.detail' %}
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="accounting-general">
                    <span>{% trans "General" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="accounting-general">
                    {% if user_feature_permissions|feature_allowed:'accounting.general.ledger' %}
                    <a href="{% url 'accounting:general_ledger' %}" class="dropdown-item-sub">{% trans "General Ledgers" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'accounting.general.subsidiary' %}
                    <a href="{% url 'accounting:general_subsidiary' %}" class="dropdown-item-sub">{% trans "Subsidiary Ledgers" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'accounting.general.detail' %}
                    <a href="{% url 'accounting:general_detail' %}" class="dropdown-item-sub">{% trans "Detail Ledgers" %}</a>
                    {% endif %}
                  </div>
                </div>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'accounting.documents.entry' or user_feature_permissions|feature_allowed:'accounting.documents.exit' %}
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="accounting-documents">
                    <span>{% trans "Accounting Documents" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="accounting-documents">
                    {% if user_feature_permissions|feature_allowed:'accounting.documents.entry' %}
                    <a href="{% url 'accounting:document_entry' %}" class="dropdown-item-sub">{% trans "Entry Document" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'accounting.documents.exit' %}
                    <a href="{% url 'accounting:document_exit' %}" class="dropdown-item-sub">{% trans "Exit Document" %}</a>
                    {% endif %}
                  </div>
                </div>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'accounting.treasury.expense' or user_feature_permissions|feature_allowed:'accounting.treasury.income' %}
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="accounting-treasury">
                    <span>{% trans "Treasury" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="accounting-treasury">
                    {% if user_feature_permissions|feature_allowed:'accounting.treasury.expense' %}
                    <a href="{% url 'accounting:treasury_expense' %}" class="dropdown-item-sub">{% trans "Expense Document" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'accounting.treasury.income' %}
                    <a href="{% url 'accounting:treasury_income' %}" class="dropdown-item-sub">{% trans "Income Document" %}</a>
                    {% endif %}
                  </div>
                </div>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'accounting.payroll.payment' or user_feature_permissions|feature_allowed:'accounting.payroll.insurance_tax' or user_feature_permissions|feature_allowed:'accounting.payroll.document' or user_feature_permissions|feature_allowed:'accounting.payroll.bank_transfer' %}
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="accounting-payroll">
                    <span>{% trans "Payroll" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="accounting-payroll">
                    {% if user_feature_permissions|feature_allowed:'accounting.payroll.payment' %}
                    <a href="{% url 'accounting:payroll_payment' %}" class="dropdown-item-sub">{% trans "Ù¾Ø±Ø¯Ø§Ø®Øª Ø­Ù‚ÙˆÙ‚ Ùˆ Ø¯Ø³ØªÙ…Ø²Ø¯" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'accounting.payroll.insurance_tax' %}
                    <a href="{% url 'accounting:payroll_insurance_tax' %}" class="dropdown-item-sub">{% trans "ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨ÛŒÙ…Ù‡ Ùˆ Ù…Ø§Ù„ÛŒØ§Øª" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'accounting.payroll.document' %}
                    <a href="{% url 'accounting:payroll_document' %}" class="dropdown-item-sub">{% trans "Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø³Ù†Ø§Ø¯ Ø­Ù‚ÙˆÙ‚ Ùˆ Ø¯Ø³ØªÙ…Ø²Ø¯" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'accounting.payroll.bank_transfer' %}
                    <a href="{% url 'accounting:payroll_bank_transfer' %}" class="dropdown-item-sub">{% trans "Ø®Ø±ÙˆØ¬ÛŒ Ø­Ù‚ÙˆÙ‚ Ùˆ Ø¯Ø³ØªÙ…Ø²Ø¯ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ù†Ú©" %}</a>
                    {% endif %}
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- Sales Menu -->
            {% if user_feature_permissions|feature_allowed:'sales.dashboard' or request.user.is_superuser %}
            <div class="top-menu-item">
              <button type="button" class="top-menu-btn" data-menu="sales">
                <span class="menu-icon">ğŸ›’</span>
                <span class="menu-label">{% trans "Sales" %}</span>
              </button>
              <div class="dropdown-menu" id="menu-sales">
                <a href="{% url 'sales:dashboard' %}" class="dropdown-item">{% trans "Dashboard" %}</a>
                {% if user_feature_permissions|feature_allowed:'sales.invoice' %}
                <a href="{% url 'sales:invoice_create' %}" class="dropdown-item">{% trans "Sales Invoice" %}</a>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- Human Resources Menu -->
            {% if user_feature_permissions|feature_allowed:'hr.dashboard' or request.user.is_superuser %}
            <div class="top-menu-item">
              <button type="button" class="top-menu-btn" data-menu="hr">
                <span class="menu-icon">ğŸ‘¥</span>
                <span class="menu-label">{% trans "Human Resources" %}</span>
              </button>
              <div class="dropdown-menu" id="menu-hr">
                <a href="{% url 'hr:dashboard' %}" class="dropdown-item">{% trans "Dashboard" %}</a>
                {% if user_feature_permissions|feature_allowed:'hr.personnel' or user_feature_permissions|feature_allowed:'hr.personnel.decree' or user_feature_permissions|feature_allowed:'hr.personnel.form' or user_feature_permissions|feature_allowed:'hr.personnel.form_groups' or user_feature_permissions|feature_allowed:'hr.personnel.form_subgroups' %}
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="hr-personnel">
                    <span>{% trans "Personnel" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="hr-personnel">
                    {% if user_feature_permissions|feature_allowed:'hr.personnel' %}
                    <a href="{% url 'hr:personnel_create' %}" class="dropdown-item-sub">{% trans "Create Personnel" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'hr.personnel.decree' %}
                    <a href="{% url 'hr:personnel_decree_assignment' %}" class="dropdown-item-sub">{% trans "Assign Decree" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'hr.personnel.form' %}
                    <a href="{% url 'hr:personnel_form_create' %}" class="dropdown-item-sub">{% trans "Personnel Form" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'hr.personnel.form_groups' %}
                    <a href="{% url 'hr:personnel_form_groups' %}" class="dropdown-item-sub">{% trans "Form Groups" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'hr.personnel.form_subgroups' %}
                    <a href="{% url 'hr:personnel_form_subgroups' %}" class="dropdown-item-sub">{% trans "Form Subgroups" %}</a>
                    {% endif %}
                  </div>
                </div>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'hr.requests.leave' or user_feature_permissions|feature_allowed:'hr.requests.sick_leave' or user_feature_permissions|feature_allowed:'hr.requests.loan' %}
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="hr-requests">
                    <span>{% trans "Requests" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="hr-requests">
                    {% if user_feature_permissions|feature_allowed:'hr.requests.leave' %}
                    <a href="{% url 'hr:requests_leave' %}" class="dropdown-item-sub">{% trans "Leave Request" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'hr.requests.sick_leave' %}
                    <a href="{% url 'hr:requests_sick_leave' %}" class="dropdown-item-sub">{% trans "Sick Leave Request" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'hr.requests.loan' %}
                    <a href="{% url 'hr:requests_loan' %}" class="dropdown-item-sub">{% trans "Loan Request" %}</a>
                    {% endif %}
                  </div>
                </div>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'hr.loans.management' or user_feature_permissions|feature_allowed:'hr.loans.scheduling' or user_feature_permissions|feature_allowed:'hr.loans.savings_fund' %}
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="hr-loans">
                    <span>{% trans "Loans" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="hr-loans">
                    {% if user_feature_permissions|feature_allowed:'hr.loans.management' %}
                    <a href="{% url 'hr:loans_management' %}" class="dropdown-item-sub">{% trans "Loan Management" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'hr.loans.scheduling' %}
                    <a href="{% url 'hr:loans_scheduling' %}" class="dropdown-item-sub">{% trans "Scheduling" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'hr.loans.savings_fund' %}
                    <a href="{% url 'hr:loans_savings_fund' %}" class="dropdown-item-sub">{% trans "Savings Fund" %}</a>
                    {% endif %}
                  </div>
                </div>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'hr.payroll.decrees' or user_feature_permissions|feature_allowed:'hr.payroll.decree_groups' or user_feature_permissions|feature_allowed:'hr.payroll.decree_subgroups' %}
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="hr-payroll-decrees">
                    <span>{% trans "Ø­Ú©Ù…â€ŒÙ‡Ø§ÛŒ Ø­Ù‚ÙˆÙ‚ Ùˆ Ø¯Ø³ØªÙ…Ø²Ø¯" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="hr-payroll-decrees">
                    {% if user_feature_permissions|feature_allowed:'hr.payroll.decrees' %}
                    <a href="{% url 'hr:payroll_decrees' %}" class="dropdown-item-sub">{% trans "Ø­Ú©Ù…â€ŒÙ‡Ø§" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'hr.payroll.decree_groups' %}
                    <a href="{% url 'hr:payroll_decree_groups' %}" class="dropdown-item-sub">{% trans "Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø­Ú©Ù…â€ŒÙ‡Ø§" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'hr.payroll.decree_subgroups' %}
                    <a href="{% url 'hr:payroll_decree_subgroups' %}" class="dropdown-item-sub">{% trans "Ø²ÛŒØ± Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø­Ú©Ù…â€ŒÙ‡Ø§" %}</a>
                    {% endif %}
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- Office Automation Menu -->
            {% if user_feature_permissions|feature_allowed:'office_automation.dashboard' or request.user.is_superuser %}
            <div class="top-menu-item">
              <button type="button" class="top-menu-btn" data-menu="office-automation">
                <span class="menu-icon">ğŸ“‹</span>
                <span class="menu-label">{% trans "Office Automation" %}</span>
              </button>
              <div class="dropdown-menu" id="menu-office-automation">
                <a href="{% url 'office_automation:dashboard' %}" class="dropdown-item">{% trans "Dashboard" %}</a>
                {% if user_feature_permissions|feature_allowed:'office_automation.inbox.incoming' or user_feature_permissions|feature_allowed:'office_automation.inbox.write' or user_feature_permissions|feature_allowed:'office_automation.inbox.fill_form' %}
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="office-automation-inbox">
                    <span>{% trans "Inbox" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="office-automation-inbox">
                    {% if user_feature_permissions|feature_allowed:'office_automation.inbox.incoming' %}
                    <a href="{% url 'office_automation:inbox_incoming' %}" class="dropdown-item-sub">{% trans "Incoming Letters" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'office_automation.inbox.write' %}
                    <a href="{% url 'office_automation:inbox_write' %}" class="dropdown-item-sub">{% trans "Write Letter" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'office_automation.inbox.fill_form' %}
                    <a href="{% url 'office_automation:inbox_fill_form' %}" class="dropdown-item-sub">{% trans "Fill Form" %}</a>
                    {% endif %}
                  </div>
                </div>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'office_automation.processes.engine' or user_feature_permissions|feature_allowed:'office_automation.processes.form_connection' %}
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="office-automation-processes">
                    <span>{% trans "Processes" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="office-automation-processes">
                    {% if user_feature_permissions|feature_allowed:'office_automation.processes.engine' %}
                    <a href="{% url 'office_automation:processes_engine' %}" class="dropdown-item-sub">{% trans "Process Engine" %}</a>
                    {% endif %}
                    {% if user_feature_permissions|feature_allowed:'office_automation.processes.form_connection' %}
                    <a href="{% url 'office_automation:processes_form_connection' %}" class="dropdown-item-sub">{% trans "Process-Form Connection" %}</a>
                    {% endif %}
                  </div>
                </div>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'office_automation.forms.builder' %}
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="office-automation-forms">
                    <span>{% trans "Forms" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="office-automation-forms">
                    <a href="{% url 'office_automation:forms_builder' %}" class="dropdown-item-sub">{% trans "Form Builder" %}</a>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- Transportation Menu -->
            {% if user_feature_permissions|feature_allowed:'transportation.dashboard' or request.user.is_superuser %}
            <div class="top-menu-item">
              <button type="button" class="top-menu-btn" data-menu="transportation">
                <span class="menu-icon">ğŸšš</span>
                <span class="menu-label">{% trans "Transportation" %}</span>
              </button>
              <div class="dropdown-menu" id="menu-transportation">
                <a href="{% url 'transportation:dashboard' %}" class="dropdown-item">{% trans "Dashboard" %}</a>
              </div>
            </div>
            {% endif %}

            <!-- Procurement Menu -->
            {% if user_feature_permissions|feature_allowed:'procurement.dashboard' or request.user.is_superuser %}
            <div class="top-menu-item">
              <button type="button" class="top-menu-btn" data-menu="procurement">
                <span class="menu-icon">ğŸ›ï¸</span>
                <span class="menu-label">{% trans "Procurement" %}</span>
              </button>
              <div class="dropdown-menu" id="menu-procurement">
                <a href="{% url 'procurement:dashboard' %}" class="dropdown-item">{% trans "Dashboard" %}</a>
                {% if user_feature_permissions|feature_allowed:'procurement.purchases' %}
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="procurement-purchases">
                    <span>{% trans "Purchases" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="procurement-purchases">
                    <a href="{% url 'procurement:purchases' %}" class="dropdown-item-sub">{% trans "Purchases" %}</a>
                  </div>
                </div>
                {% endif %}
                {% if user_feature_permissions|feature_allowed:'procurement.buyers' %}
                <div class="dropdown-submenu">
                  <button type="button" class="dropdown-item dropdown-toggle" data-submenu="procurement-buyers">
                    <span>{% trans "Buyers" %}</span>
                    <span class="dropdown-arrow">â–¶</span>
                  </button>
                  <div class="dropdown-menu-sub" id="procurement-buyers">
                    <a href="{% url 'procurement:buyer_create' %}" class="dropdown-item-sub">{% trans "Define Buyers" %}</a>
                    <a href="{% url 'procurement:buyer_assignment' %}" class="dropdown-item-sub">{% trans "Assign Buyers" %}</a>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}
            {% endcomment %}
            <!-- End of old individual menus -->
            {% endblock %}
          </nav>
        </div>
        <nav class="top-nav">
          {% block top_nav %}
          <!-- Notifications -->
          {% if request.user.is_authenticated %}
          <div class="notification-bell">
            <button type="button" class="notification-btn" id="notification-btn" title="{% trans 'Notifications' %}">
              <span class="notification-icon">ğŸ””</span>
              {% if notification_count > 0 %}
              <span class="notification-badge">{{ notification_count }}</span>
              {% endif %}
            </button>
            <div class="notification-dropdown" id="notification-dropdown">
              {% if notifications %}
              <div class="notification-header">
                <h3>{% trans "Notifications" %}</h3>
                <span class="notification-count-badge">{{ notification_count }}</span>
              </div>
              <div class="notification-list">
                {% for notification in notifications %}
                <div class="notification-item notification-{{ notification.type }} {% if notification.is_read %}notification-read{% else %}notification-unread{% endif %}">
                  <a href="{% url notification.url %}" 
                     class="notification-link"
                     data-notification-key="{{ notification.key }}"
                     data-notification-id="{{ notification.id }}">
                    <div class="notification-message">{{ notification.message }}</div>
                    <div class="notification-time">{% trans "Click to view" %}</div>
                  </a>
                  <div class="notification-actions">
                    {% if notification.is_read %}
                      <form method="post" action="{% url 'shared:mark_notification_unread' %}" style="display: inline;" onsubmit="event.stopPropagation();">
                        {% csrf_token %}
                        <input type="hidden" name="notification_id" value="{{ notification.id }}">
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <button type="submit" class="btn-notification-action" title="{% trans 'Mark as Unread' %}">ğŸ“¬</button>
                      </form>
                    {% else %}
                      <form method="post" action="{% url 'shared:mark_notification_read' %}" style="display: inline;" onsubmit="event.stopPropagation();">
                        {% csrf_token %}
                        <input type="hidden" name="notification_id" value="{{ notification.id }}">
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <button type="submit" class="btn-notification-action" title="{% trans 'Mark as Read' %}">âœ“</button>
                      </form>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
              <div class="notification-footer">
                <a href="{% url 'shared:notifications' %}" class="notification-view-all">{% trans "View All Notifications" %}</a>
              </div>
              {% else %}
              <div class="notification-empty">
                <div class="notification-empty-icon">ğŸ””</div>
                <div class="notification-empty-text">{% trans "No notifications" %}</div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
          
          <!-- Company Selector -->
          {% if request.user.is_authenticated and user_companies|length > 1 %}
          <form action="{% url 'shared:set_active_company' %}" method="post" class="company-switcher">
            {% csrf_token %}
            <input name="next" type="hidden" value="{{ request.get_full_path }}" />
            <label for="company-select" style="margin-right: 8px; font-size: 0.9rem; color: #fff;">
              {% trans "Company" %}:
            </label>
            <select name="company_id" id="company-select" onchange="this.form.submit()" class="company-select">
              {% for company in user_companies %}
                <option value="{{ company.id }}" {% if active_company and company.id == active_company.id %}selected{% endif %}>
                  {{ company.display_name }} ({{ company.public_code }})
                </option>
              {% endfor %}
            </select>
          </form>
          {% endif %}
          
          <!-- Fiscal Year Selector -->
          {% if request.user.is_authenticated and active_company %}
          {% if active_fiscal_year %}
          <form action="{% url 'accounting:set_fiscal_year' %}" method="post" class="fiscal-year-switcher">
            {% csrf_token %}
            <input name="next" type="hidden" value="{{ request.get_full_path }}" />
            <label for="fiscal-year-select" style="margin-right: 8px; font-size: 0.9rem; color: #fff;">
              {% trans "Ø³Ø§Ù„ Ù…Ø§Ù„ÛŒ" %}:
            </label>
            <select name="fiscal_year_id" id="fiscal-year-select" onchange="this.form.submit()" class="fiscal-year-select">
              {% if available_fiscal_years|length > 0 %}
                {% for fy in available_fiscal_years %}
                  <option value="{{ fy.id }}" {% if active_fiscal_year and fy.id == active_fiscal_year.id %}selected{% endif %}>
                    {{ fy.fiscal_year_code }} - {{ fy.fiscal_year_name }}
                  </option>
                {% endfor %}
              {% else %}
                <option value="{{ active_fiscal_year.id }}" selected>
                  {{ active_fiscal_year.fiscal_year_code }} - {{ active_fiscal_year.fiscal_year_name }}
                </option>
              {% endif %}
            </select>
          </form>
          {% endif %}
          {% endif %}
          
          <!-- User Info -->
          <div class="user-info-container">
            <span class="company-context">
              {% if request.user.is_authenticated %}
                ğŸ‘¤ {{ request.user.username }}
              {% else %}
                {% trans "Guest" %}
              {% endif %}
            </span>
            {% if request.user.is_authenticated %}
            <a href="{% url 'logout' %}" class="logout-btn" title="{% trans 'Logout' %}">
              {% trans "Logout" %}
            </a>
            {% endif %}
          </div>
          {% endblock %}
        </nav>
      </header>
      <aside class="app-sidebar collapsed" id="app-sidebar">
        {% block sidebar %}
          {% include "ui/components/sidebar.html" %}
        {% endblock %}
      </aside>
      <main class="app-content">
        {% block content %}
        <section class="page-section">
          <h1>{% trans "Welcome" %}</h1>
          <p>{% trans "Select a module from the sidebar." %}</p>
        </section>
        {% endblock %}
      </main>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Load saved state
        const savedState = localStorage.getItem('sidebar-sections-state');
        const sectionsState = savedState ? JSON.parse(savedState) : {};
        const savedGroups = localStorage.getItem('sidebar-groups-state');
        const groupsState = savedGroups ? JSON.parse(savedGroups) : {};

        // Initialize main sections - Default: collapsed unless explicitly opened
        const sections = document.querySelectorAll('.sidebar-section');
        sections.forEach(section => {
          const sectionName = section.getAttribute('data-section');
          // If no saved state OR saved state is false, collapse it
          const shouldBeOpen = sectionsState[sectionName] === true;
          
          if (!shouldBeOpen) {
            section.classList.add('collapsed');
          }
        });

        // Initialize nav groups - Default: collapsed unless explicitly opened
        const navGroups = document.querySelectorAll('.nav-group');
        navGroups.forEach(group => {
          const header = group.querySelector('.nav-group-header');
          if (header) {
            const submenuId = header.getAttribute('data-submenu');
            const shouldBeExpanded = groupsState[submenuId] === true;
            
            if (shouldBeExpanded) {
              group.classList.add('expanded');
            }
            // No need for else - default is collapsed
          }
        });

        // Toggle main section
        function toggleSection(section) {
          const sectionName = section.getAttribute('data-section');
          const isCollapsed = section.classList.contains('collapsed');
          
          section.classList.toggle('collapsed');
          // Save as true if opening (was collapsed), false if closing
          sectionsState[sectionName] = isCollapsed;
          
          localStorage.setItem('sidebar-sections-state', JSON.stringify(sectionsState));
        }

        // Toggle nav group
        function toggleNavGroup(group) {
          const header = group.querySelector('.nav-group-header');
          if (!header) return;
          
          const submenuId = header.getAttribute('data-submenu');
          const isExpanded = group.classList.contains('expanded');
          
          group.classList.toggle('expanded');
          // Save as true if expanding (was not expanded), false if collapsing
          groupsState[submenuId] = !isExpanded;
          
          localStorage.setItem('sidebar-groups-state', JSON.stringify(groupsState));
        }

        // Section headers
        document.querySelectorAll('.section-header').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.closest('.sidebar-section');
            if (section) {
              toggleSection(section);
            }
          });
        });

        // Nav group headers
        document.querySelectorAll('.nav-group-header').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const group = this.closest('.nav-group');
            if (group) {
              toggleNavGroup(group);
            }
          });
        });

        // Prevent nav-link-sub clicks from closing parent sections
        document.querySelectorAll('.nav-link-sub').forEach(link => {
          link.addEventListener('click', function(e) {
            e.stopPropagation();
          });
        });

        // Top menu dropdowns
        const menuButtons = document.querySelectorAll('.top-menu-btn');
        const dropdowns = document.querySelectorAll('.dropdown-menu');
        
        menuButtons.forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const menuId = this.getAttribute('data-menu');
            const dropdown = document.getElementById(`menu-${menuId}`);
            
            // Close other dropdowns
            dropdowns.forEach(d => {
              if (d !== dropdown) {
                d.classList.remove('open');
              }
            });
            
            // Toggle current dropdown
            if (dropdown) {
              const isOpening = !dropdown.classList.contains('open');
              dropdown.classList.toggle('open');
              
              // Toggle button active state
              if (isOpening) {
                this.classList.add('active');
              } else {
                this.classList.remove('active');
              }
            }
          });
        });
        
        // Prevent dropdown-item-sub clicks from closing dropdowns
        document.querySelectorAll('.dropdown-item-sub').forEach(link => {
          link.addEventListener('click', function(e) {
            // Don't prevent default - allow navigation
            // But stop propagation to prevent dropdown from closing
            e.stopPropagation();
            e.stopImmediatePropagation();
          });
        });

        // Close dropdowns when clicking outside
        // This runs in bubble phase (AFTER capture phase handlers)
        document.addEventListener('click', function(e) {
          // Don't close if clicking on ANY dropdown element
          // Check thoroughly - including nested elements and buttons
          const clickedOnDropdown = e.target.closest('.dropdown-toggle') || 
                                    e.target.closest('.dropdown-menu-sub') || 
                                    e.target.closest('.dropdown-item-sub') ||
                                    e.target.closest('.dropdown-submenu') ||
                                    e.target.closest('.dropdown-menu') ||
                                    e.target.closest('.top-menu-item') ||
                                    e.target.closest('.dropdown-item') ||
                                    e.target.closest('button[data-submenu]') ||
                                    e.target.closest('.top-menu-btn');
          
          if (clickedOnDropdown) {
            return; // Don't close dropdown
          }
          
          // Only close if we're really outside
          dropdowns.forEach(d => {
            d.classList.remove('open');
          });
        }); // Bubble phase - runs AFTER capture phase

        // Notification dropdown
        const notificationBtn = document.getElementById('notification-btn');
        const notificationDropdown = document.getElementById('notification-dropdown');
        
        if (notificationBtn && notificationDropdown) {
          notificationBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            notificationDropdown.classList.toggle('open');
          });
          
          // Close dropdown when clicking outside
          document.addEventListener('click', function(e) {
            if (!e.target.closest('.notification-bell')) {
              notificationDropdown.classList.remove('open');
            }
          });
        }
        
        // Toggle sidebar
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('app-sidebar');
        const appShell = document.querySelector('.app-shell');
        
        if (sidebarToggle && sidebar && appShell) {
          // Load saved state
          const sidebarState = localStorage.getItem('sidebar-open');
          const isOpen = sidebarState === 'true';
          
          if (!isOpen) {
            sidebar.classList.add('collapsed');
            appShell.classList.add('sidebar-collapsed');
          }
          
          sidebarToggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const isCollapsed = sidebar.classList.contains('collapsed');
            
            if (isCollapsed) {
              sidebar.classList.remove('collapsed');
              appShell.classList.remove('sidebar-collapsed');
              localStorage.setItem('sidebar-open', 'true');
            } else {
              sidebar.classList.add('collapsed');
              appShell.classList.add('sidebar-collapsed');
              localStorage.setItem('sidebar-open', 'false');
            }
          });
        }

        // Dropdown submenus - click to toggle
        // Use capture phase with HIGHEST priority to handle BEFORE all other handlers
        document.addEventListener('click', function(e) {
          // Check if click is on a dropdown-toggle button
          const toggleBtn = e.target.closest('.dropdown-toggle');
          if (!toggleBtn) return;
          
          // Check if this toggle is inside a dropdown-submenu
          const submenu = toggleBtn.closest('.dropdown-submenu');
          if (!submenu) return;
          
          const submenuEl = submenu.querySelector('.dropdown-menu-sub');
          const dropdownMenu = submenu.closest('.dropdown-menu');
          
          if (!submenuEl || !dropdownMenu) return;
          
          // Stop ALL event propagation immediately - BEFORE any other handlers
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          
          const isOpen = submenuEl.classList.contains('open');
          
          // Close all other submenus at the same level
          const parentSubmenu = submenu.parentElement.closest('.dropdown-submenu');
          if (parentSubmenu) {
            parentSubmenu.querySelectorAll('.dropdown-submenu').forEach(otherSubmenu => {
              if (otherSubmenu !== submenu) {
                const otherSubmenuEl = otherSubmenu.querySelector('.dropdown-menu-sub');
                if (otherSubmenuEl) {
                  otherSubmenuEl.classList.remove('open');
                  otherSubmenu.classList.remove('active');
                }
              }
            });
          } else {
            // Close all other submenus in the same dropdown
            dropdownMenu.querySelectorAll('.dropdown-submenu').forEach(otherSubmenu => {
              if (otherSubmenu !== submenu) {
                const otherSubmenuEl = otherSubmenu.querySelector('.dropdown-menu-sub');
                if (otherSubmenuEl) {
                  otherSubmenuEl.classList.remove('open');
                  otherSubmenu.classList.remove('active');
                }
              }
            });
          }
          
          // Toggle current submenu
          if (isOpen) {
            submenuEl.classList.remove('open');
            submenu.classList.remove('active');
          } else {
            submenuEl.classList.add('open');
            submenu.classList.add('active');
            dropdownMenu.style.overflowY = 'auto';
          }
          
          // CRITICAL: Force parent dropdown to stay open - use requestAnimationFrame to ensure it happens
          requestAnimationFrame(function() {
            dropdownMenu.classList.add('open');
            const topMenuItem = dropdownMenu.closest('.top-menu-item');
            if (topMenuItem) {
              const menuBtn = topMenuItem.querySelector('.top-menu-btn');
              if (menuBtn) {
                menuBtn.classList.add('active');
              }
            }
          });
          
          // Prevent any other handlers from running
          return false;
        }, true); // Capture phase - runs FIRST with highest priority
        
        // Close submenu when clicking outside (but not when clicking on submenu items or toggles)
        document.addEventListener('click', function(e) {
          // Don't close if clicking on dropdown elements
          const clickedInside = e.target.closest('.dropdown-item-sub') || 
                                e.target.closest('.dropdown-toggle') || 
                                e.target.closest('.dropdown-submenu') ||
                                e.target.closest('.dropdown-menu') ||
                                e.target.closest('.top-menu-item');
          
          if (clickedInside) {
            return;
          }
          
          // Close all submenus when clicking outside
          document.querySelectorAll('.dropdown-submenu').forEach(submenu => {
            const submenuEl = submenu.querySelector('.dropdown-menu-sub');
            if (submenuEl) {
              submenuEl.classList.remove('open');
              submenu.classList.remove('active');
            }
          });
        });
      });
      
      // Mark notification as read
      function markNotificationAsRead(notificationKey, notificationId, redirectUrl) {
        // Get CSRF token from any form on the page
        let csrfToken = null;
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
          csrfToken = csrfInput.value;
        } else {
          // Try to get from cookie
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith('csrftoken=')) {
              csrfToken = cookie.substring('csrftoken='.length);
              break;
            }
          }
        }
        
        if (!csrfToken) {
          // If no CSRF token found, just redirect
          console.warn('CSRF token not found, redirecting without marking as read');
          window.location.href = redirectUrl;
          return;
        }
        
        // Use fetch API to mark notification as read, then redirect
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        if (notificationKey) {
          formData.append('notification_key', notificationKey);
        }
        if (notificationId) {
          formData.append('notification_id', notificationId);
        }
        formData.append('next', redirectUrl);
        
        fetch('{% url "shared:mark_notification_read" %}', {
          method: 'POST',
          body: formData,
          credentials: 'same-origin',
          headers: {
            'X-CSRFToken': csrfToken
          }
        })
        .then(response => {
          if (response.ok || response.redirected) {
            // Redirect to the target URL
            window.location.href = redirectUrl;
          } else {
            console.error('Failed to mark notification as read');
            // Still redirect even if marking failed
            window.location.href = redirectUrl;
          }
        })
        .catch(error => {
          console.error('Error marking notification as read:', error);
          // Still redirect even if there's an error
          window.location.href = redirectUrl;
        });
      }
    </script>
    {% block extra_scripts %}{% endblock %}
  </body>
</html>

