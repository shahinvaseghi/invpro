{% extends "shared/generic/generic_form.html" %}
{% load i18n %}
{% load static %}
{% load access_tags %}

{% block breadcrumb_extra %}
<span class="separator">/</span>
<span>{% trans "Production" %}</span>
<span class="separator">/</span>
<a href="{% url 'production:product_orders' %}">{% trans "Product Orders" %}</a>
<span class="separator">/</span>
<span>{{ form_title }}</span>
{% endblock %}

{% block form_sections %}
<div class="form-section">
  <h2>{% trans "Order Information" %}</h2>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.bom.id_for_label }}">{{ form.bom.label }} *</label>
      {{ form.bom }}
      {% if form.bom.errors %}
        <span class="error">{{ form.bom.errors.0 }}</span>
      {% endif %}
      {% if form.bom.help_text %}
        <small class="form-text">{{ form.bom.help_text }}</small>
      {% endif %}
    </div>
  </div>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.quantity_planned.id_for_label }}">{{ form.quantity_planned.label }} *</label>
      {{ form.quantity_planned }}
      {% if form.quantity_planned.errors %}
        <span class="error">{{ form.quantity_planned.errors.0 }}</span>
      {% endif %}
    </div>
  </div>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.approved_by.id_for_label }}">{{ form.approved_by.label }}</label>
      {{ form.approved_by }}
      {% if form.approved_by.errors %}
        <span class="error">{{ form.approved_by.errors.0 }}</span>
      {% endif %}
      {% if form.approved_by.help_text %}
        <small class="form-text">{{ form.approved_by.help_text }}</small>
      {% endif %}
    </div>
  </div>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.due_date.id_for_label }}">{{ form.due_date.label }}</label>
      {{ form.due_date }}
      {% if form.due_date.errors %}
        <span class="error">{{ form.due_date.errors.0 }}</span>
      {% endif %}
    </div>
    
    <div class="form-field">
      <label for="{{ form.priority.id_for_label }}">{{ form.priority.label }}</label>
      {{ form.priority }}
      {% if form.priority.errors %}
        <span class="error">{{ form.priority.errors.0 }}</span>
      {% endif %}
    </div>
  </div>
  
  <div class="form-row">
    <div class="form-field full-width">
      <label for="{{ form.customer_reference.id_for_label }}">{{ form.customer_reference.label }}</label>
      {{ form.customer_reference }}
      {% if form.customer_reference.errors %}
        <span class="error">{{ form.customer_reference.errors.0 }}</span>
      {% endif %}
    </div>
  </div>
  
  <div class="form-row">
    <div class="form-field full-width">
      <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
      {{ form.notes }}
      {% if form.notes.errors %}
        <span class="error">{{ form.notes.errors.0 }}</span>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block form_extra %}
{% if user_feature_permissions|feature_allowed:'production.product_orders:create_transfer_from_order' or request.user.is_superuser %}
<div class="form-section" id="transfer-request-section">
  <header class="section-header">
    <h2>{% trans "Transfer Request (Optional)" %}</h2>
    <p>{% trans "Optionally create a transfer to line request from this order." %}</p>
  </header>
  
  <div class="form-row">
    <div class="form-field">
      <div class="form-check">
        {{ form.create_transfer_request }}
        <label class="form-check-label" for="{{ form.create_transfer_request.id_for_label }}">
          {{ form.create_transfer_request.label }}
        </label>
        {% if form.create_transfer_request.help_text %}
          <small class="form-text">{{ form.create_transfer_request.help_text }}</small>
        {% endif %}
      </div>
      {% if form.create_transfer_request.errors %}
        <span class="error">{{ form.create_transfer_request.errors.0 }}</span>
      {% endif %}
    </div>
  </div>
  
  <div class="form-row" id="transfer-approver-row" style="display: none;">
    <div class="form-field">
      <label for="{{ form.transfer_approved_by.id_for_label }}">{{ form.transfer_approved_by.label }} *</label>
      {{ form.transfer_approved_by }}
      {% if form.transfer_approved_by.errors %}
        <span class="error">{{ form.transfer_approved_by.errors.0 }}</span>
      {% endif %}
      {% if form.transfer_approved_by.help_text %}
        <small class="form-text">{{ form.transfer_approved_by.help_text }}</small>
      {% endif %}
    </div>
  </div>
  
  <div id="extra-items-section" style="display: none;">
    <h3>{% trans "Extra Request Items" %}</h3>
    <p class="form-text">{% trans "Add additional items that are not in the BOM." %}</p>
    
    {% if extra_items_formset %}
      {{ extra_items_formset.management_form }}
      
      {% if extra_items_formset.non_form_errors %}
        <div class="alert alert-error">
          {% for error in extra_items_formset.non_form_errors %}
            <div>{{ error }}</div>
          {% endfor %}
        </div>
      {% endif %}
      
      <div class="table-responsive" style="overflow-x: auto; width: 100%; margin-bottom: 1rem;">
      <table class="data-table formset-table" id="extra-items-table">
        <thead>
          <tr>
            <th>{% trans "Material Type" %}</th>
            <th>{% trans "Category" %}</th>
            <th>{% trans "Subcategory" %}</th>
            <th>{% trans "Material Item" %}</th>
            <th>{% trans "Quantity Required" %}</th>
            <th>{% trans "Unit" %}</th>
            <th>{% trans "Source Warehouse" %}</th>
            <th>{% trans "Destination Work Center" %}</th>
            <th>{% trans "Scrap Allowance (%)" %}</th>
            <th>{% trans "Actions" %}</th>
          </tr>
        </thead>
        <tbody id="extra-items-formset-container">
          {% for item_form in extra_items_formset %}
          <tr class="formset-row" data-row-index="{{ forloop.counter0 }}">
            {% for hidden in item_form.hidden_fields %}{{ hidden }}{% endfor %}
            <td>
              {{ item_form.material_type }}
              {% if item_form.material_type.errors %}
                <div class="field-error">{{ item_form.material_type.errors.0 }}</div>
              {% endif %}
            </td>
            <td>
              {{ item_form.material_category_filter }}
              {% if item_form.material_category_filter.errors %}
                <div class="field-error">{{ item_form.material_category_filter.errors.0 }}</div>
              {% endif %}
            </td>
            <td>
              {{ item_form.material_subcategory_filter }}
              {% if item_form.material_subcategory_filter.errors %}
                <div class="field-error">{{ item_form.material_subcategory_filter.errors.0 }}</div>
              {% endif %}
            </td>
            <td>
              {{ item_form.material_item }}
              {% if item_form.material_item.errors %}
                <div class="field-error">{{ item_form.material_item.errors.0 }}</div>
              {% endif %}
            </td>
            <td>
              {{ item_form.quantity_required }}
              {% if item_form.quantity_required.errors %}
                <div class="field-error">{{ item_form.quantity_required.errors.0 }}</div>
              {% endif %}
            </td>
            <td>
              {{ item_form.unit }}
              {% if item_form.unit.errors %}
                <div class="field-error">{{ item_form.unit.errors.0 }}</div>
              {% endif %}
            </td>
            <td>
              {{ item_form.source_warehouse }}
              {% if item_form.source_warehouse.errors %}
                <div class="field-error">{{ item_form.source_warehouse.errors.0 }}</div>
              {% endif %}
            </td>
            <td>
              {{ item_form.destination_work_center }}
              {% if item_form.destination_work_center.errors %}
                <div class="field-error">{{ item_form.destination_work_center.errors.0 }}</div>
              {% endif %}
            </td>
            <td>
              {{ item_form.material_scrap_allowance }}
              {% if item_form.material_scrap_allowance.errors %}
                <div class="field-error">{{ item_form.material_scrap_allowance.errors.0 }}</div>
              {% endif %}
            </td>
            <td>
              {% if extra_items_formset.can_delete %}
                {{ item_form.DELETE }}
                {% if item_form.DELETE %}
                  <label for="{{ item_form.DELETE.id_for_label }}" style="margin-left: 5px; cursor: pointer;">
                    {% trans "Delete" %}
                  </label>
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
      
      <button type="button" id="add-extra-item-btn" class="btn btn-secondary">+ {% trans "Add Extra Item" %}</button>
    {% endif %}
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_styles %}
<style>
.table-responsive {
  overflow-x: auto;
  width: 100%;
  margin-bottom: 1rem;
}

#extra-items-table {
  min-width: 1200px;
  width: 100%;
}

#extra-items-table th,
#extra-items-table td {
  white-space: nowrap;
  min-width: 120px;
  padding: 8px 12px;
}

#extra-items-table th:nth-child(1),
#extra-items-table td:nth-child(1) {
  min-width: 150px;
}

#extra-items-table th:nth-child(2),
#extra-items-table td:nth-child(2) {
  min-width: 150px;
}

#extra-items-table th:nth-child(3),
#extra-items-table td:nth-child(3) {
  min-width: 150px;
}

#extra-items-table th:nth-child(4),
#extra-items-table td:nth-child(4) {
  min-width: 200px;
}

#extra-items-table th:nth-child(5),
#extra-items-table td:nth-child(5) {
  min-width: 120px;
}

#extra-items-table th:nth-child(6),
#extra-items-table td:nth-child(6) {
  min-width: 100px;
}

#extra-items-table th:nth-child(7),
#extra-items-table td:nth-child(7) {
  min-width: 150px;
}

#extra-items-table th:nth-child(8),
#extra-items-table td:nth-child(8) {
  min-width: 180px;
}

#extra-items-table th:nth-child(9),
#extra-items-table td:nth-child(9) {
  min-width: 120px;
}

#extra-items-table th:nth-child(10),
#extra-items-table td:nth-child(10) {
  min-width: 80px;
}

.formset-table {
  border-collapse: collapse;
}

.formset-table thead {
  background: #f3f4f6;
}

.formset-table th {
  font-weight: 600;
  text-align: left;
  border-bottom: 2px solid #e5e7eb;
}

.formset-table td {
  border-bottom: 1px solid #e5e7eb;
}

.formset-table tbody tr:hover {
  background: #f9fafb;
}

.field-error {
  color: #dc2626;
  font-size: 0.875rem;
  margin-top: 0.25rem;
  display: block;
}

.form-check {
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
}

.form-check-label {
  font-weight: 500;
  cursor: pointer;
}

.form-check-input {
  width: 1.25rem;
  height: 1.25rem;
  margin-top: 0.125rem;
  cursor: pointer;
}
</style>
{% endblock %}

{% block form_scripts %}
<link rel="stylesheet" href="{% static 'css/jalali-datepicker/jalali-datepicker.min.css' %}">
<script src="{% static 'js/jalali-datepicker/jalali-datepicker.min.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Jalali DatePicker
  var jalaliInputs = document.querySelectorAll('input.jalali-date-input, input[data-jalali="true"]');
  
  jalaliInputs.forEach(function(input) {
    input.setAttribute('data-jdp', '');
    input.setAttribute('data-jdp-only-date', '');
  });
  
  if (typeof jalaliDatepicker !== 'undefined') {
    jalaliDatepicker.startWatch({
      date: true,
      time: false,
      separatorChars: {
        date: '/',
        between: ' ',
        time: ':'
      },
      persianDigits: false,
      autoShow: true,
      autoHide: true,
      hideAfterChange: true,
      showTodayBtn: true,
      showEmptyBtn: true,
      showCloseBtn: true,
      useDropDownYears: true,
      zIndex: 1000
    });
  } else {
    console.error('Jalali DatePicker library not loaded!');
  }
  
  // Show/hide transfer approver field and extra items section based on checkbox
  var createTransferCheckbox = document.getElementById('{{ form.create_transfer_request.id_for_label }}');
  var transferApproverRow = document.getElementById('transfer-approver-row');
  var transferApproverField = document.getElementById('{{ form.transfer_approved_by.id_for_label }}');
  var extraItemsSection = document.getElementById('extra-items-section');
  
  if (createTransferCheckbox) {
    function toggleTransferSection() {
      if (createTransferCheckbox.checked) {
        if (transferApproverRow) transferApproverRow.style.display = '';
        if (transferApproverField) transferApproverField.required = true;
        if (extraItemsSection) extraItemsSection.style.display = '';
      } else {
        if (transferApproverRow) transferApproverRow.style.display = 'none';
        if (transferApproverField) {
          transferApproverField.required = false;
          transferApproverField.value = '';
        }
        if (extraItemsSection) extraItemsSection.style.display = 'none';
      }
    }
    
    createTransferCheckbox.addEventListener('change', toggleTransferSection);
    toggleTransferSection();
  }
  
  // Formset management for extra items
  var extraItemsFormsetContainer = document.getElementById('extra-items-formset-container');
  var addExtraItemBtn = document.getElementById('add-extra-item-btn');
  var extraItemsTotalFormsInput = document.querySelector('#id_extra_items-TOTAL_FORMS');
  var extraItemsFormCount = extraItemsFormsetContainer ? extraItemsFormsetContainer.children.length : 0;
  
  if (addExtraItemBtn && extraItemsFormsetContainer && extraItemsTotalFormsInput) {
    addExtraItemBtn.addEventListener('click', function() {
      var newForm = extraItemsFormsetContainer.lastElementChild.cloneNode(true);
      var formIndex = extraItemsFormCount;
      extraItemsFormCount++;
      
      newForm.setAttribute('data-row-index', formIndex);
      
      newForm.querySelectorAll('input, select, textarea').forEach(function(field) {
        if (field.name) {
          field.name = field.name.replace(/extra_items-\d+-/, 'extra_items-' + formIndex + '-');
        }
        if (field.id) {
          field.id = field.id.replace(/id_extra_items-\d+-/, 'id_extra_items-' + formIndex + '-');
        }
        if (field.type !== 'hidden' && field.type !== 'checkbox') {
          field.value = '';
        }
        if (field.type === 'checkbox') {
          field.checked = false;
        }
      });
      
      newForm.querySelectorAll('label').forEach(function(label) {
        if (label.getAttribute('for')) {
          label.setAttribute('for', label.getAttribute('for').replace(/id_extra_items-\d+-/, 'id_extra_items-' + formIndex + '-'));
        }
      });
      
      var deleteCheckbox = newForm.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (deleteCheckbox) {
        deleteCheckbox.checked = false;
      }
      
      newForm.querySelectorAll('.field-error').forEach(function(error) {
        error.textContent = '';
      });
      
      extraItemsFormsetContainer.appendChild(newForm);
      extraItemsTotalFormsInput.value = extraItemsFormCount;
      
      setTimeout(function() {
        setupRowCascading(newForm, 'extra_items');
      }, 100);
    });
  }
  
  // Handle DELETE checkboxes
  if (extraItemsFormsetContainer) {
    extraItemsFormsetContainer.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox' && e.target.name && e.target.name.includes('-DELETE')) {
        var row = e.target.closest('.formset-row');
        if (row && e.target.checked) {
          row.style.display = 'none';
        } else if (row && !e.target.checked) {
          row.style.display = '';
        }
      }
    });
  }
  
  // Cascading Filters for Extra Items (Type → Category → Subcategory → Item)
  function setupRowCascading(row, prefix) {
    var rowIndex = row.dataset.rowIndex;
    if (!rowIndex) {
      var firstField = row.querySelector('[name]');
      if (firstField && firstField.name) {
        var nameMatch = firstField.name.match(new RegExp(prefix + '-(\\d+)-'));
        if (nameMatch) {
          rowIndex = nameMatch[1];
          row.setAttribute('data-row-index', rowIndex);
        } else {
          return;
        }
      } else {
        return;
      }
    }
    
    var typeSelect = row.querySelector('select[name="' + prefix + '-' + rowIndex + '-material_type"]');
    var categorySelect = row.querySelector('select[name="' + prefix + '-' + rowIndex + '-material_category_filter"]');
    var subcategorySelect = row.querySelector('select[name="' + prefix + '-' + rowIndex + '-material_subcategory_filter"]');
    var itemSelect = row.querySelector('select[name="' + prefix + '-' + rowIndex + '-material_item"]');
    var unitSelect = row.querySelector('select[name="' + prefix + '-' + rowIndex + '-unit"]');
    
    if (!typeSelect || !categorySelect || !subcategorySelect || !itemSelect) {
      return;
    }
    
    function filterCategories() {
      var selectedType = typeSelect.value;
      var currentCategory = categorySelect.value;
      
      if (!selectedType) {
        categorySelect.innerHTML = '<option value="">--------</option>';
        subcategorySelect.innerHTML = '<option value="">--------</option>';
        itemSelect.innerHTML = '<option value="">--------</option>';
        if (unitSelect) {
          unitSelect.innerHTML = '<option value="">--------</option>';
          unitSelect.disabled = true;
        }
        return;
      }
      
      categorySelect.innerHTML = '<option value="">{% trans "Loading categories..." %}</option>';
      categorySelect.disabled = true;
      
      fetch('/inventory/api/filtered-categories/?type_id=' + selectedType)
        .then(response => response.json())
        .then(data => {
          categorySelect.innerHTML = '<option value="">--------</option>';
          
          if (data.categories && data.categories.length > 0) {
            data.categories.forEach(function(cat) {
              var option = document.createElement('option');
              option.value = cat.value;
              option.textContent = cat.label;
              categorySelect.appendChild(option);
            });
            
            if (currentCategory && data.categories.some(function(c) { return c.value === currentCategory; })) {
              categorySelect.value = currentCategory;
            } else {
              subcategorySelect.value = '';
              itemSelect.innerHTML = '<option value="">--------</option>';
            }
          }
          
          categorySelect.disabled = false;
          filterSubcategories();
        })
        .catch(error => {
          console.error('Error loading categories:', error);
          categorySelect.innerHTML = '<option value="">--------</option>';
          categorySelect.disabled = false;
        });
    }
    
    function filterSubcategories() {
      var selectedType = typeSelect.value;
      var selectedCategory = categorySelect.value;
      var currentSubcategory = subcategorySelect.value;
      
      if (!selectedType || !selectedCategory) {
        subcategorySelect.innerHTML = '<option value="">--------</option>';
        itemSelect.innerHTML = '<option value="">--------</option>';
        if (unitSelect) {
          unitSelect.innerHTML = '<option value="">--------</option>';
          unitSelect.disabled = true;
        }
        return;
      }
      
      subcategorySelect.innerHTML = '<option value="">{% trans "Loading subcategories..." %}</option>';
      subcategorySelect.disabled = true;
      
      fetch('/inventory/api/filtered-subcategories/?type_id=' + selectedType + '&category_id=' + selectedCategory)
        .then(response => response.json())
        .then(data => {
          subcategorySelect.innerHTML = '<option value="">--------</option>';
          
          if (data.subcategories && data.subcategories.length > 0) {
            data.subcategories.forEach(function(subcat) {
              var option = document.createElement('option');
              option.value = subcat.value;
              option.textContent = subcat.label;
              subcategorySelect.appendChild(option);
            });
            
            if (currentSubcategory && data.subcategories.some(function(s) { return s.value === currentSubcategory; })) {
              subcategorySelect.value = currentSubcategory;
            } else {
              itemSelect.innerHTML = '<option value="">--------</option>';
            }
          }
          
          subcategorySelect.disabled = false;
          filterItems();
        })
        .catch(error => {
          console.error('Error loading subcategories:', error);
          subcategorySelect.innerHTML = '<option value="">--------</option>';
          subcategorySelect.disabled = false;
        });
    }
    
    function filterItems() {
      var selectedType = typeSelect.value;
      var selectedCategory = categorySelect.value;
      var selectedSubcategory = subcategorySelect.value;
      var currentItem = itemSelect.value;
      
      if (!selectedType || !selectedCategory || !selectedSubcategory) {
        itemSelect.innerHTML = '<option value="">--------</option>';
        if (unitSelect) {
          unitSelect.innerHTML = '<option value="">--------</option>';
          unitSelect.disabled = true;
        }
        return;
      }
      
      itemSelect.innerHTML = '<option value="">{% trans "Loading items..." %}</option>';
      itemSelect.disabled = true;
      
      fetch('/inventory/api/filtered-items/?type_id=' + selectedType + '&category_id=' + selectedCategory + '&subcategory_id=' + selectedSubcategory)
        .then(response => response.json())
        .then(data => {
          itemSelect.innerHTML = '<option value="">--------</option>';
          
          if (data.items && data.items.length > 0) {
            data.items.forEach(function(item) {
              var option = document.createElement('option');
              option.value = item.value;
              option.textContent = item.label;
              itemSelect.appendChild(option);
            });
            
            if (currentItem && data.items.some(function(i) { return i.value === currentItem; })) {
              itemSelect.value = currentItem;
              loadItemUnits(itemSelect, rowIndex, prefix);
            }
          }
          
          itemSelect.disabled = false;
        })
        .catch(error => {
          console.error('Error loading items:', error);
          itemSelect.innerHTML = '<option value="">--------</option>';
          itemSelect.disabled = false;
        });
    }
    
    function loadItemUnits(materialItemSelect, idx, pfx) {
      var itemId = materialItemSelect.value;
      var unitSel = document.querySelector('select[name="' + pfx + '-' + idx + '-unit"]');
      
      if (!itemId || !unitSel) {
        if (unitSel) {
          unitSel.innerHTML = '<option value="">--------</option>';
          unitSel.disabled = true;
        }
        return;
      }
      
      unitSel.disabled = true;
      unitSel.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
      
      fetch('/inventory/api/item-units/?item_id=' + itemId)
        .then(response => response.json())
        .then(data => {
          if (data.units && data.units.length > 0) {
            unitSel.innerHTML = '<option value="">--------</option>';
            data.units.forEach(function(unit) {
              var option = document.createElement('option');
              option.value = unit.value;
              option.textContent = unit.label;
              unitSel.appendChild(option);
            });
            unitSel.disabled = false;
          } else {
            unitSel.innerHTML = '<option value="">--------</option>';
            unitSel.disabled = true;
          }
        })
        .catch(error => {
          console.error('Error loading units:', error);
          unitSel.innerHTML = '<option value="">--------</option>';
          unitSel.disabled = true;
        });
    }
    
    typeSelect.addEventListener('change', filterCategories);
    categorySelect.addEventListener('change', filterSubcategories);
    subcategorySelect.addEventListener('change', filterItems);
    itemSelect.addEventListener('change', function() {
      loadItemUnits(itemSelect, rowIndex, prefix);
    });
  }
  
  // Initialize cascading filters for all existing rows
  if (extraItemsFormsetContainer) {
    extraItemsFormsetContainer.querySelectorAll('.formset-row').forEach(function(row) {
      setupRowCascading(row, 'extra_items');
    });
  }
});
</script>
{% endblock %}
