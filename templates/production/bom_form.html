{% extends "shared/generic/generic_form.html" %}
{% load i18n %}
{% load static %}

{% block form_sections %}

      <!-- ÿ®ÿÆÿ¥ 1: ŸÖÿ≠ÿµŸàŸÑ ŸÜŸáÿß€å€å -->
      <div class="form-section">
        <h3>{% trans "Finished Product Selection" %}</h3>
        
        <div class="form-row">
          <div class="form-field">
            <label for="{{ form.item_type.id_for_label }}">{% trans "Item Type" %}</label>
            {{ form.item_type }}
            {% if form.item_type.errors %}
              <span class="error">{{ form.item_type.errors.0 }}</span>
            {% endif %}
          </div>

          <div class="form-field">
            <label for="{{ form.item_category.id_for_label }}">{% trans "Category" %}</label>
            {{ form.item_category }}
            {% if form.item_category.errors %}
              <span class="error">{{ form.item_category.errors.0 }}</span>
            {% endif %}
          </div>

          <div class="form-field">
            <label for="{{ form.item_subcategory.id_for_label }}">{% trans "Subcategory" %}</label>
            {{ form.item_subcategory }}
            {% if form.item_subcategory.errors %}
              <span class="error">{{ form.item_subcategory.errors.0 }}</span>
            {% endif %}
          </div>
        </div>

        <div class="form-row">
          <div class="form-field full-width">
            <label for="{{ form.finished_item.id_for_label }}">{{ form.finished_item.label }} *</label>
            <div class="item-select-wrapper">
              <div class="item-filters">
                <input type="text" class="form-control filter-search-input" 
                       id="finished-item-search"
                       placeholder="{% trans 'Search by name or code...' %}" 
                       class="item-filter-input">
              </div>
              {{ form.finished_item }}
            </div>
            {% if form.finished_item.errors %}
              <span class="error">{{ form.finished_item.errors.0 }}</span>
            {% endif %}
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label for="{{ form.version.id_for_label }}">{{ form.version.label }}</label>
            {{ form.version }}
            {% if form.version.errors %}
              <span class="error">{{ form.version.errors.0 }}</span>
            {% endif %}
          </div>

          <div class="form-field">
            <label for="{{ form.is_enabled.id_for_label }}">{{ form.is_enabled.label }} *</label>
            {{ form.is_enabled }}
            {% if form.is_enabled.errors %}
              <span class="error">{{ form.is_enabled.errors.0 }}</span>
            {% endif %}
          </div>
        </div>

        <div class="form-row">
          <div class="form-field full-width">
            <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
            {{ form.description }}
          </div>
        </div>

        <div class="form-row">
          <div class="form-field full-width">
            <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
            {{ form.notes }}
          </div>
        </div>
      </div>

      <!-- ÿ®ÿÆÿ¥ 2: ŸÖŸàÿßÿØ ÿßŸàŸÑ€åŸá (Formset) -->
      <div class="form-section">
        <h3>{% trans "Materials" %}</h3>
        
        {{ formset.management_form }}
        
        {% if formset.non_form_errors %}
          <div class="alert alert-error">
            {{ formset.non_form_errors }}
          </div>
        {% endif %}

        <div class="materials-table-wrapper">
          <table class="materials-table" id="materials-table">
            <thead>
              <tr>
                <th class="col-line">{% trans "Line" %}</th>
                <th class="col-material-type">{% trans "Material Type" %}</th>
                <th class="col-category">{% trans "Category" %}</th>
                <th class="col-subcategory">{% trans "Subcategory" %}</th>
                <th>{% trans "Material/Component" %}</th>
                <th class="col-quantity">{% trans "Quantity" %}</th>
                <th class="col-unit">{% trans "Unit" %}</th>
                <th class="col-scrap">{% trans "Scrap %" %}</th>
                <th class="col-warehouses">{% trans "Source Warehouses" %}</th>
                <th class="col-optional">{% trans "Optional" %}</th>
                <th class="col-delete">{% trans "Delete" %}</th>
              </tr>
            </thead>
            <tbody id="materials-tbody">
              {% for form in formset %}
                <tr class="material-row {% if form.instance.pk %}existing{% else %}new{% endif %}" 
                    data-form-idx="{{ forloop.counter0 }}"
                    {% if form.unit.value %}data-initial-unit-value="{{ form.unit.value }}"{% endif %}>
                  <td class="line-number">{{ forloop.counter }}</td>
                  <td>
                    {{ form.id }}
                    {{ form.material_type }}
                    {% if form.material_type.errors %}
                      <span class="error">{{ form.material_type.errors.0 }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {{ form.material_category_filter }}
                    {% if form.material_category_filter.errors %}
                      <span class="error">{{ form.material_category_filter.errors.0 }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {{ form.material_subcategory_filter }}
                    {% if form.material_subcategory_filter.errors %}
                      <span class="error">{{ form.material_subcategory_filter.errors.0 }}</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="item-select-wrapper">
                      <div class="item-filters">
                        <input type="text" class="form-control filter-search-input" 
                               placeholder="{% trans 'Search by name or code...' %}" 
                               data-form-index="{{ forloop.counter0 }}"
                               style="flex: 1; min-width: 150px; font-size: 0.7rem; padding: 0.3rem 0.4rem; border: 1px solid #d1d5db; border-radius: 4px; background-color: #f9fafb; color: #6b7280;">
                      </div>
                      {{ form.material_item }}
                    </div>
                    {% if form.material_item.errors %}
                      <span class="error">{{ form.material_item.errors.0 }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {{ form.quantity_per_unit }}
                    {% if form.quantity_per_unit.errors %}
                      <span class="error">{{ form.quantity_per_unit.errors.0 }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {{ form.unit }}
                    {% if form.unit.errors %}
                      <span class="error">{{ form.unit.errors.0 }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {{ form.scrap_allowance }}
                    {% if form.scrap_allowance.errors %}
                      <span class="error">{{ form.scrap_allowance.errors.0 }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {{ form.source_warehouses }}
                    {% if form.instance.pk and form.instance.source_warehouses %}
                      <script type="application/json" id="existing-warehouses-{{ forloop.counter0 }}">{{ form.instance.source_warehouses|safe }}</script>
                    {% endif %}
                    <div class="source-warehouses-container" 
                         data-form-index="{{ forloop.counter0 }}">
                      <button type="button" class="btn-manage-warehouses" onclick="toggleWarehousesManager(this)">
                        <span class="warehouses-count">0</span> {% trans "warehouses" %}
                      </button>
                      <div class="warehouses-manager hidden">
                        <div class="warehouses-list">
                          <!-- Will be populated by JavaScript -->
                        </div>
                        <button type="button" class="btn-add-warehouse" onclick="addWarehouseRow(this)">
                          + {% trans "Add Warehouse" %}
                        </button>
                      </div>
                    </div>
                    {% if form.source_warehouses.errors %}
                      <span class="error">{{ form.source_warehouses.errors.0 }}</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    {{ form.is_optional }}
                  </td>
                  <td class="text-center">
                    {% if form.instance.pk %}
                      {{ form.DELETE }}
                      <label for="{{ form.DELETE.id_for_label }}" class="delete-label">üóëÔ∏è</label>
                    {% else %}
                      <button type="button" class="btn-remove-line" onclick="removeLine(this)">√ó</button>
                    {% endif %}
                  </td>
                </tr>
                {% if form.instance.pk %}
                  {% for material_pk, alt_formset in alternative_formsets.items %}
                    {% if material_pk == form.instance.pk %}
                      <tr class="alternatives-row hidden" data-material-pk="{{ form.instance.pk }}">
                        <td colspan="11" class="alternatives-cell">
                          <div class="alternatives-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                              <h4 style="margin: 0; font-size: 1rem; font-weight: 600;">{% trans "Alternative Items" %}</h4>
                              <button type="button" class="btn-toggle-alternatives" onclick="toggleAlternatives(this)" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; background: #f3f4f6; cursor: pointer;">
                                <span class="toggle-text">{% trans "Hide" %}</span>
                              </button>
                            </div>
                            {{ alt_formset.management_form }}
                            {% if alt_formset.non_form_errors %}
                              <div class="alert alert-error">
                                {{ alt_formset.non_form_errors }}
                              </div>
                            {% endif %}
                            <table class="alternatives-table" style="width: 100%; border-collapse: collapse;">
                              <thead>
                                <tr style="background: #f3f4f6;">
                                  <th style="padding: 8px; text-align: left; font-size: 0.875rem;">{% trans "Alternative Item" %}</th>
                                  <th style="padding: 8px; text-align: left; font-size: 0.875rem;">{% trans "Quantity" %}</th>
                                  <th style="padding: 8px; text-align: left; font-size: 0.875rem;">{% trans "Unit" %}</th>
                                  <th style="padding: 8px; text-align: left; font-size: 0.875rem;">{% trans "Priority" %}</th>
                                  <th style="padding: 8px; text-align: left; font-size: 0.875rem;">{% trans "Source Warehouses" %}</th>
                                  <th style="padding: 8px; text-align: center; font-size: 0.875rem;">{% trans "Combinable" %}</th>
                                  <th style="padding: 8px; text-align: center; font-size: 0.875rem;">{% trans "Delete" %}</th>
                                </tr>
                              </thead>
                              <tbody class="alternatives-tbody-{{ form.instance.pk }}">
                                {% for alt_form in alt_formset %}
                                  <tr class="alternative-row {% if not alt_form.instance.pk %}empty-form-template{% endif %}" {% if not alt_form.instance.pk %}style="display: none;"{% endif %}>
                                    <td>
                                      {{ alt_form.id }}
                                      <div class="item-select-wrapper">
                                        <div class="item-filters">
                                          <input type="text" class="form-control alternative-filter-search-input" 
                                                 placeholder="{% trans 'Search by name or code...' %}" 
                                                 data-material-pk="{{ form.instance.pk }}"
                                                 data-alt-index="{{ forloop.counter0 }}"
                                                 style="flex: 1; min-width: 150px; font-size: 0.7rem; padding: 0.3rem 0.4rem; border: 1px solid #d1d5db; border-radius: 4px; background-color: #f9fafb; color: #6b7280;">
                                        </div>
                                        {{ alt_form.alternative_item }}
                                      </div>
                                      {% if alt_form.alternative_item.errors %}
                                        <span class="error">{{ alt_form.alternative_item.errors.0 }}</span>
                                      {% endif %}
                                    </td>
                                    <td>
                                      {{ alt_form.quantity }}
                                      {% if alt_form.quantity.errors %}
                                        <span class="error">{{ alt_form.quantity.errors.0 }}</span>
                                      {% endif %}
                                    </td>
                                    <td>
                                      {{ alt_form.unit }}
                                      {% if alt_form.unit.errors %}
                                        <span class="error">{{ alt_form.unit.errors.0 }}</span>
                                      {% endif %}
                                    </td>
                                    <td>
                                      {{ alt_form.priority }}
                                      {% if alt_form.priority.errors %}
                                        <span class="error">{{ alt_form.priority.errors.0 }}</span>
                                      {% endif %}
                                    </td>
                                    <td>
                                      {{ alt_form.source_warehouses }}
                                      {% if alt_form.instance.pk and alt_form.instance.source_warehouses %}
                                        <script type="application/json" id="existing-alt-warehouses-{{ form.instance.pk }}-{{ forloop.counter0 }}">{{ alt_form.instance.source_warehouses|safe }}</script>
                                      {% endif %}
                                      <div class="alternative-warehouses-container" data-material-pk="{{ form.instance.pk }}" data-alt-index="{{ forloop.counter0 }}">
                                        <button type="button" class="btn-manage-alt-warehouses" onclick="toggleAltWarehousesManager(this)" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; background: #f3f4f6; cursor: pointer;">
                                          <span class="warehouses-count">0</span> {% trans "warehouses" %}
                                        </button>
                                        <div class="warehouses-manager" style="display: none; margin-top: 0.5rem; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 4px; background: #f9fafb;">
                                          <div class="warehouses-list" style="margin-bottom: 0.5rem;">
                                            <!-- Will be populated by JavaScript -->
                                          </div>
                                          <button type="button" class="btn-add-warehouse" onclick="addAltWarehouseRow(this)" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; border: 1px solid #3b82f6; border-radius: 4px; background: #3b82f6; color: white; cursor: pointer;">
                                            + {% trans "Add Warehouse" %}
                                          </button>
                                        </div>
                                      </div>
                                    </td>
                                    <td class="text-center" style="vertical-align: middle; padding: 8px;">
                                      <label for="{{ alt_form.is_combinable.id_for_label }}" style="margin: 0; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                        {{ alt_form.is_combinable }}
                                      </label>
                                      {% if alt_form.is_combinable.errors %}
                                        <span class="error">{{ alt_form.is_combinable.errors.0 }}</span>
                                      {% endif %}
                                    </td>
                                    <td class="text-center">
                                      {% if alt_form.instance.pk %}
                                        {{ alt_form.DELETE }}
                                        <label for="{{ alt_form.DELETE.id_for_label }}" class="delete-label">üóëÔ∏è</label>
                                      {% else %}
                                        <button type="button" class="btn-remove-alt-line" onclick="removeAltLine(this)">√ó</button>
                                      {% endif %}
                                    </td>
                                  </tr>
                                {% empty %}
                                  <!-- Empty form template for cloning - hidden by default -->
                                  <tr class="alternative-row empty-form-template" style="display: none;">
                                    <td>
                                      <input type="hidden" name="alternatives_{{ form.instance.pk }}-0-id" id="id_alternatives_{{ form.instance.pk }}-0-id">
                                      <div class="item-select-wrapper">
                                        <div class="item-filters">
                                          <input type="text" class="form-control alternative-filter-search-input" 
                                                 placeholder="{% trans 'Search by name or code...' %}" 
                                                 data-material-pk="{{ form.instance.pk }}"
                                                 data-alt-index="0"
                                                 style="flex: 1; min-width: 150px; font-size: 0.7rem; padding: 0.3rem 0.4rem; border: 1px solid #d1d5db; border-radius: 4px; background-color: #f9fafb; color: #6b7280;">
                                        </div>
                                        <select name="alternatives_{{ form.instance.pk }}-0-alternative_item" id="id_alternatives_{{ form.instance.pk }}-0-alternative_item" class="form-control alternative-item">
                                          <option value="">--------</option>
                                        </select>
                                      </div>
                                    </td>
                                    <td>
                                      <input type="number" name="alternatives_{{ form.instance.pk }}-0-quantity" id="id_alternatives_{{ form.instance.pk }}-0-quantity" class="form-control" step="0.000001" min="0">
                                    </td>
                                    <td>
                                      <select name="alternatives_{{ form.instance.pk }}-0-unit" id="id_alternatives_{{ form.instance.pk }}-0-unit" class="form-control alternative-unit">
                                        <option value="">{% trans "Select Unit" %}</option>
                                      </select>
                                    </td>
                                    <td>
                                      <input type="number" name="alternatives_{{ form.instance.pk }}-0-priority" id="id_alternatives_{{ form.instance.pk }}-0-priority" class="form-control" min="1" max="10">
                                    </td>
                                    <td>
                                      <input type="hidden" name="alternatives_{{ form.instance.pk }}-0-source_warehouses" id="id_alternatives_{{ form.instance.pk }}-0-source_warehouses">
                                      <div class="alternative-warehouses-container" data-material-pk="{{ form.instance.pk }}" data-alt-index="0">
                                        <button type="button" class="btn-manage-alt-warehouses" onclick="toggleAltWarehousesManager(this)" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; background: #f3f4f6; cursor: pointer;">
                                          <span class="warehouses-count">0</span> {% trans "warehouses" %}
                                        </button>
                                        <div class="warehouses-manager" style="display: none; margin-top: 0.5rem; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 4px; background: #f9fafb;">
                                          <div class="warehouses-list" style="margin-bottom: 0.5rem;">
                                            <!-- Will be populated by JavaScript -->
                                          </div>
                                          <button type="button" class="btn-add-warehouse" onclick="addAltWarehouseRow(this)" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; border: 1px solid #3b82f6; border-radius: 4px; background: #3b82f6; color: white; cursor: pointer;">
                                            + {% trans "Add Warehouse" %}
                                          </button>
                                        </div>
                                      </div>
                                    </td>
                                    <td class="text-center" style="vertical-align: middle; padding: 8px;">
                                      <input type="checkbox" 
                                             name="alternatives_{{ form.instance.pk }}-0-is_combinable" 
                                             id="id_alternatives_{{ form.instance.pk }}-0-is_combinable" 
                                             class="form-check-input" 
                                             value="1"
                                             style="width: 1.25rem !important; height: 1.25rem !important; cursor: pointer; display: inline-block !important; margin: 0 !important; min-width: 1.25rem !important; min-height: 1.25rem !important; opacity: 1 !important; visibility: visible !important; position: relative !important; z-index: 1 !important;">
                                    </td>
                                    <td class="text-center">
                                      <button type="button" class="btn-remove-alt-line" onclick="removeAltLine(this)">√ó</button>
                                    </td>
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                            <div style="margin-top: 1rem;">
                              <button type="button" class="btn-add-alternative" onclick="addAlternativeLine({{ form.instance.pk }})" style="padding: 0.5rem 1rem; font-size: 0.875rem; border: 1px solid #3b82f6; border-radius: 4px; background: #3b82f6; color: white; cursor: pointer;">
                                ‚ûï {% trans "Add Alternative" %}
                              </button>
                            </div>
                          </div>
                        </td>
                      </tr>
                      <tr class="alternatives-toggle-row" data-material-pk="{{ form.instance.pk }}">
                        <td colspan="11" style="padding: 0.5rem; background: #f3f4f6; border-top: 2px solid #e5e7eb;">
                          <button type="button" class="btn-show-alternatives" onclick="showAlternatives({{ form.instance.pk }})" data-material-pk="{{ form.instance.pk }}" style="padding: 0.5rem 1rem; font-size: 0.875rem; border: 1px solid #3b82f6; border-radius: 4px; background: #3b82f6; color: white; cursor: pointer;">
                            ‚ûï {% trans "Manage Alternatives" %} (<span class="alternatives-count-{{ form.instance.pk }}">0</span>)
                          </button>
                        </td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="formset-actions">
          <button type="button" class="btn btn-secondary" id="add-material-line">
            ‚ûï {% trans "Add Material Line" %}
          </button>
        </div>
      </div>

{% endblock %}

{% block form_extra %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/shared.css' %}">
<link rel="stylesheet" href="{% static 'css/formset-table.css' %}">

{% block form_scripts %}
{{ block.super }}
<script src="{% static 'js/cascading-dropdowns.js' %}"></script>
<script src="{% static 'js/item-filters.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Add bom-form class to form container and entity-form
  const formContainer = document.querySelector('.form-container');
  const entityForm = document.querySelector('.entity-form');
  if (formContainer) {
    formContainer.classList.add('form-container-wide');
  }
  if (entityForm) {
    entityForm.classList.add('bom-form');
  }
  // ====================================================================
  // Cascading Dropdowns for Finished Item Selection (Type ‚Üí Category ‚Üí Subcategory ‚Üí Item)
  // ====================================================================
  const itemTypeSelect = document.getElementById('id_item_type');
  const itemCategorySelect = document.getElementById('id_item_category');
  const itemSubcategorySelect = document.getElementById('id_item_subcategory');
  const finishedItemSelect = document.getElementById('id_finished_item');
  const finishedItemSearchInput = document.getElementById('finished-item-search');
  
  // Initialize cascading dropdowns using cascading-dropdowns.js
  if (itemTypeSelect && itemCategorySelect) {
    initCascadingDropdown('#id_item_type', '#id_item_category', '{% url "inventory:filtered_categories" %}', {
      parentField: 'type_id',
      placeholder: '--- Please select ---',
      valueField: 'value',
      labelField: 'label',
      onChange: function(value, element) {
        // Clear subsequent selects when category changes
        if (itemSubcategorySelect) {
          itemSubcategorySelect.innerHTML = '<option value="">--- Please select ---</option>';
        }
        if (finishedItemSelect) {
          finishedItemSelect.innerHTML = '<option value="">--- Please select ---</option>';
        }
      }
    });
  }
  
  if (itemCategorySelect && itemSubcategorySelect) {
    initCascadingDropdown('#id_item_category', '#id_item_subcategory', '{% url "inventory:filtered_subcategories" %}', {
      parentField: 'category_id',
      placeholder: '--- Please select ---',
      valueField: 'value',
      labelField: 'label',
      onChange: function(value, element) {
        // Clear finished item when subcategory changes
        if (finishedItemSelect) {
          finishedItemSelect.innerHTML = '<option value="">--- Please select ---</option>';
        }
      }
    });
  }
  
  // Filter finished items based on type, category, subcategory, and search
  function filterFinishedItems() {
    if (!finishedItemSelect) return;
    
    const selectedType = itemTypeSelect ? itemTypeSelect.value : '';
    const selectedCategory = itemCategorySelect ? itemCategorySelect.value : '';
    const selectedSubcategory = itemSubcategorySelect ? itemSubcategorySelect.value : '';
    const searchTerm = finishedItemSearchInput ? finishedItemSearchInput.value.trim() : '';
    
    // Build API URL with filters
    let apiUrl = '/inventory/api/filtered-items/';
    const params = new URLSearchParams();
    if (selectedType) params.append('type_id', selectedType);
    if (selectedCategory) params.append('category_id', selectedCategory);
    if (selectedSubcategory) params.append('subcategory_id', selectedSubcategory);
    if (searchTerm) params.append('search', searchTerm);
    
    if (params.toString()) {
      apiUrl += '?' + params.toString();
    }
    
    // Show loading
    const currentValue = finishedItemSelect.value;
    finishedItemSelect.innerHTML = '<option value="">{% trans "Loading items..." %}</option>';
    finishedItemSelect.disabled = true;
    
    // Fetch filtered items
    fetch(apiUrl)
      .then(response => response.json())
      .then(data => {
        finishedItemSelect.innerHTML = '<option value="">--- {% trans "Please select" %} ---</option>';
        
        if (data.items && data.items.length > 0) {
          data.items.forEach(function(item) {
            const option = document.createElement('option');
            option.value = item.value;
            option.textContent = item.label;
            finishedItemSelect.appendChild(option);
          });
          
          // Restore selection if it's still in filtered list
          if (currentValue && data.items.some(item => item.value === currentValue)) {
            finishedItemSelect.value = currentValue;
          }
        }
        
        finishedItemSelect.disabled = false;
      })
      .catch(error => {
        console.error('Error loading items:', error);
        finishedItemSelect.innerHTML = '<option value="">{% trans "Error loading items" %}</option>';
        finishedItemSelect.disabled = false;
      });
  }
  
  // Setup search input with debounce for finished item
  if (finishedItemSearchInput) {
    let searchTimeout;
    finishedItemSearchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(function() {
        filterFinishedItems();
      }, 300); // Debounce 300ms
    });
  }
  
  // Filter when type, category, or subcategory changes
  if (itemTypeSelect) {
    itemTypeSelect.addEventListener('change', filterFinishedItems);
  }
  
  if (itemCategorySelect) {
    itemCategorySelect.addEventListener('change', filterFinishedItems);
  }
  
  if (itemSubcategorySelect) {
    itemSubcategorySelect.addEventListener('change', filterFinishedItems);
  }
  
  // Load all items initially if no filters are selected
  if (finishedItemSelect && 
      (!(itemTypeSelect && itemTypeSelect.value) && 
       !(itemCategorySelect && itemCategorySelect.value) && 
       !(itemSubcategorySelect && itemSubcategorySelect.value))) {
    filterFinishedItems();
  }
  
  
  // ====================================================================
  // Formset Management (Add/Remove Material Lines)
  // ====================================================================
  const totalFormsInput = document.querySelector('#id_materials-TOTAL_FORMS');
  const addLineBtn = document.getElementById('add-material-line');
  const tbody = document.getElementById('materials-tbody');
  
  if (addLineBtn && tbody && totalFormsInput) {
    // Add new line button
    addLineBtn.addEventListener('click', function() {
      const currentCount = parseInt(totalFormsInput.value);
      
      // Get the last row as template (or first if none exist)
      const rows = tbody.querySelectorAll('.material-row');
      const templateRow = rows[rows.length - 1] || rows[0];
      
      if (!templateRow) {
        console.error('No template row found');
        return;
      }
      
      const newRow = templateRow.cloneNode(true);
      newRow.classList.remove('existing');
      newRow.classList.add('new');
      
      // Update form index in all fields
      newRow.querySelectorAll('[name],[id],[for]').forEach(function(elem) {
        ['name', 'id', 'for'].forEach(function(attr) {
          if (elem.hasAttribute(attr)) {
            const val = elem.getAttribute(attr);
            elem.setAttribute(attr, val.replace(/-\d+-/, `-${currentCount}-`));
          }
        });
      });
      
      // Clear values
      newRow.querySelectorAll('select').forEach(function(field) {
        field.selectedIndex = 0;
      });
      
      newRow.querySelectorAll('input[type="text"], input[type="number"]').forEach(function(field) {
        field.value = '';
      });
      
      newRow.querySelectorAll('input[type="checkbox"]').forEach(function(field) {
        field.checked = false;
      });
      
      newRow.querySelectorAll('textarea').forEach(function(field) {
        field.value = '';
      });
      
      // Clear error messages
      newRow.querySelectorAll('.error').forEach(function(error) {
        error.remove();
      });
      
      // Update line number
      newRow.querySelector('.line-number').textContent = currentCount + 1;
      newRow.setAttribute('data-form-idx', currentCount);
      
      // Update delete button (remove checkbox DELETE field if exists, add remove button)
      const deleteCell = newRow.querySelector('td:last-child');
      deleteCell.innerHTML = '<button type="button" class="btn-remove-line" onclick="removeLine(this)">√ó</button>';
      
      // Add to table
      tbody.appendChild(newRow);
      
      // Update total forms count
      totalFormsInput.value = currentCount + 1;
      
      // Update line numbers for all rows
      updateLineNumbers();
      
      // Setup cascading filters for new row
      setupRowCascading(newRow);
    });
  }
  
  
  // ====================================================================
  // Cascading Filters for Material Lines (Type ‚Üí Category ‚Üí Subcategory ‚Üí Item)
  // ====================================================================
  // Note: This uses a simple approach - filtering existing options
  // In production, consider using AJAX to load filtered data from server
  
  // Store all options for each row on page load
  function initializeCascadingFilters() {
    const rows = tbody.querySelectorAll('.material-row');
    rows.forEach(function(row) {
      setupRowCascading(row);
    });
  }
  
  function setupRowCascading(row) {
    // Get form index from row data attribute
    const formIndex = row.dataset.formIdx || row.querySelector('[data-form-index]')?.dataset.formIndex || '';
    
    const typeSelect = row.querySelector('select[name*="material_type"]');
    const categorySelect = row.querySelector('select[name*="material_category_filter"]');
    const subcategorySelect = row.querySelector('select[name*="material_subcategory_filter"]');
    const itemSelect = row.querySelector('select[name*="material_item"]');
    // Unit field might be text input or select, handle both cases
    let unitSelect = row.querySelector('select[name*="-unit"]');
    let unitInput = null;
    let unitValueFromInput = null;
    
    // If unit field is a text input, we need to convert it to select
    if (!unitSelect) {
      unitInput = row.querySelector('input[name*="-unit"]');
      if (unitInput) {
        // Store the value for later restoration BEFORE converting
        unitValueFromInput = unitInput.value || row.dataset.initialUnitValue;
        if (unitValueFromInput) {
          row.dataset.unitValue = unitValueFromInput;
          console.log(`Unit value from input/text field for row ${formIndex}: ${unitValueFromInput}`);
        }
        // Create a select element to replace the input
        unitSelect = document.createElement('select');
        unitSelect.name = unitInput.name;
        unitSelect.id = unitInput.id;
        unitSelect.className = unitInput.className || 'form-control';
        unitSelect.setAttribute('required', unitInput.hasAttribute('required'));
        unitSelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
        unitInput.parentNode.replaceChild(unitSelect, unitInput);
        console.log(`Converted unit input to select for row ${formIndex}`);
      }
    }
    
    const warehousesContainer = row.querySelector('.source-warehouses-container');
    
    if (!typeSelect || !categorySelect || !subcategorySelect || !itemSelect || !unitSelect) {
      return;
    }
    
    // Handle unit select state based on item selection
    if (!itemSelect.value) {
      unitSelect.disabled = true;
      unitSelect.innerHTML = '<option value="">ÿßÿ®ÿ™ÿØÿß ŸÖÿßÿØŸá ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</option>';
    } else {
      unitSelect.disabled = false;
      // If unit was converted from input, we already have the value stored in row.dataset.unitValue
      // Units will be loaded in the initialization section below
    }
    
    // Filter categories based on type
    function filterCategories() {
      const selectedType = typeSelect.value;
      const currentCategory = categorySelect.value;
      
      if (!selectedType) {
        // If no type selected, show all categories
        return;
      }
      
      // Show loading
      categorySelect.innerHTML = '<option value="">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...</option>';
      categorySelect.disabled = true;
      
      // Fetch filtered categories
      fetch('/inventory/api/filtered-categories/?type_id=' + selectedType)
        .then(response => response.json())
        .then(data => {
          categorySelect.innerHTML = '<option value="">--------</option>';
          
          if (data.categories && data.categories.length > 0) {
            data.categories.forEach(function(cat) {
              const option = document.createElement('option');
              option.value = cat.value;
              option.textContent = cat.label;
              categorySelect.appendChild(option);
            });
            
            // Restore selection if it's still in filtered list
            if (currentCategory && data.categories.some(cat => cat.value === currentCategory)) {
              categorySelect.value = currentCategory;
            } else {
              // Clear subcategory if category was cleared
              subcategorySelect.value = '';
              filterSubcategories();
            }
          }
          
          categorySelect.disabled = false;
        })
        .catch(error => {
          console.error('Error loading categories:', error);
          categorySelect.innerHTML = '<option value="">ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å</option>';
          categorySelect.disabled = false;
        });
    }
    
    // Filter subcategories based on type and category
    function filterSubcategories() {
      const selectedType = typeSelect.value;
      const selectedCategory = categorySelect.value;
      const currentSubcategory = subcategorySelect.value;
      
      if (!selectedType && !selectedCategory) {
        // If nothing selected, show all subcategories
        return;
      }
      
      // Show loading
      subcategorySelect.innerHTML = '<option value="">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...</option>';
      subcategorySelect.disabled = true;
      
      // Build API URL
      let apiUrl = '/inventory/api/filtered-subcategories/?';
      if (selectedType) apiUrl += 'type_id=' + selectedType + '&';
      if (selectedCategory) apiUrl += 'category_id=' + selectedCategory + '&';
      
      // Fetch filtered subcategories
      fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
          subcategorySelect.innerHTML = '<option value="">--------</option>';
          
          if (data.subcategories && data.subcategories.length > 0) {
            data.subcategories.forEach(function(subcat) {
              const option = document.createElement('option');
              option.value = subcat.value;
              option.textContent = subcat.label;
              subcategorySelect.appendChild(option);
            });
            
            // Restore selection if it's still in filtered list
            if (currentSubcategory && data.subcategories.some(sub => sub.value === currentSubcategory)) {
              subcategorySelect.value = currentSubcategory;
            } else {
              filterItems();
            }
          }
          
          subcategorySelect.disabled = false;
        })
        .catch(error => {
          console.error('Error loading subcategories:', error);
          subcategorySelect.innerHTML = '<option value="">ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å</option>';
          subcategorySelect.disabled = false;
        });
    }
    
    // Filter items based on selections using API
    function filterItems() {
      const selectedType = typeSelect.value;
      const selectedCategory = categorySelect.value;
      const selectedSubcategory = subcategorySelect.value;
      const searchInput = row.querySelector('.filter-search-input');
      const searchTerm = (searchInput && searchInput.value && searchInput.value.trim()) || '';
      const currentValue = itemSelect.value;
      
      // Build API URL with filters
      let apiUrl = '/inventory/api/filtered-items/';
      const params = new URLSearchParams();
      if (selectedType) params.append('type_id', selectedType);
      if (selectedCategory) params.append('category_id', selectedCategory);
      if (selectedSubcategory) params.append('subcategory_id', selectedSubcategory);
      if (searchTerm) params.append('search', searchTerm);
      
      // If no filters and no search, load all items
      // Otherwise, apply filters
      if (params.toString()) {
        apiUrl += '?' + params.toString();
      }
      
      // Show loading
      itemSelect.innerHTML = '<option value="">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...</option>';
      itemSelect.disabled = true;
      
      // Fetch filtered items
      fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
          itemSelect.innerHTML = '<option value="">--------</option>';
          
          if (data.items && data.items.length > 0) {
            data.items.forEach(function(item) {
              const option = document.createElement('option');
              option.value = item.value;
              option.textContent = item.label;
              itemSelect.appendChild(option);
            });
            
            // Restore selection if it's still in filtered list
            if (currentValue && data.items.some(item => item.value === currentValue)) {
              itemSelect.value = currentValue;
            }
          } else {
            itemSelect.innerHTML = '<option value="">Ÿá€å⁄Ü ⁄©ÿßŸÑÿß€å€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ</option>';
          }
          
          itemSelect.disabled = false;
          
          // If item was cleared, clear unit too
          if (!itemSelect.value) {
            unitSelect.disabled = true;
            unitSelect.innerHTML = '<option value="">ÿßÿ®ÿ™ÿØÿß ŸÖÿßÿØŸá ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</option>';
          }
        })
        .catch(error => {
          console.error('Error loading items:', error);
          itemSelect.innerHTML = '<option value="">ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ⁄©ÿßŸÑÿßŸáÿß</option>';
          itemSelect.disabled = false;
        });
    }
    
    // Add event listeners
    typeSelect.addEventListener('change', function() {
      categorySelect.value = '';
      subcategorySelect.value = '';
      filterCategories();
      filterItems();
    });
    
    categorySelect.addEventListener('change', function() {
      subcategorySelect.value = '';
      filterSubcategories();
      filterItems();
    });
    
    subcategorySelect.addEventListener('change', filterItems);
    
    // Setup search input with debounce
    const searchInput = row.querySelector('.filter-search-input');
    if (searchInput) {
      let searchTimeout;
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
          filterItems();
        }, 300); // Debounce 300ms
      });
    }
    
    // When material item changes, load units for that item
    itemSelect.addEventListener('change', function() {
      const itemId = this.value;
      
      // Save current selected unit BEFORE clearing the select
      // Priority: 1) current select value, 2) row's data attribute (set during form submission), 3) empty
      let currentUnit = unitSelect.value;
      if (!currentUnit) {
        // Try to get from the row's data attribute (set during form submission or page load)
        const rowUnitValue = row.dataset.unitValue;
        if (rowUnitValue) {
          currentUnit = rowUnitValue;
        }
      }
      
      if (!itemId) {
        unitSelect.disabled = true;
        unitSelect.innerHTML = '<option value="">ÿßÿ®ÿ™ÿØÿß ŸÖÿßÿØŸá ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</option>';
        return;
      }
      
      // Enable and show loading
      unitSelect.disabled = false;
      unitSelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
      
      // Fetch units for selected item
      fetch('/inventory/api/item-units/?item_id=' + itemId)
        .then(response => response.json())
        .then(data => {
          unitSelect.innerHTML = '<option value="">{% trans "Select Unit" %}</option>';
          
          if (data.units && data.units.length > 0) {
            data.units.forEach(function(unit) {
              const option = document.createElement('option');
              // Use unit_name as value (not the pk)
              option.value = unit.unit_name;
              option.textContent = unit.label;
              unitSelect.appendChild(option);
            });
            
            // Restore previously selected unit if exists
            if (currentUnit) {
              // Check if the unit exists in the loaded options
              const unitOption = unitSelect.querySelector(`option[value="${currentUnit}"]`);
              if (unitOption) {
                unitSelect.value = currentUnit;
                // Clear the data attribute after successful restore
                delete row.dataset.unitValue;
              }
            }
          } else {
            unitSelect.innerHTML = '<option value="">{% trans "No units defined" %}</option>';
          }
          
          // Auto-set material_type if item_type_id is provided
          if (data.item_type_id) {
            const typeSelect = row.querySelector('select[name*="material_type"]');
            if (typeSelect) {
              // Check if the type exists in the dropdown
              for (let i = 0; i < typeSelect.options.length; i++) {
                if (typeSelect.options[i].value == data.item_type_id) {
                  typeSelect.value = data.item_type_id;
                  break;
                }
              }
            }
          }
        })
        .catch(error => {
          console.error('Error loading units:', error);
          unitSelect.innerHTML = '<option value="">{% trans "Error loading units" %}</option>';
        });
      
      // Initialize warehouses manager for this row
      if (warehousesContainer) {
        initializeWarehousesManager(warehousesContainer, itemId);
      }
    });
    
    // Initialize warehouses manager if item is already selected on page load
    if (itemSelect.value && warehousesContainer) {
      const itemId = itemSelect.value;
      initializeWarehousesManager(warehousesContainer, itemId);
    }
    
    // Initialize items on page load
    // If item is already selected (edit mode), restore type, category, subcategory, and unit
    // Otherwise, load all items
    if (itemSelect.value) {
      const itemId = itemSelect.value;
      
      // CRITICAL: Save current unit value BEFORE making any changes to the select
      // First, enable the select if disabled (disabled selects don't return proper values)
      const wasDisabled = unitSelect.disabled;
      if (wasDisabled) {
        unitSelect.disabled = false;
      }
      
      // Get unit value from multiple sources (priority order)
      let savedUnitValue = null;
      
      // Try 1: Get from selected option value
      if (unitSelect.selectedIndex >= 0) {
        const selectedOption = unitSelect.options[unitSelect.selectedIndex];
        if (selectedOption && selectedOption.value) {
          savedUnitValue = selectedOption.value;
        } else if (selectedOption && selectedOption.textContent && selectedOption.textContent.trim() !== '') {
          // If no value but has text, use text as value (for CharField units)
          savedUnitValue = selectedOption.textContent.trim();
        }
      }
      
      // Try 2: Get from unitSelect.value directly
      if (!savedUnitValue && unitSelect.value) {
        savedUnitValue = unitSelect.value;
      }
      
      // Try 3: Get from row data attribute (from template or converted input)
      if (!savedUnitValue) {
        savedUnitValue = row.dataset.initialUnitValue || row.dataset.unitValue || unitValueFromInput;
      }
      
      // Try 4: Get from the actual selected option text (for CharField units stored as text)
      if (!savedUnitValue && unitSelect && unitSelect.selectedIndex > 0) {
        const option = unitSelect.options[unitSelect.selectedIndex];
        if (option && option.textContent) {
          savedUnitValue = option.textContent.trim();
        }
      }
      
      // Store in data attribute for later restoration
      if (savedUnitValue) {
        row.dataset.unitValue = savedUnitValue;
        console.log(`Saved unit value for row ${formIndex}: ${savedUnitValue}`);
      } else {
        // Last attempt: check if there's a selected option with text content
        if (unitSelect && unitSelect.selectedIndex >= 0) {
          const selectedOption = unitSelect.options[unitSelect.selectedIndex];
          if (selectedOption && selectedOption.textContent && selectedOption.textContent.trim() !== '' && selectedOption.textContent.trim() !== '---') {
            savedUnitValue = selectedOption.textContent.trim();
            row.dataset.unitValue = savedUnitValue;
            console.log(`Saved unit value from option text for row ${formIndex}: ${savedUnitValue}`);
          }
        }
      }
      
      // Load item units API which now returns type_id, category_id, subcategory_id, and units
      unitSelect.disabled = false;
      unitSelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
      
      fetch('/inventory/api/item-units/?item_id=' + itemId)
        .then(response => response.json())
        .then(data => {
          // Step 1: Set material_type
          if (data.item_type_id) {
            for (let i = 0; i < typeSelect.options.length; i++) {
              if (typeSelect.options[i].value == data.item_type_id) {
                typeSelect.value = data.item_type_id;
                
                // Step 2: Load and set category
                if (data.category_id) {
                  filterCategories();
                  // Wait a bit for categories to load, then set category
                  setTimeout(() => {
                    categorySelect.value = data.category_id;
                    
                    // Step 3: Load and set subcategory
                    if (data.subcategory_id) {
                      filterSubcategories();
                      // Wait a bit for subcategories to load, then set subcategory
                      setTimeout(() => {
                        subcategorySelect.value = data.subcategory_id;
                      }, 300);
                    }
                  }, 300);
                }
                break;
              }
            }
          }
          
          // Step 4: Load and restore unit
          unitSelect.innerHTML = '<option value="">{% trans "Select Unit" %}</option>';
          
          if (data.units && data.units.length > 0) {
            data.units.forEach(function(unit) {
              const option = document.createElement('option');
              // Use unit_name as value
              option.value = unit.unit_name;
              option.textContent = unit.label;
              unitSelect.appendChild(option);
            });
            
            // Restore previously selected unit if exists
            if (savedUnitValue) {
              // Try exact value match first
              let unitOption = unitSelect.querySelector(`option[value="${savedUnitValue}"]`);
              
              // If not found, try matching by unit_name (for CharField units)
              if (!unitOption) {
                const allOptions = unitSelect.querySelectorAll('option');
                for (let opt of allOptions) {
                  if (opt.value === savedUnitValue || opt.textContent.trim() === savedUnitValue) {
                    unitOption = opt;
                    break;
                  }
                  // Also check if unit_name matches
                  const unitNameMatch = data.units.find(u => u.unit_name === savedUnitValue || u.label === savedUnitValue);
                  if (unitNameMatch && opt.value === unitNameMatch.unit_name) {
                    unitOption = opt;
                    break;
                  }
                }
              }
              
              if (unitOption) {
                unitSelect.value = unitOption.value;
                console.log(`Restored unit value for row ${formIndex}: ${unitOption.value} (${unitOption.textContent})`);
                delete row.dataset.unitValue;
              } else {
                console.warn(`Could not restore unit value for row ${formIndex}: ${savedUnitValue}. Available units:`, data.units.map(u => u.unit_name));
              }
            }
          } else {
            unitSelect.innerHTML = '<option value="">{% trans "No units defined" %}</option>';
          }
        })
        .catch(error => {
          console.error('Error loading item details:', error);
          unitSelect.innerHTML = '<option value="">{% trans "Error loading units" %}</option>';
        });
    } else {
      // If no item is selected (new row), load all items initially
      filterItems();
    }
  }
  
  function getSelectOptions(selectElement) {
    const options = [];
    for (let i = 0; i < selectElement.options.length; i++) {
      options.push({
        value: selectElement.options[i].value,
        text: selectElement.options[i].text
      });
    }
    return options;
  }
  
  // Initialize filters on page load
  initializeCascadingFilters();
  
  // Initialize alternative items search for all existing rows
  const allAlternativeRows = document.querySelectorAll('.alternative-row:not(.empty-form-template)');
  allAlternativeRows.forEach(function(row) {
    const materialPkElement = row.querySelector('[data-material-pk]');
    if (materialPkElement) {
      const materialPk = materialPkElement.getAttribute('data-material-pk');
      setupAlternativeRowCascading(row, materialPk);
    }
  });
  
  // Update alternatives count for each material (only count real alternatives with instance.pk)
  document.querySelectorAll('.btn-show-alternatives').forEach(function(btn) {
    const materialPk = btn.dataset.materialPk;
    if (materialPk) {
      updateAlternativesCount(materialPk);
    }
  });
  
  // ====================================================================
  // Form Validation
  // ====================================================================
  const form = document.getElementById('bom-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      // CRITICAL: Enable all unit selects before submission (disabled fields are not submitted!)
      const allUnitSelects = form.querySelectorAll('select[name*="-unit"]');
      allUnitSelects.forEach(function(unitSelect) {
        if (unitSelect.disabled) {
          const materialSelect = unitSelect.closest('.material-row')?.querySelector('[name*="material_item"]');
          if (materialSelect && materialSelect.value) {
            unitSelect.disabled = false;
          }
        }
      });
      
      // CRITICAL: Update all warehouses JSON before submission
      const allWarehousesContainers = form.querySelectorAll('.source-warehouses-container');
      allWarehousesContainers.forEach(function(container) {
        updateWarehousesJSON(container);
      });
      
      // CRITICAL: Update all alternative warehouses JSON before submission
      const allAltWarehousesContainers = form.querySelectorAll('.alternative-warehouses-container');
      allAltWarehousesContainers.forEach(function(container) {
        const materialPk = container.dataset.materialPk;
        const altIndex = container.dataset.altIndex;
        if (materialPk && altIndex !== undefined) {
          updateAltWarehousesJSON(container, materialPk, altIndex);
        }
      });
      
      // Check if at least one material is added
      const materialRows = tbody.querySelectorAll('.material-row');
      let validRowCount = 0;
      
      materialRows.forEach(function(row) {
        const materialSelect = row.querySelector('[name*="material_item"]');
        const deleteCheckbox = row.querySelector('[name*="DELETE"]');
        
        // Count only if material is selected and not marked for deletion
        if (materialSelect && materialSelect.value && 
            (!deleteCheckbox || !deleteCheckbox.checked)) {
          validRowCount++;
        }
      });
      
      if (validRowCount === 0) {
        alert('ŸÑÿ∑ŸÅÿßŸã ÿ≠ÿØÿßŸÇŸÑ €å⁄© ŸÖÿßÿØŸá ÿßŸàŸÑ€åŸá ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜ€åÿØ.');
        e.preventDefault();
        return false;
      }
    });
  }
  
  
  // ====================================================================
  // Helper Functions
  // ====================================================================
  function updateLineNumbers() {
    const rows = tbody.querySelectorAll('.material-row');
    rows.forEach(function(row, index) {
      row.querySelector('.line-number').textContent = index + 1;
    });
  }
});


// ====================================================================
// Source Warehouses Management Functions (Global)
// ====================================================================

// Store warehouses data for each row
const warehousesData = {};

function initializeWarehousesManager(container, itemId) {
  const formIndex = container.dataset.formIndex;
  const row = container.closest('.material-row');
  const hiddenField = row.querySelector('input[name*="source_warehouses"]');
  
  if (!itemId) {
    container.querySelector('.btn-manage-warehouses').disabled = true;
    container.querySelector('.btn-add-warehouse').disabled = true;
    return;
  }
  
  // Initialize data structure for this row
  if (!warehousesData[formIndex]) {
    warehousesData[formIndex] = {
      itemId: itemId,
      warehouses: [],
      availableWarehouses: []
    };
  } else {
    warehousesData[formIndex].itemId = itemId;
  }
  
  // Load existing warehouses from script tag, hidden field, or data attribute
  let existingWarehouses = null;
  
  // First try script tag (from instance)
  const scriptTag = document.getElementById('existing-warehouses-' + formIndex);
  if (scriptTag) {
    try {
      existingWarehouses = JSON.parse(scriptTag.textContent);
    } catch (e) {
      console.error('Error parsing existing warehouses from script tag:', e);
    }
  }
  
  // If not found in script tag, try hidden field
  if (!existingWarehouses && hiddenField && hiddenField.value) {
    try {
      existingWarehouses = JSON.parse(hiddenField.value);
    } catch (e) {
      console.error('Error parsing existing warehouses from hidden field:', e);
    }
  }
  
  if (existingWarehouses && Array.isArray(existingWarehouses)) {
    warehousesData[formIndex].warehouses = existingWarehouses;
    updateWarehousesCount(container);
  }
  
  // Load available warehouses for this item
  fetch('/inventory/api/item-allowed-warehouses/?item_id=' + itemId)
    .then(response => response.json())
    .then(data => {
      if (data.warehouses && data.warehouses.length > 0) {
        warehousesData[formIndex].availableWarehouses = data.warehouses;
        // Re-render to update available options
        renderWarehousesList(container);
      }
      container.querySelector('.btn-manage-warehouses').disabled = false;
    })
    .catch(error => {
      console.error('Error loading warehouses:', error);
      container.querySelector('.btn-manage-warehouses').disabled = true;
    });
}

function toggleWarehousesManager(button) {
  const container = button.closest('.source-warehouses-container');
  const manager = container.querySelector('.warehouses-manager');
  
  if (manager.style.display === 'none') {
    manager.style.display = 'block';
    renderWarehousesList(container);
  } else {
    manager.style.display = 'none';
  }
}

function renderWarehousesList(container) {
  const formIndex = container.dataset.formIndex;
  const data = warehousesData[formIndex];
  const listContainer = container.querySelector('.warehouses-list');
  
  if (!data || !listContainer) return;
  
  listContainer.innerHTML = '';
  
  if (data.warehouses.length === 0) {
    listContainer.innerHTML = '<div style="padding: 0.5rem; color: #6b7280; font-size: 0.875rem;">{% trans "No warehouses added yet." %}</div>';
    updateWarehousesCount(container);
    updateWarehousesJSON(container);
    return;
  }
  
  // Sort by priority
  const sorted = [...data.warehouses].sort((a, b) => (a.priority || 999) - (b.priority || 999));
  
  sorted.forEach((warehouse, originalIndex) => {
    const row = document.createElement('div');
    row.className = 'warehouse-row';
    row.style.cssText = 'display: flex; gap: 0.5rem; align-items: center; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 0.5rem; background: white;';
    
    // Get currently selected warehouse IDs (excluding current one)
    const selectedIds = data.warehouses
      .map((w, idx) => idx !== originalIndex && w.warehouse_id ? String(w.warehouse_id) : null)
      .filter(id => id);
    
    // Filter available warehouses: show all if not selected, or only selected one if already selected
    const availableOptions = data.availableWarehouses.filter(w => {
      if (warehouse.warehouse_id && String(w.value) === String(warehouse.warehouse_id)) {
        return true; // Always show currently selected warehouse
      }
      return !selectedIds.includes(String(w.value)); // Don't show already selected warehouses
    });
    
    row.innerHTML = `
      <select class="warehouse-select" style="flex: 1; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;" onchange="updateWarehouseSelect(this, ${formIndex}, ${originalIndex})">
        <option value="">---</option>
        ${availableOptions.map(w => {
          const labelParts = w.label.split(' - ');
          const code = labelParts[0] || '';
          return `
          <option value="${w.value}" data-code="${code}" ${String(w.value) === String(warehouse.warehouse_id) ? 'selected' : ''}>
            ${w.label}
          </option>
        `;
        }).join('')}
      </select>
      <input type="number" class="warehouse-priority" min="1" max="5" value="${warehouse.priority || originalIndex + 1}" 
             style="width: 60px; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;"
             onchange="updateWarehousePriority(this, ${formIndex}, ${originalIndex})" />
      <button type="button" class="btn-remove-warehouse" onclick="removeWarehouseRow(this, ${formIndex}, ${originalIndex})" 
              style="padding: 0.25rem 0.5rem; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">
        √ó
      </button>
    `;
    
    listContainer.appendChild(row);
  });
  
  updateWarehousesCount(container);
  updateWarehousesJSON(container);
}

function addWarehouseRow(button) {
  const container = button.closest('.source-warehouses-container');
  const formIndex = container.dataset.formIndex;
  const data = warehousesData[formIndex];
  
  if (!data) {
    alert('{% trans "Please select a material item first." %}');
    return;
  }
  
  // Check if already 5 warehouses
  if (data.warehouses.length >= 5) {
    alert('{% trans "Maximum 5 warehouses allowed per material." %}');
    return;
  }
  
  // Check if there are available warehouses
  const selectedIds = data.warehouses.map(w => String(w.warehouse_id)).filter(id => id);
  const availableOptions = data.availableWarehouses.filter(w => !selectedIds.includes(String(w.value)));
  
  if (availableOptions.length === 0) {
    alert('{% trans "No more warehouses available for this material." %}');
    return;
  }
  
  // Add new warehouse with next priority
  const nextPriority = data.warehouses.length + 1;
  data.warehouses.push({
    warehouse_id: null,
    warehouse_code: '',
    priority: nextPriority
  });
  
  renderWarehousesList(container);
}

function removeWarehouseRow(button, formIndex, index) {
  const container = button.closest('.source-warehouses-container');
  const data = warehousesData[formIndex];
  
  if (data && data.warehouses[index]) {
    data.warehouses.splice(index, 1);
    renderWarehousesList(container);
  }
}

function updateWarehouseSelect(select, formIndex, index) {
  const container = select.closest('.source-warehouses-container');
  const data = warehousesData[formIndex];
  
  if (data && data.warehouses[index]) {
    const selectedOption = select.options[select.selectedIndex];
    if (selectedOption && selectedOption.value) {
      const labelParts = selectedOption.textContent.split(' - ');
      data.warehouses[index].warehouse_id = parseInt(selectedOption.value);
      data.warehouses[index].warehouse_code = labelParts[0] || '';
    } else {
      data.warehouses[index].warehouse_id = null;
      data.warehouses[index].warehouse_code = '';
    }
    renderWarehousesList(container);
  }
}

function updateWarehousePriority(input, formIndex, index) {
  const container = input.closest('.source-warehouses-container');
  const data = warehousesData[formIndex];
  
  if (data && data.warehouses[index]) {
    const priority = parseInt(input.value) || 1;
    data.warehouses[index].priority = Math.max(1, Math.min(5, priority));
    renderWarehousesList(container);
  }
}

function updateWarehousesCount(container) {
  const formIndex = container.dataset.formIndex;
  const data = warehousesData[formIndex];
  const countElement = container.querySelector('.warehouses-count');
  
  if (countElement && data) {
    const validCount = data.warehouses.filter(w => w.warehouse_id).length;
    countElement.textContent = validCount;
  }
}

function updateWarehousesJSON(container) {
  const formIndex = container.dataset.formIndex;
  const row = container.closest('.material-row');
  const hiddenField = row.querySelector('input[name*="source_warehouses"]');
  const data = warehousesData[formIndex];
  
  if (hiddenField && data) {
    // Filter out warehouses without warehouse_id
    const validWarehouses = data.warehouses
      .filter(w => w.warehouse_id)
      .map(w => ({
        warehouse_id: w.warehouse_id,
        warehouse_code: w.warehouse_code,
        priority: w.priority || 999
      }));
    
    hiddenField.value = JSON.stringify(validWarehouses);
  }
}


// ====================================================================
// Remove Line Function (Global)
// ====================================================================
function removeLine(button) {
  const row = button.closest('.material-row');
  const tbody = document.getElementById('materials-tbody');
  const rows = tbody.querySelectorAll('.material-row');
  
  // Don't allow removing if only one row left
  if (rows.length <= 1) {
    alert('ÿ≠ÿØÿßŸÇŸÑ €å⁄© ÿ±ÿØ€åŸÅ ÿ®ÿß€åÿØ ÿ®ÿßŸÇ€å ÿ®ŸÖÿßŸÜÿØ.');
    return;
  }
  
  row.remove();
  
  // Update line numbers
  tbody.querySelectorAll('.material-row .line-number').forEach(function(cell, index) {
    cell.textContent = index + 1;
  });
  
  // Update TOTAL_FORMS if this was a new row (not from database)
  if (row.classList.contains('new')) {
    const totalFormsInput = document.querySelector('#id_materials-TOTAL_FORMS');
    if (totalFormsInput) {
      totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
    }
  }
}


// ====================================================================
// Alternatives Management Functions (Global)
// ====================================================================

function updateAlternativesCount(materialPk) {
  const btn = document.querySelector(`.btn-show-alternatives[data-material-pk="${materialPk}"]`);
  if (!btn) return;
  
  const alternativesRow = document.querySelector(`.alternatives-row[data-material-pk="${materialPk}"]`);
  if (alternativesRow) {
    // Count only alternatives that have an ID (exist in database)
    const existingAlternatives = alternativesRow.querySelectorAll('.alternative-row:not(.empty-form-template)');
    let count = 0;
    existingAlternatives.forEach(function(row) {
      const idInput = row.querySelector('input[type="hidden"][name*="-id"]');
      if (idInput && idInput.value && idInput.value !== '') {
        count++;
      }
    });
    const countSpan = btn.querySelector('.alternatives-count-' + materialPk);
    if (countSpan) {
      countSpan.textContent = count;
    }
  } else {
    const countSpan = btn.querySelector('.alternatives-count-' + materialPk);
    if (countSpan) {
      countSpan.textContent = '0';
    }
  }
}

function showAlternatives(materialPk) {
  const toggleRow = document.querySelector(`.alternatives-toggle-row[data-material-pk="${materialPk}"]`);
  const alternativesRow = document.querySelector(`.alternatives-row[data-material-pk="${materialPk}"]`);
  
  if (toggleRow && alternativesRow) {
    toggleRow.style.display = 'none';
    alternativesRow.style.display = '';
    
    // Setup search for all alternative rows in this section
    const allAlternativeRowsInSection = alternativesRow.querySelectorAll('.alternative-row:not(.empty-form-template)');
    allAlternativeRowsInSection.forEach(function(row) {
      setupAlternativeRowCascading(row, materialPk);
    });
  }
}

function toggleAlternatives(button) {
  const materialPk = button.closest('.alternatives-container').closest('[data-material-pk]').dataset.materialPk;
  const toggleRow = document.querySelector(`.alternatives-toggle-row[data-material-pk="${materialPk}"]`);
  const alternativesRow = document.querySelector(`.alternatives-row[data-material-pk="${materialPk}"]`);
  
  if (alternativesRow.style.display === 'none') {
    alternativesRow.style.display = '';
    button.querySelector('.toggle-text').textContent = '{% trans "Hide" %}';
  } else {
    alternativesRow.style.display = 'none';
    if (toggleRow) {
      toggleRow.style.display = '';
    }
    button.querySelector('.toggle-text').textContent = '{% trans "Show" %}';
  }
}

function addAlternativeLine(materialPk) {
  const tbody = document.querySelector(`.alternatives-tbody-${materialPk}`);
  const totalFormsInput = document.querySelector(`#id_alternatives_${materialPk}-TOTAL_FORMS`);
  
  if (!tbody || !totalFormsInput) {
    console.error('Could not find alternatives tbody or total forms input for material:', materialPk);
    console.error('tbody:', tbody);
    console.error('totalFormsInput:', totalFormsInput);
    return;
  }
  
  const currentCount = parseInt(totalFormsInput.value) || 0;
  
  // Find template row (empty form template or last existing row)
  let templateRow = tbody.querySelector('.empty-form-template');
  if (!templateRow) {
    const rows = tbody.querySelectorAll('.alternative-row:not(.empty-form-template)');
    templateRow = rows[rows.length - 1];
  }
  
  if (!templateRow) {
    console.error('No template row found for material:', materialPk);
    return;
  }
  
  const newRow = templateRow.cloneNode(true);
  newRow.classList.remove('empty-form-template');
  newRow.style.display = '';
  
  // Update form index in all fields
  newRow.querySelectorAll('[name],[id],[for]').forEach(function(elem) {
    ['name', 'id', 'for'].forEach(function(attr) {
      if (elem.hasAttribute(attr)) {
        const val = elem.getAttribute(attr);
        // Replace pattern: alternatives_PK-INDEX- or alternatives_PK-INDEX_
        // Match: alternatives_123-0-field or alternatives_123-0_field
        const regex = new RegExp(`(alternatives_${materialPk}-)\\d+([-_])`, 'g');
        const newVal = val.replace(regex, `$1${currentCount}$2`);
        elem.setAttribute(attr, newVal);
      }
    });
  });
  
  // Update data attributes
  newRow.querySelectorAll('[data-alt-index]').forEach(function(elem) {
    elem.setAttribute('data-alt-index', currentCount);
  });
  
  // Update data-material-pk attributes
  newRow.querySelectorAll('[data-material-pk]').forEach(function(elem) {
    elem.setAttribute('data-material-pk', materialPk);
  });
  
  // Clear values
  newRow.querySelectorAll('select').forEach(function(field) {
    field.selectedIndex = 0;
    field.value = '';
  });
  
  newRow.querySelectorAll('input[type="text"], input[type="number"]').forEach(function(field) {
    if (field.type !== 'hidden') {
      field.value = '';
    }
  });
  
  newRow.querySelectorAll('input[type="checkbox"]').forEach(function(field) {
    field.checked = false;
  });
  
  // Clear error messages
  newRow.querySelectorAll('.error').forEach(function(error) {
    error.remove();
  });
  
  // Update delete button
  const deleteCell = newRow.querySelector('td:last-child');
  if (deleteCell) {
    deleteCell.innerHTML = '<button type="button" class="btn-remove-alt-line" onclick="removeAltLine(this)">√ó</button>';
  }
  
  // Add to table
  tbody.appendChild(newRow);
  
  // Update total forms count
  totalFormsInput.value = currentCount + 1;
  
  // Setup cascading filters for new alternative row
  setupAlternativeRowCascading(newRow, materialPk);
  
  // Update alternatives count (new row doesn't have ID yet, so count stays same, but update anyway)
  updateAlternativesCount(materialPk);
}

function removeAltLine(button) {
  const row = button.closest('.alternative-row');
  const tbody = row.closest('tbody');
  const materialPkAttr = row.querySelector('[data-material-pk]');
  let materialPk = materialPkAttr ? materialPkAttr.getAttribute('data-material-pk') : null;
  
  if (!materialPk) {
    // Try to extract from tbody class
    const tbodyClass = Array.from(tbody.classList).find(cls => cls.startsWith('alternatives-tbody-'));
    if (tbodyClass) {
      materialPk = tbodyClass.replace('alternatives-tbody-', '');
    }
  }
  
  const totalFormsInput = materialPk ? document.querySelector(`#id_alternatives_${materialPk}-TOTAL_FORMS`) : null;
  
  row.remove();
  
  if (totalFormsInput) {
    totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
  }
  
  // Update alternatives count
  if (materialPk) {
    updateAlternativesCount(materialPk);
  }
}

function setupAlternativeRowCascading(row, materialPk) {
  // Setup search and filtering for alternative items
  const itemSelect = row.querySelector('select[name*="alternative_item"]');
  const unitSelect = row.querySelector('select[name*="-unit"]');
  const searchInput = row.querySelector('.alternative-filter-search-input');
  const altIndex = row.querySelector('[data-alt-index]')?.dataset.altIndex || '0';
  
  if (!itemSelect) {
    return;
  }
  
  // Function to filter items based on search
  function filterAlternativeItems() {
    const searchTerm = (searchInput && searchInput.value && searchInput.value.trim()) || '';
    const currentValue = itemSelect.value;
    
    // Build API URL with search filter
    let apiUrl = '/inventory/api/filtered-items/';
    const params = new URLSearchParams();
    if (searchTerm) params.append('search', searchTerm);
    
    if (params.toString()) {
      apiUrl += '?' + params.toString();
    }
    
    // Show loading
    itemSelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
    itemSelect.disabled = true;
    
    // Fetch filtered items
    fetch(apiUrl)
      .then(response => response.json())
      .then(data => {
        itemSelect.innerHTML = '<option value="">--------</option>';
        
        if (data.items && data.items.length > 0) {
          data.items.forEach(function(item) {
            const option = document.createElement('option');
            option.value = item.value;
            option.textContent = item.label;
            itemSelect.appendChild(option);
          });
          
          // Restore selection if it's still in filtered list
          if (currentValue && data.items.some(item => item.value === currentValue)) {
            itemSelect.value = currentValue;
          }
        } else {
          itemSelect.innerHTML = '<option value="">{% trans "No items found" %}</option>';
        }
        
        itemSelect.disabled = false;
      })
      .catch(error => {
        console.error('Error loading alternative items:', error);
        itemSelect.innerHTML = '<option value="">{% trans "Error loading items" %}</option>';
        itemSelect.disabled = false;
      });
  }
  
  // Setup search input with debounce
  if (searchInput) {
    let searchTimeout;
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(function() {
        filterAlternativeItems();
      }, 300); // Debounce 300ms
    });
  }
  
  // Load all items initially
  filterAlternativeItems();
  
  // Setup unit loading and warehouses manager when item is selected
  if (itemSelect && unitSelect) {
    itemSelect.addEventListener('change', function() {
      const itemId = this.value;
      const altRow = this.closest('.alternative-row');
      const warehousesContainer = altRow ? altRow.querySelector('.alternative-warehouses-container') : null;
      
      if (!itemId) {
        unitSelect.disabled = true;
        unitSelect.innerHTML = '<option value="">{% trans "Please select item first" %}</option>';
        if (warehousesContainer) {
          warehousesContainer.querySelector('.btn-manage-alt-warehouses').disabled = true;
        }
        return;
      }
      
      unitSelect.disabled = false;
      unitSelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
      
      fetch('/inventory/api/item-units/?item_id=' + itemId)
        .then(response => response.json())
        .then(data => {
          unitSelect.innerHTML = '<option value="">{% trans "Select Unit" %}</option>';
          
          if (data.units && data.units.length > 0) {
            data.units.forEach(function(unit) {
              const option = document.createElement('option');
              option.value = unit.unit_name;
              option.textContent = unit.label;
              unitSelect.appendChild(option);
            });
          }
          
          // Initialize warehouses manager for this alternative item
          if (warehousesContainer) {
            const materialPk = warehousesContainer.dataset.materialPk;
            const altIndex = warehousesContainer.dataset.altIndex;
            if (materialPk && altIndex !== undefined) {
              initializeAltWarehousesManager(warehousesContainer, materialPk, altIndex, itemId);
            }
          }
        })
        .catch(error => {
          console.error('Error loading units:', error);
          unitSelect.innerHTML = '<option value="">{% trans "Error loading units" %}</option>';
        });
    });
  }
  
  // Initialize warehouses manager if item is already selected
  const altRow = itemSelect ? itemSelect.closest('.alternative-row') : null;
  if (altRow && itemSelect && itemSelect.value) {
    const warehousesContainer = altRow.querySelector('.alternative-warehouses-container');
    if (warehousesContainer) {
      const materialPk = warehousesContainer.dataset.materialPk;
      const altIndex = warehousesContainer.dataset.altIndex;
      const itemId = itemSelect.value;
      if (materialPk && altIndex !== undefined && itemId) {
        initializeAltWarehousesManager(warehousesContainer, materialPk, altIndex, itemId);
      }
    }
  }
}


// ====================================================================
// Alternative Items Warehouses Management Functions (Global)
// ====================================================================

// Store warehouses data for alternative items
const altWarehousesData = {};

function getAltWarehouseKey(materialPk, altIndex) {
  return `${materialPk}_${altIndex}`;
}

function toggleAltWarehousesManager(button) {
  const container = button.closest('.alternative-warehouses-container');
  const manager = container.querySelector('.warehouses-manager');
  
  if (manager.style.display === 'none') {
    manager.style.display = 'block';
    const materialPk = container.dataset.materialPk;
    const altIndex = container.dataset.altIndex;
    const itemSelect = container.closest('.alternative-row').querySelector('select[name*="alternative_item"]');
    const itemId = itemSelect ? itemSelect.value : null;
    
    if (itemId) {
      initializeAltWarehousesManager(container, materialPk, altIndex, itemId);
    }
    renderAltWarehousesList(container, materialPk, altIndex);
  } else {
    manager.style.display = 'none';
  }
}

function initializeAltWarehousesManager(container, materialPk, altIndex, itemId) {
  const key = getAltWarehouseKey(materialPk, altIndex);
  const row = container.closest('.alternative-row');
  const hiddenField = row.querySelector('input[name*="source_warehouses"]');
  
  if (!itemId) {
    container.querySelector('.btn-manage-alt-warehouses').disabled = true;
    container.querySelector('.btn-add-warehouse').disabled = true;
    return;
  }
  
  // Initialize data structure for this alternative row
  if (!altWarehousesData[key]) {
    altWarehousesData[key] = {
      itemId: itemId,
      warehouses: [],
      availableWarehouses: []
    };
  } else {
    altWarehousesData[key].itemId = itemId;
  }
  
  // Load existing warehouses from script tag or hidden field
  let existingWarehouses = null;
  
  // First try script tag (from instance)
  const scriptTag = document.getElementById(`existing-alt-warehouses-${materialPk}-${altIndex}`);
  if (scriptTag) {
    try {
      existingWarehouses = JSON.parse(scriptTag.textContent);
    } catch (e) {
      console.error('Error parsing existing warehouses from script tag:', e);
    }
  }
  
  // If not found in script tag, try hidden field
  if (!existingWarehouses && hiddenField && hiddenField.value) {
    try {
      existingWarehouses = JSON.parse(hiddenField.value);
    } catch (e) {
      console.error('Error parsing existing warehouses from hidden field:', e);
    }
  }
  
  if (existingWarehouses && Array.isArray(existingWarehouses)) {
    altWarehousesData[key].warehouses = existingWarehouses;
    updateAltWarehousesCount(container, materialPk, altIndex);
  }
  
  // Load available warehouses for this alternative item
  fetch('/inventory/api/item-allowed-warehouses/?item_id=' + itemId)
    .then(response => response.json())
    .then(data => {
      if (data.warehouses && data.warehouses.length > 0) {
        altWarehousesData[key].availableWarehouses = data.warehouses;
        renderAltWarehousesList(container, materialPk, altIndex);
      }
      container.querySelector('.btn-manage-alt-warehouses').disabled = false;
    })
    .catch(error => {
      console.error('Error loading warehouses:', error);
      container.querySelector('.btn-manage-alt-warehouses').disabled = true;
    });
}

function renderAltWarehousesList(container, materialPk, altIndex) {
  const key = getAltWarehouseKey(materialPk, altIndex);
  const data = altWarehousesData[key];
  const listContainer = container.querySelector('.warehouses-list');
  
  if (!data || !listContainer) return;
  
  listContainer.innerHTML = '';
  
  if (data.warehouses.length === 0) {
    listContainer.innerHTML = '<div style="padding: 0.5rem; color: #6b7280; font-size: 0.875rem;">{% trans "No warehouses added yet." %}</div>';
    updateAltWarehousesCount(container, materialPk, altIndex);
    updateAltWarehousesJSON(container, materialPk, altIndex);
    return;
  }
  
  // Sort by priority
  const sorted = [...data.warehouses].sort((a, b) => (a.priority || 999) - (b.priority || 999));
  
  sorted.forEach((warehouse, originalIndex) => {
    const row = document.createElement('div');
    row.className = 'warehouse-row';
    row.style.cssText = 'display: flex; gap: 0.5rem; align-items: center; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 0.5rem; background: white;';
    
    // Get currently selected warehouse IDs (excluding current one)
    const selectedIds = data.warehouses
      .map((w, idx) => idx !== originalIndex && w.warehouse_id ? String(w.warehouse_id) : null)
      .filter(id => id);
    
    // Filter available warehouses
    const availableOptions = data.availableWarehouses.filter(w => {
      if (warehouse.warehouse_id && String(w.value) === String(warehouse.warehouse_id)) {
        return true;
      }
      return !selectedIds.includes(String(w.value));
    });
    
    row.innerHTML = `
      <select class="warehouse-select" style="flex: 1; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;" onchange="updateAltWarehouseSelect(this, '${materialPk}', ${altIndex}, ${originalIndex})">
        <option value="">---</option>
        ${availableOptions.map(w => {
          const labelParts = w.label.split(' - ');
          const code = labelParts[0] || '';
          return `
          <option value="${w.value}" data-code="${code}" ${String(w.value) === String(warehouse.warehouse_id) ? 'selected' : ''}>
            ${w.label}
          </option>
        `;
        }).join('')}
      </select>
      <input type="number" class="warehouse-priority" min="1" max="5" value="${warehouse.priority || originalIndex + 1}" 
             style="width: 60px; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;"
             onchange="updateAltWarehousePriority(this, '${materialPk}', ${altIndex}, ${originalIndex})" />
      <button type="button" class="btn-remove-warehouse" onclick="removeAltWarehouseRow(this, '${materialPk}', ${altIndex}, ${originalIndex})" 
              style="padding: 0.25rem 0.5rem; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">
        √ó
      </button>
    `;
    
    listContainer.appendChild(row);
  });
  
  updateAltWarehousesCount(container, materialPk, altIndex);
  updateAltWarehousesJSON(container, materialPk, altIndex);
}

function addAltWarehouseRow(button) {
  const container = button.closest('.alternative-warehouses-container');
  const materialPk = container.dataset.materialPk;
  const altIndex = container.dataset.altIndex;
  const key = getAltWarehouseKey(materialPk, altIndex);
  const data = altWarehousesData[key];
  
  if (!data) {
    alert('{% trans "Please select an alternative item first." %}');
    return;
  }
  
  // Check if already 5 warehouses
  if (data.warehouses.length >= 5) {
    alert('{% trans "Maximum 5 warehouses allowed per alternative item." %}');
    return;
  }
  
  // Check if there are available warehouses
  const selectedIds = data.warehouses.map(w => String(w.warehouse_id)).filter(id => id);
  const availableOptions = data.availableWarehouses.filter(w => !selectedIds.includes(String(w.value)));
  
  if (availableOptions.length === 0) {
    alert('{% trans "No more warehouses available for this alternative item." %}');
    return;
  }
  
  // Add new warehouse with next priority
  const nextPriority = data.warehouses.length + 1;
  data.warehouses.push({
    warehouse_id: null,
    warehouse_code: '',
    priority: nextPriority
  });
  
  renderAltWarehousesList(container, materialPk, altIndex);
}

function removeAltWarehouseRow(button, materialPk, altIndex, index) {
  const container = button.closest('.alternative-warehouses-container');
  const key = getAltWarehouseKey(materialPk, altIndex);
  const data = altWarehousesData[key];
  
  if (data && data.warehouses[index]) {
    data.warehouses.splice(index, 1);
    renderAltWarehousesList(container, materialPk, altIndex);
  }
}

function updateAltWarehouseSelect(select, materialPk, altIndex, index) {
  const container = select.closest('.alternative-warehouses-container');
  const key = getAltWarehouseKey(materialPk, altIndex);
  const data = altWarehousesData[key];
  
  if (data && data.warehouses[index]) {
    const selectedOption = select.options[select.selectedIndex];
    if (selectedOption && selectedOption.value) {
      const labelParts = selectedOption.textContent.split(' - ');
      data.warehouses[index].warehouse_id = parseInt(selectedOption.value);
      data.warehouses[index].warehouse_code = labelParts[0] || '';
    } else {
      data.warehouses[index].warehouse_id = null;
      data.warehouses[index].warehouse_code = '';
    }
    renderAltWarehousesList(container, materialPk, altIndex);
  }
}

function updateAltWarehousePriority(input, materialPk, altIndex, index) {
  const container = input.closest('.alternative-warehouses-container');
  const key = getAltWarehouseKey(materialPk, altIndex);
  const data = altWarehousesData[key];
  
  if (data && data.warehouses[index]) {
    const priority = parseInt(input.value) || 1;
    data.warehouses[index].priority = Math.max(1, Math.min(5, priority));
    renderAltWarehousesList(container, materialPk, altIndex);
  }
}

function updateAltWarehousesCount(container, materialPk, altIndex) {
  const key = getAltWarehouseKey(materialPk, altIndex);
  const data = altWarehousesData[key];
  const countElement = container.querySelector('.warehouses-count');
  
  if (countElement && data) {
    const validCount = data.warehouses.filter(w => w.warehouse_id).length;
    countElement.textContent = validCount;
  }
}

function updateAltWarehousesJSON(container, materialPk, altIndex) {
  const key = getAltWarehouseKey(materialPk, altIndex);
  const row = container.closest('.alternative-row');
  const hiddenField = row.querySelector('input[name*="source_warehouses"]');
  const data = altWarehousesData[key];
  
  if (hiddenField && data) {
    // Filter out warehouses without warehouse_id
    const validWarehouses = data.warehouses
      .filter(w => w.warehouse_id)
      .map(w => ({
        warehouse_id: w.warehouse_id,
        warehouse_code: w.warehouse_code,
        priority: w.priority || 999
      }));
    
    hiddenField.value = JSON.stringify(validWarehouses);
  }
}

</script>
{% endblock %}
