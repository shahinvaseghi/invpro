{% extends "shared/generic/generic_form.html" %}
{% load i18n %}

{% block breadcrumb_extra %}
<span class="separator">/</span>
<span>{% trans "Production" %}</span>
<span class="separator">/</span>
<a href="{% url 'production:personnel' %}">{% trans "Personnel" %}</a>
<span class="separator">/</span>
<span>{{ form_title }}</span>
{% endblock %}

{% block form_sections %}
<div class="form-section">
  <h2>{% trans "Organizational Units" %}</h2>
  <div class="form-row">
    <div class="form-field full-width checkbox-list" dir="rtl">
      <label class="section-label">{{ form.company_units.label }}</label>
      <div class="checkbox-grid">
        {% for checkbox in form.company_units %}
          <label class="checkbox-item">
            {{ checkbox.tag }}
            <span>{{ checkbox.choice_label }}</span>
          </label>
        {% empty %}
          <p class="form-text">{% trans "No units available for this company." %}</p>
        {% endfor %}
      </div>
      {% if form.company_units.help_text %}
        <small class="form-text">{{ form.company_units.help_text }}</small>
      {% endif %}
      {% if form.company_units.errors %}
        <span class="error">{{ form.company_units.errors.0 }}</span>
      {% endif %}
    </div>
  </div>
</div>

<div class="form-section">
  <h2>{% trans "Basic Information" %}</h2>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.is_enabled.id_for_label }}">{{ form.is_enabled.label }}</label>
      {{ form.is_enabled }}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.first_name.id_for_label }}">{{ form.first_name.label }} *</label>
      {{ form.first_name }}
      {% if form.first_name.errors %}
        <span class="error">{{ form.first_name.errors.0 }}</span>
      {% endif %}
    </div>

    <div class="form-field">
      <label for="{{ form.last_name.id_for_label }}">{{ form.last_name.label }} *</label>
      {{ form.last_name }}
      {% if form.last_name.errors %}
        <span class="error">{{ form.last_name.errors.0 }}</span>
      {% endif %}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.first_name_en.id_for_label }}">{{ form.first_name_en.label }}</label>
      {{ form.first_name_en }}
    </div>

    <div class="form-field">
      <label for="{{ form.last_name_en.id_for_label }}">{{ form.last_name_en.label }}</label>
      {{ form.last_name_en }}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.national_id.id_for_label }}">{{ form.national_id.label }}</label>
      {{ form.national_id }}
    </div>

    <div class="form-field">
      <label for="{{ form.personnel_code.id_for_label }}">{{ form.personnel_code.label }}</label>
      {{ form.personnel_code }}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field">
      <div class="form-check" style="margin-top: 2rem;">
        {{ form.use_personnel_code_as_username }}
        <label class="form-check-label" for="use_personnel_code">
          {{ form.use_personnel_code_as_username.label }}
        </label>
        <small class="form-text">{{ form.use_personnel_code_as_username.help_text }}</small>
      </div>
    </div>

    <div class="form-field">
      <label for="{{ form.username.id_for_label }}">{{ form.username.label }} *</label>
      {{ form.username }}
      {% if form.username.errors %}
        <span class="error">{{ form.username.errors.0 }}</span>
      {% endif %}
    </div>
  </div>
</div>

<div class="form-section">
  <h2>{% trans "Contact Information" %}</h2>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.phone_number.id_for_label }}">{{ form.phone_number.label }}</label>
      {{ form.phone_number }}
    </div>

    <div class="form-field">
      <label for="{{ form.mobile_number.id_for_label }}">{{ form.mobile_number.label }}</label>
      {{ form.mobile_number }}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field full-width">
      <label for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
      {{ form.email }}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field full-width">
      <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
      {{ form.description }}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field full-width">
      <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
      {{ form.notes }}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_styles %}
<style>
.entity-form .checkbox-list .checkbox-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 0.75rem 1.25rem;
  padding: 0.5rem 0;
}

.entity-form .checkbox-list .checkbox-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  font-weight: 500;
  color: #1f2937;
}

.entity-form .checkbox-list input[type="checkbox"] {
  width: 1.1rem;
  height: 1.1rem;
  accent-color: #2563eb;
}

.entity-form .checkbox-list .section-label {
  font-weight: 600;
  margin-bottom: 0.5rem;
  display: inline-block;
}

.form-check {
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
}

.form-check-label {
  font-weight: 500;
  cursor: pointer;
}

.form-check-input {
  width: 1.25rem;
  height: 1.25rem;
  margin-top: 0.125rem;
  cursor: pointer;
}
</style>
{% endblock %}

{% block form_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const checkbox = document.getElementById('id_use_personnel_code_as_username');
  const personnelCodeField = document.getElementById('id_personnel_code');
  const usernameField = document.getElementById('id_username');
  
  function syncUsername() {
    if (checkbox && checkbox.checked && personnelCodeField && usernameField) {
      usernameField.value = personnelCodeField.value;
      usernameField.readOnly = true;
      usernameField.style.backgroundColor = '#f3f4f6';
    } else if (usernameField) {
      usernameField.readOnly = false;
      usernameField.style.backgroundColor = '';
    }
  }
  
  // Initial sync
  syncUsername();
  
  // Listen to checkbox changes
  if (checkbox) {
    checkbox.addEventListener('change', syncUsername);
  }
  
  // Listen to personnel code changes
  if (personnelCodeField) {
    personnelCodeField.addEventListener('input', function() {
      if (checkbox && checkbox.checked && usernameField) {
        usernameField.value = personnelCodeField.value;
      }
    });
  }
});
</script>
{% endblock %}
