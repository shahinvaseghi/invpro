{% extends "shared/generic/generic_list.html" %}
{% load i18n %}

{% block table_headers %}
<th style="width: 40px;"></th>
<th>{% trans "Code" %}</th>
<th>{% trans "Finished Item" %}</th>
<th>{% trans "BOM" %}</th>
<th>{% trans "Revision" %}</th>
<th>{% trans "Operations" %}</th>
<th>{% trans "Work Lines" %}</th>
<th>{% trans "Status" %}</th>
{% if show_actions %}
  <th>{% trans "Actions" %}</th>
{% endif %}
{% endblock %}

{% block table_rows %}
{% for process in object_list %}
<tr data-process-id="{{ process.pk }}">
  <td style="text-align: center;">
    {% if process.operations.exists %}
      <button type="button" class="toggle-operations-btn" onclick="toggleOperations({{ process.pk }})" style="background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 0.25rem;">
        <span class="toggle-icon">‚ñ∂</span>
      </button>
    {% endif %}
  </td>
  <td><code>{{ process.process_code }}</code></td>
  <td><strong>{{ process.finished_item.name }}</strong></td>
  <td>
    {% if process.bom %}
      <code>{{ process.bom.bom_code }}</code>
    {% else %}
      <span style="color: #9ca3af;">‚Äî</span>
    {% endif %}
  </td>
  <td>
    {% if process.revision %}
      {{ process.revision }}
    {% else %}
      <span style="color: #9ca3af;">‚Äî</span>
    {% endif %}
  </td>
  <td>
    {% if process.operations %}
      {% with operations_count=process.operations.count %}
        {% if operations_count > 0 %}
          <span class="operations-count">{{ operations_count }} {% trans "operation(s)" %}</span>
        {% else %}
          <span style="color: #9ca3af;">‚Äî</span>
        {% endif %}
      {% endwith %}
    {% else %}
      <span style="color: #9ca3af;">‚Äî</span>
    {% endif %}
  </td>
  <td>
    {% if process.work_lines.exists %}
      <ul style="margin: 0; padding-right: 1.5rem; list-style: none;">
        {% for work_line in process.work_lines.all|slice:":3" %}
        <li>{{ work_line.name }}</li>
        {% endfor %}
        {% if process.work_lines.count > 3 %}
        <li><em>{% trans "and" %} {{ process.work_lines.count|add:"-3" }} {% trans "more" %}</em></li>
        {% endif %}
      </ul>
    {% else %}
      <span style="color: #9ca3af;">‚Äî</span>
    {% endif %}
  </td>
  <td>
    {% if process.is_enabled %}
      <span class="badge badge-active">{% trans "Active" %}</span>
    {% else %}
      <span class="badge badge-inactive">{% trans "Inactive" %}</span>
    {% endif %}
  </td>
  {% if show_actions %}
  <td>
    {% include 'shared/partials/row_actions.html' with object=process feature_code=feature_code detail_url_name=detail_url_name edit_url_name=edit_url_name delete_url_name=delete_url_name %}
  </td>
  {% endif %}
</tr>
<!-- Operations detail row (hidden by default) -->
{% if process.operations and process.operations.count > 0 %}
<tr class="operations-detail-row" id="operations-detail-{{ process.pk }}" style="display: none; background: #f9fafb;">
  <td colspan="9" style="padding: 1rem 2rem;">
    <h4 style="margin-top: 0; margin-bottom: 1rem; color: #374151;">{% trans "Production Operations" %}</h4>
    <div class="operations-list">
      {% for operation in process.operations.all %}
      <div class="operation-card" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
          <div>
            <strong>{% trans "Operation" %} #{{ operation.sequence_order }}</strong>
            {% if operation.name %}
              <span style="color: #6b7280; margin-right: 0.5rem;">¬∑ {{ operation.name }}</span>
            {% endif %}
          </div>
          <div style="font-size: 0.875rem; color: #6b7280;">
            <span>‚öôÔ∏è {{ operation.labor_minutes_per_unit }} {% trans "min labor" %}</span>
            <span style="margin-right: 1rem;">|</span>
            <span>üîß {{ operation.machine_minutes_per_unit }} {% trans "min machine" %}</span>
          </div>
        </div>
        {% if operation.description %}
          <p style="margin: 0.5rem 0; color: #6b7280; font-size: 0.875rem;">{{ operation.description }}</p>
        {% endif %}
        {% if operation.work_line %}
          <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f3f4f6;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-bottom: 0.75rem;">
              <div>
                <strong style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.25rem;">{% trans "Work Line" %}:</strong>
                <span style="color: #374151; font-size: 0.875rem;">{{ operation.work_line.name }}</span>
              </div>
              {% if operation.work_line.warehouse %}
                <div>
                  <strong style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.25rem;">{% trans "Warehouse" %}:</strong>
                  <span style="color: #374151; font-size: 0.875rem;">{{ operation.work_line.warehouse.public_code }} - {{ operation.work_line.warehouse.name }}</span>
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}
        
        {% if operation.operation_materials.exists %}
          <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f3f4f6;">
            <strong style="font-size: 0.875rem; color: #374151; display: block; margin-bottom: 0.5rem;">{% trans "Materials Used" %}:</strong>
            <ul style="margin: 0; padding-right: 1.5rem; list-style: none; font-size: 0.875rem;">
              {% for material in operation.operation_materials.all %}
              <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 4px;">
                <code style="font-size: 0.8rem; background: #e5e7eb; padding: 0.125rem 0.375rem; border-radius: 3px;">{{ material.bom_material.material_item_code }}</code>
                <span style="color: #374151; margin-right: 0.5rem;">{{ material.bom_material.material_item.name|default:material.bom_material.material_item_code }}</span>
                <span style="color: #9ca3af;">({{ material.quantity_used }} {{ material.unit }})</span>
              </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        
        {% if operation.work_line %}
          {% with work_line=operation.work_line %}
            {% if work_line.personnel.exists %}
              <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f3f4f6;">
                <strong style="font-size: 0.875rem; color: #374151; display: block; margin-bottom: 0.5rem;">{% trans "Personnel" %}:</strong>
                <ul style="margin: 0; padding-right: 1.5rem; list-style: none; font-size: 0.875rem;">
                  {% for person in work_line.personnel.all %}
                  <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 4px;">
                    <span style="color: #374151;">{{ person.name }}</span>
                    {% if person.public_code %}
                      <code style="font-size: 0.8rem; background: #e5e7eb; padding: 0.125rem 0.375rem; border-radius: 3px; margin-right: 0.5rem;">{{ person.public_code }}</code>
                    {% endif %}
                  </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            
            {% if work_line.machines.exists %}
              <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f3f4f6;">
                <strong style="font-size: 0.875rem; color: #374151; display: block; margin-bottom: 0.5rem;">{% trans "Machines" %}:</strong>
                <ul style="margin: 0; padding-right: 1.5rem; list-style: none; font-size: 0.875rem;">
                  {% for machine in work_line.machines.all %}
                  <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 4px;">
                    <span style="color: #374151;">{{ machine.name }}</span>
                    {% if machine.public_code %}
                      <code style="font-size: 0.8rem; background: #e5e7eb; padding: 0.125rem 0.375rem; border-radius: 3px; margin-right: 0.5rem;">{{ machine.public_code }}</code>
                    {% endif %}
                  </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          {% endwith %}
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </td>
</tr>
{% endif %}
{% endfor %}
{% endblock %}

{% block empty_state_title %}{% trans "No Processes Found" %}{% endblock %}
{% block empty_state_message %}{% trans "Start by creating your first process." %}{% endblock %}
{% block empty_state_icon %}‚öôÔ∏è{% endblock %}

{% block after_table %}
<style>
.toggle-operations-btn {
  transition: transform 0.2s;
}

.toggle-operations-btn .toggle-icon {
  display: inline-block;
  transition: transform 0.2s;
}

.toggle-operations-btn.expanded .toggle-icon {
  transform: rotate(90deg);
}

.operations-detail-row {
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    max-height: 0;
  }
  to {
    opacity: 1;
    max-height: 1000px;
  }
}

.operations-count {
  color: #3b82f6;
  font-weight: 500;
  font-size: 0.875rem;
}

.operation-card {
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.operation-card:hover {
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
</style>
<script>
function toggleOperations(processId) {
  const detailRow = document.getElementById('operations-detail-' + processId);
  const toggleBtn = event.target.closest('.toggle-operations-btn');
  
  if (detailRow.style.display === 'none') {
    detailRow.style.display = 'table-row';
    toggleBtn.classList.add('expanded');
  } else {
    detailRow.style.display = 'none';
    toggleBtn.classList.remove('expanded');
  }
}
</script>
{% endblock %}
