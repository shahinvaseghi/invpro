{% extends "shared/generic/generic_form.html" %}
{% load i18n %}

{% block breadcrumb_extra %}
<span class="separator">/</span>
<span>{% trans "Production" %}</span>
<span class="separator">/</span>
<a href="{% url 'production:processes' %}">{% trans "Processes" %}</a>
{% endblock %}

{% block before_form %}
{% if form.instance.pk and form.instance.process_code %}
<div class="info-banner info-banner-flex">
  <div><strong>{% trans "Code" %}:</strong> <code>{{ form.instance.process_code }}</code></div>
  {% if form.instance.finished_item %}
  <div><strong>{% trans "Finished Item" %}:</strong> {{ form.instance.finished_item.name }}</div>
  {% endif %}
</div>
{% endif %}
{% endblock %}

{% block form_sections %}
<div class="form-section">
  <h2>{% trans "Process Information" %}</h2>
  
  <div class="form-field">
    <label for="{{ form.bom.id_for_label }}">
      {{ form.bom.label }}
      {% if form.bom.field.required %}*{% endif %}
    </label>
    {{ form.bom }}
    {% if form.bom.errors %}
      <span class="error">{{ form.bom.errors.0 }}</span>
    {% endif %}
    {% if form.bom.help_text %}
      <small class="form-text">{{ form.bom.help_text }}</small>
    {% endif %}
  </div>

  <div class="form-field">
    <label for="{{ form.work_lines.id_for_label }}">
      {{ form.work_lines.label }}
      {% if form.work_lines.field.required %}*{% endif %}
    </label>
    {{ form.work_lines }}
    {% if form.work_lines.errors %}
      <span class="error">{{ form.work_lines.errors.0 }}</span>
    {% endif %}
    {% if form.work_lines.help_text %}
      <small class="form-text">{{ form.work_lines.help_text }}</small>
    {% endif %}
    <small class="form-text">{% trans "ÿ®ÿ±ÿß€å ÿßŸÜÿ™ÿÆÿßÿ® ⁄ÜŸÜÿØ ŸÖŸàÿ±ÿØÿå ⁄©ŸÑ€åÿØ Ctrl (€åÿß Cmd ÿØÿ± Mac) ÿ±ÿß ŸÜ⁄ØŸá ÿØÿßÿ±€åÿØ Ÿà ⁄©ŸÑ€å⁄© ⁄©ŸÜ€åÿØ" %}</small>
  </div>

  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.revision.id_for_label }}">
        {{ form.revision.label }}
        {% if form.revision.field.required %}*{% endif %}
      </label>
      {{ form.revision }}
      {% if form.revision.errors %}
        <span class="error">{{ form.revision.errors.0 }}</span>
      {% endif %}
      {% if form.revision.help_text %}
        <small class="form-text">{{ form.revision.help_text }}</small>
      {% endif %}
    </div>

    <div class="form-field">
      <label for="{{ form.is_primary.id_for_label }}">
        {{ form.is_primary.label }}
        {% if form.is_primary.field.required %}*{% endif %}
      </label>
      {{ form.is_primary }}
      {% if form.is_primary.errors %}
        <span class="error">{{ form.is_primary.errors.0 }}</span>
      {% endif %}
      {% if form.is_primary.help_text %}
        <small class="form-text">{{ form.is_primary.help_text }}</small>
      {% endif %}
    </div>
  </div>

  <div class="form-field">
    <label for="{{ form.approved_by.id_for_label }}">
      {{ form.approved_by.label }}
      {% if form.approved_by.field.required %}*{% endif %}
    </label>
    {{ form.approved_by }}
    {% if form.approved_by.errors %}
      <span class="error">{{ form.approved_by.errors.0 }}</span>
    {% endif %}
    {% if form.approved_by.help_text %}
      <small class="form-text">{{ form.approved_by.help_text }}</small>
    {% endif %}
  </div>

  <div class="form-field full-width">
    <label for="{{ form.description.id_for_label }}">
      {{ form.description.label }}
      {% if form.description.field.required %}*{% endif %}
    </label>
    {{ form.description }}
    {% if form.description.errors %}
      <span class="error">{{ form.description.errors.0 }}</span>
    {% endif %}
    {% if form.description.help_text %}
      <small class="form-text">{{ form.description.help_text }}</small>
    {% endif %}
  </div>

  <div class="form-field full-width">
    <label for="{{ form.notes.id_for_label }}">
      {{ form.notes.label }}
      {% if form.notes.field.required %}*{% endif %}
    </label>
    {{ form.notes }}
    {% if form.notes.errors %}
      <span class="error">{{ form.notes.errors.0 }}</span>
    {% endif %}
    {% if form.notes.help_text %}
      <small class="form-text">{{ form.notes.help_text }}</small>
    {% endif %}
  </div>

  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.sort_order.id_for_label }}">
        {{ form.sort_order.label }}
        {% if form.sort_order.field.required %}*{% endif %}
      </label>
      {{ form.sort_order }}
      {% if form.sort_order.errors %}
        <span class="error">{{ form.sort_order.errors.0 }}</span>
      {% endif %}
      {% if form.sort_order.help_text %}
        <small class="form-text">{{ form.sort_order.help_text }}</small>
      {% endif %}
    </div>

    <div class="form-field">
      <label for="{{ form.is_enabled.id_for_label }}">
        {{ form.is_enabled.label }}
        {% if form.is_enabled.field.required %}*{% endif %}
      </label>
      {{ form.is_enabled }}
      {% if form.is_enabled.errors %}
        <span class="error">{{ form.is_enabled.errors.0 }}</span>
      {% endif %}
      {% if form.is_enabled.help_text %}
        <small class="form-text">{{ form.is_enabled.help_text }}</small>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block form_extra %}
<!-- Production Operations Section -->
{% if form.bom %}
<div class="form-section">
  <header class="section-header">
    <h2>{% trans "Production Operations" %}</h2>
    <p class="form-help-text">{% trans "Define production operations and materials used in each operation" %}</p>
  </header>
  
  {{ operations_formset.management_form }}
  
  {% if operations_formset.non_form_errors %}
    <div class="alert alert-error">
      {% for error in operations_formset.non_form_errors %}
        <div>{{ error }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div id="operations-container">
    {% for operation_form in operations_formset %}
      <div class="operation-row" data-operation-index="{{ forloop.counter0 }}">
        {% for hidden in operation_form.hidden_fields %}{{ hidden }}{% endfor %}
        
        <div class="operation-header">
          <h4>{% trans "Operation" %} #<span class="operation-number">{{ forloop.counter }}</span></h4>
          {% if operation_form.DELETE %}
            {{ operation_form.DELETE }}
            <label for="{{ operation_form.DELETE.id_for_label }}" class="delete-operation-label">
              üóëÔ∏è {% trans "Delete Operation" %}
            </label>
          {% else %}
            <button type="button" class="btn-remove-operation" onclick="removeOperation(this)">√ó {% trans "Remove" %}</button>
          {% endif %}
        </div>
        
        <div class="operation-form-fields">
          <div class="form-row">
            <div class="form-field">
              <label for="{{ operation_form.name.id_for_label }}">{{ operation_form.name.label }}</label>
              {{ operation_form.name }}
              {% if operation_form.name.errors %}
                <span class="error">{{ operation_form.name.errors.0 }}</span>
              {% endif %}
            </div>
            
            <div class="form-field">
              <label for="{{ operation_form.sequence_order.id_for_label }}">{{ operation_form.sequence_order.label }}</label>
              {{ operation_form.sequence_order }}
              {% if operation_form.sequence_order.errors %}
                <span class="error">{{ operation_form.sequence_order.errors.0 }}</span>
              {% endif %}
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label for="{{ operation_form.labor_minutes_per_unit.id_for_label }}">{{ operation_form.labor_minutes_per_unit.label }}</label>
              {{ operation_form.labor_minutes_per_unit }}
              {% if operation_form.labor_minutes_per_unit.errors %}
                <span class="error">{{ operation_form.labor_minutes_per_unit.errors.0 }}</span>
              {% endif %}
            </div>
            
            <div class="form-field">
              <label for="{{ operation_form.machine_minutes_per_unit.id_for_label }}">{{ operation_form.machine_minutes_per_unit.label }}</label>
              {{ operation_form.machine_minutes_per_unit }}
              {% if operation_form.machine_minutes_per_unit.errors %}
                <span class="error">{{ operation_form.machine_minutes_per_unit.errors.0 }}</span>
              {% endif %}
            </div>
          </div>

          <div class="form-field">
            <label for="{{ operation_form.work_line.id_for_label }}">{{ operation_form.work_line.label }}</label>
            {{ operation_form.work_line }}
            {% if operation_form.work_line.errors %}
              <span class="error">{{ operation_form.work_line.errors.0 }}</span>
            {% endif %}
            {% if operation_form.work_line.help_text %}
              <small class="form-text">{{ operation_form.work_line.help_text }}</small>
            {% endif %}
          </div>

          <div class="form-field">
            <label for="{{ operation_form.requires_qc.id_for_label }}" class="checkbox-label-flex">
              {{ operation_form.requires_qc }}
              <span>{{ operation_form.requires_qc.label }}</span>
            </label>
            {% if operation_form.requires_qc.errors %}
              <span class="error">{{ operation_form.requires_qc.errors.0 }}</span>
            {% endif %}
          </div>

          <div class="form-field full-width">
            <label for="{{ operation_form.description.id_for_label }}">{{ operation_form.description.label }}</label>
            {{ operation_form.description }}
            {% if operation_form.description.errors %}
              <span class="error">{{ operation_form.description.errors.0 }}</span>
            {% endif %}
          </div>

          <div class="form-field full-width">
            <label for="{{ operation_form.notes.id_for_label }}">{{ operation_form.notes.label }}</label>
            {{ operation_form.notes }}
            {% if operation_form.notes.errors %}
              <span class="error">{{ operation_form.notes.errors.0 }}</span>
            {% endif %}
          </div>

          <!-- Materials formset for this operation -->
          <div class="operation-materials-section">
            <h5>{% trans "Materials Used in This Operation" %}</h5>
            
            <div class="materials-table-wrapper">
              <table class="materials-table">
                <thead>
                  <tr>
                    <th>{% trans "Material from BOM" %}</th>
                    <th class="col-quantity-used">{% trans "Quantity Used" %}</th>
                    <th class="col-unit">{% trans "Unit" %}</th>
                    <th class="col-delete">{% trans "Delete" %}</th>
                  </tr>
                </thead>
                <tbody class="operation-materials-tbody" data-operation-index="{{ forloop.counter0 }}">
                  <!-- Materials will be added here via JavaScript -->
                  <tr class="material-row-placeholder">
                    <td colspan="4" class="text-center muted-text-cell">
                      {% trans "No materials added yet. Select a BOM first." %}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <button type="button" class="btn btn-secondary btn-sm add-material-btn" 
                    data-operation-index="{{ forloop.counter0 }}"
                    onclick="addMaterialToOperation({{ forloop.counter0 }})"
                    {% if not form.bom.value and not process_id %}disabled{% endif %}>
              ‚ûï {% trans "Add Material" %}
            </button>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="formset-actions">
    <button type="button" class="btn btn-secondary" id="add-operation-btn" onclick="addOperation()">
      ‚ûï {% trans "Add Operation" %}
    </button>
  </div>
</div>
{% else %}
<div class="form-section">
  <div class="info-banner info-banner-warning">
    <p class="no-margin">‚ö†Ô∏è {% trans "Please select a BOM first to add production operations" %}</p>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_styles %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/shared.css' %}">
<link rel="stylesheet" href="{% static 'css/formset-table.css' %}">
<style>
.entity-form select[multiple] {
  min-height: 200px;
  padding: 0.5rem;
}

.form-help-text {
  color: #6b7280;
  font-size: 0.875rem;
  margin-bottom: 1rem;
}

/* Operation Styles */
.operation-row {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  background: #f9fafb;
}

.operation-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid #e5e7eb;
}

.operation-header h4 {
  margin: 0;
  font-size: 1.125rem;
  color: #1f2937;
}

.delete-operation-label {
  cursor: pointer;
  color: #dc2626;
  font-size: 0.875rem;
}

.btn-remove-operation {
  background: #dc2626;
  color: white;
  border: none;
  padding: 0.375rem 0.75rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.875rem;
}

.btn-remove-operation:hover {
  background: #b91c1c;
}

.operation-form-fields {
  display: grid;
  gap: 1rem;
}

.operation-materials-section {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid #e5e7eb;
}

.operation-materials-section h5 {
  margin: 0 0 1rem 0;
  font-size: 1rem;
  color: #374151;
}

.materials-table-wrapper {
  overflow-x: auto;
  margin-bottom: 1rem;
}

.materials-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 4px;
  overflow: hidden;
}

.materials-table th {
  background: #f3f4f6;
  padding: 0.75rem;
  text-align: right;
  font-weight: 600;
  font-size: 0.875rem;
  border-bottom: 2px solid #e5e7eb;
}

.materials-table td {
  padding: 0.5rem;
  border-bottom: 1px solid #f3f4f6;
}

.materials-table input,
.materials-table select {
  width: 100%;
  padding: 0.375rem 0.5rem;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 0.875rem;
}

.add-material-btn {
  margin-top: 0.5rem;
}

.text-center {
  text-align: center;
}

.btn-remove-material {
  background: #dc2626;
  color: white;
  border: none;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.875rem;
}

.btn-remove-material:hover {
  background: #b91c1c;
}

.formset-actions {
  margin-top: 1rem;
}
</style>
{% endblock %}

{% block form_scripts %}
<script>
// Define global variables for process and BOM
const processIdGlobal = {% if process_id %}{{ process_id }}{% else %}null{% endif %};
const bomSelectId = '{{ form.bom.id_for_label }}';

// Work lines data for JavaScript
const workLinesData = [
  {% for wl in work_lines %}
  {id: {{ wl.id }}, name: "{{ wl.name|escapejs }}", public_code: "{{ wl.public_code|escapejs }}"}{% if not forloop.last %},{% endif %}
  {% empty %}
  {% endfor %}
];

// Validate all material quantities before form submission
function validateAllMaterialQuantities() {
  let hasErrors = false;
  const bomMaterialIds = new Set();
  
  // Collect all BOM material IDs
  document.querySelectorAll('.operation-material-bom-material').forEach(select => {
    if (select.value) {
      bomMaterialIds.add(select.value);
    }
  });
  
  // Validate each material
  bomMaterialIds.forEach(bomMaterialId => {
    const quantityPerUnit = getBOMQuantityPerUnit(bomMaterialId);
    if (!quantityPerUnit) return;
    
    let total = 0;
    document.querySelectorAll('.operation-material-bom-material').forEach(select => {
      if (select.value === bomMaterialId) {
        const materialRow = select.closest('.material-row');
        if (materialRow) {
          const quantityInput = materialRow.querySelector('.operation-material-quantity');
          if (quantityInput && quantityInput.value) {
            const quantity = parseFloat(quantityInput.value);
            if (!isNaN(quantity) && quantity > 0) {
              total += quantity;
            }
          }
        }
      }
    });
    
    if (total > quantityPerUnit) {
      // Mark all inputs with this material as error
      document.querySelectorAll('.operation-material-bom-material').forEach(select => {
        if (select.value === bomMaterialId) {
          const materialRow = select.closest('.material-row');
          if (materialRow) {
            const quantityInput = materialRow.querySelector('.operation-material-quantity');
            if (quantityInput) {
              validateMaterialQuantity(bomMaterialId, quantityInput);
            }
          }
        }
      });
      hasErrors = true;
    }
  });
  
  return !hasErrors;
}

// BOM change handler - load materials when BOM is selected
document.addEventListener('DOMContentLoaded', function() {
  const bomSelect = document.getElementById(bomSelectId);
  
  // Function to enable/disable add material buttons
  function updateAddMaterialButtons() {
    const addMaterialBtns = document.querySelectorAll('.add-material-btn');
    const currentBomId = bomSelect ? bomSelect.value : '';
    const hasBOM = currentBomId || processIdGlobal; // Enable if BOM selected or process_id exists
    
    console.log('updateAddMaterialButtons - hasBOM:', hasBOM, 'currentBomId:', currentBomId, 'processId:', processIdGlobal);
    console.log('Found', addMaterialBtns.length, 'Add Material buttons');
    
    addMaterialBtns.forEach((btn, index) => {
      btn.disabled = !hasBOM;
      console.log(`Button ${index} (operation ${btn.getAttribute('data-operation-index') || 'unknown'}): disabled = ${btn.disabled}`);
    });
  }
  
  if (bomSelect) {
    bomSelect.addEventListener('change', function() {
      const bomId = this.value;
      updateAddMaterialButtons();
      
      // Reload materials dropdowns if BOM is selected
      if (bomId) {
        loadBOMMaterials(bomId);
      } else if (processIdGlobal) {
        // If BOM is cleared but process_id exists, load from Process
        loadProcessBOMMaterials(processIdGlobal);
      }
    });
    
    // Initial state
    updateAddMaterialButtons();
    if (bomSelect.value) {
      loadBOMMaterials(bomSelect.value);
    }
  } else if (processIdGlobal) {
    // If no BOM select but process_id exists, enable buttons and load materials
    updateAddMaterialButtons();
    loadProcessBOMMaterials(processIdGlobal);
  }
  
  // Add form submission validation
  const form = document.querySelector('form.entity-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      if (!validateAllMaterialQuantities()) {
        e.preventDefault();
        alert('ŸÑÿ∑ŸÅÿßŸã ÿÆÿ∑ÿßŸáÿß€å ŸÖÿ±ÿ®Ÿàÿ∑ ÿ®Ÿá ŸÖŸÇÿßÿØ€åÿ± ŸÖŸàÿßÿØ ÿ±ÿß ÿ®ÿ±ÿ∑ÿ±ŸÅ ⁄©ŸÜ€åÿØ. ŸÖÿ¨ŸÖŸàÿπ ŸÖŸÇÿßÿØ€åÿ± ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿ¥ÿØŸá ÿØÿ± ÿπŸÖŸÑ€åÿßÿ™‚ÄåŸáÿß ŸÜÿ®ÿß€åÿØ ÿ®€åÿ¥ÿ™ÿ± ÿßÿ≤ ŸÖŸÇÿØÿßÿ± ŸÖÿ¨ÿßÿ≤ BOM ÿ®ÿßÿ¥ÿØ.');
        return false;
      }
    });
  }
  
  // Create array of materials for each operation index (matching formset order)
  const operationMaterialsByIndex = [];
  {% if existing_operations_data %}
    {% for op_data in existing_operations_data %}
      operationMaterialsByIndex[{{ forloop.counter0 }}] = [
        {% for material in op_data.materials %}
          {
            id: {{ material.id|default:"null" }},
            bom_material_id: {{ material.bom_material_id }},
            quantity_used: '{{ material.quantity_used|escapejs }}',
            unit: '{{ material.unit|escapejs }}'
          }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ];
    {% endfor %}
  {% endif %}
  
  // Function to load existing materials for all operations
  function loadAllExistingMaterials() {
    {% if existing_operations_data %}
      // Function to actually add materials after BOM is loaded
      const addMaterialsToOperations = () => {
        // Wait a bit for DOM to be fully ready and BOM materials to be cached
        setTimeout(() => {
          operationMaterialsByIndex.forEach((materials, operationIndex) => {
            if (materials && materials.length > 0) {
              // Add each material one by one with a small delay
              materials.forEach((material, idx) => {
                setTimeout(() => {
                  addExistingMaterialToOperation(
                    operationIndex,
                    material.bom_material_id,
                    material.quantity_used,
                    material.unit,
                    material.id
                  );
                }, idx * 200); // Increased delay between each material to ensure dropdown is ready
              });
            }
          });
        }, 500); // Increased delay to ensure everything is ready
      };
      
      const bomId = bomSelect ? bomSelect.value : '';
      
      if (bomId) {
        // Wait for BOM materials to load, then add materials
        loadBOMMaterials(bomId).then(() => {
          // Wait a bit more for cache to be ready
          setTimeout(() => {
            addMaterialsToOperations();
          }, 300);
        });
      } else if (processIdGlobal) {
        // Wait for process BOM materials to load, then add materials
        loadProcessBOMMaterials(processIdGlobal).then(() => {
          // Wait a bit more for cache to be ready
          setTimeout(() => {
            addMaterialsToOperations();
          }, 300);
        });
      }
    {% endif %}
  }
  
  // Load existing operations materials if in edit mode
  {% if existing_operations_data %}
    // Wait for initial BOM loading to complete, then load materials
    // First ensure BOM materials are loaded
    const ensureBOMMaterialsLoaded = () => {
      const bomId = bomSelect ? bomSelect.value : '';
      
      if (bomId && bomMaterialsCache[bomId]) {
        // BOM materials already cached
        return Promise.resolve();
      } else if (bomId) {
        // Load BOM materials
        return loadBOMMaterials(bomId);
      } else if (processIdGlobal && bomMaterialsCache[`process_${processIdGlobal}`]) {
        // Process BOM materials already cached
        return Promise.resolve();
      } else if (processIdGlobal) {
        // Load process BOM materials
        return loadProcessBOMMaterials(processIdGlobal);
      } else {
        return Promise.resolve();
      }
    };
    
    // Wait a bit for DOM to be ready, then ensure BOM materials are loaded, then load materials
    setTimeout(() => {
      ensureBOMMaterialsLoaded().then(() => {
        // Wait a bit more for everything to be ready
        setTimeout(() => {
          loadAllExistingMaterials();
        }, 200);
      });
    }, 500);
  {% endif %}
});

// Function to load BOM materials from Process
function loadProcessBOMMaterials(processId) {
  return new Promise((resolve, reject) => {
    if (!processId) {
      resolve([]);
      return;
    }
    
    const cacheKey = `process_${processId}`;
    
    // Check cache first
    if (bomMaterialsCache[cacheKey]) {
      resolve(bomMaterialsCache[cacheKey]);
      return;
    }
    
    fetch(`/production/api/process/${processId}/bom-materials/`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to load BOM materials from Process');
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        bomMaterialsCache[cacheKey] = data.materials;
        resolve(data.materials);
      })
      .catch(error => {
        console.error('Error loading BOM materials from Process:', error);
        reject(error);
      });
  });
}

// Store BOM materials globally
let bomMaterialsCache = {};

function loadBOMMaterials(bomId) {
  return new Promise((resolve, reject) => {
    if (!bomId) {
      bomMaterialsCache = {};
      // Disable all add material buttons
      document.querySelectorAll('.add-material-btn').forEach(btn => {
        btn.disabled = true;
      });
      resolve([]);
      return;
    }
    
    // Check cache first
    if (bomMaterialsCache[bomId]) {
      resolve(bomMaterialsCache[bomId]);
      return;
    }
    
    // Fetch BOM materials via AJAX
    fetch(`/production/api/bom/${bomId}/materials/`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to load BOM materials');
        }
        return response.json();
      })
      .then(data => {
        // Cache materials
        bomMaterialsCache[bomId] = data.materials;
        
        // Log for debugging
        console.log(`Loaded ${data.materials.length} materials from BOM ${bomId}:`);
        console.log('BOM Code:', data.bom_code);
        console.log('Finished Item:', data.finished_item_name);
        console.log('Materials:', data.materials.map(m => `${m.material_item_code} - ${m.material_item_name} (ID: ${m.id})`));
        
        // Enable all add material buttons
        document.querySelectorAll('.add-material-btn').forEach(btn => {
          btn.disabled = false;
        });
        
        // Update all existing material selects
        document.querySelectorAll('.operation-material-bom-material').forEach(select => {
          updateMaterialSelect(select, data.materials);
        });
        
        resolve(data.materials);
      })
      .catch(error => {
        console.error('Error loading BOM materials:', error);
        alert('ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÖŸàÿßÿØ BOM. ŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.');
        reject(error);
      });
  });
}

function updateMaterialSelect(selectElement, materials, targetValue = null) {
  // Only update if materials array is provided and not empty
  if (!materials || !Array.isArray(materials) || materials.length === 0) {
    // If no materials, keep only the default option
    selectElement.innerHTML = '<option value="">---</option>';
    console.log('updateMaterialSelect: No materials provided, dropdown cleared');
    return;
  }
  
  const currentValue = targetValue || selectElement.value;
  
  // Clear all existing options
  while (selectElement.firstChild) {
    selectElement.removeChild(selectElement.firstChild);
  }
  
  // Add default option
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = '---';
  selectElement.appendChild(defaultOption);
  
  let addedCount = 0;
  let targetOption = null;
  
  // Only add BOM materials (these should only be BOM materials from API)
  materials.forEach(material => {
    // Ensure we only add materials that have required fields (BOM materials)
    if (material.id && material.material_item_code && material.material_item_name) {
      const option = document.createElement('option');
      const materialIdStr = String(material.id);
      option.value = materialIdStr;
      option.textContent = `${material.material_item_code} - ${material.material_item_name}`;
      option.dataset.unit = material.unit || '';
      option.dataset.quantityPerUnit = material.quantity_per_unit || '';
      selectElement.appendChild(option);
      
      // Track if this is the target option
      if (targetValue && materialIdStr === String(targetValue)) {
        targetOption = option;
      }
      
      addedCount++;
    } else {
      console.warn('updateMaterialSelect: Skipping invalid material:', material);
    }
  });
  
  console.log(`updateMaterialSelect: Added ${addedCount} BOM materials to dropdown (total provided: ${materials.length})`);
  
  // Set the target value if provided and found
  if (targetValue && targetOption) {
    targetOption.setAttribute('selected', 'selected');
    targetOption.selected = true;
    selectElement.value = String(targetValue);
    selectElement.selectedIndex = Array.from(selectElement.options).indexOf(targetOption);
    console.log(`updateMaterialSelect: Set target value ${targetValue} during populate, select.value: ${selectElement.value}`);
  } else if (currentValue) {
    // Restore previous value if still valid
    const optionExists = Array.from(selectElement.options).some(opt => opt.value === String(currentValue));
    if (optionExists) {
      selectElement.value = String(currentValue);
      const selectedOption = selectElement.querySelector(`option[value="${String(currentValue)}"]`);
      if (selectedOption) {
        selectedOption.setAttribute('selected', 'selected');
        selectedOption.selected = true;
      }
      console.log(`updateMaterialSelect: Restored previous value ${currentValue}, select.value: ${selectElement.value}`);
    }
  }
}

let operationCounter = {{ operations_formset.total_form_count|default:0 }};

function addOperation() {
  const container = document.getElementById('operations-container');
  const totalForms = document.getElementById('id_operations-TOTAL_FORMS');
  const formCount = parseInt(totalForms.value);
  
  const newOperationHtml = `
    <div class="operation-row" data-operation-index="${formCount}">
      <div class="operation-header">
        <h4>{% trans "Operation" %} #<span class="operation-number">${formCount + 1}</span></h4>
        <button type="button" class="btn-remove-operation" onclick="removeOperation(this)">√ó {% trans "Remove" %}</button>
      </div>
      
      <div class="operation-form-fields">
        <div class="form-row">
          <div class="form-field">
            <label>{% trans "Operation Name" %}</label>
            <input type="text" name="operations-${formCount}-name" class="form-control operation-name" />
          </div>
          <div class="form-field">
            <label>{% trans "Sequence Order" %}</label>
            <input type="number" name="operations-${formCount}-sequence_order" class="form-control operation-sequence" min="1" value="${formCount + 1}" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-field">
            <label>{% trans "Labor Minutes per Unit" %}</label>
            <input type="number" name="operations-${formCount}-labor_minutes_per_unit" class="form-control operation-labor-minutes" step="0.000001" min="0" />
          </div>
          <div class="form-field">
            <label>{% trans "Machine Minutes per Unit" %}</label>
            <input type="number" name="operations-${formCount}-machine_minutes_per_unit" class="form-control operation-machine-minutes" step="0.000001" min="0" />
          </div>
        </div>
        
        <div class="form-field">
          <label>{% trans "Work Line (ÿÆÿ∑ ⁄©ÿßÿ±€å)" %}</label>
          <select name="operations-${formCount}-work_line" class="form-control operation-work-line">
            <option value="">---</option>
            ${workLinesData.map(wl => `<option value="${wl.id}">${wl.public_code} - ${wl.name}</option>`).join('')}
          </select>
        </div>
        
        <div class="form-field">
          <label class="checkbox-label-flex">
            <input type="checkbox" name="operations-${formCount}-requires_qc" id="id_operations-${formCount}-requires_qc" class="form-check-input operation-requires-qc" />
            <span>{% trans "ŸÜ€åÿßÿ≤ ÿ®Ÿá QC" %}</span>
          </label>
        </div>
        
        <div class="form-field full-width">
          <label>{% trans "Description" %}</label>
          <input type="text" name="operations-${formCount}-description" class="form-control operation-description" />
        </div>
        
        <div class="form-field full-width">
          <label>{% trans "Notes" %}</label>
          <textarea name="operations-${formCount}-notes" class="form-control operation-notes" rows="2"></textarea>
        </div>
        
        <div class="operation-materials-section">
          <h5>{% trans "Materials Used in This Operation" %}</h5>
          <div class="materials-table-wrapper">
            <table class="materials-table">
              <thead>
                <tr>
                  <th>{% trans "Material from BOM" %}</th>
                  <th class="col-quantity-used">{% trans "Quantity Used" %}</th>
                  <th class="col-unit">{% trans "Unit" %}</th>
                  <th class="col-delete">{% trans "Delete" %}</th>
                </tr>
              </thead>
              <tbody class="operation-materials-tbody" data-operation-index="${formCount}">
                <tr class="material-row-placeholder">
                  <td colspan="4" class="text-center" style="color: #9ca3af; padding: 1rem;">
                    {% trans "No materials added yet." %}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <button type="button" class="btn btn-secondary btn-sm add-material-btn" 
                  data-operation-index="${formCount}"
                  onclick="addMaterialToOperation(${formCount})">
            ‚ûï {% trans "Add Material" %}
          </button>
        </div>
      </div>
    </div>
  `;
  
  container.insertAdjacentHTML('beforeend', newOperationHtml);
  totalForms.value = formCount + 1;
  operationCounter++;
  
  // Update operation numbers
  updateOperationNumbers();
  
  // Wait for DOM to be ready, then update buttons
  setTimeout(function() {
    // Update add material buttons state for newly added operation
    updateAddMaterialButtons();
    
    // Ensure the newly added button is enabled if BOM or process exists
    const bomSelect = document.getElementById(bomSelectId);
    const bomId = bomSelect ? bomSelect.value : '';
    const hasBOM = bomId || processIdGlobal;
    
    console.log('New operation added - formCount:', formCount, 'hasBOM:', hasBOM, 'bomId:', bomId);
    
    // Enable the newly added button if BOM/process exists
    if (hasBOM) {
      const newBtn = container.querySelector(`.operation-row[data-operation-index="${formCount}"] .add-material-btn`);
      console.log('Found new button:', newBtn);
      if (newBtn) {
        newBtn.disabled = false;
        console.log('Button enabled for operation', formCount);
      } else {
        console.error('Could not find button for operation', formCount);
      }
    } else {
      console.warn('No BOM selected, button will be disabled');
    }
  }, 100);
}

function removeOperation(button) {
  const operationRow = button.closest('.operation-row');
  operationRow.remove();
  updateOperationNumbers();
}

function updateOperationNumbers() {
  const operations = document.querySelectorAll('.operation-row');
  operations.forEach((op, index) => {
    const numberSpan = op.querySelector('.operation-number');
    if (numberSpan) {
      numberSpan.textContent = index + 1;
    }
  });
}

let materialCounters = {};

function addMaterialToOperation(operationIndex) {
  console.log('addMaterialToOperation called for operation index:', operationIndex);
  
  if (!materialCounters[operationIndex]) {
    materialCounters[operationIndex] = 0;
  }
  
  const materialIndex = materialCounters[operationIndex]++;
  console.log('Material index:', materialIndex);
  
  const tbody = document.querySelector(`.operation-materials-tbody[data-operation-index="${operationIndex}"]`);
  console.log('Found tbody:', tbody);
  
  // Check if tbody exists
  if (!tbody) {
    console.error(`Cannot find tbody for operation index ${operationIndex}`);
    console.error('Available tbodies:', document.querySelectorAll('.operation-materials-tbody'));
    alert('ÿÆÿ∑ÿß: ŸÜÿ™ŸàÿßŸÜÿ≥ÿ™ ÿ®ÿÆÿ¥ ŸÖŸàÿßÿØ ÿπŸÖŸÑ€åÿßÿ™ ÿ±ÿß Ÿæ€åÿØÿß ⁄©ŸÜÿØ. ŸÑÿ∑ŸÅÿßŸã ÿµŸÅÿ≠Ÿá ÿ±ÿß ÿ±ŸÅÿ±ÿ¥ ⁄©ŸÜ€åÿØ.');
    return;
  }
  
  // Remove placeholder if exists
  const placeholder = tbody.querySelector('.material-row-placeholder');
  if (placeholder) {
    placeholder.remove();
  }
  
  const newMaterialRow = `
    <tr class="material-row" data-material-index="${materialIndex}">
      <td>
        <select name="materials-${operationIndex}-${materialIndex}-bom_material" class="form-control operation-material-bom-material" required>
          <option value="">---</option>
          <!-- Options will be loaded from Process BOM -->
        </select>
      </td>
      <td>
        <input type="number" name="materials-${operationIndex}-${materialIndex}-quantity_used" 
               class="form-control operation-material-quantity" step="0.000001" min="0" required />
      </td>
      <td>
        <input type="text" name="materials-${operationIndex}-${materialIndex}-unit" 
               class="form-control operation-material-unit" readonly />
      </td>
      <td class="text-center">
        <button type="button" class="btn-remove-material" onclick="removeMaterial(this)">√ó</button>
      </td>
    </tr>
  `;
  
  tbody.insertAdjacentHTML('beforeend', newMaterialRow);
  
  // Load BOM materials - wait a bit for DOM to be ready
  setTimeout(function() {
    const select = tbody.querySelector(`.material-row[data-material-index="${materialIndex}"] .operation-material-bom-material`);
    if (!select) {
      console.error(`Cannot find select element for operation ${operationIndex}, material ${materialIndex}`);
      return;
    }
    
    // Get current BOM ID from select element
    const bomSelect = document.getElementById(bomSelectId);
    const currentBomId = bomSelect ? bomSelect.value : '';
    const processId = processIdGlobal;
    
    // Load BOM materials from Process if process_id is available
    if (processId) {
      loadProcessBOMMaterialsForOperation(operationIndex, materialIndex, processId);
      return;
    }
    
    // Try to load from current BOM ID (either from cache or API)
    if (currentBomId) {
      if (bomMaterialsCache[currentBomId]) {
        // Use cached materials
        updateMaterialSelect(select, bomMaterialsCache[currentBomId]);
        attachMaterialSelectHandlers(select);
      } else {
        // Load from API and cache
        loadBOMMaterialsForOperation(operationIndex, materialIndex, currentBomId);
      }
      return;
    }
    
    // If no BOM selected, try to use any available cache
    const cachedBomId = Object.keys(bomMaterialsCache).find(key => !key.startsWith('process_'));
    if (cachedBomId && bomMaterialsCache[cachedBomId]) {
      console.log('Using cached BOM materials from:', cachedBomId);
      updateMaterialSelect(select, bomMaterialsCache[cachedBomId]);
      attachMaterialSelectHandlers(select);
      return;
    }
    
    // Also check for process cache
    const processCacheKey = Object.keys(bomMaterialsCache).find(key => key.startsWith('process_'));
    if (processCacheKey && bomMaterialsCache[processCacheKey]) {
      console.log('Using cached process BOM materials from:', processCacheKey);
      updateMaterialSelect(select, bomMaterialsCache[processCacheKey]);
      attachMaterialSelectHandlers(select);
      return;
    }
    
    // If nothing available, keep dropdown empty (only --- option)
    console.warn('No BOM selected and no cached materials available');
    console.warn('Available cache keys:', Object.keys(bomMaterialsCache));
    // Don't show alert - just keep dropdown empty
    // Dropdown should only show materials after BOM is selected
  }, 100);
}

function removeMaterial(button) {
  const row = button.closest('.material-row');
  const tbody = row.closest('tbody');
  row.remove();
  
  // Show placeholder if no materials left
  if (tbody.querySelectorAll('.material-row').length === 0) {
    tbody.innerHTML = `
      <tr class="material-row-placeholder">
        <td colspan="4" class="text-center" style="color: #9ca3af; padding: 1rem;">
          {% trans "No materials added yet." %}
        </td>
      </tr>
    `;
  }
}

function loadProcessBOMMaterialsForOperation(operationIndex, materialIndex, processId) {
  const select = document.querySelector(
    `.operation-materials-tbody[data-operation-index="${operationIndex}"] .material-row[data-material-index="${materialIndex}"] .operation-material-bom-material`
  );
  
  if (!select) {
    return;
  }
  
  // Use process_id as cache key
  const cacheKey = `process_${processId}`;
  
  // Check cache first
  if (bomMaterialsCache[cacheKey]) {
    updateMaterialSelect(select, bomMaterialsCache[cacheKey]);
    attachMaterialSelectHandlers(select);
    return;
  }
  
  // Fetch BOM materials from Process
  fetch(`/production/api/process/${processId}/bom-materials/`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to load BOM materials from Process');
      }
      return response.json();
    })
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      
      // Log for debugging
      console.log(`Loaded ${data.materials.length} materials from Process ${processId}:`);
      console.log('BOM Code:', data.bom_code);
      console.log('Finished Item:', data.finished_item_name);
      console.log('Materials:', data.materials.map(m => `${m.material_item_code} - ${m.material_item_name} (ID: ${m.id})`));
      
      bomMaterialsCache[cacheKey] = data.materials;
      updateMaterialSelect(select, data.materials);
      attachMaterialSelectHandlers(select);
    })
    .catch(error => {
      console.error('Error loading BOM materials from Process:', error);
      alert('ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÖŸàÿßÿØ BOM ÿßÿ≤ ŸÅÿ±ÿß€åŸÜÿØ. ŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.');
    });
}

function loadBOMMaterialsForOperation(operationIndex, materialIndex, bomId) {
  const select = document.querySelector(
    `.operation-materials-tbody[data-operation-index="${operationIndex}"] .material-row[data-material-index="${materialIndex}"] .operation-material-bom-material`
  );
  
  if (!select) {
    return;
  }
  
  // Check cache first
  if (bomMaterialsCache[bomId]) {
    updateMaterialSelect(select, bomMaterialsCache[bomId]);
    attachMaterialSelectHandlers(select);
    return;
  }
  
  // Fetch if not in cache
  fetch(`/production/api/bom/${bomId}/materials/`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to load BOM materials');
      }
      return response.json();
    })
    .then(data => {
      bomMaterialsCache[bomId] = data.materials;
      updateMaterialSelect(select, data.materials);
      attachMaterialSelectHandlers(select);
    })
    .catch(error => {
      console.error('Error loading BOM materials:', error);
      alert('ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÖŸàÿßÿØ BOM. ŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.');
    });
}

// Calculate total quantity used for a specific BOM material across all operations
function calculateTotalQuantityUsed(bomMaterialId) {
  let total = 0;
  
  document.querySelectorAll('.operation-material-bom-material').forEach(select => {
    if (select.value === bomMaterialId) {
      const materialRow = select.closest('.material-row');
      if (materialRow) {
        const quantityInput = materialRow.querySelector('.operation-material-quantity');
        if (quantityInput && quantityInput.value) {
          const quantity = parseFloat(quantityInput.value);
          if (!isNaN(quantity) && quantity > 0) {
            total += quantity;
          }
        }
      }
    }
  });
  
  return total;
}

// Get quantity_per_unit for a BOM material
function getBOMQuantityPerUnit(bomMaterialId) {
  const select = document.querySelector(`.operation-material-bom-material option[value="${bomMaterialId}"]`);
  if (select) {
    const quantityPerUnit = parseFloat(select.dataset.quantityPerUnit);
    return isNaN(quantityPerUnit) ? null : quantityPerUnit;
  }
  return null;
}

// Validate quantity used for a specific material
function validateMaterialQuantity(bomMaterialId, quantityInput) {
  const quantityPerUnit = getBOMQuantityPerUnit(bomMaterialId);
  if (!quantityPerUnit) return true; // Skip validation if quantity_per_unit not found
  
  // Calculate total excluding current input
  let total = 0;
  document.querySelectorAll('.operation-material-bom-material').forEach(select => {
    if (select.value === bomMaterialId) {
      const materialRow = select.closest('.material-row');
      if (materialRow) {
        const qtyInput = materialRow.querySelector('.operation-material-quantity');
        // Exclude current input from calculation
        if (qtyInput && qtyInput !== quantityInput && qtyInput.value) {
          const qty = parseFloat(qtyInput.value);
          if (!isNaN(qty) && qty > 0) {
            total += qty;
          }
        }
      }
    }
  });
  
  // Add current input value
  const currentQuantity = parseFloat(quantityInput.value);
  if (!isNaN(currentQuantity) && currentQuantity > 0) {
    total += currentQuantity;
  }
  
  // Validate
  if (total > quantityPerUnit) {
    const materialRow = quantityInput.closest('.material-row');
    const select = materialRow ? materialRow.querySelector('.operation-material-bom-material') : null;
    const materialName = select && select.selectedOptions[0] ? select.selectedOptions[0].textContent : '';
    
    // Show error message
    let errorMsg = materialRow ? materialRow.querySelector('.quantity-error-msg') : null;
    if (!errorMsg) {
      errorMsg = document.createElement('div');
      errorMsg.className = 'quantity-error-msg';
      errorMsg.style.color = '#dc2626';
      errorMsg.style.fontSize = '0.875rem';
      errorMsg.style.marginTop = '0.25rem';
      if (quantityInput.parentNode) {
        quantityInput.parentNode.appendChild(errorMsg);
      }
    }
    errorMsg.innerHTML = `<bdi>ŸÖÿ¨ŸÖŸàÿπ ŸÖŸÇÿßÿØ€åÿ± ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿ¥ÿØŸá (${total.toFixed(6)}) ÿ®€åÿ¥ÿ™ÿ± ÿßÿ≤ ŸÖŸÇÿØÿßÿ± ŸÖÿ¨ÿßÿ≤ BOM ÿ®ÿ±ÿß€å €å⁄© Ÿàÿßÿ≠ÿØ ŸÖÿ≠ÿµŸàŸÑ ŸÜŸáÿß€å€å (${quantityPerUnit}) ÿßÿ≥ÿ™</bdi>`;
    quantityInput.style.borderColor = '#dc2626';
    return false;
  } else {
    // Remove error message if exists
    const materialRow = quantityInput.closest('.material-row');
    const errorMsg = materialRow ? materialRow.querySelector('.quantity-error-msg') : null;
    if (errorMsg) {
      errorMsg.remove();
    }
    quantityInput.style.borderColor = '';
    return true;
  }
}

function attachMaterialSelectHandlers(selectElement) {
  // Remove existing handlers
  const newSelect = selectElement.cloneNode(true);
  selectElement.parentNode.replaceChild(newSelect, selectElement);
  
  // Add change handler to update unit and set default quantity
  newSelect.addEventListener('change', function() {
    const materialRow = this.closest('.material-row');
    if (!materialRow) return;
    
    const unitInput = materialRow.querySelector('.operation-material-unit');
    const quantityInput = materialRow.querySelector('.operation-material-quantity');
    
    if (this.selectedOptions[0] && this.selectedOptions[0].value) {
      const selectedOption = this.selectedOptions[0];
      const unit = selectedOption.dataset.unit || '';
      const quantityPerUnit = selectedOption.dataset.quantityPerUnit || '';
      
      if (unitInput) {
        unitInput.value = unit;
      }
      
      // Set default quantity to BOM quantity if quantity input is empty
      if (quantityInput && !quantityInput.value && quantityPerUnit) {
        quantityInput.value = quantityPerUnit;
      }
      
      // Validate quantity after material selection
      if (quantityInput && quantityInput.value) {
        validateMaterialQuantity(this.value, quantityInput);
      }
    } else {
      if (unitInput) {
        unitInput.value = '';
      }
      // Remove error message if material is deselected
      const errorMsg = materialRow.querySelector('.quantity-error-msg');
      if (errorMsg) {
        errorMsg.remove();
      }
      if (quantityInput) {
        quantityInput.style.borderColor = '';
      }
    }
  });
  
  // Add validation handler for quantity input
  const materialRow = newSelect.closest('.material-row');
  if (materialRow) {
    const quantityInput = materialRow.querySelector('.operation-material-quantity');
    if (quantityInput) {
      // Remove existing validation handlers
      const newQuantityInput = quantityInput.cloneNode(true);
      quantityInput.parentNode.replaceChild(newQuantityInput, quantityInput);
      
      // Add validation on input change
      newQuantityInput.addEventListener('input', function() {
        const bomMaterialSelect = materialRow.querySelector('.operation-material-bom-material');
        if (bomMaterialSelect && bomMaterialSelect.value) {
          validateMaterialQuantity(bomMaterialSelect.value, this);
        }
      });
      
      // Add validation on blur
      newQuantityInput.addEventListener('blur', function() {
        const bomMaterialSelect = materialRow.querySelector('.operation-material-bom-material');
        if (bomMaterialSelect && bomMaterialSelect.value) {
          validateMaterialQuantity(bomMaterialSelect.value, this);
        }
      });
    }
  }
}

// Load existing operation materials (for edit mode)
function loadExistingOperationMaterials(operationIndex, operationId, materialCount) {
  const tbody = document.querySelector(`.operation-materials-tbody[data-operation-index="${operationIndex}"]`);
  if (!tbody) return;
  
  // Remove placeholder
  const placeholder = tbody.querySelector('.material-row-placeholder');
  if (placeholder) {
    placeholder.remove();
  }
  
  const bomSelect = document.getElementById(bomSelectId);
  const bomId = bomSelect ? bomSelect.value : '';
  
  if (!bomId && !processIdGlobal) {
    return;
  }
  
  // Add existing materials from server data
  {% if existing_operations_data %}
    {% for op_data in existing_operations_data %}
      {% if op_data.materials %}
        {% for material in op_data.materials %}
          addExistingMaterialToOperation(
            {{ forloop.parentloop.counter0 }}, 
            {{ material.bom_material_id }}, 
            '{{ material.quantity_used }}', 
            '{{ material.unit }}', 
            {{ material.id|default:"null" }}
          );
        {% endfor %}
      {% endif %}
    {% endfor %}
  {% endif %}
}

function addExistingMaterialToOperation(operationIndex, bomMaterialId, quantityUsed, unit, materialId) {
  if (!materialCounters[operationIndex]) {
    materialCounters[operationIndex] = 0;
  }
  
  const materialIndex = materialCounters[operationIndex]++;
  const tbody = document.querySelector(`.operation-materials-tbody[data-operation-index="${operationIndex}"]`);
  
  if (!tbody) return;
  
  // Remove placeholder if exists
  const placeholder = tbody.querySelector('.material-row-placeholder');
  if (placeholder) {
    placeholder.remove();
  }
  
  const bomSelect = document.getElementById(bomSelectId);
  const bomId = bomSelect ? bomSelect.value : '';
  
  const newMaterialRow = `
    <tr class="material-row" data-material-index="${materialIndex}">
      <td>
        <select name="materials-${operationIndex}-${materialIndex}-bom_material" class="form-control operation-material-bom-material" required>
          <option value="">---</option>
        </select>
        ${materialId ? `<input type="hidden" name="materials-${operationIndex}-${materialIndex}-id" value="${materialId}" />` : ''}
      </td>
      <td>
        <input type="number" name="materials-${operationIndex}-${materialIndex}-quantity_used" 
               class="form-control operation-material-quantity" step="0.000001" min="0" value="${quantityUsed}" required />
      </td>
      <td>
        <input type="text" name="materials-${operationIndex}-${materialIndex}-unit" 
               class="form-control operation-material-unit" value="${unit}" readonly />
      </td>
      <td class="text-center">
        <button type="button" class="btn-remove-material" onclick="removeMaterial(this)">√ó</button>
      </td>
    </tr>
  `;
  
  tbody.insertAdjacentHTML('beforeend', newMaterialRow);
  
  // Load BOM materials and set selected value
  // Wait a bit longer for DOM to be ready (row needs to be fully inserted)
  setTimeout(() => {
    const select = tbody.querySelector(`.material-row[data-material-index="${materialIndex}"] .operation-material-bom-material`);
    
    if (!select) {
      console.error(`Cannot find select for operation ${operationIndex}, material ${materialIndex}`);
      return;
    }
    
      const populateAndSelect = (materials) => {
        if (!materials || materials.length === 0) {
          console.warn('No BOM materials available for populating dropdown');
          return;
        }
        
        // Save the target value before clearing
        const targetValue = String(bomMaterialId);
        
        console.log(`Populating dropdown for operation ${operationIndex}, material ${materialIndex}, target value: ${targetValue}`);
        console.log('Available materials:', materials.map(m => `${m.id} (${m.material_item_code})`));
        
        // Populate dropdown - pass target value to preserve it
        updateMaterialSelect(select, materials, targetValue);
        
        // Immediately after populate, verify the value was set
        console.log(`Immediately after populate - select.value: ${select.value}, options count: ${select.options.length}`);
        if (select.value !== targetValue) {
          console.warn(`Value not set correctly during populate! Expected: ${targetValue}, Got: ${select.value}`);
          // Try to set it now
          const foundOption = Array.from(select.options).find(opt => String(opt.value) === String(targetValue));
          if (foundOption) {
            select.value = targetValue;
            select.selectedIndex = Array.from(select.options).indexOf(foundOption);
            console.log(`Manually set value after populate, select.value now: ${select.value}`);
          }
        }
        
        // Wait for DOM to update, then verify and set value again if needed
        // Use a longer delay to ensure dropdown is fully populated
        setTimeout(() => {
        // Verify select element is still in DOM and visible
        if (!select || !select.parentElement || !document.body.contains(select)) {
          console.error('Select element not found in DOM!');
          return;
        }
        
        // Verify dropdown has options
        const options = select.querySelectorAll('option');
        console.log(`Dropdown has ${options.length} options after populate`);
        console.log('Available option values:', Array.from(options).map(opt => `${opt.value} (${opt.textContent})`));
        
        // If dropdown has no options or only default option, wait more
        if (options.length <= 1) {
          console.warn('Dropdown not fully populated yet, waiting more...');
          setTimeout(() => {
            const retryOptions = select.querySelectorAll('option');
            console.log(`After retry, dropdown has ${retryOptions.length} options`);
          }, 200);
          return;
        }
        
        // Find the option with matching value (try both string and number)
        let option = select.querySelector(`option[value="${targetValue}"]`);
        if (!option) {
          // Try to find by comparing values (in case of type mismatch)
          option = Array.from(select.options).find(opt => String(opt.value) === String(targetValue));
        }
        
        if (option) {
          // First remove selected from all options
          select.querySelectorAll('option').forEach(opt => {
            opt.removeAttribute('selected');
            opt.selected = false;
          });
          
          // Set selected attribute and property on the target option
          option.setAttribute('selected', 'selected');
          option.selected = true;
          
          // Set value property (try both string and number)
          console.log(`Attempting to set value to: ${targetValue}, current select.value before: ${select.value}`);
          
          // First, try setting selectedIndex directly
          const optionIndex = Array.from(select.options).indexOf(option);
          console.log(`Found option at index: ${optionIndex}, option value: ${option.value}, option text: ${option.textContent}`);
          
          if (optionIndex >= 0) {
            select.selectedIndex = optionIndex;
            console.log(`Set selectedIndex to ${optionIndex}, select.value now: ${select.value}`);
          }
          
          // Also set value property
          select.value = targetValue;
          console.log(`Set select.value to ${targetValue}, select.value now: ${select.value}`);
          
          // Verify the value is actually set
          if (select.value !== targetValue && select.value !== String(targetValue)) {
            console.warn(`Value mismatch! Expected: ${targetValue}, Got: ${select.value}`);
            // Try with number if string didn't work
            const numValue = parseInt(targetValue);
            if (!isNaN(numValue)) {
              select.value = numValue;
              console.log(`Tried setting with number: ${numValue}, select.value now: ${select.value}`);
            }
          }
          
          // Force a re-check after a small delay
          setTimeout(() => {
            const currentValue = select.value;
            const currentSelected = select.options[select.selectedIndex];
            console.log(`After delay - select.value: ${currentValue}, selectedIndex: ${select.selectedIndex}, selected option: ${currentSelected ? currentSelected.textContent : 'none'}`);
            
            if (currentValue !== targetValue && String(currentValue) !== String(targetValue)) {
              console.warn(`Value not set correctly! Expected: ${targetValue}, Current: ${currentValue}`);
              // Try one more time
              select.value = targetValue;
              select.selectedIndex = optionIndex;
              console.log(`Retried setting value, select.value now: ${select.value}`);
            }
          }, 50);
          
          console.log(`Successfully set value to ${targetValue}, selectedIndex: ${optionIndex}, current select.value: ${select.value}`);
          
          // Attach handlers after value is set
          attachMaterialSelectHandlers(select);
          
          // Final verification and force set if needed
          setTimeout(() => {
            if (select.value !== targetValue && String(select.value) !== String(targetValue)) {
              console.warn(`Value was changed after setting! Expected: ${targetValue}, Current: ${select.value}, forcing reset...`);
              select.value = targetValue;
              select.selectedIndex = optionIndex;
              option.selected = true;
              option.setAttribute('selected', 'selected');
            }
            
            // Trigger change event to update unit and other dependent fields
            const changeEvent = new Event('change', { bubbles: true, cancelable: true });
            select.dispatchEvent(changeEvent);
            
            // Force a re-render by triggering input event as well
            const inputEvent = new Event('input', { bubbles: true, cancelable: true });
            select.dispatchEvent(inputEvent);
            
            // Final check - log the actual displayed value
            const displayedOption = select.options[select.selectedIndex];
            const displayedText = displayedOption ? displayedOption.textContent : 'N/A';
            const displayedValue = select.value;
            
            console.log(`Final state - select.value: ${displayedValue}, displayed text: "${displayedText}", selectedIndex: ${select.selectedIndex}`);
            
            // If value is set but text is still "---", there's a display issue
            if (displayedValue === targetValue && displayedText === '---') {
              console.error(`ERROR: Value is set (${displayedValue}) but dropdown shows "---"! This is a display issue.`);
              console.error('Select element:', select);
              console.error('Selected option:', displayedOption);
              console.error('All options:', Array.from(select.options).map(opt => ({value: opt.value, text: opt.textContent, selected: opt.selected})));
              
              // Try to force a visual update by toggling disabled state
              const wasDisabled = select.disabled;
              select.disabled = true;
              setTimeout(() => {
                select.disabled = wasDisabled;
                console.log('Toggled disabled state to force re-render');
              }, 10);
            } else if (displayedValue === targetValue) {
              console.log(`‚úÖ SUCCESS: Value correctly set and displayed: "${displayedText}"`);
            } else {
              console.warn(`‚ö†Ô∏è WARNING: Value mismatch. Expected: ${targetValue}, Displayed value: ${displayedValue}, Displayed text: "${displayedText}"`);
            }
            
            console.log(`Successfully set BOM material ${targetValue} for operation ${operationIndex}`);
          }, 100);
        } else {
          const availableValues = Array.from(select.options).map(opt => `${opt.value} (${typeof opt.value})`);
          console.warn(`BOM material ${targetValue} (${typeof targetValue}) not found in dropdown options. Available values:`, availableValues);
          console.warn(`Select element:`, select);
        }
      }, 200); // Increased delay to ensure dropdown is fully populated
    };
    
    if (processIdGlobal) {
      // Load from Process
      const cacheKey = `process_${processIdGlobal}`;
      if (bomMaterialsCache[cacheKey]) {
        populateAndSelect(bomMaterialsCache[cacheKey]);
      } else {
        loadProcessBOMMaterials(processIdGlobal).then((materials) => {
          populateAndSelect(materials);
        }).catch(err => {
          console.error('Error loading process BOM materials:', err);
        });
      }
    } else if (bomId && bomMaterialsCache[bomId]) {
      populateAndSelect(bomMaterialsCache[bomId]);
    } else if (bomId) {
      // Wait for BOM materials to load
      loadBOMMaterials(bomId).then((materials) => {
        populateAndSelect(materials);
      }).catch(err => {
        console.error('Error loading BOM materials:', err);
      });
    } else {
      console.warn('No BOM ID or process ID available for loading materials');
    }
  }, 150); // Increased delay to ensure row is fully inserted in DOM
}
</script>
{% endblock %}
