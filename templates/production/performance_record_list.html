{% extends "shared/generic/generic_list.html" %}
{% load i18n %}
{% load jalali_tags %}
{% load access_tags %}

{% block table_headers %}
<th>{% trans "Performance Code" %}</th>
<th>{% trans "Product Order" %}</th>
<th>{% trans "Finished Item" %}</th>
<th>{% trans "Performance Date" %}</th>
<th>{% trans "Planned Qty" %}</th>
<th>{% trans "Actual Qty" %}</th>
<th>{% trans "Status" %}</th>
<th>{% trans "Approver" %}</th>
<th>{% trans "Lock Status" %}</th>
{% if show_actions %}
  <th>{% trans "Actions" %}</th>
{% endif %}
{% endblock %}

{% block table_rows %}
{% for record in object_list %}
<tr>
  <td><code>{{ record.performance_code }}</code></td>
  <td>{{ record.order_code }}</td>
  <td>
    {% if record.finished_item %}
      {{ record.finished_item.item_code }} - {{ record.finished_item.name }}
    {% else %}
      <span class="muted-text">–</span>
    {% endif %}
  </td>
  <td>{{ record.performance_date|jalali_date }}</td>
  <td>{{ record.quantity_planned }} {{ record.unit }}</td>
  <td>{{ record.quantity_actual }} {{ record.unit }}</td>
  <td>
    <span class="badge badge-{{ record.status }}">
      {{ record.get_status_display }}
    </span>
  </td>
  <td>{{ record.approved_by.get_full_name|default:record.approved_by.username|default:"–" }}</td>
  <td>
    {% if record.is_locked == 1 %}
      <span class="badge badge-locked">{% trans "Locked" %}</span>
    {% else %}
      <span class="badge badge-unlocked">{% trans "Editable" %}</span>
    {% endif %}
  </td>
  {% if show_actions %}
  <td>
    {% if record.is_locked != 1 %}
      {% if user_feature_permissions|feature_allowed:'production.performance_records:edit_own' or user.is_superuser %}
        <a href="{% url edit_url_name record.pk %}" class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.85rem;">
          {% trans "Edit" %}
        </a>
      {% endif %}
      {% if user_feature_permissions|feature_allowed:'production.performance_records:delete_own' or user.is_superuser %}
        <a href="{% url delete_url_name record.pk %}" class="btn btn-primary" style="padding: 4px 12px; font-size: 0.85rem;">
          {% trans "Delete" %}
        </a>
      {% endif %}
    {% endif %}
    {% if record.status == 'pending_approval' and record.approved_by == user %}
      {% if user_feature_permissions|feature_allowed:'production.performance_records:approve' or user.is_superuser %}
        <button type="button" class="btn btn-sm btn-success" onclick="approveRecord({{ record.pk }})" style="padding: 4px 12px; font-size: 0.85rem;">
          {% trans "Approve" %}
        </button>
      {% endif %}
      {% if user_feature_permissions|feature_allowed:'production.performance_records:reject' or user.is_superuser %}
        <button type="button" class="btn btn-sm btn-warning" onclick="rejectRecord({{ record.pk }})" style="padding: 4px 12px; font-size: 0.85rem;">
          {% trans "Reject" %}
        </button>
      {% endif %}
    {% endif %}
    {% if record.status == 'approved' and record.is_locked == 1 %}
      {% if user_feature_permissions|feature_allowed:'production.performance_records:create_receipt' or user.is_superuser %}
        <a href="{% url 'production:performance_record_create_receipt' record.pk %}" class="btn btn-sm btn-primary" onclick="return confirm('{% trans "Create receipt for this performance record?" %}')" style="padding: 4px 12px; font-size: 0.85rem;">
          {% trans "Create Receipt" %}
        </a>
      {% endif %}
    {% endif %}
  </td>
  {% endif %}
</tr>
{% endfor %}
{% endblock %}

{% block after_table %}
<script>
function approveRecord(recordId) {
  if (!confirm('{% trans "Are you sure you want to approve this performance record?" %}')) {
    return;
  }
  
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `{% url 'production:performance_record_approve' 0 %}`.replace('0', recordId);
  
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
  if (csrfToken) {
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken.value;
    form.appendChild(csrfInput);
  }
  
  document.body.appendChild(form);
  form.submit();
}

function rejectRecord(recordId) {
  if (!confirm('{% trans "Are you sure you want to reject this performance record?" %}')) {
    return;
  }
  
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `{% url 'production:performance_record_reject' 0 %}`.replace('0', recordId);
  
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
  if (csrfToken) {
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken.value;
    form.appendChild(csrfInput);
  }
  
  document.body.appendChild(form);
  form.submit();
}
</script>
{% endblock %}
