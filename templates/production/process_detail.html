{% extends "shared/generic/generic_detail.html" %}
{% load i18n jalali_tags %}

{% block detail_sections %}
{% if detail_sections %}
  {% for section in detail_sections %}
    {% if section.type == 'operations_detail' %}
      {# Custom rendering for operations with detailed information #}
      <div class="form-section">
        <h3>{{ section.title }}</h3>
        {% for op_info in section.operations %}
          {% with operation=op_info.operation materials=op_info.materials personnel=op_info.personnel machines=op_info.machines warehouse=op_info.warehouse %}
          <div class="operation-detail-card" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #f3f4f6;">
              <div>
                <strong style="font-size: 1.1rem; color: #111827;">{% trans "Operation" %} #{{ operation.sequence_order }}</strong>
                {% if operation.name %}
                  <span style="color: #6b7280; margin-right: 0.5rem;">¬∑ {{ operation.name }}</span>
                {% endif %}
              </div>
              <div style="font-size: 0.875rem; color: #6b7280;">
                <span>‚öôÔ∏è {{ operation.labor_minutes_per_unit }} {% trans "min labor" %}</span>
                <span style="margin-right: 1rem;">|</span>
                <span>üîß {{ operation.machine_minutes_per_unit }} {% trans "min machine" %}</span>
              </div>
            </div>
            
            {% if operation.description %}
              <div style="margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem;">
                {{ operation.description }}
              </div>
            {% endif %}
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
              {% if operation.work_line %}
                <div>
                  <strong style="font-size: 0.875rem; color: #374151; display: block; margin-bottom: 0.5rem;">{% trans "Work Line" %}:</strong>
                  <span style="color: #6b7280;">{{ operation.work_line.name }}</span>
                </div>
              {% endif %}
              
              {% if warehouse %}
                <div>
                  <strong style="font-size: 0.875rem; color: #374151; display: block; margin-bottom: 0.5rem;">{% trans "Warehouse" %}:</strong>
                  <span style="color: #6b7280;">{{ warehouse.public_code }} - {{ warehouse.name }}</span>
                </div>
              {% endif %}
            </div>
            
            {% if materials %}
              <div style="margin-bottom: 1rem; padding-top: 1rem; border-top: 1px solid #f3f4f6;">
                <strong style="font-size: 0.875rem; color: #374151; display: block; margin-bottom: 0.75rem;">{% trans "Materials Used" %}:</strong>
                <ul style="margin: 0; padding-right: 1.5rem; list-style: none; font-size: 0.875rem;">
                  {% for material in materials %}
                  <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 4px;">
                    <code style="font-size: 0.8rem; background: #e5e7eb; padding: 0.125rem 0.375rem; border-radius: 3px;">{{ material.bom_material.material_item_code }}</code>
                    <span style="color: #374151; margin-right: 0.5rem;">{{ material.bom_material.material_item.name|default:material.bom_material.material_item_code }}</span>
                    <span style="color: #9ca3af;">({{ material.quantity_used }} {{ material.unit }})</span>
                  </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            
            {% if personnel %}
              <div style="margin-bottom: 1rem; padding-top: 1rem; border-top: 1px solid #f3f4f6;">
                <strong style="font-size: 0.875rem; color: #374151; display: block; margin-bottom: 0.75rem;">{% trans "Personnel" %}:</strong>
                <ul style="margin: 0; padding-right: 1.5rem; list-style: none; font-size: 0.875rem;">
                  {% for person in personnel %}
                  <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 4px;">
                    <span style="color: #374151;">{{ person.name }}</span>
                    {% if person.public_code %}
                      <code style="font-size: 0.8rem; background: #e5e7eb; padding: 0.125rem 0.375rem; border-radius: 3px; margin-right: 0.5rem;">{{ person.public_code }}</code>
                    {% endif %}
                  </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            
            {% if machines %}
              <div style="margin-bottom: 1rem; padding-top: 1rem; border-top: 1px solid #f3f4f6;">
                <strong style="font-size: 0.875rem; color: #374151; display: block; margin-bottom: 0.75rem;">{% trans "Machines" %}:</strong>
                <ul style="margin: 0; padding-right: 1.5rem; list-style: none; font-size: 0.875rem;">
                  {% for machine in machines %}
                  <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 4px;">
                    <span style="color: #374151;">{{ machine.name }}</span>
                    {% if machine.public_code %}
                      <code style="font-size: 0.8rem; background: #e5e7eb; padding: 0.125rem 0.375rem; border-radius: 3px; margin-right: 0.5rem;">{{ machine.public_code }}</code>
                    {% endif %}
                  </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    {% else %}
      {# Render other sections using generic template logic #}
      <div class="form-section">
        <h3>{{ section.title }}</h3>
        {% if section.type == 'fields' or section.fields %}
          <div class="form-row">
            {% for field in section.fields %}
              <div class="form-field">
                <label>{{ field.label }}</label>
                <div class="readonly-field">
                  {% if field.type == 'code' %}
                    <code>{{ field.value }}</code>
                  {% elif field.type == 'badge' %}
                    {% if field.value %}
                      <span class="badge badge-active">{{ field.true_label|default:"Active" }}</span>
                    {% else %}
                      <span class="badge badge-inactive">{{ field.false_label|default:"Inactive" }}</span>
                    {% endif %}
                  {% elif field.type == 'link' and field.url %}
                    <a href="{{ field.url }}">{{ field.value }}</a>
                  {% else %}
                    {{ field.value|default:"-" }}
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% elif section.type == 'table' %}
          {% if section.data %}
          <div class="data-table-container">
            <table class="data-table">
              <thead>
                <tr>
                  {% for header in section.headers %}
                    <th>{{ header }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in section.data %}
                  <tr>
                    {% for cell in row %}
                      <td>{{ cell|default:"-" }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-info">
            {% trans "No data available." %}
          </div>
          {% endif %}
        {% elif section.type == 'custom' %}
          {{ section.content|safe }}
        {% endif %}
      </div>
    {% endif %}
  {% endfor %}
{% endif %}

{% if object.approved_at %}
<div class="form-section">
  <h3>{% trans "Approval Information" %}</h3>
  <div class="form-row">
    {% if object.approved_by %}
    <div class="form-field">
      <label>{% trans "Approved By" %}</label>
      <div class="readonly-field">{{ object.approved_by.get_full_name|default:object.approved_by.username }}</div>
    </div>
    {% endif %}
    {% if object.approved_at %}
    <div class="form-field">
      <label>{% trans "Approved At" %}</label>
      <div class="readonly-field">{{ object.approved_at|jalali_date:"%Y/%m/%d %H:%M" }}</div>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

{% if object.created_at or object.updated_at or object.created_by or object.edited_by %}
<div class="form-section">
  <h3>{% trans "Audit Information" %}</h3>
  <div class="form-row">
    {% if object.created_by %}
    <div class="form-field">
      <label>{% trans "Created By" %}</label>
      <div class="readonly-field">{{ object.created_by.get_full_name|default:object.created_by.username }}</div>
    </div>
    {% endif %}
    {% if object.created_at %}
    <div class="form-field">
      <label>{% trans "Created At" %}</label>
      <div class="readonly-field">{{ object.created_at|jalali_date:"%Y/%m/%d %H:%M" }}</div>
    </div>
    {% endif %}
    {% if object.edited_by %}
    <div class="form-field">
      <label>{% trans "Edited By" %}</label>
      <div class="readonly-field">{{ object.edited_by.get_full_name|default:object.edited_by.username }}</div>
    </div>
    {% endif %}
    {% if object.updated_at %}
    <div class="form-field">
      <label>{% trans "Last Updated" %}</label>
      <div class="readonly-field">{{ object.updated_at|jalali_date:"%Y/%m/%d %H:%M" }}</div>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}
{% endblock %}
