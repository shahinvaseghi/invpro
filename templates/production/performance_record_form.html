{% extends "shared/generic/generic_form.html" %}
{% load i18n %}
{% load static %}
{% load jalali_tags %}
{% load access_tags %}

{% block breadcrumb_extra %}
<span class="separator">/</span>
<span>{% trans "Production" %}</span>
<span class="separator">/</span>
<a href="{% url 'production:performance_records' %}">{% trans "Performance Records" %}</a>
<span class="separator">/</span>
<span>{{ form_title }}</span>
{% endblock %}

{% block before_form %}
{% if object and object.pk %}
  <div class="info-banner" style="background: #f3f4f6; padding: 1.5rem; border-radius: 6px; margin-bottom: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
    <div><strong>{% trans "Performance Code" %}:</strong> <code>{{ object.performance_code }}</code></div>
    <div><strong>{% trans "Performance Date" %}:</strong> {{ object.performance_date|jalali_date }}</div>
    <div><strong>{% trans "Status" %}:</strong> {{ object.get_status_display }}</div>
    <div class="lock-status">
      <strong>{% trans "Lock Status" %}:</strong>
      {% if object.is_locked == 1 %}
        <span class="badge badge-locked">{% trans "Locked" %}</span>
      {% else %}
        <span class="badge badge-unlocked">{% trans "Editable" %}</span>
      {% endif %}
    </div>
  </div>
  
  {% if object.is_locked == 1 %}
  <div class="alert alert-info" style="background: #dbeafe; color: #1e40af; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; border: 1px solid #93c5fd;">
    {% trans "This performance record is locked and can no longer be edited." %}
  </div>
  {% endif %}
{% endif %}
{% endblock %}

{% block form_sections %}
<div class="form-section">
  <h2>{% trans "Performance Information" %}</h2>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.document_type.id_for_label }}">{{ form.document_type.label }} *</label>
      {{ form.document_type }}
      {% if form.document_type.errors %}
        <span class="error">{{ form.document_type.errors.0 }}</span>
      {% endif %}
      {% if form.document_type.help_text %}
        <small class="form-text">{{ form.document_type.help_text }}</small>
      {% endif %}
    </div>
  </div>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.order.id_for_label }}">{{ form.order.label }} *</label>
      {{ form.order }}
      {% if form.order.errors %}
        <span class="error">{{ form.order.errors.0 }}</span>
      {% endif %}
      {% if form.order.help_text %}
        <small class="form-text">{{ form.order.help_text }}</small>
      {% endif %}
    </div>
    
    <div class="form-field" id="operation-field-container">
      <label for="{{ form.operation.id_for_label }}">{{ form.operation.label }} <span id="operation-required" style="display: none;">*</span></label>
      {{ form.operation }}
      {% if form.operation.errors %}
        <span class="error">{{ form.operation.errors.0 }}</span>
      {% endif %}
      {% if form.operation.help_text %}
        <small class="form-text">{{ form.operation.help_text }}</small>
      {% endif %}
    </div>
  </div>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.transfer.id_for_label }}">{{ form.transfer.label }}</label>
      {{ form.transfer }}
      {% if form.transfer.errors %}
        <span class="error">{{ form.transfer.errors.0 }}</span>
      {% endif %}
      {% if form.transfer.help_text %}
        <small class="form-text">{{ form.transfer.help_text }}</small>
      {% endif %}
    </div>
  </div>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.performance_date.id_for_label }}">{{ form.performance_date.label }} *</label>
      {{ form.performance_date }}
      {% if form.performance_date.errors %}
        <span class="error">{{ form.performance_date.errors.0 }}</span>
      {% endif %}
    </div>
    
    <div class="form-field">
      <label for="{{ form.approved_by.id_for_label }}">{{ form.approved_by.label }}</label>
      {{ form.approved_by }}
      {% if form.approved_by.errors %}
        <span class="error">{{ form.approved_by.errors.0 }}</span>
      {% endif %}
      {% if form.approved_by.help_text %}
        <small class="form-text">{{ form.approved_by.help_text }}</small>
      {% endif %}
    </div>
  </div>
  
  <div class="form-row" id="quantity-fields-container">
    <div class="form-field">
      <label for="{{ form.quantity_planned.id_for_label }}">{{ form.quantity_planned.label }} <span id="quantity-planned-required" style="display: none;">*</span></label>
      {{ form.quantity_planned }}
      {% if form.quantity_planned.errors %}
        <span class="error">{{ form.quantity_planned.errors.0 }}</span>
      {% endif %}
      {% if form.quantity_planned.help_text %}
        <small class="form-text">{{ form.quantity_planned.help_text }}</small>
      {% endif %}
    </div>
    
    <div class="form-field">
      <label for="{{ form.quantity_actual.id_for_label }}">{{ form.quantity_actual.label }} <span id="quantity-actual-required" style="display: none;">*</span></label>
      {{ form.quantity_actual }}
      {% if form.quantity_actual.errors %}
        <span class="error">{{ form.quantity_actual.errors.0 }}</span>
      {% endif %}
      {% if form.quantity_actual.help_text %}
        <small class="form-text">{{ form.quantity_actual.help_text }}</small>
      {% endif %}
    </div>
  </div>
  
  <div class="form-row">
    <div class="form-field full-width">
      <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
      {{ form.notes }}
      {% if form.notes.errors %}
        <span class="error">{{ form.notes.errors.0 }}</span>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block form_extra %}
<!-- Materials Section -->
<div class="form-section">
  <header class="section-header">
    <h2>{% trans "Materials (Waste Tracking)" %}</h2>
    <p>{% trans "Materials from transfer document. Enter waste quantity for each material." %}</p>
  </header>
  
  {{ material_formset.management_form }}
  
  {% if material_formset.non_form_errors %}
    <div class="alert alert-error">
      {% for error in material_formset.non_form_errors %}
        <div>{{ error }}</div>
      {% endfor %}
    </div>
  {% endif %}
  
  <div class="table-responsive" style="overflow-x: auto; width: 100%; margin-bottom: 1rem;">
    <table class="data-table formset-table" id="materials-table">
      <thead>
        <tr>
          <th>{% trans "Material Item" %}</th>
          <th>{% trans "Required Quantity" %}</th>
          <th>{% trans "Waste Quantity" %}</th>
          <th>{% trans "Unit" %}</th>
          <th>{% trans "Notes" %}</th>
        </tr>
      </thead>
      <tbody id="materials-formset-container">
        {% for material_form in material_formset %}
        <tr class="formset-row" data-row-index="{{ forloop.counter0 }}">
          {% for hidden in material_form.hidden_fields %}{{ hidden }}{% endfor %}
          <td>
            {{ material_form.material_item }}
            {% if material_form.material_item.errors %}
              <div class="field-error">{{ material_form.material_item.errors.0 }}</div>
            {% endif %}
          </td>
          <td>
            {{ material_form.quantity_required }}
            {% if material_form.quantity_required.errors %}
              <div class="field-error">{{ material_form.quantity_required.errors.0 }}</div>
            {% endif %}
          </td>
          <td>
            {{ material_form.quantity_waste }}
            {% if material_form.quantity_waste.errors %}
              <div class="field-error">{{ material_form.quantity_waste.errors.0 }}</div>
            {% endif %}
          </td>
          <td>
            {{ material_form.unit }}
            {% if material_form.unit.errors %}
              <div class="field-error">{{ material_form.unit.errors.0 }}</div>
            {% endif %}
          </td>
          <td>
            {{ material_form.notes }}
            {% if material_form.notes.errors %}
              <div class="field-error">{{ material_form.notes.errors.0 }}</div>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Persons Section -->
<div class="form-section" id="persons-section">
  <header class="section-header">
    <h2>{% trans "Personnel (Labor Time)" %}</h2>
    {% if is_general_document %}
    <p>{% trans "Personnel data is automatically aggregated from operational performance records." %}</p>
    {% else %}
    <p>{% trans "Add personnel who worked on this order and enter their work minutes." %}</p>
    {% endif %}
  </header>
  
  {{ person_formset.management_form }}
  
  {% if person_formset.non_form_errors %}
    <div class="alert alert-error">
      {% for error in person_formset.non_form_errors %}
        <div>{{ error }}</div>
      {% endfor %}
    </div>
  {% endif %}
  
  <div class="table-responsive" style="overflow-x: auto; width: 100%; margin-bottom: 1rem;">
    <table class="data-table formset-table" id="persons-table">
      <thead>
        <tr>
          <th>{% trans "Person" %}</th>
          <th>{% trans "Work Minutes" %}</th>
          <th>{% trans "Work Line" %}</th>
          <th>{% trans "Notes" %}</th>
          <th>{% trans "Actions" %}</th>
        </tr>
      </thead>
      <tbody id="persons-formset-container">
        {% for person_form in person_formset %}
        <tr class="formset-row" data-row-index="{{ forloop.counter0 }}">
          {% for hidden in person_form.hidden_fields %}{{ hidden }}{% endfor %}
          <td>
            {{ person_form.person }}
            {% if person_form.person.errors %}
              <div class="field-error">{{ person_form.person.errors.0 }}</div>
            {% endif %}
          </td>
          <td>
            {{ person_form.work_minutes }}
            {% if person_form.work_minutes.errors %}
              <div class="field-error">{{ person_form.work_minutes.errors.0 }}</div>
            {% endif %}
          </td>
          <td>
            {{ person_form.work_line }}
            {% if person_form.work_line.errors %}
              <div class="field-error">{{ person_form.work_line.errors.0 }}</div>
            {% endif %}
          </td>
          <td>
            {{ person_form.notes }}
            {% if person_form.notes.errors %}
              <div class="field-error">{{ person_form.notes.errors.0 }}</div>
            {% endif %}
          </td>
          <td>
            {% if not is_general_document and person_formset.can_delete %}
              {{ person_form.DELETE }}
              {% if person_form.DELETE %}
                <label for="{{ person_form.DELETE.id_for_label }}" style="margin-left: 5px; cursor: pointer;">
                  {% trans "Delete" %}
                </label>
              {% endif %}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  {% if not is_general_document %}
  <button type="button" id="add-person-btn" class="btn btn-secondary">+ {% trans "Add Person" %}</button>
  {% endif %}
</div>

<!-- Machines Section -->
<div class="form-section" id="machines-section">
  <header class="section-header">
    <h2>{% trans "Machines (Machine Usage Time)" %}</h2>
    {% if is_general_document %}
    <p>{% trans "Machine data is automatically aggregated from operational performance records." %}</p>
    {% else %}
    <p>{% trans "Add machines used in this order and enter their work minutes." %}</p>
    {% endif %}
  </header>
  
  {{ machine_formset.management_form }}
  
  {% if machine_formset.non_form_errors %}
    <div class="alert alert-error">
      {% for error in machine_formset.non_form_errors %}
        <div>{{ error }}</div>
      {% endfor %}
    </div>
  {% endif %}
  
  <div class="table-responsive" style="overflow-x: auto; width: 100%; margin-bottom: 1rem;">
    <table class="data-table formset-table" id="machines-table">
      <thead>
        <tr>
          <th>{% trans "Machine" %}</th>
          <th>{% trans "Work Minutes" %}</th>
          <th>{% trans "Work Line" %}</th>
          <th>{% trans "Notes" %}</th>
          <th>{% trans "Actions" %}</th>
        </tr>
      </thead>
      <tbody id="machines-formset-container">
        {% for machine_form in machine_formset %}
        <tr class="formset-row" data-row-index="{{ forloop.counter0 }}">
          {% for hidden in machine_form.hidden_fields %}{{ hidden }}{% endfor %}
          <td>
            {{ machine_form.machine }}
            {% if machine_form.machine.errors %}
              <div class="field-error">{{ machine_form.machine.errors.0 }}</div>
            {% endif %}
          </td>
          <td>
            {{ machine_form.work_minutes }}
            {% if machine_form.work_minutes.errors %}
              <div class="field-error">{{ machine_form.work_minutes.errors.0 }}</div>
            {% endif %}
          </td>
          <td>
            {{ machine_form.work_line }}
            {% if machine_form.work_line.errors %}
              <div class="field-error">{{ machine_form.work_line.errors.0 }}</div>
            {% endif %}
          </td>
          <td>
            {{ machine_form.notes }}
            {% if machine_form.notes.errors %}
              <div class="field-error">{{ machine_form.notes.errors.0 }}</div>
            {% endif %}
          </td>
          <td>
            {% if not is_general_document and machine_formset.can_delete %}
              {{ machine_form.DELETE }}
              {% if machine_form.DELETE %}
                <label for="{{ machine_form.DELETE.id_for_label }}" style="margin-left: 5px; cursor: pointer;">
                  {% trans "Delete" %}
                </label>
              {% endif %}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  {% if not is_general_document %}
  <button type="button" id="add-machine-btn" class="btn btn-secondary">+ {% trans "Add Machine" %}</button>
  {% endif %}
</div>

<!-- Create Receipt Section (only for approved and locked records) -->
{% if object and object.pk and object.status == 'approved' and object.is_locked == 1 %}
  {% if user_feature_permissions|feature_allowed:'production.performance_records:create_receipt' or user.is_superuser %}
  <div class="form-section">
    <header class="section-header">
      <h2>{% trans "Create Receipt" %}</h2>
      <p>{% trans "Create a receipt for the actual quantity produced." %}</p>
    </header>
    <a href="{% url 'production:performance_record_create_receipt' object.pk %}" class="btn btn-primary" onclick="return confirm('{% trans "Create receipt for this performance record?" %}')">
      {% trans "Create Receipt" %}
    </a>
  </div>
  {% endif %}
{% endif %}
{% endblock %}

{% block form_actions_extra %}
{% if object and object.is_locked == 1 %}
  <style>
    .form-actions button[type="submit"] {
      display: none !important;
    }
  </style>
{% endif %}
{% endblock %}

{% block extra_styles %}
<style>
.table-responsive {
  overflow-x: auto;
  width: 100%;
  margin-bottom: 1rem;
}

#materials-table,
#persons-table,
#machines-table {
  min-width: 800px;
  width: 100%;
}

#materials-table th,
#materials-table td,
#persons-table th,
#persons-table td,
#machines-table th,
#machines-table td {
  white-space: nowrap;
  min-width: 120px;
  padding: 8px 12px;
}

.formset-table {
  border-collapse: collapse;
}

.formset-table thead {
  background: #f3f4f6;
}

.formset-table th {
  font-weight: 600;
  text-align: left;
  border-bottom: 2px solid #e5e7eb;
}

.formset-table td {
  border-bottom: 1px solid #e5e7eb;
}

.formset-table tbody tr:hover {
  background: #f9fafb;
}

.field-error {
  color: #dc2626;
  font-size: 0.875rem;
  margin-top: 0.25rem;
  display: block;
}
</style>
{% endblock %}

{% block form_scripts %}
<script src="{% static 'js/jalali-datepicker/jalali-datepicker.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/jalali-datepicker/jalali-datepicker.min.css' %}">

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Jalali Date Picker
  var performanceDateInput = document.getElementById('id_performance_date');
  if (performanceDateInput) {
    jalaliDatepicker.startWatch({
      minDate: 'attr',
      maxDate: 'attr',
    });
    performanceDateInput.addEventListener('focus', function() {
      jalaliDatepicker.show(this);
    });
  }

  // Get form elements
  var documentTypeSelect = document.getElementById('id_document_type');
  var orderSelect = document.getElementById('id_order');
  var operationSelect = document.getElementById('id_operation');
  var transferSelect = document.getElementById('id_transfer');
  var quantityPlannedInput = document.getElementById('id_quantity_planned');
  var quantityActualInput = document.getElementById('id_quantity_actual');
  var quantityFieldsContainer = document.getElementById('quantity-fields-container');
  var operationFieldContainer = document.getElementById('operation-field-container');
  var operationRequired = document.getElementById('operation-required');
  var quantityPlannedRequired = document.getElementById('quantity-planned-required');
  var quantityActualRequired = document.getElementById('quantity-actual-required');

  // Function to toggle fields based on document type
  function toggleFieldsByDocumentType() {
    var documentType = documentTypeSelect ? documentTypeSelect.value : '';
    var isGeneral = (documentType === 'general');
    
    // Toggle operation and quantity fields
    if (documentType === 'operational') {
      // Show operation field, hide quantity fields
      if (operationFieldContainer) {
        operationFieldContainer.style.display = '';
      }
      if (operationSelect) {
        operationSelect.required = true;
        operationSelect.disabled = false;
      }
      if (operationRequired) {
        operationRequired.style.display = 'inline';
      }
      
      if (quantityFieldsContainer) {
        quantityFieldsContainer.style.display = 'none';
      }
      if (quantityPlannedInput) {
        quantityPlannedInput.required = false;
        quantityPlannedInput.value = '';
        quantityPlannedInput.disabled = false;
      }
      if (quantityActualInput) {
        quantityActualInput.required = false;
        quantityActualInput.value = '';
        quantityActualInput.disabled = false;
      }
      if (quantityPlannedRequired) {
        quantityPlannedRequired.style.display = 'none';
      }
      if (quantityActualRequired) {
        quantityActualRequired.style.display = 'none';
      }
    } else if (documentType === 'general') {
      // Hide operation field, show quantity fields
      if (operationFieldContainer) {
        operationFieldContainer.style.display = 'none';
      }
      if (operationSelect) {
        operationSelect.required = false;
        operationSelect.value = '';
        operationSelect.disabled = false;
      }
      if (operationRequired) {
        operationRequired.style.display = 'none';
      }
      
      if (quantityFieldsContainer) {
        quantityFieldsContainer.style.display = '';
      }
      if (quantityPlannedInput) {
        quantityPlannedInput.required = true;
        quantityPlannedInput.disabled = false;
      }
      if (quantityActualInput) {
        quantityActualInput.required = true;
        quantityActualInput.disabled = false;
      }
      if (quantityPlannedRequired) {
        quantityPlannedRequired.style.display = 'inline';
      }
      if (quantityActualRequired) {
        quantityActualRequired.style.display = 'inline';
      }
    }
    
    // Toggle persons and machines sections
    var personsSection = document.getElementById('persons-section');
    var machinesSection = document.getElementById('machines-section');
    var addPersonBtn = document.getElementById('add-person-btn');
    var addMachineBtn = document.getElementById('add-machine-btn');
    
    if (isGeneral) {
      // Disable all person and machine inputs
      if (personsSection) {
        var personInputs = personsSection.querySelectorAll('input, select, textarea');
        personInputs.forEach(function(input) {
          if (input.type !== 'hidden' && !input.name.includes('DELETE')) {
            input.disabled = true;
            input.readOnly = true;
          }
        });
      }
      
      if (machinesSection) {
        var machineInputs = machinesSection.querySelectorAll('input, select, textarea');
        machineInputs.forEach(function(input) {
          if (input.type !== 'hidden' && !input.name.includes('DELETE')) {
            input.disabled = true;
            input.readOnly = true;
          }
        });
      }
      
      // Hide add buttons
      if (addPersonBtn) {
        addPersonBtn.style.display = 'none';
      }
      if (addMachineBtn) {
        addMachineBtn.style.display = 'none';
      }
    } else {
      // Enable all person and machine inputs
      if (personsSection) {
        var personInputs = personsSection.querySelectorAll('input, select, textarea');
        personInputs.forEach(function(input) {
          input.disabled = false;
          input.readOnly = false;
        });
      }
      
      if (machinesSection) {
        var machineInputs = machinesSection.querySelectorAll('input, select, textarea');
        machineInputs.forEach(function(input) {
          input.disabled = false;
          input.readOnly = false;
        });
      }
      
      // Show add buttons
      if (addPersonBtn) {
        addPersonBtn.style.display = '';
      }
      if (addMachineBtn) {
        addMachineBtn.style.display = '';
      }
    }
  }

  // Initialize field visibility on page load
  toggleFieldsByDocumentType();

  // Load operations on page load if order is already selected
  if (orderSelect && orderSelect.value && documentTypeSelect && documentTypeSelect.value === 'operational') {
    loadOperationsForOrder(orderSelect.value);
  }

  // Update fields when document type changes
  if (documentTypeSelect) {
    documentTypeSelect.addEventListener('change', function() {
      toggleFieldsByDocumentType();
      // Clear operation when switching to general
      if (this.value === 'general' && operationSelect) {
        operationSelect.value = '';
        operationSelect.innerHTML = '<option value="">--------</option>';
      }
      // Reload operations when switching to operational
      if (this.value === 'operational' && orderSelect && orderSelect.value) {
        loadOperationsForOrder(orderSelect.value);
      }
    });
  }

  // Function to load operations for selected order
  function loadOperationsForOrder(orderId) {
    console.log('loadOperationsForOrder called with orderId:', orderId);
    
    if (!orderId || !operationSelect) {
      console.log('No orderId or operationSelect, clearing options');
      if (operationSelect) {
        operationSelect.innerHTML = '<option value="">--------</option>';
      }
      return;
    }

    // Only fetch operations if document type is operational
    if (documentTypeSelect && documentTypeSelect.value !== 'operational') {
      console.log('Document type is not operational, skipping');
      if (operationSelect) {
        operationSelect.innerHTML = '<option value="">--------</option>';
      }
      return;
    }

    // Show loading state
    if (operationSelect) {
      operationSelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
      operationSelect.disabled = true;
    }

    // Build URL - ensure it includes language prefix
    var baseUrl = '{% url "production:performance_record_get_operations" %}';
    // If baseUrl doesn't start with /fa/, add it
    if (!baseUrl.startsWith('/fa/') && !baseUrl.startsWith('http')) {
      baseUrl = '/fa' + baseUrl;
    }
    var url = baseUrl + '?order_id=' + orderId;
    console.log('Fetching operations from:', url);
    console.log('Base URL:', baseUrl);
    console.log('Order ID:', orderId);

    // Fetch operations for the selected order's process via AJAX
    fetch(url, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json',
      },
      credentials: 'same-origin',  // Include cookies for session
    })
      .then(function(response) {
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
      })
      .then(function(data) {
        console.log('Received data:', data);
        
        if (data.error) {
          console.error('Error fetching operations:', data.error);
          if (operationSelect) {
            operationSelect.innerHTML = '<option value="">--------</option>';
            operationSelect.disabled = false;
          }
          return;
        }
        
        // Clear existing options
        if (operationSelect) {
          operationSelect.innerHTML = '<option value="">--------</option>';
          
          // Add new options
          if (data.operations && data.operations.length > 0) {
            console.log('Adding', data.operations.length, 'operations');
            data.operations.forEach(function(op) {
              var option = document.createElement('option');
              option.value = op.id;
              option.textContent = op.name || ('Operation ' + op.sequence_order);
              operationSelect.appendChild(option);
            });
          } else {
            console.log('No operations available');
            // No operations available
            var option = document.createElement('option');
            option.value = '';
            option.textContent = '{% trans "No operations available" %}';
            option.disabled = true;
            operationSelect.appendChild(option);
          }
          operationSelect.disabled = false;
        }
      })
      .catch(function(error) {
        console.error('Error fetching operations:', error);
        if (operationSelect) {
          operationSelect.innerHTML = '<option value="">--------</option>';
          operationSelect.disabled = false;
        }
      });
  }

  // Update operation options when order changes
  if (orderSelect && operationSelect) {
    console.log('Setting up order change listener');
    
    // Use both change and input events to ensure it works
    function handleOrderChange() {
      var orderId = orderSelect.value;
      console.log('Order changed/input to:', orderId);
      if (orderId) {
        loadOperationsForOrder(orderId);
      } else {
        if (operationSelect) {
          operationSelect.innerHTML = '<option value="">--------</option>';
        }
      }
    }
    
    orderSelect.addEventListener('change', handleOrderChange);
    orderSelect.addEventListener('input', handleOrderChange);
    
    // Also check if order is already selected on page load
    // Use multiple timeouts to ensure DOM is ready
    setTimeout(function() {
      console.log('Checking for pre-selected order...');
      console.log('orderSelect:', orderSelect);
      console.log('orderSelect.value:', orderSelect ? orderSelect.value : 'N/A');
      console.log('documentTypeSelect:', documentTypeSelect);
      console.log('documentTypeSelect.value:', documentTypeSelect ? documentTypeSelect.value : 'N/A');
      
      if (orderSelect && orderSelect.value && documentTypeSelect && documentTypeSelect.value === 'operational') {
        console.log('Order already selected on page load:', orderSelect.value);
        loadOperationsForOrder(orderSelect.value);
      }
    }, 500);
    
    // Also try after a longer delay
    setTimeout(function() {
      if (orderSelect && orderSelect.value && documentTypeSelect && documentTypeSelect.value === 'operational') {
        console.log('Second check - Order already selected:', orderSelect.value);
        loadOperationsForOrder(orderSelect.value);
      }
    }, 1000);
  } else {
    console.error('orderSelect or operationSelect not found!');
    console.log('orderSelect:', orderSelect);
    console.log('operationSelect:', operationSelect);
  }

  if (orderSelect && transferSelect) {
    function updateTransferOptions() {
      var orderId = orderSelect.value;
      if (!orderId) {
        transferSelect.innerHTML = '<option value="">--------</option>';
        return;
      }

      // Filter transfers by selected order
      var options = transferSelect.querySelectorAll('option');
      options.forEach(function(option) {
        if (option.value) {
          // Check if this transfer belongs to the selected order
          // This is a simplified check - in real implementation, you might need an API call
          option.style.display = '';
        }
      });
    }

    orderSelect.addEventListener('change', function() {
      updateTransferOptions();
      // Auto-populate quantity_planned from order (only for general documents)
      if (documentTypeSelect && documentTypeSelect.value === 'general') {
        if (orderSelect.options[orderSelect.selectedIndex]) {
          var orderText = orderSelect.options[orderSelect.selectedIndex].text;
          // Extract quantity from order text if available, or make API call
        }
      }
    });

    transferSelect.addEventListener('change', function() {
      // When transfer is selected, materials should be auto-populated
      // This will be handled server-side in the view
    });
  }

  // Formset management for persons
  var addPersonBtn = document.getElementById('add-person-btn');
  var personsFormsetContainer = document.getElementById('persons-formset-container');
  var totalPersonsInput = document.querySelector('#id_persons-TOTAL_FORMS');

  if (addPersonBtn && personsFormsetContainer && totalPersonsInput) {
    addPersonBtn.addEventListener('click', function() {
      var currentFormCount = parseInt(totalPersonsInput.value);
      var newFormIndex = currentFormCount;

      var newFormRow = personsFormsetContainer.lastElementChild.cloneNode(true);
      newFormRow.setAttribute('data-row-index', newFormIndex);

      newFormRow.querySelectorAll('input, select, textarea').forEach(function(field) {
        if (field.name) {
          field.name = field.name.replace(/persons-(\d+)-/, `persons-${newFormIndex}-`);
        }
        if (field.id) {
          field.id = field.id.replace(/id_persons-(\d+)-/, `id_persons-${newFormIndex}-`);
        }
        if (field.type !== 'hidden' && field.type !== 'checkbox') {
          field.value = '';
        }
        if (field.type === 'checkbox') {
          field.checked = false;
        }
      });

      newFormRow.querySelectorAll('.field-error').forEach(function(error) {
        error.textContent = '';
      });

      personsFormsetContainer.appendChild(newFormRow);
      totalPersonsInput.value = newFormIndex + 1;
    });
  }

  // Formset management for machines
  var addMachineBtn = document.getElementById('add-machine-btn');
  var machinesFormsetContainer = document.getElementById('machines-formset-container');
  var totalMachinesInput = document.querySelector('#id_machines-TOTAL_FORMS');

  if (addMachineBtn && machinesFormsetContainer && totalMachinesInput) {
    addMachineBtn.addEventListener('click', function() {
      var currentFormCount = parseInt(totalMachinesInput.value);
      var newFormIndex = currentFormCount;

      var newFormRow = machinesFormsetContainer.lastElementChild.cloneNode(true);
      newFormRow.setAttribute('data-row-index', newFormIndex);

      newFormRow.querySelectorAll('input, select, textarea').forEach(function(field) {
        if (field.name) {
          field.name = field.name.replace(/machines-(\d+)-/, `machines-${newFormIndex}-`);
        }
        if (field.id) {
          field.id = field.id.replace(/id_machines-(\d+)-/, `id_machines-${newFormIndex}-`);
        }
        if (field.type !== 'hidden' && field.type !== 'checkbox') {
          field.value = '';
        }
        if (field.type === 'checkbox') {
          field.checked = false;
        }
      });

      newFormRow.querySelectorAll('.field-error').forEach(function(error) {
        error.textContent = '';
      });

      machinesFormsetContainer.appendChild(newFormRow);
      totalMachinesInput.value = newFormIndex + 1;
    });
  }

  // Handle DELETE checkboxes
  if (personsFormsetContainer) {
    personsFormsetContainer.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox' && e.target.name && e.target.name.includes('-DELETE')) {
        var row = e.target.closest('.formset-row');
        if (row && e.target.checked) {
          row.style.display = 'none';
        } else if (row && !e.target.checked) {
          row.style.display = '';
        }
      }
    });
  }

  if (machinesFormsetContainer) {
    machinesFormsetContainer.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox' && e.target.name && e.target.name.includes('-DELETE')) {
        var row = e.target.closest('.formset-row');
        if (row && e.target.checked) {
          row.style.display = 'none';
        } else if (row && !e.target.checked) {
          row.style.display = '';
        }
      }
    });
  }
});
</script>
{% endblock %}
