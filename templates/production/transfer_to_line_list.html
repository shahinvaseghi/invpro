{% extends "shared/generic/generic_list.html" %}
{% load i18n %}
{% load jalali_tags %}
{% load access_tags %}

{% block page_title %}{% trans "Transfer to Line Requests" %}{% endblock %}

{% block breadcrumb_extra %}
<span class="separator">/</span>
<span>{% trans "Production" %}</span>
<span class="separator">/</span>
<span>{% trans "Transfer to Line Requests" %}</span>
{% endblock %}

{% block page_actions %}
<div class="page-actions">
  {% if user_feature_permissions|feature_allowed:'production.transfer_requests:create' or user.is_superuser %}
    <a href="{% url 'production:transfer_request_create' %}" class="btn btn-primary">{% trans "Create Transfer Request +" %}</a>
  {% endif %}
</div>
{% endblock %}

{% block table_headers %}
<th>{% trans "Transfer Code" %}</th>
<th>{% trans "Product Order" %}</th>
<th>{% trans "Finished Item" %}</th>
<th>{% trans "Transfer Date" %}</th>
<th>{% trans "Status" %}</th>
<th>{% trans "Approver" %}</th>
<th>{% trans "Lock Status" %}</th>
<th>{% trans "Actions" %}</th>
{% endblock %}

{% block table_rows %}
{% for object in object_list %}
<tr>
  <td>{{ object.transfer_code }}</td>
  <td>{{ object.order_code }}</td>
  <td>
    {% if object.order.finished_item %}
      {{ object.order.finished_item.item_code }} - {{ object.order.finished_item.name }}
    {% else %}
      -
    {% endif %}
  </td>
  <td>{{ object.transfer_date|jalali_date }}</td>
  <td>
    <span class="badge badge-{{ object.status }}">
      {{ object.get_status_display }}
    </span>
  </td>
  <td>{{ object.approved_by.get_full_name|default:object.approved_by.username|default:"-" }}</td>
  <td>
    {% if object.is_locked == 1 %}
      <span class="badge badge-locked">{% trans "Locked" %}</span>
    {% else %}
      <span class="badge badge-unlocked">{% trans "Editable" %}</span>
    {% endif %}
  </td>
  <td>
    {% if object.is_locked != 1 %}
      {% if user_feature_permissions|feature_allowed:'production.transfer_requests:edit_own' or user.is_superuser %}
        <a href="{% url 'production:transfer_request_edit' object.pk %}" class="btn btn-sm btn-secondary">{% trans "Edit" %}</a>
      {% endif %}
      {% if user_feature_permissions|feature_allowed:'production.transfer_requests:delete_own' or user.is_superuser %}
        <a href="{% url 'production:transfer_request_delete' object.pk %}" class="btn btn-sm btn-danger">{% trans "Delete" %}</a>
      {% endif %}
    {% endif %}
    {% if object.status == 'pending_approval' and object.approved_by == user %}
      {% if user_feature_permissions|feature_allowed:'production.transfer_requests:approve' or user.is_superuser %}
        <button type="button" class="btn btn-sm btn-success" onclick="approveTransfer({{ object.pk }})">{% trans "Approve" %}</button>
      {% endif %}
      {% if user_feature_permissions|feature_allowed:'production.transfer_requests:reject' or user.is_superuser %}
        <button type="button" class="btn btn-sm btn-warning" onclick="rejectTransfer({{ object.pk }})">{% trans "Reject" %}</button>
      {% endif %}
    {% endif %}
  </td>
</tr>
{% endfor %}
{% endblock %}

{% block pagination %}
{% if is_paginated %}
<div class="pagination">
  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}" class="page-link">{% trans "Previous" %}</a>
  {% endif %}
  <span>{% trans "Page" %} {{ page_obj.number }} {% trans "of" %} {{ page_obj.paginator.num_pages }}</span>
  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}" class="page-link">{% trans "Next" %}</a>
  {% endif %}
</div>
{% endif %}
{% endblock %}

{% block empty_state_title %}{% trans "No Transfer Requests Found" %}{% endblock %}
{% block empty_state_message %}{% trans "No transfer to line requests found. Create your first transfer request to get started." %}{% endblock %}
{% block empty_state_icon %}ðŸ“¦{% endblock %}
{% block empty_state_action %}
  {% if user_feature_permissions|feature_allowed:'production.transfer_requests:create' or user.is_superuser %}
    <a href="{% url 'production:transfer_request_create' %}" class="btn btn-primary">{% trans "Create Transfer Request +" %}</a>
  {% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
function approveTransfer(transferId) {
  if (!confirm('{% trans "Are you sure you want to approve this transfer request?" %}')) {
    return;
  }
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `{% url 'production:transfer_request_approve' 0 %}`.replace('0', transferId);
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
  if (csrfToken) {
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken.value;
    form.appendChild(csrfInput);
  }
  document.body.appendChild(form);
  form.submit();
}

function rejectTransfer(transferId) {
  if (!confirm('{% trans "Are you sure you want to reject this transfer request?" %}')) {
    return;
  }
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `{% url 'production:transfer_request_reject' 0 %}`.replace('0', transferId);
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
  if (csrfToken) {
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken.value;
    form.appendChild(csrfInput);
  }
  document.body.appendChild(form);
  form.submit();
}
</script>
{% endblock %}
