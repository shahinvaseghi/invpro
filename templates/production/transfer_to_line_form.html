{% extends "shared/generic/generic_form.html" %}
{% load i18n %}
{% load static %}
{% load jalali_tags %}

{% block breadcrumb_extra %}
<span class="separator">/</span>
<span>{% trans "Production" %}</span>
<span class="separator">/</span>
<a href="{% url 'production:transfer_requests' %}">{% trans "Transfer to Line Requests" %}</a>
<span class="separator">/</span>
<span>{{ form_title }}</span>
{% endblock %}

{% block before_form %}
{% if object and object.pk %}
<div class="info-banner" style="display: flex; gap: 1.5rem; margin-bottom: 1.5rem; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; color: #1f2937; font-weight: 600;">
  <div><strong>{% trans "Transfer Code" %}:</strong> {{ object.transfer_code }}</div>
  <div><strong>{% trans "Transfer Date" %}:</strong> {{ object.transfer_date|jalali_date }}</div>
  <div><strong>{% trans "Status" %}:</strong> {{ object.get_status_display }}</div>
  <div class="lock-status">
    <strong>{% trans "Lock Status" %}:</strong>
    {% if object.is_locked == 1 %}
      <span class="badge badge-locked" style="background: #dc2626; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">{% trans "Locked" %}</span>
    {% else %}
      <span class="badge badge-unlocked" style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">{% trans "Editable" %}</span>
    {% endif %}
  </div>
</div>

{% if object.is_locked == 1 %}
<div class="alert alert-info" style="margin-bottom: 1.5rem; padding: 1rem; border-radius: 4px; background: #dbeafe; border: 1px solid #93c5fd; color: #1e40af;">
  {% trans "This transfer request is locked and can no longer be edited." %}
</div>
{% endif %}
{% endif %}
{% endblock %}

{% block form_sections %}
<div class="form-section">
  <h2>{% trans "اطلاعات انتقال" %}</h2>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.order.id_for_label }}">
        {{ form.order.label }}
        {% if form.order.field.required %}*{% endif %}
      </label>
      {{ form.order }}
      {% if form.order.errors %}
        <span class="error">{{ form.order.errors.0 }}</span>
      {% endif %}
      {% if form.order.help_text %}
        <small class="form-text">{{ form.order.help_text }}</small>
      {% endif %}
    </div>

    <div class="form-field">
      <label for="{{ form.transfer_date.id_for_label }}">
        {{ form.transfer_date.label }}
        {% if form.transfer_date.field.required %}*{% endif %}
      </label>
      {{ form.transfer_date }}
      {% if form.transfer_date.errors %}
        <span class="error">{{ form.transfer_date.errors.0 }}</span>
      {% endif %}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.approved_by.id_for_label }}">
        {{ form.approved_by.label }}
        {% if form.approved_by.field.required %}*{% endif %}
      </label>
      {{ form.approved_by }}
      {% if form.approved_by.errors %}
        <span class="error">{{ form.approved_by.errors.0 }}</span>
      {% endif %}
      {% if form.approved_by.help_text %}
        <small class="form-text">{{ form.approved_by.help_text }}</small>
      {% endif %}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field full-width">
      <label for="{{ form.is_scrap_replacement.id_for_label }}">
        {{ form.is_scrap_replacement }}
        {{ form.is_scrap_replacement.label }}
      </label>
      {% if form.is_scrap_replacement.errors %}
        <span class="error">{{ form.is_scrap_replacement.errors.0 }}</span>
      {% endif %}
      {% if form.is_scrap_replacement.help_text %}
        <small class="form-text">{{ form.is_scrap_replacement.help_text }}</small>
      {% endif %}
    </div>
  </div>

  <div class="form-row" id="qc-approver-row" style="display: none;">
    <div class="form-field">
      <label for="{{ form.qc_approved_by.id_for_label }}">
        {{ form.qc_approved_by.label }}
        {% if form.qc_approved_by.field.required %}*{% endif %}
      </label>
      {{ form.qc_approved_by }}
      {% if form.qc_approved_by.errors %}
        <span class="error">{{ form.qc_approved_by.errors.0 }}</span>
      {% endif %}
      {% if form.qc_approved_by.help_text %}
        <small class="form-text">{{ form.qc_approved_by.help_text }}</small>
      {% endif %}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field full-width">
      <label>{{ form.transfer_type.label }}</label>
      <div class="radio-group">
        {% for radio in form.transfer_type %}
          <div class="radio-option">
            {{ radio.tag }}
            <label for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
          </div>
        {% endfor %}
      </div>
      {% if form.transfer_type.errors %}
        <span class="error">{{ form.transfer_type.errors.0 }}</span>
      {% endif %}
      {% if form.transfer_type.help_text %}
        <small class="form-text">{{ form.transfer_type.help_text }}</small>
      {% endif %}
    </div>
  </div>

  <div class="form-row" id="operations-selection-row" style="display: none;">
    <div class="form-field full-width">
      <label>{{ form.selected_operations.label }}</label>
      <div id="operations-container" class="operations-checkbox-container">
        <div id="operations-loading" style="display: none; padding: 1rem; text-align: center; color: #6b7280;">
          {% trans "در حال بارگذاری عملیات‌ها..." %}
        </div>
        <div id="operations-list" class="checkbox-group">
          {% for checkbox in form.selected_operations %}
            <div class="checkbox-option">
              {{ checkbox.tag }}
              <label for="{{ checkbox.id_for_label }}">{{ checkbox.choice_label }}</label>
            </div>
          {% endfor %}
        </div>
        <div id="operations-error" style="display: none; padding: 1rem; color: #dc2626;">
        </div>
      </div>
      {% if form.selected_operations.errors %}
        <span class="error">{{ form.selected_operations.errors.0 }}</span>
      {% endif %}
      {% if form.selected_operations.help_text %}
        <small class="form-text">{{ form.selected_operations.help_text }}</small>
      {% endif %}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field full-width">
      <label for="{{ form.notes.id_for_label }}">
        {{ form.notes.label }}
        {% if form.notes.field.required %}*{% endif %}
      </label>
      {{ form.notes }}
      {% if form.notes.errors %}
        <span class="error">{{ form.notes.errors.0 }}</span>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block form_extra %}
{% if object and object.pk and bom_items %}
<div class="form-section">
  <header class="section-header">
    <h2>{% trans "اقلام فهرست مواد (BOM)" %} <small style="font-size: 0.875rem; color: #6b7280;">({% trans "فقط خواندنی" %})</small></h2>
  </header>
  
  <div class="table-responsive" style="overflow-x: auto; width: 100%; margin-bottom: 1rem;">
  <table class="data-table formset-table">
    <thead>
      <tr>
        <th>{% trans "کالای مورد نیاز" %}</th>
        <th>{% trans "مقدار مورد نیاز" %}</th>
        <th>{% trans "واحد" %}</th>
        <th>{% trans "انبار مبدا" %}</th>
        <th>{% trans "ضریب ضایعات (%)" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for item in bom_items %}
      <tr>
        <td>{{ item.material_item.item_code }} - {{ item.material_item.name }}</td>
        <td>{{ item.quantity_required }}</td>
        <td>{{ item.unit }}</td>
        <td>{{ item.source_warehouse.name|default:"-" }}</td>
        <td>{{ item.material_scrap_allowance }}%</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
</div>
{% endif %}

{% if not object or not object.pk or not is_locked %}
<div class="form-section">
  <header class="section-header">
    <h2>{% trans "اقلام درخواست اضافی" %}</h2>
    <p>{% trans "کالاهای اضافی که در فهرست مواد (BOM) نیستند را اضافه کنید." %}</p>
  </header>
  
  {{ formset.management_form }}
  
  {% if formset.non_form_errors %}
    <div class="alert alert-error">
      {% for error in formset.non_form_errors %}
        <div>{{ error }}</div>
      {% endfor %}
    </div>
  {% endif %}
  
  <div class="table-responsive" style="overflow-x: auto; width: 100%; margin-bottom: 1rem;">
  <table class="data-table formset-table" id="extra-items-table">
    <thead>
      <tr>
        <th>{% trans "نوع ماده" %}</th>
        <th>{% trans "دسته‌بندی" %}</th>
        <th>{% trans "زیردسته‌بندی" %}</th>
        <th>{% trans "کالای مورد نیاز" %}</th>
        <th>{% trans "مقدار مورد نیاز" %}</th>
        <th>{% trans "واحد" %}</th>
        <th>{% trans "انبار مبدا" %}</th>
        <th>{% trans "مرکز کار مقصد" %}</th>
        <th>{% trans "ضریب ضایعات (%)" %}</th>
        <th>{% trans "عملیات" %}</th>
      </tr>
    </thead>
    <tbody id="formset-container">
      {% for item_form in formset %}
      <tr class="formset-row" data-row-index="{{ forloop.counter0 }}">
        {% for hidden in item_form.hidden_fields %}{{ hidden }}{% endfor %}
        <td>
          {{ item_form.material_type }}
          {% if item_form.material_type.errors %}
            <div class="field-error">{{ item_form.material_type.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {{ item_form.material_category_filter }}
          {% if item_form.material_category_filter.errors %}
            <div class="field-error">{{ item_form.material_category_filter.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {{ item_form.material_subcategory_filter }}
          {% if item_form.material_subcategory_filter.errors %}
            <div class="field-error">{{ item_form.material_subcategory_filter.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          <div class="searchable-select-container" style="position: relative;">
            {{ item_form.material_item }}
            {% if item_form.material_item.errors %}
              <div class="field-error">{{ item_form.material_item.errors.0 }}</div>
            {% endif %}
          </div>
        </td>
        <td>
          {{ item_form.quantity_required }}
          {% if item_form.quantity_required.errors %}
            <div class="field-error">{{ item_form.quantity_required.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {{ item_form.unit }}
          {% if item_form.unit.errors %}
            <div class="field-error">{{ item_form.unit.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {{ item_form.source_warehouse }}
          {% if item_form.source_warehouse.errors %}
            <div class="field-error">{{ item_form.source_warehouse.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {{ item_form.destination_work_center }}
          {% if item_form.destination_work_center.errors %}
            <div class="field-error">{{ item_form.destination_work_center.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {{ item_form.material_scrap_allowance }}
          {% if item_form.material_scrap_allowance.errors %}
            <div class="field-error">{{ item_form.material_scrap_allowance.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {% if formset.can_delete %}
            {{ item_form.DELETE }}
            {% if item_form.DELETE %}
              <label for="{{ item_form.DELETE.id_for_label }}" style="margin-left: 5px; cursor: pointer; font-size: 0.875rem;">
                {% trans "حذف" %}
              </label>
            {% endif %}
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
  
  <button type="button" id="add-extra-item-btn" class="btn btn-secondary">+ {% trans "افزودن کالای اضافی" %}</button>
</div>
{% endif %}
{% endblock %}

{% block form_actions_extra %}
{% endblock %}

{% block extra_styles %}
<style>
.table-responsive {
  overflow-x: auto;
  width: 100%;
  margin-bottom: 1rem;
}

#extra-items-table {
  min-width: 1200px;
  width: 100%;
}

#extra-items-table th,
#extra-items-table td {
  white-space: nowrap;
  min-width: 120px;
  padding: 8px 12px;
}

#extra-items-table th:nth-child(1),
#extra-items-table td:nth-child(1) {
  min-width: 150px;
}

#extra-items-table th:nth-child(2),
#extra-items-table td:nth-child(2) {
  min-width: 150px;
}

#extra-items-table th:nth-child(3),
#extra-items-table td:nth-child(3) {
  min-width: 150px;
}

#extra-items-table th:nth-child(4),
#extra-items-table td:nth-child(4) {
  min-width: 200px;
}

#extra-items-table th:nth-child(5),
#extra-items-table td:nth-child(5) {
  min-width: 120px;
}

#extra-items-table th:nth-child(6),
#extra-items-table td:nth-child(6) {
  min-width: 100px;
}

#extra-items-table th:nth-child(7),
#extra-items-table td:nth-child(7) {
  min-width: 150px;
}

#extra-items-table th:nth-child(8),
#extra-items-table td:nth-child(8) {
  min-width: 180px;
}

#extra-items-table th:nth-child(9),
#extra-items-table td:nth-child(9) {
  min-width: 120px;
}

#extra-items-table th:nth-child(10),
#extra-items-table td:nth-child(10) {
  min-width: 80px;
}

.formset-table {
  border-collapse: collapse;
}

.formset-table thead {
  background: #f3f4f6;
}

.formset-table th {
  font-weight: 600;
  text-align: left;
  border-bottom: 2px solid #e5e7eb;
}

.formset-table td {
  border-bottom: 1px solid #e5e7eb;
}

.formset-table tbody tr:hover {
  background: #f9fafb;
}

.field-error {
  color: #dc2626;
  font-size: 0.875rem;
  margin-top: 0.25rem;
  display: block;
}

.radio-group {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-top: 0.5rem;
}

.radio-option {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.radio-option input[type="radio"] {
  margin: 0;
  cursor: pointer;
}

.radio-option label {
  margin: 0;
  cursor: pointer;
  font-weight: normal;
}

.checkbox-group {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-top: 0.5rem;
  max-height: 300px;
  overflow-y: auto;
  padding: 0.75rem;
  border: 1px solid #e5e7eb;
  border-radius: 4px;
  background: #f9fafb;
}

.checkbox-option {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem;
  border-radius: 4px;
  transition: background-color 0.2s;
}

.checkbox-option:hover {
  background-color: #f3f4f6;
}

.checkbox-option input[type="checkbox"] {
  margin: 0;
  cursor: pointer;
}

.checkbox-option label {
  margin: 0;
  cursor: pointer;
  font-weight: normal;
  flex: 1;
}

.operations-checkbox-container {
  margin-top: 0.5rem;
}

#operations-selection-row {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #e5e7eb;
}
</style>
{% endblock %}

{% block form_scripts %}
<link rel="stylesheet" href="{% static 'css/jalali-datepicker/jalali-datepicker.min.css' %}">
<script src="{% static 'js/jalali-datepicker/jalali-datepicker.min.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Hide submit button if transfer is locked
  {% if object and object.pk and object.is_locked == 1 %}
  var submitButton = document.querySelector('button[type="submit"]');
  if (submitButton) {
    submitButton.style.display = 'none';
  }
  {% endif %}
  
  // Initialize Jalali DatePicker
  var jalaliInputs = document.querySelectorAll('input.jalali-date-input, input[data-jalali="true"]');
  
  jalaliInputs.forEach(function(input) {
    input.setAttribute('data-jdp', '');
    input.setAttribute('data-jdp-only-date', '');
  });
  
  if (typeof jalaliDatepicker !== 'undefined') {
    jalaliDatepicker.startWatch({
      date: true,
      time: false,
      separatorChars: {
        date: '/',
        between: ' ',
        time: ':'
      },
      persianDigits: false,
      autoShow: true,
      autoHide: true,
      hideAfterChange: true,
      showTodayBtn: true,
      showEmptyBtn: true,
      showCloseBtn: true,
      useDropDownYears: true,
      zIndex: 1000
    });
  } else {
    console.error('Jalali DatePicker library not loaded!');
  }
  
  // Formset management for extra items
  var formsetContainer = document.getElementById('formset-container');
  var addBtn = document.getElementById('add-extra-item-btn');
  var totalFormsInput = document.querySelector('#id_items-TOTAL_FORMS');
  var formCount = formsetContainer ? formsetContainer.children.length : 0;
  
  if (addBtn && formsetContainer && totalFormsInput) {
    addBtn.addEventListener('click', function() {
      var newForm = formsetContainer.lastElementChild.cloneNode(true);
      var formIndex = formCount;
      formCount++;
      
      newForm.setAttribute('data-row-index', formIndex);
      
      newForm.querySelectorAll('input, select, textarea').forEach(function(field) {
        if (field.name) {
          field.name = field.name.replace(/items-\d+-/, 'items-' + formIndex + '-');
        }
        if (field.id) {
          field.id = field.id.replace(/id_items-\d+-/, 'id_items-' + formIndex + '-');
        }
        if (field.type !== 'hidden' && field.type !== 'checkbox') {
          field.value = '';
        }
        if (field.type === 'checkbox') {
          field.checked = false;
        }
      });
      
      newForm.querySelectorAll('label').forEach(function(label) {
        if (label.getAttribute('for')) {
          label.setAttribute('for', label.getAttribute('for').replace(/id_items-\d+-/, 'id_items-' + formIndex + '-'));
        }
      });
      
      var deleteCheckbox = newForm.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (deleteCheckbox) {
        deleteCheckbox.checked = false;
      }
      
      newForm.querySelectorAll('.field-error').forEach(function(error) {
        error.textContent = '';
      });
      
      formsetContainer.appendChild(newForm);
      totalFormsInput.value = formCount;
      
      setTimeout(function() {
        setupRowCascading(newForm);
      }, 100);
    });
  }
  
  // Handle DELETE checkboxes
  if (formsetContainer) {
    formsetContainer.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox' && e.target.name && e.target.name.includes('-DELETE')) {
        var row = e.target.closest('.formset-row');
        if (row && e.target.checked) {
          row.style.display = 'none';
        } else if (row && !e.target.checked) {
          row.style.display = '';
        }
      }
    });
  }
  
  // Cascading Filters for Extra Items (Type → Category → Subcategory → Item)
  function setupRowCascading(row) {
    var rowIndex = row.dataset.rowIndex;
    if (!rowIndex) {
      var firstField = row.querySelector('[name]');
      if (firstField && firstField.name) {
        var nameMatch = firstField.name.match(/items-(\d+)-/);
        if (nameMatch) {
          rowIndex = nameMatch[1];
          row.setAttribute('data-row-index', rowIndex);
        } else {
          return;
        }
      } else {
        return;
      }
    }
    
    var typeSelect = row.querySelector('select[name="items-' + rowIndex + '-material_type"]');
    var categorySelect = row.querySelector('select[name="items-' + rowIndex + '-material_category_filter"]');
    var subcategorySelect = row.querySelector('select[name="items-' + rowIndex + '-material_subcategory_filter"]');
    var itemSelect = row.querySelector('select[name="items-' + rowIndex + '-material_item"]');
    var unitSelect = row.querySelector('select[name="items-' + rowIndex + '-unit"]');
    
    if (!typeSelect || !categorySelect || !subcategorySelect || !itemSelect) {
      return;
    }
    
    function filterCategories() {
      var selectedType = typeSelect.value;
      var currentCategory = categorySelect.value;
      
      if (!selectedType) {
        categorySelect.innerHTML = '<option value="">--------</option>';
        subcategorySelect.innerHTML = '<option value="">--------</option>';
        itemSelect.innerHTML = '<option value="">--------</option>';
        if (unitSelect) {
          unitSelect.innerHTML = '<option value="">--------</option>';
          unitSelect.disabled = true;
        }
        return;
      }
      
          categorySelect.innerHTML = '<option value="">{% trans "در حال بارگذاری دسته‌بندی‌ها..." %}</option>';
      categorySelect.disabled = true;
      
      fetch('/inventory/api/filtered-categories/?type_id=' + selectedType)
        .then(response => response.json())
        .then(data => {
          categorySelect.innerHTML = '<option value="">--------</option>';
          
          if (data.categories && data.categories.length > 0) {
            data.categories.forEach(function(cat) {
              var option = document.createElement('option');
              option.value = cat.value;
              option.textContent = cat.label;
              categorySelect.appendChild(option);
            });
            
            if (currentCategory && data.categories.some(function(c) { return c.value === currentCategory; })) {
              categorySelect.value = currentCategory;
            } else {
              subcategorySelect.value = '';
              itemSelect.innerHTML = '<option value="">--------</option>';
            }
          }
          
          categorySelect.disabled = false;
          filterSubcategories();
        })
        .catch(error => {
          console.error('Error loading categories:', error);
          categorySelect.innerHTML = '<option value="">--------</option>';
          categorySelect.disabled = false;
        });
    }
    
    function filterSubcategories() {
      var selectedType = typeSelect.value;
      var selectedCategory = categorySelect.value;
      var currentSubcategory = subcategorySelect.value;
      
      if (!selectedType || !selectedCategory) {
        subcategorySelect.innerHTML = '<option value="">--------</option>';
        itemSelect.innerHTML = '<option value="">--------</option>';
        if (unitSelect) {
          unitSelect.innerHTML = '<option value="">--------</option>';
          unitSelect.disabled = true;
        }
        return;
      }
      
      subcategorySelect.innerHTML = '<option value="">{% trans "در حال بارگذاری زیردسته‌بندی‌ها..." %}</option>';
      subcategorySelect.disabled = true;
      
      fetch('/inventory/api/filtered-subcategories/?type_id=' + selectedType + '&category_id=' + selectedCategory)
        .then(response => response.json())
        .then(data => {
          subcategorySelect.innerHTML = '<option value="">--------</option>';
          
          if (data.subcategories && data.subcategories.length > 0) {
            data.subcategories.forEach(function(subcat) {
              var option = document.createElement('option');
              option.value = subcat.value;
              option.textContent = subcat.label;
              subcategorySelect.appendChild(option);
            });
            
            if (currentSubcategory && data.subcategories.some(function(s) { return s.value === currentSubcategory; })) {
              subcategorySelect.value = currentSubcategory;
            } else {
              itemSelect.innerHTML = '<option value="">--------</option>';
            }
          }
          
          subcategorySelect.disabled = false;
          filterItems();
        })
        .catch(error => {
          console.error('Error loading subcategories:', error);
          subcategorySelect.innerHTML = '<option value="">--------</option>';
          subcategorySelect.disabled = false;
        });
    }
    
    function filterItems() {
      var selectedType = typeSelect.value;
      var selectedCategory = categorySelect.value;
      var selectedSubcategory = subcategorySelect.value;
      var currentItem = itemSelect.value;
      
      if (!selectedType || !selectedCategory || !selectedSubcategory) {
        itemSelect.innerHTML = '<option value="">--------</option>';
        if (unitSelect) {
          unitSelect.innerHTML = '<option value="">--------</option>';
          unitSelect.disabled = true;
        }
        return;
      }
      
      itemSelect.innerHTML = '<option value="">{% trans "در حال بارگذاری کالاها..." %}</option>';
      itemSelect.disabled = true;
      
      fetch('/inventory/api/filtered-items/?type_id=' + selectedType + '&category_id=' + selectedCategory + '&subcategory_id=' + selectedSubcategory)
        .then(response => response.json())
        .then(data => {
          itemSelect.innerHTML = '<option value="">--------</option>';
          
          if (data.items && data.items.length > 0) {
            data.items.forEach(function(item) {
              var option = document.createElement('option');
              option.value = item.value;
              option.textContent = item.label;
              itemSelect.appendChild(option);
            });
            
            if (currentItem && data.items.some(function(i) { return i.value === currentItem; })) {
              itemSelect.value = currentItem;
              loadItemUnits(itemSelect, rowIndex);
              loadItemAllowedWarehouses(itemSelect, rowIndex);
            }
            
            // Make select searchable with visible search bar after loading items
            setTimeout(function() {
              makeSelectSearchableWithInput(itemSelect, rowIndex);
            }, 100);
          }
          
          itemSelect.disabled = false;
        })
        .catch(error => {
          console.error('Error loading items:', error);
          itemSelect.innerHTML = '<option value="">--------</option>';
          itemSelect.disabled = false;
        });
    }
    
    function loadItemUnits(materialItemSelect, idx) {
      var itemId = materialItemSelect.value;
      var unitSel = document.querySelector('select[name="items-' + idx + '-unit"]');
      
      if (!itemId || !unitSel) {
        if (unitSel) {
          unitSel.innerHTML = '<option value="">--------</option>';
          unitSel.disabled = true;
        }
        return;
      }
      
      unitSel.disabled = true;
      unitSel.innerHTML = '<option value="">{% trans "در حال بارگذاری..." %}</option>';
      
      fetch('/inventory/api/item-units/?item_id=' + itemId)
        .then(response => response.json())
        .then(data => {
          if (data.units && data.units.length > 0) {
            unitSel.innerHTML = '<option value="">--------</option>';
            data.units.forEach(function(unit) {
              var option = document.createElement('option');
              option.value = unit.value;
              option.textContent = unit.label;
              unitSel.appendChild(option);
            });
            unitSel.disabled = false;
          } else {
            unitSel.innerHTML = '<option value="">--------</option>';
            unitSel.disabled = true;
          }
        })
        .catch(error => {
          console.error('Error loading units:', error);
          unitSel.innerHTML = '<option value="">--------</option>';
          unitSel.disabled = true;
        });
    }
    
    function loadItemAllowedWarehouses(materialItemSelect, idx) {
      var itemId = materialItemSelect.value;
      var warehouseSel = document.querySelector('select[name="items-' + idx + '-source_warehouse"]');
      
      if (!itemId || !warehouseSel) {
        if (warehouseSel) {
          warehouseSel.innerHTML = '<option value="">--------</option>';
          warehouseSel.disabled = true;
        }
        return;
      }
      
      warehouseSel.disabled = true;
      warehouseSel.innerHTML = '<option value="">{% trans "در حال بارگذاری..." %}</option>';
      
      fetch('/inventory/api/item-allowed-warehouses/?item_id=' + itemId)
        .then(response => response.json())
        .then(data => {
          warehouseSel.innerHTML = '<option value="">--------</option>';
          
          if (data.warehouses && data.warehouses.length > 0) {
            data.warehouses.forEach(function(warehouse) {
              var option = document.createElement('option');
              option.value = warehouse.value;
              option.textContent = warehouse.label;
              warehouseSel.appendChild(option);
            });
            warehouseSel.disabled = false;
          } else {
            // No allowed warehouses configured for this item
            warehouseSel.disabled = true;
            warehouseSel.innerHTML = '<option value="">{% trans "هیچ انبار مجازی برای این کالا تعریف نشده است" %}</option>';
          }
        })
        .catch(error => {
          console.error('Error loading allowed warehouses:', error);
          warehouseSel.innerHTML = '<option value="">--------</option>';
          warehouseSel.disabled = true;
        });
    }
    
    typeSelect.addEventListener('change', filterCategories);
    categorySelect.addEventListener('change', filterSubcategories);
    subcategorySelect.addEventListener('change', filterItems);
    itemSelect.addEventListener('change', function() {
      loadItemUnits(itemSelect, rowIndex);
      loadItemAllowedWarehouses(itemSelect, rowIndex);
    });
    
    // Make material_item dropdown searchable with visible search bar
    makeSelectSearchableWithInput(itemSelect, rowIndex);
    
    // Initialize if values exist (edit mode)
    if (typeSelect.value) {
      filterCategories();
      setTimeout(function() {
        if (categorySelect.value) {
          filterSubcategories();
          setTimeout(function() {
            if (subcategorySelect.value) {
              filterItems();
              setTimeout(function() {
                if (itemSelect.value) {
                  loadItemUnits(itemSelect, rowIndex);
                }
              }, 300);
            }
          }, 300);
        }
      }, 300);
    }
  }
  
  // Function to make select dropdowns searchable with visible search input
  function makeSelectSearchableWithInput(selectElement, rowIndex) {
    if (!selectElement || selectElement.tagName !== 'SELECT') {
      return;
    }
    
    // Only apply if select has many options
    if (selectElement.options.length < 3) {
      return;
    }
    
    // Create search input wrapper
    var wrapper = selectElement.closest('.searchable-select-container') || selectElement.parentNode;
    if (!wrapper.classList || !wrapper.classList.contains('searchable-select-container')) {
      var newWrapper = document.createElement('div');
      newWrapper.className = 'searchable-select-container';
      newWrapper.style.position = 'relative';
      selectElement.parentNode.insertBefore(newWrapper, selectElement);
      newWrapper.appendChild(selectElement);
      wrapper = newWrapper;
    }
    
    // Create search input if not exists
    var searchInputId = 'item-search-' + rowIndex;
    var existingSearch = wrapper.querySelector('#' + searchInputId);
    if (existingSearch) {
      return; // Already initialized
    }
    
    var searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.id = searchInputId;
    searchInput.className = 'item-search-input';
    searchInput.placeholder = '{% trans "جستجوی کالا (کد یا نام)..." %}';
    searchInput.style.cssText = 'width: 100%; padding: 6px 8px; margin-bottom: 4px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem; box-sizing: border-box;';
    
    wrapper.insertBefore(searchInput, selectElement);
    
    // Store original options
    var allOptions = [];
    Array.from(selectElement.options).forEach(function(opt) {
      allOptions.push({
        value: opt.value,
        text: opt.textContent
      });
    });
    
    // Filter function
    function filterOptions(searchText) {
      if (!searchText || searchText.trim() === '') {
        // Restore all options
        selectElement.innerHTML = '';
        allOptions.forEach(function(opt) {
          var option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.text;
          selectElement.appendChild(option);
        });
        return;
      }
      
      searchText = searchText.toLowerCase();
      selectElement.innerHTML = '';
      
      var matches = allOptions.filter(function(opt) {
        if (opt.value === '') return true; // Keep empty option
        return opt.text.toLowerCase().includes(searchText);
      });
      
      matches.forEach(function(opt) {
        var option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.text;
        selectElement.appendChild(option);
      });
    }
    
    // Filter on input
    searchInput.addEventListener('input', function() {
      filterOptions(this.value);
    });
    
    // Update allOptions when options change (for dynamic dropdowns)
    var observer = new MutationObserver(function() {
      allOptions = [];
      Array.from(selectElement.options).forEach(function(opt) {
        allOptions.push({
          value: opt.value,
          text: opt.textContent
        });
      });
    });
    observer.observe(selectElement, { childList: true });
  }
  
  // Function to make select dropdowns searchable (keyboard only)
  function makeSelectSearchable(selectElement) {
    if (!selectElement || selectElement.tagName !== 'SELECT') {
      return;
    }
    
    // Store all original options for filtering
    var allOptions = [];
    Array.from(selectElement.options).forEach(function(opt) {
      allOptions.push({
        value: opt.value,
        text: opt.textContent
      });
    });
    
    // Add keyboard search functionality
    var searchString = '';
    var searchTimeout = null;
    
    selectElement.addEventListener('keydown', function(e) {
      // Clear timeout
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      // Allow normal navigation keys
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'Enter' || e.key === 'Escape') {
        if (e.key === 'Escape') {
          searchString = '';
        }
        return;
      }
      
      // Build search string from typed characters
      if (e.key.length === 1) {
        e.preventDefault();
        searchString += e.key.toLowerCase();
        
        // Filter options
        filterOptionsBySearch(selectElement, allOptions, searchString);
        
        // Clear search string after 1 second of no typing
        searchTimeout = setTimeout(function() {
          searchString = '';
        }, 1000);
      } else if (e.key === 'Backspace') {
        e.preventDefault();
        searchString = searchString.slice(0, -1);
        filterOptionsBySearch(selectElement, allOptions, searchString);
      }
    });
    
    // Filter function
    function filterOptionsBySearch(select, options, search) {
      if (!search) {
        // Restore all options
        select.innerHTML = '';
        options.forEach(function(opt) {
          var option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.text;
          select.appendChild(option);
        });
        return;
      }
      
      // Filter and show matching options
      select.innerHTML = '';
      var matches = options.filter(function(opt) {
        return opt.value === '' || opt.text.toLowerCase().includes(search);
      });
      
      matches.forEach(function(opt) {
        var option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.text;
        select.appendChild(option);
      });
      
      // Auto-select first match if any
      if (matches.length > 1) {
        select.selectedIndex = 0;
      }
    }
    
    // Update allOptions when options change (for dynamic dropdowns)
    var observer = new MutationObserver(function() {
      allOptions = [];
      Array.from(selectElement.options).forEach(function(opt) {
        allOptions.push({
          value: opt.value,
          text: opt.textContent
        });
      });
    });
    observer.observe(selectElement, { childList: true });
  }
  
  // Initialize cascading filters for all existing rows
  if (formsetContainer) {
    formsetContainer.querySelectorAll('.formset-row').forEach(function(row) {
      setupRowCascading(row);
      // Make material_item dropdown searchable for existing rows
      var existingItemSelect = row.querySelector('select[name*="-material_item"]');
      if (existingItemSelect) {
        var nameMatch = existingItemSelect.name.match(/items-(\d+)-/);
        if (nameMatch) {
          var rowIdx = nameMatch[1];
          setTimeout(function() {
            makeSelectSearchableWithInput(existingItemSelect, rowIdx);
          }, 200);
        }
      }
    });
  }
  
  // Transfer Type and Operations Selection
  var orderSelect = document.getElementById('id_order');
  var transferTypeRadios = document.querySelectorAll('input[name="transfer_type"]');
  var operationsSelectionRow = document.getElementById('operations-selection-row');
  var operationsContainer = document.getElementById('operations-container');
  var operationsList = document.getElementById('operations-list');
  var operationsLoading = document.getElementById('operations-loading');
  var operationsError = document.getElementById('operations-error');
  var scrapReplacementCheckbox = document.getElementById('id_is_scrap_replacement');
  
  function updateOperationsVisibility() {
    var selectedTransferType = document.querySelector('input[name="transfer_type"]:checked');
    if (selectedTransferType && selectedTransferType.value === 'operations') {
      operationsSelectionRow.style.display = 'block';
      if (orderSelect && orderSelect.value) {
        loadOperations();
      }
    } else {
      operationsSelectionRow.style.display = 'none';
    }
  }
  
  function loadOperations() {
    var orderId = orderSelect.value;
    if (!orderId) {
      operationsList.innerHTML = '';
      return;
    }
    
    // scrap_replacement_mode: if checkbox is checked, show only transferred operations
    // if checkbox is unchecked, show only non-transferred operations
    var scrapReplacementMode = scrapReplacementCheckbox ? scrapReplacementCheckbox.checked : false;
    var url = '{% url "production:api_order_operations" 0 %}'.replace('0', orderId);
    if (scrapReplacementMode) {
      url += '?scrap_replacement_mode=true';
    }
    
    operationsLoading.style.display = 'block';
    operationsList.innerHTML = '';
    operationsError.style.display = 'none';
    
    fetch(url)
      .then(response => response.json())
      .then(data => {
        operationsLoading.style.display = 'none';
        
        if (data.error) {
          operationsError.textContent = data.error;
          operationsError.style.display = 'block';
          return;
        }
        
        if (!data.has_process) {
          operationsError.textContent = data.message || '{% trans "This order does not have an associated process." %}';
          operationsError.style.display = 'block';
          return;
        }
        
        if (data.is_full_transferred && !scrapReplacementMode) {
          operationsError.innerHTML = '{% trans "All materials for this order have already been transferred. If this is for scrap replacement, please check the Scrap Replacement checkbox." %}';
          operationsError.style.display = 'block';
        }
        
        if (data.operations && data.operations.length > 0) {
          operationsList.innerHTML = '';
          data.operations.forEach(function(operation) {
            var checkboxDiv = document.createElement('div');
            checkboxDiv.className = 'checkbox-option';
            
            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'selected_operations';
            checkbox.value = operation.id;
            checkbox.id = 'id_selected_operations_' + operation.id;
            checkbox.className = 'form-check-input';
            
            var label = document.createElement('label');
            label.setAttribute('for', checkbox.id);
            label.textContent = operation.sequence_order + '. ' + operation.name + 
                               (operation.description ? ' - ' + operation.description : '');
            
            checkboxDiv.appendChild(checkbox);
            checkboxDiv.appendChild(label);
            operationsList.appendChild(checkboxDiv);
          });
        } else {
          if (scrapReplacementMode) {
            operationsList.innerHTML = '<div style="padding: 1rem; color: #6b7280;">{% trans "هیچ عملیات انتقال داده شده‌ای یافت نشد." %}</div>';
          } else {
            operationsList.innerHTML = '<div style="padding: 1rem; color: #6b7280;">{% trans "هیچ عملیاتی یافت نشد." %}</div>';
          }
        }
      })
      .catch(error => {
        operationsLoading.style.display = 'none';
          operationsError.textContent = '{% trans "خطا در بارگذاری عملیات‌ها: " %}' + error.message;
        operationsError.style.display = 'block';
        console.error('Error loading operations:', error);
      });
  }
  
  // Handle transfer type change
  transferTypeRadios.forEach(function(radio) {
    radio.addEventListener('change', updateOperationsVisibility);
  });
  
  // Function to check if order has previous transfers and update scrap replacement checkbox
  function updateScrapReplacementAvailability() {
    var orderId = orderSelect ? orderSelect.value : null;
    if (!orderId || !scrapReplacementCheckbox) {
      return;
    }
    
    var url = '{% url "production:api_order_operations" 0 %}'.replace('0', orderId);
    
    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.has_previous_transfers) {
          // Order has previous transfers - enable scrap replacement checkbox
          scrapReplacementCheckbox.disabled = false;
          scrapReplacementCheckbox.title = '';
          // Remove any warning styling
          var checkboxLabel = scrapReplacementCheckbox.closest('label');
          if (checkboxLabel) {
            checkboxLabel.style.opacity = '1';
            checkboxLabel.style.cursor = 'pointer';
          }
        } else {
          // Order has no previous transfers - disable scrap replacement checkbox
          scrapReplacementCheckbox.disabled = true;
          scrapReplacementCheckbox.checked = false;
          scrapReplacementCheckbox.title = '{% trans "این گزینه فقط برای سفارش‌هایی که قبلاً انتقال به پای کار داشته‌اند فعال است" %}';
          // Add visual indication
          var checkboxLabel = scrapReplacementCheckbox.closest('label');
          if (checkboxLabel) {
            checkboxLabel.style.opacity = '0.6';
            checkboxLabel.style.cursor = 'not-allowed';
          }
          // Hide QC approver row if visible
          if (qcApproverRow) {
            qcApproverRow.style.display = 'none';
          }
          if (qcApproverField) {
            qcApproverField.required = false;
            qcApproverField.value = '';
          }
        }
      })
      .catch(error => {
        console.error('Error checking order transfers:', error);
        // On error, enable checkbox to avoid blocking user
        if (scrapReplacementCheckbox) {
          scrapReplacementCheckbox.disabled = false;
        }
        // Remove hidden input on error
        if (hiddenInput) {
          hiddenInput.remove();
        }
      });
  }
  
  // Handle order change
  if (orderSelect) {
    orderSelect.addEventListener('change', function() {
      // Check scrap replacement availability
      updateScrapReplacementAvailability();
      
      // Load operations if needed
      if (document.querySelector('input[name="transfer_type"]:checked')?.value === 'operations') {
        loadOperations();
      }
    });
  }
  
  // Handle scrap replacement checkbox change
  if (scrapReplacementCheckbox) {
    scrapReplacementCheckbox.addEventListener('change', function() {
      if (document.querySelector('input[name="transfer_type"]:checked')?.value === 'operations' && orderSelect && orderSelect.value) {
        loadOperations();
      }
    });
  }
  
  // Initialize visibility on page load
  updateOperationsVisibility();
  
  // QC Approver field visibility (only shown when scrap replacement is checked)
  // Note: scrapReplacementCheckbox is already defined above
  var qcApproverRow = document.getElementById('qc-approver-row');
  var qcApproverField = document.getElementById('id_qc_approved_by');
  
  // Check scrap replacement availability on page load
  if (orderSelect && orderSelect.value) {
    updateScrapReplacementAvailability();
  }
  
  function updateQCApproverVisibility() {
    if (scrapReplacementCheckbox && qcApproverRow) {
      if (scrapReplacementCheckbox.checked) {
        qcApproverRow.style.display = 'block';
        if (qcApproverField) {
          qcApproverField.required = true;
        }
      } else {
        qcApproverRow.style.display = 'none';
        if (qcApproverField) {
          qcApproverField.required = false;
          qcApproverField.value = '';
        }
      }
    }
  }
  
  // Handle scrap replacement checkbox change
  if (scrapReplacementCheckbox) {
    scrapReplacementCheckbox.addEventListener('change', updateQCApproverVisibility);
    // Initialize on page load
    updateQCApproverVisibility();
  }
});
</script>
{% endblock %}
