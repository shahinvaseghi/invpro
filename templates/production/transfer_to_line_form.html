{% extends "shared/generic/generic_form.html" %}
{% load i18n %}
{% load static %}
{% load jalali_tags %}

{% block breadcrumb_extra %}
<span class="separator">/</span>
<span>{% trans "Production" %}</span>
<span class="separator">/</span>
<a href="{% url 'production:transfer_requests' %}">{% trans "Transfer to Line Requests" %}</a>
<span class="separator">/</span>
<span>{{ form_title }}</span>
{% endblock %}

{% block before_form %}
{% if object and object.pk %}
<div class="info-banner" style="display: flex; gap: 1.5rem; margin-bottom: 1.5rem; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; color: #1f2937; font-weight: 600;">
  <div><strong>{% trans "Transfer Code" %}:</strong> {{ object.transfer_code }}</div>
  <div><strong>{% trans "Transfer Date" %}:</strong> {{ object.transfer_date|jalali_date }}</div>
  <div><strong>{% trans "Status" %}:</strong> {{ object.get_status_display }}</div>
  <div class="lock-status">
    <strong>{% trans "Lock Status" %}:</strong>
    {% if object.is_locked == 1 %}
      <span class="badge badge-locked" style="background: #dc2626; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">{% trans "Locked" %}</span>
    {% else %}
      <span class="badge badge-unlocked" style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">{% trans "Editable" %}</span>
    {% endif %}
  </div>
</div>

{% if object.is_locked == 1 %}
<div class="alert alert-info" style="margin-bottom: 1.5rem; padding: 1rem; border-radius: 4px; background: #dbeafe; border: 1px solid #93c5fd; color: #1e40af;">
  {% trans "This transfer request is locked and can no longer be edited." %}
</div>
{% endif %}
{% endif %}
{% endblock %}

{% block form_sections %}
<div class="form-section">
  <h2>{% trans "Transfer Information" %}</h2>
  
  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.order.id_for_label }}">
        {{ form.order.label }}
        {% if form.order.field.required %}*{% endif %}
      </label>
      {{ form.order }}
      {% if form.order.errors %}
        <span class="error">{{ form.order.errors.0 }}</span>
      {% endif %}
      {% if form.order.help_text %}
        <small class="form-text">{{ form.order.help_text }}</small>
      {% endif %}
    </div>

    <div class="form-field">
      <label for="{{ form.transfer_date.id_for_label }}">
        {{ form.transfer_date.label }}
        {% if form.transfer_date.field.required %}*{% endif %}
      </label>
      {{ form.transfer_date }}
      {% if form.transfer_date.errors %}
        <span class="error">{{ form.transfer_date.errors.0 }}</span>
      {% endif %}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field">
      <label for="{{ form.approved_by.id_for_label }}">
        {{ form.approved_by.label }}
        {% if form.approved_by.field.required %}*{% endif %}
      </label>
      {{ form.approved_by }}
      {% if form.approved_by.errors %}
        <span class="error">{{ form.approved_by.errors.0 }}</span>
      {% endif %}
      {% if form.approved_by.help_text %}
        <small class="form-text">{{ form.approved_by.help_text }}</small>
      {% endif %}
    </div>
  </div>

  <div class="form-row">
    <div class="form-field full-width">
      <label for="{{ form.notes.id_for_label }}">
        {{ form.notes.label }}
        {% if form.notes.field.required %}*{% endif %}
      </label>
      {{ form.notes }}
      {% if form.notes.errors %}
        <span class="error">{{ form.notes.errors.0 }}</span>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block form_extra %}
{% if object and object.pk and bom_items %}
<div class="form-section">
  <header class="section-header">
    <h2>{% trans "BOM Items" %} <small style="font-size: 0.875rem; color: #6b7280;">({% trans "Read-only" %})</small></h2>
  </header>
  
  <div class="table-responsive" style="overflow-x: auto; width: 100%; margin-bottom: 1rem;">
  <table class="data-table formset-table">
    <thead>
      <tr>
        <th>{% trans "Material Item" %}</th>
        <th>{% trans "Quantity Required" %}</th>
        <th>{% trans "Unit" %}</th>
        <th>{% trans "Source Warehouse" %}</th>
        <th>{% trans "Scrap Allowance (%)" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for item in bom_items %}
      <tr>
        <td>{{ item.material_item.item_code }} - {{ item.material_item.name }}</td>
        <td>{{ item.quantity_required }}</td>
        <td>{{ item.unit }}</td>
        <td>{{ item.source_warehouse.name|default:"-" }}</td>
        <td>{{ item.material_scrap_allowance }}%</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
</div>
{% endif %}

{% if not object or not object.pk or not is_locked %}
<div class="form-section">
  <header class="section-header">
    <h2>{% trans "Extra Request Items" %}</h2>
    <p>{% trans "Add additional items that are not in the BOM." %}</p>
  </header>
  
  {{ formset.management_form }}
  
  {% if formset.non_form_errors %}
    <div class="alert alert-error">
      {% for error in formset.non_form_errors %}
        <div>{{ error }}</div>
      {% endfor %}
    </div>
  {% endif %}
  
  <div class="table-responsive" style="overflow-x: auto; width: 100%; margin-bottom: 1rem;">
  <table class="data-table formset-table" id="extra-items-table">
    <thead>
      <tr>
        <th>{% trans "Material Type" %}</th>
        <th>{% trans "Category" %}</th>
        <th>{% trans "Subcategory" %}</th>
        <th>{% trans "Material Item" %}</th>
        <th>{% trans "Quantity Required" %}</th>
        <th>{% trans "Unit" %}</th>
        <th>{% trans "Source Warehouse" %}</th>
        <th>{% trans "Destination Work Center" %}</th>
        <th>{% trans "Scrap Allowance (%)" %}</th>
        <th>{% trans "Actions" %}</th>
      </tr>
    </thead>
    <tbody id="formset-container">
      {% for item_form in formset %}
      <tr class="formset-row" data-row-index="{{ forloop.counter0 }}">
        {% for hidden in item_form.hidden_fields %}{{ hidden }}{% endfor %}
        <td>
          {{ item_form.material_type }}
          {% if item_form.material_type.errors %}
            <div class="field-error">{{ item_form.material_type.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {{ item_form.material_category_filter }}
          {% if item_form.material_category_filter.errors %}
            <div class="field-error">{{ item_form.material_category_filter.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {{ item_form.material_subcategory_filter }}
          {% if item_form.material_subcategory_filter.errors %}
            <div class="field-error">{{ item_form.material_subcategory_filter.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {{ item_form.material_item }}
          {% if item_form.material_item.errors %}
            <div class="field-error">{{ item_form.material_item.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {{ item_form.quantity_required }}
          {% if item_form.quantity_required.errors %}
            <div class="field-error">{{ item_form.quantity_required.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {{ item_form.unit }}
          {% if item_form.unit.errors %}
            <div class="field-error">{{ item_form.unit.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {{ item_form.source_warehouse }}
          {% if item_form.source_warehouse.errors %}
            <div class="field-error">{{ item_form.source_warehouse.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {{ item_form.destination_work_center }}
          {% if item_form.destination_work_center.errors %}
            <div class="field-error">{{ item_form.destination_work_center.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {{ item_form.material_scrap_allowance }}
          {% if item_form.material_scrap_allowance.errors %}
            <div class="field-error">{{ item_form.material_scrap_allowance.errors.0 }}</div>
          {% endif %}
        </td>
        <td>
          {% if formset.can_delete %}
            {{ item_form.DELETE }}
            {% if item_form.DELETE %}
              <label for="{{ item_form.DELETE.id_for_label }}" style="margin-left: 5px; cursor: pointer; font-size: 0.875rem;">
                {% trans "Delete" %}
              </label>
            {% endif %}
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
  
  <button type="button" id="add-extra-item-btn" class="btn btn-secondary">+ {% trans "Add Extra Item" %}</button>
</div>
{% endif %}
{% endblock %}

{% block form_actions_extra %}
{% endblock %}

{% block extra_styles %}
<style>
.table-responsive {
  overflow-x: auto;
  width: 100%;
  margin-bottom: 1rem;
}

#extra-items-table {
  min-width: 1200px;
  width: 100%;
}

#extra-items-table th,
#extra-items-table td {
  white-space: nowrap;
  min-width: 120px;
  padding: 8px 12px;
}

#extra-items-table th:nth-child(1),
#extra-items-table td:nth-child(1) {
  min-width: 150px;
}

#extra-items-table th:nth-child(2),
#extra-items-table td:nth-child(2) {
  min-width: 150px;
}

#extra-items-table th:nth-child(3),
#extra-items-table td:nth-child(3) {
  min-width: 150px;
}

#extra-items-table th:nth-child(4),
#extra-items-table td:nth-child(4) {
  min-width: 200px;
}

#extra-items-table th:nth-child(5),
#extra-items-table td:nth-child(5) {
  min-width: 120px;
}

#extra-items-table th:nth-child(6),
#extra-items-table td:nth-child(6) {
  min-width: 100px;
}

#extra-items-table th:nth-child(7),
#extra-items-table td:nth-child(7) {
  min-width: 150px;
}

#extra-items-table th:nth-child(8),
#extra-items-table td:nth-child(8) {
  min-width: 180px;
}

#extra-items-table th:nth-child(9),
#extra-items-table td:nth-child(9) {
  min-width: 120px;
}

#extra-items-table th:nth-child(10),
#extra-items-table td:nth-child(10) {
  min-width: 80px;
}

.formset-table {
  border-collapse: collapse;
}

.formset-table thead {
  background: #f3f4f6;
}

.formset-table th {
  font-weight: 600;
  text-align: left;
  border-bottom: 2px solid #e5e7eb;
}

.formset-table td {
  border-bottom: 1px solid #e5e7eb;
}

.formset-table tbody tr:hover {
  background: #f9fafb;
}

.field-error {
  color: #dc2626;
  font-size: 0.875rem;
  margin-top: 0.25rem;
  display: block;
}
</style>
{% endblock %}

{% block form_scripts %}
<link rel="stylesheet" href="{% static 'css/jalali-datepicker/jalali-datepicker.min.css' %}">
<script src="{% static 'js/jalali-datepicker/jalali-datepicker.min.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Hide submit button if transfer is locked
  {% if object and object.pk and object.is_locked == 1 %}
  var submitButton = document.querySelector('button[type="submit"]');
  if (submitButton) {
    submitButton.style.display = 'none';
  }
  {% endif %}
  
  // Initialize Jalali DatePicker
  var jalaliInputs = document.querySelectorAll('input.jalali-date-input, input[data-jalali="true"]');
  
  jalaliInputs.forEach(function(input) {
    input.setAttribute('data-jdp', '');
    input.setAttribute('data-jdp-only-date', '');
  });
  
  if (typeof jalaliDatepicker !== 'undefined') {
    jalaliDatepicker.startWatch({
      date: true,
      time: false,
      separatorChars: {
        date: '/',
        between: ' ',
        time: ':'
      },
      persianDigits: false,
      autoShow: true,
      autoHide: true,
      hideAfterChange: true,
      showTodayBtn: true,
      showEmptyBtn: true,
      showCloseBtn: true,
      useDropDownYears: true,
      zIndex: 1000
    });
  } else {
    console.error('Jalali DatePicker library not loaded!');
  }
  
  // Formset management for extra items
  var formsetContainer = document.getElementById('formset-container');
  var addBtn = document.getElementById('add-extra-item-btn');
  var totalFormsInput = document.querySelector('#id_items-TOTAL_FORMS');
  var formCount = formsetContainer ? formsetContainer.children.length : 0;
  
  if (addBtn && formsetContainer && totalFormsInput) {
    addBtn.addEventListener('click', function() {
      var newForm = formsetContainer.lastElementChild.cloneNode(true);
      var formIndex = formCount;
      formCount++;
      
      newForm.setAttribute('data-row-index', formIndex);
      
      newForm.querySelectorAll('input, select, textarea').forEach(function(field) {
        if (field.name) {
          field.name = field.name.replace(/items-\d+-/, 'items-' + formIndex + '-');
        }
        if (field.id) {
          field.id = field.id.replace(/id_items-\d+-/, 'id_items-' + formIndex + '-');
        }
        if (field.type !== 'hidden' && field.type !== 'checkbox') {
          field.value = '';
        }
        if (field.type === 'checkbox') {
          field.checked = false;
        }
      });
      
      newForm.querySelectorAll('label').forEach(function(label) {
        if (label.getAttribute('for')) {
          label.setAttribute('for', label.getAttribute('for').replace(/id_items-\d+-/, 'id_items-' + formIndex + '-'));
        }
      });
      
      var deleteCheckbox = newForm.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (deleteCheckbox) {
        deleteCheckbox.checked = false;
      }
      
      newForm.querySelectorAll('.field-error').forEach(function(error) {
        error.textContent = '';
      });
      
      formsetContainer.appendChild(newForm);
      totalFormsInput.value = formCount;
      
      setTimeout(function() {
        setupRowCascading(newForm);
      }, 100);
    });
  }
  
  // Handle DELETE checkboxes
  if (formsetContainer) {
    formsetContainer.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox' && e.target.name && e.target.name.includes('-DELETE')) {
        var row = e.target.closest('.formset-row');
        if (row && e.target.checked) {
          row.style.display = 'none';
        } else if (row && !e.target.checked) {
          row.style.display = '';
        }
      }
    });
  }
  
  // Cascading Filters for Extra Items (Type → Category → Subcategory → Item)
  function setupRowCascading(row) {
    var rowIndex = row.dataset.rowIndex;
    if (!rowIndex) {
      var firstField = row.querySelector('[name]');
      if (firstField && firstField.name) {
        var nameMatch = firstField.name.match(/items-(\d+)-/);
        if (nameMatch) {
          rowIndex = nameMatch[1];
          row.setAttribute('data-row-index', rowIndex);
        } else {
          return;
        }
      } else {
        return;
      }
    }
    
    var typeSelect = row.querySelector('select[name="items-' + rowIndex + '-material_type"]');
    var categorySelect = row.querySelector('select[name="items-' + rowIndex + '-material_category_filter"]');
    var subcategorySelect = row.querySelector('select[name="items-' + rowIndex + '-material_subcategory_filter"]');
    var itemSelect = row.querySelector('select[name="items-' + rowIndex + '-material_item"]');
    var unitSelect = row.querySelector('select[name="items-' + rowIndex + '-unit"]');
    
    if (!typeSelect || !categorySelect || !subcategorySelect || !itemSelect) {
      return;
    }
    
    function filterCategories() {
      var selectedType = typeSelect.value;
      var currentCategory = categorySelect.value;
      
      if (!selectedType) {
        categorySelect.innerHTML = '<option value="">--------</option>';
        subcategorySelect.innerHTML = '<option value="">--------</option>';
        itemSelect.innerHTML = '<option value="">--------</option>';
        if (unitSelect) {
          unitSelect.innerHTML = '<option value="">--------</option>';
          unitSelect.disabled = true;
        }
        return;
      }
      
      categorySelect.innerHTML = '<option value="">{% trans "Loading categories..." %}</option>';
      categorySelect.disabled = true;
      
      fetch('/inventory/api/filtered-categories/?type_id=' + selectedType)
        .then(response => response.json())
        .then(data => {
          categorySelect.innerHTML = '<option value="">--------</option>';
          
          if (data.categories && data.categories.length > 0) {
            data.categories.forEach(function(cat) {
              var option = document.createElement('option');
              option.value = cat.value;
              option.textContent = cat.label;
              categorySelect.appendChild(option);
            });
            
            if (currentCategory && data.categories.some(function(c) { return c.value === currentCategory; })) {
              categorySelect.value = currentCategory;
            } else {
              subcategorySelect.value = '';
              itemSelect.innerHTML = '<option value="">--------</option>';
            }
          }
          
          categorySelect.disabled = false;
          filterSubcategories();
        })
        .catch(error => {
          console.error('Error loading categories:', error);
          categorySelect.innerHTML = '<option value="">--------</option>';
          categorySelect.disabled = false;
        });
    }
    
    function filterSubcategories() {
      var selectedType = typeSelect.value;
      var selectedCategory = categorySelect.value;
      var currentSubcategory = subcategorySelect.value;
      
      if (!selectedType || !selectedCategory) {
        subcategorySelect.innerHTML = '<option value="">--------</option>';
        itemSelect.innerHTML = '<option value="">--------</option>';
        if (unitSelect) {
          unitSelect.innerHTML = '<option value="">--------</option>';
          unitSelect.disabled = true;
        }
        return;
      }
      
      subcategorySelect.innerHTML = '<option value="">{% trans "Loading subcategories..." %}</option>';
      subcategorySelect.disabled = true;
      
      fetch('/inventory/api/filtered-subcategories/?type_id=' + selectedType + '&category_id=' + selectedCategory)
        .then(response => response.json())
        .then(data => {
          subcategorySelect.innerHTML = '<option value="">--------</option>';
          
          if (data.subcategories && data.subcategories.length > 0) {
            data.subcategories.forEach(function(subcat) {
              var option = document.createElement('option');
              option.value = subcat.value;
              option.textContent = subcat.label;
              subcategorySelect.appendChild(option);
            });
            
            if (currentSubcategory && data.subcategories.some(function(s) { return s.value === currentSubcategory; })) {
              subcategorySelect.value = currentSubcategory;
            } else {
              itemSelect.innerHTML = '<option value="">--------</option>';
            }
          }
          
          subcategorySelect.disabled = false;
          filterItems();
        })
        .catch(error => {
          console.error('Error loading subcategories:', error);
          subcategorySelect.innerHTML = '<option value="">--------</option>';
          subcategorySelect.disabled = false;
        });
    }
    
    function filterItems() {
      var selectedType = typeSelect.value;
      var selectedCategory = categorySelect.value;
      var selectedSubcategory = subcategorySelect.value;
      var currentItem = itemSelect.value;
      
      if (!selectedType || !selectedCategory || !selectedSubcategory) {
        itemSelect.innerHTML = '<option value="">--------</option>';
        if (unitSelect) {
          unitSelect.innerHTML = '<option value="">--------</option>';
          unitSelect.disabled = true;
        }
        return;
      }
      
      itemSelect.innerHTML = '<option value="">{% trans "Loading items..." %}</option>';
      itemSelect.disabled = true;
      
      fetch('/inventory/api/filtered-items/?type_id=' + selectedType + '&category_id=' + selectedCategory + '&subcategory_id=' + selectedSubcategory)
        .then(response => response.json())
        .then(data => {
          itemSelect.innerHTML = '<option value="">--------</option>';
          
          if (data.items && data.items.length > 0) {
            data.items.forEach(function(item) {
              var option = document.createElement('option');
              option.value = item.value;
              option.textContent = item.label;
              itemSelect.appendChild(option);
            });
            
            if (currentItem && data.items.some(function(i) { return i.value === currentItem; })) {
              itemSelect.value = currentItem;
              loadItemUnits(itemSelect, rowIndex);
            }
          }
          
          itemSelect.disabled = false;
        })
        .catch(error => {
          console.error('Error loading items:', error);
          itemSelect.innerHTML = '<option value="">--------</option>';
          itemSelect.disabled = false;
        });
    }
    
    function loadItemUnits(materialItemSelect, idx) {
      var itemId = materialItemSelect.value;
      var unitSel = document.querySelector('select[name="items-' + idx + '-unit"]');
      
      if (!itemId || !unitSel) {
        if (unitSel) {
          unitSel.innerHTML = '<option value="">--------</option>';
          unitSel.disabled = true;
        }
        return;
      }
      
      unitSel.disabled = true;
      unitSel.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
      
      fetch('/inventory/api/item-units/?item_id=' + itemId)
        .then(response => response.json())
        .then(data => {
          if (data.units && data.units.length > 0) {
            unitSel.innerHTML = '<option value="">--------</option>';
            data.units.forEach(function(unit) {
              var option = document.createElement('option');
              option.value = unit.value;
              option.textContent = unit.label;
              unitSel.appendChild(option);
            });
            unitSel.disabled = false;
          } else {
            unitSel.innerHTML = '<option value="">--------</option>';
            unitSel.disabled = true;
          }
        })
        .catch(error => {
          console.error('Error loading units:', error);
          unitSel.innerHTML = '<option value="">--------</option>';
          unitSel.disabled = true;
        });
    }
    
    typeSelect.addEventListener('change', filterCategories);
    categorySelect.addEventListener('change', filterSubcategories);
    subcategorySelect.addEventListener('change', filterItems);
    itemSelect.addEventListener('change', function() {
      loadItemUnits(itemSelect, rowIndex);
    });
    
    // Initialize if values exist (edit mode)
    if (typeSelect.value) {
      filterCategories();
      setTimeout(function() {
        if (categorySelect.value) {
          filterSubcategories();
          setTimeout(function() {
            if (subcategorySelect.value) {
              filterItems();
              setTimeout(function() {
                if (itemSelect.value) {
                  loadItemUnits(itemSelect, rowIndex);
                }
              }, 300);
            }
          }, 300);
        }
      }, 300);
    }
  }
  
  // Initialize cascading filters for all existing rows
  if (formsetContainer) {
    formsetContainer.querySelectorAll('.formset-row').forEach(function(row) {
      setupRowCascading(row);
    });
  }
});
</script>
{% endblock %}
